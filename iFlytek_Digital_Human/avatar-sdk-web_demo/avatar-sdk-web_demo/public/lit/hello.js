/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function e(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)}function t(e,t,r){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,r),r}
/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const r=globalThis,i=r.ShadowRoot&&(void 0===r.ShadyCSS||r.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,n=Symbol(),o=new WeakMap;class s{constructor(e,t,r){if(this._$cssResult$=!0,r!==n)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t}get styleSheet(){let e=this.o;const t=this.t;if(i&&void 0===e){const r=void 0!==t&&1===t.length;r&&(e=o.get(t)),void 0===e&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),r&&o.set(t,e))}return e}toString(){return this.cssText}}const a=i?e=>e:e=>e instanceof CSSStyleSheet?(e=>{let t="";for(const r of e.cssRules)t+=r.cssText;return(e=>new s("string"==typeof e?e:e+"",void 0,n))(t)})(e):e
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */,{is:c,defineProperty:u,getOwnPropertyDescriptor:d,getOwnPropertyNames:l,getOwnPropertySymbols:h,getPrototypeOf:p}=Object,f=globalThis,m=f.trustedTypes,g=m?m.emptyScript:"",v=f.reactiveElementPolyfillSupport,y=(e,t)=>e,b={toAttribute(e,t){switch(t){case Boolean:e=e?g:null;break;case Object:case Array:e=null==e?e:JSON.stringify(e)}return e},fromAttribute(e,t){let r=e;switch(t){case Boolean:r=null!==e;break;case Number:r=null===e?null:Number(e);break;case Object:case Array:try{r=JSON.parse(e)}catch(e){r=null}}return r}},S=(e,t)=>!c(e,t),E={attribute:!0,type:String,converter:b,reflect:!1,hasChanged:S};Symbol.metadata??=Symbol("metadata"),f.litPropertyMetadata??=new WeakMap;class C extends HTMLElement{static addInitializer(e){this._$Ei(),(this.l??=[]).push(e)}static get observedAttributes(){return this.finalize(),this._$Eh&&[...this._$Eh.keys()]}static createProperty(e,t=E){if(t.state&&(t.attribute=!1),this._$Ei(),this.elementProperties.set(e,t),!t.noAccessor){const r=Symbol(),i=this.getPropertyDescriptor(e,r,t);void 0!==i&&u(this.prototype,e,i)}}static getPropertyDescriptor(e,t,r){const{get:i,set:n}=d(this.prototype,e)??{get(){return this[t]},set(e){this[t]=e}};return{get(){return i?.call(this)},set(t){const o=i?.call(this);n.call(this,t),this.requestUpdate(e,o,r)},configurable:!0,enumerable:!0}}static getPropertyOptions(e){return this.elementProperties.get(e)??E}static _$Ei(){if(this.hasOwnProperty(y("elementProperties")))return;const e=p(this);e.finalize(),void 0!==e.l&&(this.l=[...e.l]),this.elementProperties=new Map(e.elementProperties)}static finalize(){if(this.hasOwnProperty(y("finalized")))return;if(this.finalized=!0,this._$Ei(),this.hasOwnProperty(y("properties"))){const e=this.properties,t=[...l(e),...h(e)];for(const r of t)this.createProperty(r,e[r])}const e=this[Symbol.metadata];if(null!==e){const t=litPropertyMetadata.get(e);if(void 0!==t)for(const[e,r]of t)this.elementProperties.set(e,r)}this._$Eh=new Map;for(const[e,t]of this.elementProperties){const r=this._$Eu(e,t);void 0!==r&&this._$Eh.set(r,e)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(e){const t=[];if(Array.isArray(e)){const r=new Set(e.flat(1/0).reverse());for(const e of r)t.unshift(a(e))}else void 0!==e&&t.push(a(e));return t}static _$Eu(e,t){const r=t.attribute;return!1===r?void 0:"string"==typeof r?r:"string"==typeof e?e.toLowerCase():void 0}constructor(){super(),this._$Ep=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this._$Em=null,this._$Ev()}_$Ev(){this._$ES=new Promise((e=>this.enableUpdating=e)),this._$AL=new Map,this._$E_(),this.requestUpdate(),this.constructor.l?.forEach((e=>e(this)))}addController(e){(this._$EO??=new Set).add(e),void 0!==this.renderRoot&&this.isConnected&&e.hostConnected?.()}removeController(e){this._$EO?.delete(e)}_$E_(){const e=new Map,t=this.constructor.elementProperties;for(const r of t.keys())this.hasOwnProperty(r)&&(e.set(r,this[r]),delete this[r]);e.size>0&&(this._$Ep=e)}createRenderRoot(){const e=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return((e,t)=>{if(i)e.adoptedStyleSheets=t.map((e=>e instanceof CSSStyleSheet?e:e.styleSheet));else for(const i of t){const t=document.createElement("style"),n=r.litNonce;void 0!==n&&t.setAttribute("nonce",n),t.textContent=i.cssText,e.appendChild(t)}})(e,this.constructor.elementStyles),e}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(!0),this._$EO?.forEach((e=>e.hostConnected?.()))}enableUpdating(e){}disconnectedCallback(){this._$EO?.forEach((e=>e.hostDisconnected?.()))}attributeChangedCallback(e,t,r){this._$AK(e,r)}_$EC(e,t){const r=this.constructor.elementProperties.get(e),i=this.constructor._$Eu(e,r);if(void 0!==i&&!0===r.reflect){const n=(void 0!==r.converter?.toAttribute?r.converter:b).toAttribute(t,r.type);this._$Em=e,null==n?this.removeAttribute(i):this.setAttribute(i,n),this._$Em=null}}_$AK(e,t){const r=this.constructor,i=r._$Eh.get(e);if(void 0!==i&&this._$Em!==i){const e=r.getPropertyOptions(i),n="function"==typeof e.converter?{fromAttribute:e.converter}:void 0!==e.converter?.fromAttribute?e.converter:b;this._$Em=i,this[i]=n.fromAttribute(t,e.type),this._$Em=null}}requestUpdate(e,t,r){if(void 0!==e){if(r??=this.constructor.getPropertyOptions(e),!(r.hasChanged??S)(this[e],t))return;this.P(e,t,r)}!1===this.isUpdatePending&&(this._$ES=this._$ET())}P(e,t,r){this._$AL.has(e)||this._$AL.set(e,t),!0===r.reflect&&this._$Em!==e&&(this._$Ej??=new Set).add(e)}async _$ET(){this.isUpdatePending=!0;try{await this._$ES}catch(e){Promise.reject(e)}const e=this.scheduleUpdate();return null!=e&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this._$Ep){for(const[e,t]of this._$Ep)this[e]=t;this._$Ep=void 0}const e=this.constructor.elementProperties;if(e.size>0)for(const[t,r]of e)!0!==r.wrapped||this._$AL.has(t)||void 0===this[t]||this.P(t,this[t],r)}let e=!1;const t=this._$AL;try{e=this.shouldUpdate(t),e?(this.willUpdate(t),this._$EO?.forEach((e=>e.hostUpdate?.())),this.update(t)):this._$EU()}catch(t){throw e=!1,this._$EU(),t}e&&this._$AE(t)}willUpdate(e){}_$AE(e){this._$EO?.forEach((e=>e.hostUpdated?.())),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(e)),this.updated(e)}_$EU(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$ES}shouldUpdate(e){return!0}update(e){this._$Ej&&=this._$Ej.forEach((e=>this._$EC(e,this[e]))),this._$EU()}updated(e){}firstUpdated(e){}}C.elementStyles=[],C.shadowRootOptions={mode:"open"},C[y("elementProperties")]=new Map,C[y("finalized")]=new Map,v?.({ReactiveElement:C}),(f.reactiveElementVersions??=[]).push("2.0.4");
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
const T=globalThis,R=T.trustedTypes,_=R?R.createPolicy("lit-html",{createHTML:e=>e}):void 0,I="$lit$",w=`lit$${(Math.random()+"").slice(9)}$`,k="?"+w,O=`<${k}>`,A=document,P=()=>A.createComment(""),L=e=>null===e||"object"!=typeof e&&"function"!=typeof e,x=Array.isArray,D="[ \t\n\f\r]",M=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,U=/-->/g,N=/>/g,V=RegExp(`>|${D}(?:([^\\s"'>=/]+)(${D}*=${D}*(?:[^ \t\n\f\r"'\`<>=]|("|')|))|$)`,"g"),j=/'/g,F=/"/g,B=/^(?:script|style|textarea|title)$/i,W=(e=>(t,...r)=>({_$litType$:e,strings:t,values:r}))(1),G=Symbol.for("lit-noChange"),H=Symbol.for("lit-nothing"),$=new WeakMap,z=A.createTreeWalker(A,129);function J(e,t){if(!Array.isArray(e)||!e.hasOwnProperty("raw"))throw Error("invalid template strings array");return void 0!==_?_.createHTML(t):t}class Y{constructor({strings:e,_$litType$:t},r){let i;this.parts=[];let n=0,o=0;const s=e.length-1,a=this.parts,[c,u]=((e,t)=>{const r=e.length-1,i=[];let n,o=2===t?"<svg>":"",s=M;for(let t=0;t<r;t++){const r=e[t];let a,c,u=-1,d=0;for(;d<r.length&&(s.lastIndex=d,c=s.exec(r),null!==c);)d=s.lastIndex,s===M?"!--"===c[1]?s=U:void 0!==c[1]?s=N:void 0!==c[2]?(B.test(c[2])&&(n=RegExp("</"+c[2],"g")),s=V):void 0!==c[3]&&(s=V):s===V?">"===c[0]?(s=n??M,u=-1):void 0===c[1]?u=-2:(u=s.lastIndex-c[2].length,a=c[1],s=void 0===c[3]?V:'"'===c[3]?F:j):s===F||s===j?s=V:s===U||s===N?s=M:(s=V,n=void 0);const l=s===V&&e[t+1].startsWith("/>")?" ":"";o+=s===M?r+O:u>=0?(i.push(a),r.slice(0,u)+I+r.slice(u)+w+l):r+w+(-2===u?t:l)}return[J(e,o+(e[r]||"<?>")+(2===t?"</svg>":"")),i]})(e,t);if(this.el=Y.createElement(c,r),z.currentNode=this.el.content,2===t){const e=this.el.content.firstChild;e.replaceWith(...e.childNodes)}for(;null!==(i=z.nextNode())&&a.length<s;){if(1===i.nodeType){if(i.hasAttributes())for(const e of i.getAttributeNames())if(e.endsWith(I)){const t=u[o++],r=i.getAttribute(e).split(w),s=/([.?@])?(.*)/.exec(t);a.push({type:1,index:n,name:s[2],strings:r,ctor:"."===s[1]?Z:"?"===s[1]?ee:"@"===s[1]?te:Q}),i.removeAttribute(e)}else e.startsWith(w)&&(a.push({type:6,index:n}),i.removeAttribute(e));if(B.test(i.tagName)){const e=i.textContent.split(w),t=e.length-1;if(t>0){i.textContent=R?R.emptyScript:"";for(let r=0;r<t;r++)i.append(e[r],P()),z.nextNode(),a.push({type:2,index:++n});i.append(e[t],P())}}}else if(8===i.nodeType)if(i.data===k)a.push({type:2,index:n});else{let e=-1;for(;-1!==(e=i.data.indexOf(w,e+1));)a.push({type:7,index:n}),e+=w.length-1}n++}}static createElement(e,t){const r=A.createElement("template");return r.innerHTML=e,r}}function K(e,t,r=e,i){if(t===G)return t;let n=void 0!==i?r._$Co?.[i]:r._$Cl;const o=L(t)?void 0:t._$litDirective$;return n?.constructor!==o&&(n?._$AO?.(!1),void 0===o?n=void 0:(n=new o(e),n._$AT(e,r,i)),void 0!==i?(r._$Co??=[])[i]=n:r._$Cl=n),void 0!==n&&(t=K(e,n._$AS(e,t.values),n,i)),t}class q{constructor(e,t){this._$AV=[],this._$AN=void 0,this._$AD=e,this._$AM=t}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(e){const{el:{content:t},parts:r}=this._$AD,i=(e?.creationScope??A).importNode(t,!0);z.currentNode=i;let n=z.nextNode(),o=0,s=0,a=r[0];for(;void 0!==a;){if(o===a.index){let t;2===a.type?t=new X(n,n.nextSibling,this,e):1===a.type?t=new a.ctor(n,a.name,a.strings,this,e):6===a.type&&(t=new re(n,this,e)),this._$AV.push(t),a=r[++s]}o!==a?.index&&(n=z.nextNode(),o++)}return z.currentNode=A,i}p(e){let t=0;for(const r of this._$AV)void 0!==r&&(void 0!==r.strings?(r._$AI(e,r,t),t+=r.strings.length-2):r._$AI(e[t])),t++}}class X{get _$AU(){return this._$AM?._$AU??this._$Cv}constructor(e,t,r,i){this.type=2,this._$AH=H,this._$AN=void 0,this._$AA=e,this._$AB=t,this._$AM=r,this.options=i,this._$Cv=i?.isConnected??!0}get parentNode(){let e=this._$AA.parentNode;const t=this._$AM;return void 0!==t&&11===e?.nodeType&&(e=t.parentNode),e}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(e,t=this){e=K(this,e,t),L(e)?e===H||null==e||""===e?(this._$AH!==H&&this._$AR(),this._$AH=H):e!==this._$AH&&e!==G&&this._(e):void 0!==e._$litType$?this.$(e):void 0!==e.nodeType?this.T(e):(e=>x(e)||"function"==typeof e?.[Symbol.iterator])(e)?this.k(e):this._(e)}S(e){return this._$AA.parentNode.insertBefore(e,this._$AB)}T(e){this._$AH!==e&&(this._$AR(),this._$AH=this.S(e))}_(e){this._$AH!==H&&L(this._$AH)?this._$AA.nextSibling.data=e:this.T(A.createTextNode(e)),this._$AH=e}$(e){const{values:t,_$litType$:r}=e,i="number"==typeof r?this._$AC(e):(void 0===r.el&&(r.el=Y.createElement(J(r.h,r.h[0]),this.options)),r);if(this._$AH?._$AD===i)this._$AH.p(t);else{const e=new q(i,this),r=e.u(this.options);e.p(t),this.T(r),this._$AH=e}}_$AC(e){let t=$.get(e.strings);return void 0===t&&$.set(e.strings,t=new Y(e)),t}k(e){x(this._$AH)||(this._$AH=[],this._$AR());const t=this._$AH;let r,i=0;for(const n of e)i===t.length?t.push(r=new X(this.S(P()),this.S(P()),this,this.options)):r=t[i],r._$AI(n),i++;i<t.length&&(this._$AR(r&&r._$AB.nextSibling,i),t.length=i)}_$AR(e=this._$AA.nextSibling,t){for(this._$AP?.(!1,!0,t);e&&e!==this._$AB;){const t=e.nextSibling;e.remove(),e=t}}setConnected(e){void 0===this._$AM&&(this._$Cv=e,this._$AP?.(e))}}class Q{get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}constructor(e,t,r,i,n){this.type=1,this._$AH=H,this._$AN=void 0,this.element=e,this.name=t,this._$AM=i,this.options=n,r.length>2||""!==r[0]||""!==r[1]?(this._$AH=Array(r.length-1).fill(new String),this.strings=r):this._$AH=H}_$AI(e,t=this,r,i){const n=this.strings;let o=!1;if(void 0===n)e=K(this,e,t,0),o=!L(e)||e!==this._$AH&&e!==G,o&&(this._$AH=e);else{const i=e;let s,a;for(e=n[0],s=0;s<n.length-1;s++)a=K(this,i[r+s],t,s),a===G&&(a=this._$AH[s]),o||=!L(a)||a!==this._$AH[s],a===H?e=H:e!==H&&(e+=(a??"")+n[s+1]),this._$AH[s]=a}o&&!i&&this.j(e)}j(e){e===H?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,e??"")}}class Z extends Q{constructor(){super(...arguments),this.type=3}j(e){this.element[this.name]=e===H?void 0:e}}class ee extends Q{constructor(){super(...arguments),this.type=4}j(e){this.element.toggleAttribute(this.name,!!e&&e!==H)}}class te extends Q{constructor(e,t,r,i,n){super(e,t,r,i,n),this.type=5}_$AI(e,t=this){if((e=K(this,e,t,0)??H)===G)return;const r=this._$AH,i=e===H&&r!==H||e.capture!==r.capture||e.once!==r.once||e.passive!==r.passive,n=e!==H&&(r===H||i);i&&this.element.removeEventListener(this.name,this,r),n&&this.element.addEventListener(this.name,this,e),this._$AH=e}handleEvent(e){"function"==typeof this._$AH?this._$AH.call(this.options?.host??this.element,e):this._$AH.handleEvent(e)}}class re{constructor(e,t,r){this.element=e,this.type=6,this._$AN=void 0,this._$AM=t,this.options=r}get _$AU(){return this._$AM._$AU}_$AI(e){K(this,e)}}const ie=T.litHtmlPolyfillSupport;ie?.(Y,X),(T.litHtmlVersions??=[]).push("3.1.2");
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
class ne extends C{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0}createRenderRoot(){const e=super.createRenderRoot();return this.renderOptions.renderBefore??=e.firstChild,e}update(e){const t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this._$Do=((e,t,r)=>{const i=r?.renderBefore??t;let n=i._$litPart$;if(void 0===n){const e=r?.renderBefore??null;i._$litPart$=n=new X(t.insertBefore(P(),e),e,void 0,r??{})}return n._$AI(e),n})(t,this.renderRoot,this.renderOptions)}connectedCallback(){super.connectedCallback(),this._$Do?.setConnected(!0)}disconnectedCallback(){super.disconnectedCallback(),this._$Do?.setConnected(!1)}render(){return G}}ne._$litElement$=!0,ne.finalized=!0,globalThis.litElementHydrateSupport?.({LitElement:ne});const oe=globalThis.litElementPolyfillSupport;oe?.({LitElement:ne}),(globalThis.litElementVersions??=[]).push("4.0.4");var se,ae,ce,ue;!function(e){e[e.webrtc=6]="webrtc",e[e.xrtc=12]="xrtc",e[e.text=99]="text"}(se||(se={})),function(e){e[e.start=0]="start",e[e.intermediate=1]="intermediate",e[e.end=2]="end"}(ae||(ae={})),function(e){e.init="0",e.bs="2",e.audio="3",e.asr="4",e.nlp="5",e.frameBegin="10",e.duration="9",e.frameEnd="11",e.commonError="-9",e.seriousError="-99"}(ce||(ce={})),function(e){e.ping="-99",e.break="-1",e.init="0",e.nlpByVoice="1",e.nlpByText="2",e.repeatText="3",e.repeatVoice="4",e.repeatBigVoice="5",e.actionPlay="6"}(ue||(ue={}));class de extends Error{constructor(e,t,r,i,n){super(e),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"aside",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sid",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=r,this.code=t,this.aside=n||"",this.sid=i||"",this.stack=new Error(e).stack}}function le(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})).replace(/-/g,"")}const he=()=>{const e={};return{promise:new Promise(((t,r)=>{e.resolve=t,e.reject=r})),controller:e}},pe="function"==typeof btoa,fe="function"==typeof Buffer,me=("function"==typeof TextDecoder&&new TextDecoder,"function"==typeof TextEncoder?new TextEncoder:void 0),ge=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),ve=((e=>{let t={};ge.forEach(((e,r)=>t[e]=r))})(),String.fromCharCode.bind(String)),ye=("function"==typeof Uint8Array.from&&Uint8Array.from.bind(Uint8Array),e=>e.replace(/=/g,"").replace(/[+\/]/g,(e=>"+"==e?"-":"_"))),be=e=>{let t,r,i,n,o="";const s=e.length%3;for(let s=0;s<e.length;){if((r=e.charCodeAt(s++))>255||(i=e.charCodeAt(s++))>255||(n=e.charCodeAt(s++))>255)throw new TypeError("invalid character found");t=r<<16|i<<8|n,o+=ge[t>>18&63]+ge[t>>12&63]+ge[t>>6&63]+ge[63&t]}return s?o.slice(0,s-3)+"===".substring(s):o},Se=pe?e=>btoa(e):fe?e=>Buffer.from(e,"binary").toString("base64"):be,Ee=fe?e=>Buffer.from(e).toString("base64"):e=>{let t=[];for(let r=0,i=e.length;r<i;r+=4096)t.push(ve.apply(null,e.subarray(r,r+4096)));return Se(t.join(""))},Ce=(e,t=!1)=>t?ye(Ee(e)):Ee(e),Te=e=>{if(e.length<2)return(t=e.charCodeAt(0))<128?e:t<2048?ve(192|t>>>6)+ve(128|63&t):ve(224|t>>>12&15)+ve(128|t>>>6&63)+ve(128|63&t);var t=65536+1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320);return ve(240|t>>>18&7)+ve(128|t>>>12&63)+ve(128|t>>>6&63)+ve(128|63&t)},Re=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,_e=e=>e.replace(Re,Te),Ie=fe?e=>Buffer.from(e,"utf8").toString("base64"):me?e=>Ee(me.encode(e)):e=>Se(_e(e)),we=(e,t=!1)=>t?ye(Ie(e)):Ie(e),ke=we,Oe=Ce,Ae={code:"000001",message:"必要参数缺失"},Pe={code:"999998",message:"无效连接"},Le={code:"999996",message:"无效的响应"},xe={code:"700003",message:"无效的流数据"},De={code:"700002",message:"播放不允许"},Me={code:"700004",message:"缺失播放插件"},Ue={code:"080000",message:"不支持的环境"},Ne={code:"090001",message:"未找到指定约束的设备"},Ve={code:"090002",message:"设备访问权限异常/无法请求使用源设备"},je={code:"090003",message:"暂时无法访问摄像头/麦克风，请确保当前没有其他应用请求访问设备，并重试"},Fe={code:"090004",message:"无效的设备请求参数"},Be={code:"090005",message:"不支持的环境"},We={code:"090006",message:"当前页面未处于激活状态"};var Ge;!function(e){e.InvalidParam="InvalidParam",e.InvalidResponse="InvalidResponse",e.ContextError="ContextError",e.NetworkError="NetworkError",e.ConnectError="ConnectError",e.InvalidConnect="InvalidConnect",e.MediaError="MediaError",e.UserMediaError="UserMediaError"}(Ge||(Ge={}));const He=0;class $e{constructor(e){Object.defineProperty(this,"emitDelay",{enumerable:!0,configurable:!0,writable:!0,value:He}),Object.defineProperty(this,"listeners",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.emitDelay=e?.emitDelay??He}addListenner(e,t,r){if("function"!=typeof t)throw TypeError("listener must be a function");-1===this.events.indexOf(e)?(this.listeners[e]=[{once:r||!1,fn:t}],this.events.push(e)):this.listeners[e].push({once:r||!1,fn:t})}applyEvents(e,t){const r=this.listeners[e],i=[];r?.forEach((function(e,r){e.fn.apply(null,t),e.once&&i.unshift(r)})),i?.forEach((function(e){r.splice(e,1)}))}on(e,t){return this.addListenner(e,t,!1),this}once(e,t){return this.addListenner(e,t,!0),this}off(e,t){const r=this.events.indexOf(e);if(e&&-1!==r)if(t){const i=[],n=this.listeners[e];n?.forEach((function(e,r){e.fn===t&&i.unshift(r)})),i?.forEach((function(e){n.splice(e,1)})),n.length||(this.events.splice(r,1),delete this.listeners[e])}else delete this.listeners[e],this.events.splice(r,1);return this}removeAllListeners(){return this.listeners={},this.events=[],this}emit(e,...t){this.emitDelay?setTimeout((()=>{this.applyEvents(e,t)}),this.emitDelay):this.applyEvents(e,t)}emitSync(e,...t){this.applyEvents(e,t)}destroy(){this.listeners={},this.events=[]}}var ze,Je;
/*!
 * xrtc.js v4.7.0
 * (c) 2020-2024 
 * Released under the MIT License in iflytek.
 */
function Ye(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ke(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function qe(e,t){if(e){if("string"==typeof e)return Ke(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ke(e,t):void 0}}function Xe(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var r=[],i=!0,n=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(i=(s=a.next()).done)&&(r.push(s.value),!t||r.length!==t);i=!0);}catch(e){n=!0,o=e}finally{try{i||null==a.return||a.return()}finally{if(n)throw o}}return r}}(e,t)||qe(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Qe(e,t,r,i,n,o,s){try{var a=e[o](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(i,n)}function Ze(e){return function(){var t=this,r=arguments;return new Promise((function(i,n){var o=e.apply(t,r);function s(e){Qe(o,i,n,s,a,"next",e)}function a(e){Qe(o,i,n,s,a,"throw",e)}s(void 0)}))}}function et(e){return function(e){if(Array.isArray(e))return Ke(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||qe(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function tt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function rt(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function it(e,t,r){return t&&rt(e.prototype,t),r&&rt(e,r),e}function nt(e){var t={exports:{}};return e(t,t.exports),t.exports}!function(e){e.connected="connected",e.disconnected="disconnected",e.frameBegin="frameBegin",e.frameEnd="frameEnd",e.duration="duration",e.nlp="nlp",e.asr="asr",e.error="error"}(ze||(ze={})),function(e){e.play="play",e.waiting="waiting",e.playing="playing",e.stop="stop",e.playNotAllowed="not-allowed",e.error="error"}(Je||(Je={}));var ot=nt((function(e){var t=function(e){var t,r=Object.prototype,i=r.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",a=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function u(e,t,r,i){var n=Object.create((t&&t.prototype instanceof g?t:g).prototype),o=new k(i||[]);return n._invoke=function(e,t,r){var i=l;return function(n,o){if(i===p)throw new Error("Generator is already running");if(i===f){if("throw"===n)throw o;return A()}for(r.method=n,r.arg=o;;){var s=r.delegate;if(s){var a=_(s,r);if(a){if(a===m)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===l)throw i=f,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=p;var c=d(e,t,r);if("normal"===c.type){if(i=r.done?f:h,c.arg===m)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(i=f,r.method="throw",r.arg=c.arg)}}}(e,r,o),n}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var l="suspendedStart",h="suspendedYield",p="executing",f="completed",m={};function g(){}function v(){}function y(){}var b={};b[o]=function(){return this};var S=Object.getPrototypeOf,E=S&&S(S(O([])));E&&E!==r&&i.call(E,o)&&(b=E);var C=y.prototype=g.prototype=Object.create(b);function T(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function R(e,t){function r(n,o,s,a){var c=d(e[n],e,o);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==typeof l&&i.call(l,"__await")?t.resolve(l.__await).then((function(e){r("next",e,s,a)}),(function(e){r("throw",e,s,a)})):t.resolve(l).then((function(e){u.value=e,s(u)}),(function(e){return r("throw",e,s,a)}))}a(c.arg)}var n;this._invoke=function(e,i){function o(){return new t((function(t,n){r(e,i,t,n)}))}return n=n?n.then(o,o):o()}}function _(e,r){var i=e.iterator[r.method];if(i===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,_(e,r),"throw"===r.method))return m;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return m}var n=d(i,e.iterator,r.arg);if("throw"===n.type)return r.method="throw",r.arg=n.arg,r.delegate=null,m;var o=n.arg;return o?o.done?(r[e.resultName]=o.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,m):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,m)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function w(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function O(e){if(e){var r=e[o];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,s=function r(){for(;++n<e.length;)if(i.call(e,n))return r.value=e[n],r.done=!1,r;return r.value=t,r.done=!0,r};return s.next=s}}return{next:A}}function A(){return{value:t,done:!0}}return v.prototype=C.constructor=y,y.constructor=v,v.displayName=c(y,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,c(e,a,"GeneratorFunction")),e.prototype=Object.create(C),e},e.awrap=function(e){return{__await:e}},T(R.prototype),R.prototype[s]=function(){return this},e.AsyncIterator=R,e.async=function(t,r,i,n,o){void 0===o&&(o=Promise);var s=new R(u(t,r,i,n),o);return e.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},T(C),c(C,a,"Generator"),C[o]=function(){return this},C.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var i=t.pop();if(i in e)return r.value=i,r.done=!1,r}return r.done=!0,r}},e.values=O,k.prototype={constructor:k,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(w),!e)for(var r in this)"t"===r.charAt(0)&&i.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function n(i,n){return a.type="throw",a.arg=e,r.next=i,n&&(r.method="next",r.arg=t),!!n}for(var o=this.tryEntries.length-1;o>=0;--o){var s=this.tryEntries[o],a=s.completion;if("root"===s.tryLoc)return n("end");if(s.tryLoc<=this.prev){var c=i.call(s,"catchLoc"),u=i.call(s,"finallyLoc");if(c&&u){if(this.prev<s.catchLoc)return n(s.catchLoc,!0);if(this.prev<s.finallyLoc)return n(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return n(s.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return n(s.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&i.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,m):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),w(r),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var i=r.completion;if("throw"===i.type){var n=i.arg;w(r)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,i){return this.delegate={iterator:O(e),resultName:r,nextLoc:i},"next"===this.method&&(this.arg=t),m}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}})),st=function(){function e(t){tt(this,e),this.events={},this.logger=t}return it(e,[{key:"on",value:function(e,t){var r=this.events[e]||[];return r.push(t),this.events[e]=r,this}},{key:"once",value:function(e,t){var r=this;this.on(e,(function i(){for(var n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];t.apply(null,o),r.off(e,i)}))}},{key:"off",value:function(e,t){if("*"===e)return this.events={},this;var r=this.events[e];return this.events[e]=r&&r.filter((function(e){return e!==t})),this}},{key:"emit",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];"network-quality"!==e&&"audio-volume"!==e&&"mic-volume"!==e&&this.logger&&this.logger.info("Emit event name:",e);var n=this.events[e];return n&&n.forEach((function(e){return e.apply(null,r)})),this}}]),e}(),at=new Map;at.set("anchor",{publish:{audio:!0,video:!0},subscribe:{audio:!0,video:!0},control:!0}),at.set("audience",{publish:{audio:!1,video:!1},subscribe:{audio:!0,video:!0},control:!1});var ct,ut,dt,lt;!function(e){e[e.New=0]="New",e[e.Joining=1]="Joining",e[e.Joined=2]="Joined",e[e.Leaving=3]="Leaving",e[e.Leaved=4]="Leaved"}(ct||(ct={})),function(e){e[e.Create=0]="Create",e[e.Publishing=1]="Publishing",e[e.Published=2]="Published",e[e.Unpublished=3]="Unpublished"}(ut||(ut={})),function(e){e[e.Create=0]="Create",e[e.Subscribing=1]="Subscribing",e[e.Subscribed=2]="Subscribed",e[e.Unsubscribed=3]="Unsubscribed"}(dt||(dt={})),function(e){e[e.Invalid=0]="Invalid",e[e.AudioOnly=1]="AudioOnly",e[e.VideoOnly=2]="VideoOnly",e[e.AudioVideo=3]="AudioVideo"}(lt||(lt={}));var ht="auxiliary",pt="error";function ft(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function mt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ft(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ft(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var gt=mt(mt(mt(mt(mt(mt({},{INVALID_PARAMETER:4096,INVALID_OPERATION:4097,NOT_SUPPORTED:4098}),{JOIN_ROOM_FAILED:16388,CREATE_OFFER_FAILED:16389,LEAVE_ROOM_FAILED:16390,PUBLISH_STREAM_FAILED:16391,UNPUBLISH_STREAM_FAILED:16392,SUBSCRIBE_FAILED:16393,UNSUBSCRIBE_FAILED:16400,SWITCH_ROLE_ERROR:16401,INVALID_TRANSPORT_STATA:16402,LOCAL_AUDIO_STATA_ERROR:16403,LOCAL_VIDEO_STATA_ERROR:16404,REMOTE_AUDIO_STATA_ERROR:16405,REMOTE_VIDEO_STATA_ERROR:16406,LOCAL_SWITCH_SIMULCAST:16407,REMOTE_SWITCH_SIMULCAST:16408,SUBSCRIPTION_TIMEOUT:16450,UNKNOWN:"0xFFFF"}),{INIT_STREAM_FAILED:12289,PLAY_STREAM_ERROR:12290,SET_AUDIO_OUTPUT_FAILED:12291,SET_VIDEO_PROFILE_ERROR:12292,SET_SCREEN_SHARE_FAILED:12293,SWITCH_DEVICE_FAILED:12294,ADD_TRACK_FAILED:12295,REMOVE_TRACK_FAILED:12296,REPLACE_TRACK_FAILED:12297,PLAY_NOT_ALLOWED:16451,DEVICE_AUTO_RECOVER_FAILED:16452,CANDIDATE_COLLECT_FAILED:16453,RTCPEERCONNECTION_SATE_FAILED:16480}),{DEVICE_NOT_FOUND:256,H264_NOT_SUPPORTED:257,CAMERAS_NOT_FOUND:258,MICROPHONES_NOT_FOUND:259,SPEAKERS_NOT_FOUND:260,OS_NOT_SUPPORTED:261,WEBRTC_NOT_SUPPORTED:262,BROWSER_NOT_SUPPORTED:263}),{SIGNAL_CHANNEL_SETUP_FAILED:20481,SIGNAL_CHANNEL_RECONNECTION_FAILED:20482,SERVER_TIMEOUT:20483}),{SERVER_UNKNOWN_ERROR:-10011,AUTHORIZATION_FAILED:-10013,GET_SERVER_NODE_FAILED:-10015,REQUEST_TIMEOUT:-10020});function vt(e,t){return(vt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function yt(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&vt(e,t)}function bt(e){return(bt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function St(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Et(e,t){return!t||"object"!==bt(t)&&"function"!=typeof t?St(e):t}function Ct(e){return(Ct=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Tt(e,t,r){return(Tt=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,r){var i=[null];i.push.apply(i,t);var n=new(Function.bind.apply(e,i));return r&&vt(n,r.prototype),n}).apply(null,arguments)}function Rt(e){var t="function"==typeof Map?new Map:void 0;return(Rt=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return Tt(e,arguments,Ct(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),vt(r,e)})(e)}var _t,It=function(e){yt(r,Rt(Error));var t=function(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Ct(e);if(t){var n=Ct(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return Et(this,r)}}(r);function r(e){var i;tt(this,r),(i=t.call(this)).code=e.code,e.name&&(i.name=e.name);var n=e.message instanceof Error?e.message.message:e.message;return i.message=n,i}return it(r,[{key:"getCode",value:function(){return this.code}}]),r}(),wt=function(){function e(){var t=this;tt(this,e),this.context=new(window.AudioContext||window.webkitAudioContext),this.instant=0,this.slow=0,this.clip=0,this.script=this.context.createScriptProcessor(2048,1,1),this.script.onaudioprocess=function(e){var r,i=e.inputBuffer.getChannelData(0),n=0,o=0;for(r=0;r<i.length;++r)n+=i[r]*i[r],Math.abs(i[r])>.99&&(o+=1);t.instant=Math.sqrt(n/i.length),t.slow=.95*t.slow+.05*t.instant,t.clip=o/i.length}}return it(e,[{key:"connectToSource",value:function(e){try{var t=new MediaStream;t.addTrack(e),this.mic=this.context.createMediaStreamSource(t),this.mic.connect(this.script),this.script.connect(this.context.destination)}catch(e){console.error("soundMeter connectoToSource error: "+e)}}},{key:"stop",value:function(){this.mic.disconnect(),this.script.disconnect()}},{key:"resume",value:function(){this.context&&this.context.resume()}},{key:"getVolume",value:function(){return this.instant.toFixed(2)}}]),e}(),kt=function(){function e(t){tt(this,e),this.stream=t.stream,this.userId=t.stream.userId,this.log=t.stream.logger,this.track=t.track,this.div=t.div,this.muted=t.muted,this.outputDeviceId=t.deviceId,this.volume=t.volume,this.element=null,this.state="NONE",this.pausedRetryCount=5,this._emitter=new st,this.handleEleEventPlaying=this.eleEventPlaying.bind(this),this.handleEleEventEnded=this.eleEventEnded.bind(this),this.handleEleEventPause=this.eleEventPause.bind(this),this.handleTrackEventEnded=this.trackEventEnded.bind(this),this.handleTrackEventMute=this.trackEventMute.bind(this),this.handleTrackEventUnmute=this.trackEventUnmute.bind(this)}var t;return it(e,[{key:"play",value:(t=Ze(ot.mark((function e(){var t=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){var i=new MediaStream;i.addTrack(t.track);var n=document.createElement("audio");n.srcObject=i,n.muted=t.muted,n.setAttribute("id","audio_".concat(t.stream.getId(),"_").concat(Date.now())),n.setAttribute("autoplay","autoplay"),n.setAttribute("playsinline","playsinline"),t.div.appendChild(n),t.outputDeviceId&&"function"==typeof(null==n?void 0:n.setSinkId)&&n.setSinkId(t.outputDeviceId),t.element=n,t.setVolume(t.volume),t.handleEvents(),n.addEventListener("canplay",(function(){t.element.play().then((function(){e()})).catch((function(e){r(e)}))}))})));case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"handleEvents",value:function(){var e,t,r;null===(e=this.element)||void 0===e||e.addEventListener("playing",this.handleEleEventPlaying),null===(t=this.element)||void 0===t||t.addEventListener("ended",this.handleEleEventEnded),null===(r=this.element)||void 0===r||r.addEventListener("pause",this.handleEleEventPause),this.trackHandleEvents()}},{key:"trackHandleEvents",value:function(){var e,t,r;null===(e=this.track)||void 0===e||e.addEventListener("ended",this.handleTrackEventEnded),null===(t=this.track)||void 0===t||t.addEventListener("mute",this.handleTrackEventMute),null===(r=this.track)||void 0===r||r.addEventListener("unmute",this.handleTrackEventUnmute)}},{key:"trackRemoveEvents",value:function(){var e,t,r;null===(e=this.track)||void 0===e||e.removeEventListener("ended",this.handleTrackEventEnded),null===(t=this.track)||void 0===t||t.removeEventListener("mute",this.handleTrackEventMute),null===(r=this.track)||void 0===r||r.removeEventListener("unmute",this.handleTrackEventUnmute)}},{key:"removeEvents",value:function(){var e,t,r;null===(e=this.element)||void 0===e||e.removeEventListener("playing",this.handleEleEventPlaying),null===(t=this.element)||void 0===t||t.removeEventListener("ended",this.handleEleEventEnded),null===(r=this.element)||void 0===r||r.removeEventListener("pause",this.handleEleEventPause),this.trackRemoveEvents()}},{key:"setSinkId",value:function(e){var t;this.outputDeviceId!==e&&(this.outputDeviceId=e,"function"==typeof(null===(t=this.element)||void 0===t?void 0:t.setSinkId)&&this.element.setSinkId(e))}},{key:"setVolume",value:function(e){this.log.info("stream - audioElement setVolume to : ".concat(e.toString())),this.element.volume=e}},{key:"getAudioLevel",value:function(){return this.soundMeter||(this.soundMeter=new wt,this.soundMeter.connectToSource(this.track)),this.soundMeter.getVolume()}},{key:"stop",value:function(){this.removeEvents(),this.div.removeChild(this.element),this.element.srcObject=null,this.element=null,this.soundMeter&&(this.soundMeter.stop(),this.soundMeter=null)}},{key:"resume",value:function(){var e;return null===(e=this.element)||void 0===e?void 0:e.play()}},{key:"getAudioElement",value:function(){return this.element}},{key:"setAudioTrack",value:function(e){this.trackRemoveEvents();var t=new MediaStream;t.addTrack(e),this.track=e,this.trackHandleEvents(),this.soundMeter=null,this.log.info("setAudioTrack",e),this.element&&(this.element.srcObject=t,this.element.play())}},{key:"eleEventPlaying",value:function(){this.log.info("stream ".concat(this.userId," - audio player is starting playing")),this.state="PLAYING",this._emitter.emit("player-state-changed",{state:this.state,reason:"playing"})}},{key:"eleEventEnded",value:function(){this.log.info("stream ".concat(this.userId," - audio player is ended")),"STOPPED"!==this.state&&(this.state="STOPPED",this._emitter.emit("player-state-changed",{state:this.state,reason:"ended"}))}},{key:"eleEventPause",value:function(){if(this.log.info("stream ".concat(this.userId," - audio player is paused")),this.state="PAUSED",this._emitter.emit("player-state-changed",{state:this.state,reason:"pause"}),this.div&&document.getElementById(this.div.id)){var e=(window.navigator&&window.navigator.userAgent||"").match(/Chrome\/(\d+)/),t=e&&e[1]?Number(e[1]):null;this.pausedRetryCount>0&&"number"==typeof t&&t<70&&(this.resume(),this.pausedRetryCount--)}else this.log.warn("audio container is not in DOM")}},{key:"trackEventEnded",value:function(){this.log.info("stream ".concat(this.userId," - audio player track is ended")),"STOPPED"!==this.state&&(this.state="STOPPED",this._emitter.emit("player-state-changed",{state:this.state,reason:"ended",type:"track"}))}},{key:"trackEventMute",value:function(){this.log.info("stream ".concat(this.userId," - audio track is muted")),"PAUSED"!==this.state&&(this.state="PAUSED",this._emitter.emit("player-state-changed",{state:this.state,reason:"mute",type:"track"}))}},{key:"trackEventUnmute",value:function(){this.log.info("stream ".concat(this.userId," - audio track is unmuted")),"PAUSED"===this.state&&(this.state="PLAYING",this._emitter.emit("player-state-changed",{state:this.state,reason:"unmute",type:"track"}))}}]),e}(),Ot=(_t=function(e,t){for(var r=["webgl","experimental-webgl","webkit-3d","moz-webgl"],i=null,n=0;n<r.length;++n){try{i=e.getContext(r[n],t)}catch(e){}if(i)break}return i},function(e,t,r){r=r||function(e){var t=document.getElementsByTagName("body")[0];if(t){var r=window.WebGLRenderingContext?'It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org">Click here for more information.</a>':'This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>';e&&(r+="<br/><br/>Status: "+e),t.innerHTML=function(e){return'<div style="margin: auto; width:500px;z-index:10000;margin-top:20em;text-align:center;"> '.concat(e," </div>")}(r)}},e.addEventListener&&e.addEventListener("webglcontextcreationerror",(function(e){r(e.statusMessage)}),!1);var i=_t(e,t);return i||r(""),i});function At(e,t,r){var i=e.createShader(t);if(null==i)return console.log("unable to create shader"),null;if(e.shaderSource(i,r),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS)){var n=e.getShaderInfoLog(i);return console.log("Failed to compile shader: "+n),e.deleteShader(i),null}return i}window.requestAnimationFrame||(window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}),window.cancelAnimationFrame||(window.cancelAnimationFrame=window.cancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||window.oCancelAnimationFrame||window.oCancelRequestAnimationFrame||window.clearTimeout);var Pt=function(){function e(t,r){tt(this,e),this.div=t.div,this.video=t.video,this.virtualBackgroundMix=t.virtualBackgroundMix||null,this.textures=[],this.canCopyVideo=!1,this.canCopyBackground=!1,this.log=r,this.track=t.track,this.initVirtualBackground(t.virtualBackground),this.isEleLisenter=t.isEleLisenter}return it(e,[{key:"play",value:function(){var e=this;if(this.initCanvas(),this.gl=Ot(this.canvas,{preserveDrawingBuffer:!0,alpha:!0,antialias:!0})||null,this.gl){var t=this.initXShaderSource();if(function(e,t,r){var i=function(e,t,r){var i=At(e,e.VERTEX_SHADER,t),n=At(e,e.FRAGMENT_SHADER,r);if(!i||!n)return null;var o=e.createProgram();if(!o)return null;if(e.attachShader(o,i),e.attachShader(o,n),e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS)){var s=e.getProgramInfoLog(o);return console.log("Failed to link program: "+s),e.deleteProgram(o),e.deleteShader(n),e.deleteShader(i),null}return o}(e,t,r);return i?(e.useProgram(i),e.program=i,!0):(console.log("Failed to create program"),!1)}(this.gl,t.VSHADER,t.FSHADER))if(this.initVertexBuffers(this.gl)<0)this.log.warn("Failed to initialize shaders");else{var r=[];this.video?(this.setupVideo(this.video,"canCopyVideo"),r.push(this.video),this.virtualBackground&&this.virtualBackgroundMix&&r.push(this.virtualBackground),r.forEach((function(t,r){var i=e.initTextures(e.gl,r);i?e.textures.push(i):e.log.warn("Failed to initialize texture")})),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.render()):this.log.warn("Failed to get video")}else this.log.warn("Failed to initialize shaders")}else this.log.warn("Failed to get the rendering context for webgl")}},{key:"stop",value:function(){this.canCopyVideo=!1,this.canCopyBackground=!1,this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=null,this.virtualBackground=null,this.virtualBackgroundMix=!1,this.isEleLisenter&&this.observer.unobserve(this.div),this.canvas.remove(),delete this.canvas,delete this.gl}},{key:"unmute",value:function(){this.render()}},{key:"mute",value:function(){this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=null,this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.canvas.style.backgroundImage=""}},{key:"render",value:function(){var e,t,r=this,i=Date.now();!function n(){var o=r.track.getSettings();r.frameRate=o.frameRate||15;var s=1e3/r.frameRate;r.rafId&&cancelAnimationFrame(r.rafId),r.rafId=requestAnimationFrame(n),e=Date.now(),(t=e-i)>s&&(i=e-t/s,r.canCopyVideo&&(r.updateTexture(r.gl,r.textures[0],r.video),r.setCanvasBgImage(),r.canUpdateBackground()&&r.updateTexture(r.gl,r.textures[1],r.virtualBackground)),r.gl.clear(r.gl.COLOR_BUFFER_BIT),r.gl.viewport(0,0,r.canvas.width,r.canvas.height),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4))}()}},{key:"initVirtualBackground",value:function(e){if(e){if("IMG"===e.nodeName){var t=new Image;t.src=e.src,this.virtualBackground=t}else if("VIDEO"===e.nodeName){var r=document.createElement("video");r.playsInline=!0,r.muted=!0,r.loop=!0,r.src=e.src,r.play(),this.virtualBackground=r,this.setupVideo(this.video,"canCopyBackground")}}else this.virtualBackground=null}},{key:"initCanvas",value:function(){this.canvas=document.createElement("canvas"),this.canvas?(this.canvas.width=this.div.clientWidth,this.canvas.height=this.div.clientHeight,this.canvas.style.objectFit=this.video.style.objectFit,this.canvas.style.width="100%",this.canvas.style.height="100%",this.isEleLisenter&&this.addDivListener(),this.div.appendChild(this.canvas)):this.log.warn("Failed to retrieve the <canvas> element")}},{key:"resize",value:function(){var e=this.canvas.width,t=this.div.clientHeight,r=this.div.clientWidth;t!==this.canvas.height&&(this.canvas.height=t),r!==e&&(this.canvas.width=r)}},{key:"addDivListener",value:function(){this.observer=new ResizeObserver(this.resize.bind(this)),this.observer.observe(this.div)}},{key:"setCanvasBgImage",value:function(){this.canvas.style.backgroundImage||this.virtualBackground&&!this.virtualBackgroundMix&&(this.canvas.style.backgroundImage="url(".concat(this.virtualBackground.src,")"),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="cover")}},{key:"setupVideo",value:function(e,t){var r=this,i=!1,n=!1;e.addEventListener("playing",(function(){i=!0,o()}),!0),e.addEventListener("timeupdate",(function(){n=!0,o()}),!0);var o=function(){i&&n&&(r[t]=!0)}}},{key:"canUpdateBackground",value:function(){return!(!this.virtualBackground||!this.virtualBackgroundMix)&&("IMG"===this.virtualBackground.nodeName?this.virtualBackground.complete:this.canCopyBackground)}},{key:"initVertexBuffers",value:function(e){var t=new Float32Array([-1,1,0,1,-1,-1,0,0,1,1,1,1,1,-1,1,0]),r=t.BYTES_PER_ELEMENT,i=e.createBuffer();if(!i)return this.log.warn("Failed to create vertex buffer"),-1;e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW);var n=e.getAttribLocation(e.program,"a_Position");if(n<0)return this.log.warn("Failed to get the storage location of a_Position"),-1;e.vertexAttribPointer(n,2,e.FLOAT,!1,4*r,0),e.enableVertexAttribArray(n);var o=e.getAttribLocation(e.program,"a_TexCoord");return o<0?(this.log.warn("Failed to get the storage location of a_TexCoord"),-1):(e.vertexAttribPointer(o,2,e.FLOAT,!1,4*r,2*r),e.enableVertexAttribArray(o),4)}},{key:"initTextures",value:function(e,t){var r,i,n=e.createTexture();if(!n)return this.log.warn("Failed to create the texture object"),null;if(0===t){if(!(r=e.getUniformLocation(e.program,"u_Sampler0")))return this.log.warn("Failed to get the storage location of u_Sampler"),null}else if(!(i=e.getUniformLocation(e.program,"u_Sampler1")))return this.log.warn("Failed to get the storage location of u_Sampler"),null;return e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.activeTexture(0===t?e.TEXTURE0:e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),0===t?e.uniform1i(r,0):e.uniform1i(i,1),n}},{key:"updateTexture",value:function(e,t,r){var i=e.RGBA,n=e.RGBA,o=e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,i,n,o,r)}},{key:"initXShaderSource",value:function(){return{VSHADER:"attribute vec4 a_Position;\nattribute vec2 a_TexCoord;\nvarying vec2 v_TexCoord;\nvoid main() {\ngl_Position = a_Position;\nv_TexCoord = a_TexCoord;\n}\n",FSHADER:this.virtualBackground&&this.virtualBackgroundMix?"precision mediump float;\nuniform sampler2D u_Sampler0;\nuniform sampler2D u_Sampler1;\nvarying vec2 v_TexCoord;\nvoid main() {\nvec2 true_pixel_coord = vec2(v_TexCoord.x, (0.5 + (v_TexCoord.y / 2.))); \nvec2 mask_pexel_coord = vec2(v_TexCoord.x, v_TexCoord.y / 2.); \nfloat alpha = texture2D(u_Sampler0, mask_pexel_coord).r; \nvec3 rgb = texture2D(u_Sampler0, true_pixel_coord).rgb*alpha;\nvec4 videoColor = vec4(rgb, alpha);\nvec4 imgColor = vec4(texture2D(u_Sampler1, v_TexCoord).rgb*(1.0-alpha),1.0-alpha);\ngl_FragColor = imgColor + videoColor;\n}\n":"precision mediump float;\nuniform sampler2D u_Sampler0;\nvarying vec2 v_TexCoord;\nvoid main() {\nvec2 true_pixel_coord = vec2(v_TexCoord.x, (0.5 + (v_TexCoord.y / 2.))); \nvec2 mask_pexel_coord = vec2(v_TexCoord.x, v_TexCoord.y / 2.); \nfloat alpha = texture2D(u_Sampler0, mask_pexel_coord).r; \nvec3 rgb = texture2D(u_Sampler0, true_pixel_coord).rgb*alpha;\nvec4 videoColor = vec4(rgb, alpha);\ngl_FragColor = videoColor;\n}\n"}}}]),e}(),Lt=function(){function e(t){tt(this,e),this.stream=t.stream,this.userId=t.stream.userId,this.log=t.stream.logger,this.track=t.track,this.div=t.div,this.muted=t.muted,this.objectFit=t.objectFit,this.mirror=t.mirror,this.element=null,this.state="NONE",this.pausedRetryCount=5,this.isEleLisenter=t.isEleLisenter,this._emitter=new st,this.handleEleEventPlaying=this.eleEventPlaying.bind(this),this.handleEleEventEnded=this.eleEventEnded.bind(this),this.handleEleEventPause=this.eleEventPause.bind(this),this.handleTrackEventEnded=this.trackEventEnded.bind(this),this.handleTrackEventMute=this.trackEventMute.bind(this),this.handleTrackEventUnmute=this.trackEventUnmute.bind(this),this.isAlphaChannels=t.isAlphaChannels||!1,this.virtualBackground=t.virtualBackground,this.virtualBackgroundMix=t.virtualBackgroundMix,this.initializeElement(),this.isAlphaChannels&&this.startTexturesPlayer()}var t;return it(e,[{key:"initializeElement",value:function(){var e=new MediaStream;e.addTrack(this.track);var t=document.createElement("video");t.srcObject=e,t.muted=!0;var r="width: 100%; height: 100%; object-fit: ".concat(this.objectFit,";");this.mirror&&(r+="transform: rotateY(180deg);"),t.setAttribute("id","video_".concat(this.stream.getId(),"_").concat(Date.now())),t.setAttribute("style",r),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),this.div.style.lineHeight="0",this.div.appendChild(t),this.element=t,this.handleEvents()}},{key:"play",value:(t=Ze(ot.mark((function e(){var t=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){t.element.play().then((function(){t.element.pause(),e()})).catch((function(e){r(e)}))})));case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"handleEvents",value:function(){var e,t,r;null===(e=this.element)||void 0===e||e.addEventListener("playing",this.handleEleEventPlaying),null===(t=this.element)||void 0===t||t.addEventListener("ended",this.handleEleEventEnded),null===(r=this.element)||void 0===r||r.addEventListener("pause",this.handleEleEventPause),this.trackHandleEvents()}},{key:"trackHandleEvents",value:function(){var e,t,r;null===(e=this.track)||void 0===e||e.addEventListener("ended",this.handleTrackEventEnded),null===(t=this.track)||void 0===t||t.addEventListener("mute",this.handleTrackEventMute),null===(r=this.track)||void 0===r||r.addEventListener("unmute",this.handleTrackEventUnmute)}},{key:"trackRemoveEvents",value:function(){var e,t,r;null===(e=this.track)||void 0===e||e.removeEventListener("ended",this.handleTrackEventEnded),null===(t=this.track)||void 0===t||t.removeEventListener("mute",this.handleTrackEventMute),null===(r=this.track)||void 0===r||r.removeEventListener("unmute",this.handleTrackEventUnmute)}},{key:"removeEvents",value:function(){var e,t,r;null===(e=this.element)||void 0===e||e.removeEventListener("playing",this.handleEleEventPlaying),null===(t=this.element)||void 0===t||t.removeEventListener("ended",this.handleEleEventEnded),null===(r=this.element)||void 0===r||r.removeEventListener("pause",this.handleEleEventPause),this.trackRemoveEvents()}},{key:"stop",value:function(){this.removeEvents(),this.div.removeChild(this.element),this.element.srcObject=null,this.element=null,this.isAlphaChannels&&this.texturesPlayer.stop(),this.isAlphaChannels=!1}},{key:"resume",value:function(){var e;return null===(e=this.element)||void 0===e?void 0:e.play()}},{key:"getVideoFrame",value:function(){var e,t,r=document.createElement("canvas");r.width=null===(e=this.element)||void 0===e?void 0:e.videoWidth,r.height=null===(t=this.element)||void 0===t?void 0:t.videoHeight;var i=null;return this.isAlphaChannels?(i=this.texturesPlayer.canvas,r.height=r.height/2,r.getContext("2d").drawImage(i,0,0,i.width,i.height,0,0,r.width,r.height)):(i=this.element,r.getContext("2d").drawImage(i,0,0)),r.toDataURL("image/png")}},{key:"getVideoElement",value:function(){return this.element}},{key:"setVideoTrack",value:function(e){this.trackRemoveEvents();var t=new MediaStream;t.addTrack(e),this.track=e,this.trackHandleEvents(),this.log.info("setVideoTrack",e),this.element&&(this.element.srcObject=t,this.element.play())}},{key:"unmute",value:function(){this.isAlphaChannels&&this.texturesPlayer.unmute()}},{key:"mute",value:function(){this.isAlphaChannels&&this.texturesPlayer.mute()}},{key:"startTexturesPlayer",value:function(){this.element.style.position="absolute",this.element.style.width="0",this.element.style.height="0",this.element.style.zIndex="-1",this.texturesPlayer=new Pt({div:this.div,video:this.element,track:this.track,virtualBackground:this.virtualBackground,virtualBackgroundMix:this.virtualBackgroundMix,isEleLisenter:this.isEleLisenter},this.log),this.texturesPlayer.play()}},{key:"resize",value:function(){this.texturesPlayer.resize()}},{key:"eleEventPlaying",value:function(){this.log.info("stream ".concat(this.userId," - video player is starting playing")),this.state="PLAYING",this._emitter.emit("player-state-changed",{state:this.state,reason:"playing"})}},{key:"eleEventEnded",value:function(){this.log.info("stream ".concat(this.userId," - video player is ended")),"STOPPED"!==this.state&&(this.state="STOPPED",this._emitter.emit("player-state-changed",{state:this.state,reason:"ended"}))}},{key:"eleEventPause",value:function(){this.log.info("stream ".concat(this.userId," - video player is paused")),this.state="PAUSED",this._emitter.emit("player-state-changed",{state:this.state,reason:"pause"}),this.div&&document.getElementById(this.div.id)?this.pausedRetryCount>0&&(this.log.info("auto resume when video paused"),this.resume(),this.pausedRetryCount--):this.log.warn("video container is not in DOM")}},{key:"trackEventEnded",value:function(){this.log.info("stream ".concat(this.userId," - video player track is ended")),"STOPPED"!==this.state&&(this.state="STOPPED",this._emitter.emit("player-state-changed",{state:this.state,reason:"ended",type:"track"}))}},{key:"trackEventMute",value:function(){this.log.info("stream ".concat(this.userId," - video track is muted")),"PAUSED"!==this.state&&(this.state="PAUSED",this._emitter.emit("player-state-changed",{state:this.state,reason:"mute",type:"track"}))}},{key:"trackEventUnmute",value:function(){this.log.info("stream ".concat(this.userId," - video track is unmuted")),"PAUSED"===this.state&&(this.state="PLAYING",this._emitter.emit("player-state-changed",{state:this.state,reason:"unmute",type:"track"}))}}]),e}();function xt(){var e=navigator.userAgent,t=navigator.connection,r=e.match(/NetType\/\w+/)?e.match(/NetType\/\w+/)[0]:"";"3gnet"===(r=r.toLowerCase().replace("nettype/",""))&&(r="3g");var i=t&&t.type&&t.type.toLowerCase(),n=t&&t.effectiveType&&t.effectiveType.toLowerCase();"slow-2"===n&&(n="2g");var o=r||"unknown";if(i)switch(i){case"cellular":case"wimax":o=n||"unknown";break;case"wifi":o="wifi";break;case"ethernet":o="wired";break;case"none":case"other":case"unknown":o="unknown"}return o}var Dt={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry|BB10/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},specil:function(){return navigator.userAgent.match(/MicroMessenger/i)},any:function(){return Dt.Android()||Dt.BlackBerry()||Dt.iOS()||Dt.Opera()||Dt.Windows()},getOsName:function(){var e="Unknown OS";return Dt.Android()&&(e="Android"),Dt.BlackBerry()&&(e="BlackBerry"),Dt.iOS()&&(e="iOS"),Dt.Opera()&&(e="Opera Mini"),Dt.Windows()&&(e="Windows"),{osName:e,type:"mobile"}}};function Mt(){var e,t,r=navigator.userAgent.toLocaleLowerCase();if(-1!=r.indexOf("firefox"))e="Firefox";else if(-1!=r.indexOf("trident"))e="IE",-1==r.indexOf("ie")&&(t=11);else if(-1!=r.indexOf("opr"))e="OPR";else if(-1!=r.indexOf("edge"))e="Edge";else if(-1!=r.indexOf("chrome"))e="Chrome";else if(-1!=r.indexOf("safari")){e="Safari";var i=r.match(/(version).*?([\d.]+)/);t=i?i[2]:""}else e="未知浏览器";if(void 0===t){var n=r.match(/(firefox|trident|opr|chrome|safari).*?([\d.]+)/);t=n?n[2]:""}return{browser:e,version:t}}var Ut,Nt,Vt,jt,Ft,Bt,Wt,Gt,Ht,$t,zt,Jt,Yt,Kt,qt=Mt(),Xt=qt.browser,Qt=qt.version;function Zt(e){switch(e){case Gt.ForwardStream:return"forward";case Gt.MixedStream:return"mixed"}return""}function er(e){return"forward"==e?Gt.ForwardStream:"mixed"==e?Gt.MixedStream:Gt.Invalid}function tr(e){switch(e){case zt.Microphone:return"mic";case zt.ScreenShare:return"screen";case zt.File:return"file"}return""}function rr(e){return"mic"==e?zt.Microphone:"screen"==e?zt.ScreenShare:"file"==e?zt.File:zt.Unknown}function ir(e){switch(e){case Jt.Camera:return"camera";case Jt.ScreenShare:return"screen";case Jt.File:return"file"}return""}function nr(e){return"camera"==e?Jt.Camera:"screen"==e?Jt.ScreenShare:"file"==e?Jt.File:Jt.Unknown}function or(e){switch(e){case Yt.BigStream:return"h";case Yt.MiddleStream:return"m";case Yt.SmallStream:return"l"}return""}function sr(e){return"h"==e?Yt.BigStream:"m"==e?Yt.MiddleStream:"l"==e?Yt.SmallStream:Yt.Invalid}!function(e){e[e.Failed=0]="Failed",e[e.Success=1]="Success",e[e.Timeout=2]="Timeout"}(Ut||(Ut={})),function(e){e[e.Unknown=0]="Unknown",e[e.ActivelyLeave=1]="ActivelyLeave",e[e.RoomDissolved=2]="RoomDissolved",e[e.RepeatLogin=3]="RepeatLogin"}(Nt||(Nt={})),function(e){e[e.Normal=0]="Normal",e[e.Timeout=1]="Timeout",e[e.Kick=2]="Kick",e[e.RepeatLogin=3]="RepeatLogin",e[e.RoomDissolved=4]="RoomDissolved"}(Vt||(Vt={})),function(e){e[e.Unknown=0]="Unknown",e[e.Kicked=1]="Kicked",e[e.RepeatLogin=2]="RepeatLogin",e[e.RoomDissolved=3]="RoomDissolved"}(jt||(jt={})),function(e){e[e.New=0]="New",e[e.ConnectionConnected=1]="ConnectionConnected",e[e.ConnectionLost=2]="ConnectionLost",e[e.ConnectionRetring=3]="ConnectionRetring",e[e.ConnectionRecovery=4]="ConnectionRecovery"}(Ft||(Ft={})),function(e){e[e.ParticipantJoin=0]="ParticipantJoin",e[e.ParticipantLeave=1]="ParticipantLeave",e[e.StreamAdd=2]="StreamAdd",e[e.StreamUpdate=3]="StreamUpdate",e[e.StreamRemove=4]="StreamRemove",e[e.Drop=5]="Drop",e[e.PermissionChange=6]="PermissionChange",e[e.MuteLocal=7]="MuteLocal"}(Bt||(Bt={})),function(e){e[e.AudioMute=0]="AudioMute",e[e.VideoMute=1]="VideoMute",e[e.AudioUnmute=2]="AudioUnmute",e[e.VideoUnmute=3]="VideoUnmute",e[e.Kick=4]="Kick"}(Wt||(Wt={})),function(e){e[e.Invalid=0]="Invalid",e[e.ForwardStream=1]="ForwardStream",e[e.MixedStream=2]="MixedStream"}(Gt||(Gt={})),function(e){e[e.Invalid=0]="Invalid",e[e.AudioOnly=1]="AudioOnly",e[e.VideoOnly=2]="VideoOnly",e[e.AudioVideo=3]="AudioVideo"}(Ht||(Ht={})),function(e){e[e.Normal=0]="Normal",e[e.Shadow=1]="Shadow"}($t||($t={})),function(e){e[e.Unknown=0]="Unknown",e[e.Microphone=1]="Microphone",e[e.ScreenShare=2]="ScreenShare",e[e.File=3]="File"}(zt||(zt={})),function(e){e[e.Unknown=0]="Unknown",e[e.Camera=1]="Camera",e[e.ScreenShare=2]="ScreenShare",e[e.File=3]="File"}(Jt||(Jt={})),function(e){e[e.Invalid=0]="Invalid",e[e.BigStream=1]="BigStream",e[e.MiddleStream=2]="MiddleStream",e[e.SmallStream=3]="SmallStream"}(Yt||(Yt={})),function(e){e[e.Amute=0]="Amute",e[e.Aunmute=1]="Aunmute",e[e.Vmute=2]="Vmute",e[e.Vunmute=3]="Vunmute"}(Kt||(Kt={}));var ar={TOP_ERROR:8801,SET_LOG_LEVEL:3001,ENABLE_UPLOAD_LOG:3002,DISABLE_UPLOAD_LOG:3003,JOIN:3004,JOIN_FIRST:8001,JOIN_SUCCESS:1103,JOIN_FAILED:1104,LEAVE:3007,LEAVE_SUCCESS:3008,LEAVE_FAILED:3009,SWITCH_ROLE_ANCHOR:3010,SWITCH_ROLE_AUDIENCE:3011,SWITCH_ROLE_ANCHOR_SUCCESS:3012,SWITCH_ROLE_ANCHOR_FAILED:3013,SWITCH_ROLE_AUDIENCE_SUCCESS:3014,SWITCH_ROLE_AUDIENCE_FAILED:3015,PUBLISH_STREAM:3016,PUBLISH_STREAM_SCREEN:3017,PUBLISH_STREAM_SUCCESS:3018,PUBLISH_STREAM_FAILED:3019,PUBLISH_STREAM_SCREEN_SUCCESS:3020,PUBLISH_STREAM_SCREEN_FAILED:3021,UNPUBLISH_STREAM:3022,UNPUBLISH_STREAM_SCREEN:3023,UNPUBLISH_STREAM_SUCCESS:3024,UNPUBLISH_STREAM_FAILED:3025,UNPUBLISH_STREAM_SCREEN_SUCCESS:3026,UNPUBLISH_STREAM_SCREEN_FAILED:3027,SUBSCRIBE_STREAM:3028,SUBSCRIBE_STREAM_SCREEN:3029,SUBSCRIBE_STREAM_SUCCESS:3030,SUBSCRIBE_STREAM_FAILED:3031,SUBSCRIBE_STREAM_SCREEN_SUCCESS:3032,SUBSCRIBE_STREAM_SCREEN_FAILED:3033,UNSUBSCRIBE_STREAM:3034,UNSUBSCRIBE_STREAM_SCREEN:3035,UNSUBSCRIBE_STREAM_SUCCESS:3036,UNSUBSCRIBE_STREAM_FAILED:3037,UNSUBSCRIBE_STREAM_SCREEN_SUCCESS:3038,UNSUBSCRIBE_STREAM_SCREEN_FAILED:3039,HAS_PUBLISHED_STREAM:3040,GET_CLIENT_STATE:3041,GET_REMOTE_MUTED_STATE:3042,ENABLE_AUDIO_VOLUME_EVALUATION:3043,ENABLE_SMALL_STREAM:3044,DISABLE_SMALL_STREAM:3045,SET_SMALL_STREAM_PROFILE:3046,SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL:3047,SET_REMOTE_VIDEO_STREAM_TYPE_BIG:3048,SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL_SUCCESS:3049,SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL_FAILED:3050,SET_REMOTE_VIDEO_STREAM_TYPE_BIG_SUCCESSE:3051,SET_REMOTE_VIDEO_STREAM_TYPE_BIG_FAILED:3052,UPDATE_SIMULCAST:3053,UPDATE_SIMULCAST_SUCCESSE:3054,UPDATE_SIMULCAST_FAILED:3055,PLAY_LOCAL_VIDEO:3056,PLAY_LOCAL_AUDIO:3057,PLAY_LOCAL_VIDEO_SCREEN:3058,PLAY_LOCAL_AUDIO_SCREEN:3059,PLAY_REMOTE_VIDEO:3060,PLAY_REMOTE_AUDIO:3061,PLAY_REMOTE_VIDEO_SCREEN:3062,PLAY_REMOTE_AUDIO_SCREEN:3063,STOP_LOCAL_VIDEO:3064,STOP_LOCAL_AUDIO:3065,STOP_LOCAL_VIDEO_SCREEN:3066,STOP_LOCAL_AUDIO_SCREEN:3067,STOP_REMOTE_VIDEO:3068,STOP_REMOTE_AUDIO:3069,STOP_REMOTE_VIDEO_SCREEN:3070,STOP_REMOTE_AUDIO_SCREEN:3071,RESUME_LOCAL_VIDEO:3072,RESUME_LOCAL_AUDIO:3073,RESUME_LOCAL_VIDEO_SCREEN:3074,RESUME_LOCAL_AUDIO_SCREEN:3075,RESUME_REMOTE_VIDEO:3076,RESUME_REMOTE_AUDIO:3077,RESUME_REMOTE_VIDEO_SCREEN:3078,RESUME_REMOTE_AUDIO_SCREEN:3079,CLOSE_LOCAL_VIDEO:3080,CLOSE_LOCAL_AUDIO:3081,CLOSE_LOCAL_VIDEO_SCREEN:3082,CLOSE_LOCAL_AUDIO_SCREEN:3083,CLOSE_REMOTE_VIDEO:3084,CLOSE_REMOTE_AUDIO:3085,CLOSE_REMOTE_VIDEO_SCREEN:3086,CLOSE_REMOTE_AUDIO_SCREEN:3087,MUTE_LOCAL_AUDIO:3088,MUTE_LOCAL_AUDIO_SCREEN:3089,MUTE_REMOTE_AUDIO:3090,MUTE_REMOTE_AUDIO_SCREEN:3091,MUTE_LOCAL_VIDEO:3092,MUTE_LOCAL_VIDEO_SCREEN:3093,MUTE_REMOTE_VIDEO:3094,MUTE_REMOTE_VIDEO_SCREEN:3095,UNMUTE_LOCAL_AUDIO:3096,UNMUTE_LOCAL_AUDIO_SCREEN:3097,UNMUTE_REMOTE_AUDIO:3098,UNMUTE_REMOTE_AUDIO_SCREEN:3099,UNMUTE_LOCAL_VIDEO:3100,UNMUTE_LOCAL_VIDEO_SCREEN:3101,UNMUTE_REMOTE_VIDEO:3102,UNMUTE_REMOTE_VIDEO_SCREEN:3103,GET_LOCAL_ID:3104,GET_REMOTE_ID:3105,GET_LOCAL_USER_ID:3106,GET_REMOTE_USER_ID:3107,SET_AUDIO_OUTPUT:3108,SET_LOCAL_AUDIO_VOLUME:3109,SET_LOCAL_AUDIO_VOLUME_SCREEN:3110,SET_REMOTE_AUDIO_VOLUME:3111,SET_REMOTE_AUDIO_VOLUME_SCREEN:3112,GET_LOCAL_AUDIO_LEVEL:3113,GET_LOCAL_AUDIO_LEVEL_SCREEN:3114,GET_REMOTE_AUDIO_LEVEL:3115,GET_REMOTE_AUDIO_LEVEL_SCREEN:3116,HAS_LOCAL_AUDIO:3117,HAS_LOCAL_AUDIO_SCREEN:3118,HAS_REMOTE_AUDIO:3119,HAS_REMOTE_AUDIO_SCREEN:3120,HAS_LOCAL_VIDEO:3121,HAS_LOCAL_VIDEO_SCREEN:3122,HAS_REMOTE_VIDEO:3123,HAS_REMOTE_VIDEO_SCREEN:3124,GET_LCOAL_AUDIO_TRACK:3125,GET_LCOAL_AUDIO_TRACK_SCREEN:3126,GET_REMOTE_AUDIO_TRACK:3127,GET_REMOTE_AUDIO_TRACK_SCREEN:3128,GET_LCOAL_VIDEO_TRACK:3129,GET_LCOAL_VIDEO_TRACK_SCREEN:3130,GET_REMOTE_VIDEO_TRACK:3131,GET_REMOTE_VIDEO_TRACK_SCREEN:3132,GET_LCOAL_VIDEO_FRAME:3133,GET_LCOAL_VIDEO_FRAME_SCREEN:3134,GET_REMOTE_VIDEO_FRAME:3135,GET_REMOTE_VIDEO_FRAME_SCREEN:3136,GET_LCOAL_TYPE:3137,GET_REMOTE_TYPE:3138,GET_LOCAL_AUDIO_ELEMENT:3139,GET_LOCAL_AUDIO_ELEMENT_SCREEN:3140,GET_REMOTE_AUDIO_ELEMENT:3141,GET_REMOTE_AUDIO_ELEMENT_SCREEN:3142,GET_LOCAL_VIDEO_ELEMENT:3143,GET_LOCAL_VIDEO_ELEMENT_SCREEN:3144,GET_REMOTE_VIDEO_ELEMENT:3145,GET_REMOTE_VIDEO_ELEMENT_SCREEN:3146,SET_AUDIO_PROFILE:3147,SET_VIDEO_PROFILE:3148,SET_SCREEN_PROFILE:3149,SET_VIDEO_CONTENT_HINT:3150,SWITCH_DEVICE_AUDIO:3151,SWITCH_DEVICE_VIDEO:3152,ADD_AUDIO_TRACK:3153,ADD_AUDIO_TRACK_SCREEN:3154,ADD_VIDEO_TRACK:3155,ADD_VIDEO_TRACK_SCREEN:3156,REMOVE_TRACK:3157,REMOVE_TRACK_SCREEN:3158,REPLACE_AUDIO_TRACK:3159,REPLACE_AUDIO_TRACK_SCREEN:3160,REPLACE_VIDEO_TRACK:3161,REPLACE_VIDEO_TRACK_SCREEN:3162,GET_DEVICES_INFO_IN_USE:3163,ON_STREAM_ADDED:3164,ON_STREAM_ADDED_SCREEN:3165,ON_STREAM_REMOVED:3166,ON_STREAM_REMOVED_SCREEN:3167,ON_STREAM_UPDATED:3168,ON_STREAM_UPDATED_SCREEN:3169,ON_STREAM_SUBSCRIBED:3170,ON_STREAM_SUBSCRIBED_SCREEN:3171,ON_PEER_JOIN:3172,ON_PEER_LEVAE:3173,ON_MUTE_AUDIO:3174,ON_MUTE_AUDIO_SCREEN:3175,ON_MUTE_VIDEO:3176,ON_MUTE_VIDEO_SCREEN:3177,ON_UNMUTE_AUDIO:3178,ON_UNMUTE_AUDIO_SCREEN:3179,ON_UNMUTE_VIDEO:3180,ON_UNMUTE_VIDEO_SCREEN:3181,ON_CLIENT_BANNED:3182,ON_CAMERA_CHANGED:3183,ON_RECORDING_DEVICE_CHANGED:3184,ON_PLAYBACK_DEVICE_CHANGED:3185,ON_ERROR:3186,OFF_STREAM_ADDED:3187,OFF_STREAM_REMOVED:3188,OFF_STREAM_UPDATED:3189,OFF_STREAM_SUBSCRIBED:3190,OFF_CONNECTION_STATE_CHANGED:3191,OFF_PEER_JOIN:3192,OFF_PEER_LEVAE:3193,OFF_MUTE_AUDIO:3194,OFF_MUTE_VIDEO:3195,OFF_UNMUTE_VIDEO:3196,OFF_CLIENT_BANNED:3197,OFF_CAMERA_CHANGED:3198,OFF_RECORDING_DEVICE_CHANGED:3199,OFF_PLAYBACK_DEVICE_CHANGED:3200,OFF_NETWORK_QUALITY:3201,OFF_AUDIO_VOLUME:3202,OFF_ERROR:3203,ON_PLAYER_STATE_CHANGED:3204,ON_SCREEN_SHARING_STOPPED:3205,ON_STREAM_ERROR:3206,CONNECTIONLOST_CB:3207,TRY_TO_RECONNECT_CB:3208,CONNECTION_RECOVERY_CB:3209},cr={VUBIT:2001,VDBIT:2002,AUBIT:2003,ADBIT:2004,VULOSS:2005,VDLOSS:2006,AULOSS:2007,ADLOSS:2008,VURTT:2009,VDRTT:2010,AURTT:2011,ADRTT:2012,VUFPS:2013,VDFPS:2014,AUFPS:2015,ADFPS:2016,VUBLOCK:2017,VDBLOCK:2018,AUBLOCK:2019,ADBLOCK:2020,VUWIDTHHEIGHT:2021,VDWIDTHHEIGHT:2022,APPCPU:2023,SYSCPU:2024};function ur(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function dr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ur(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ur(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var lr=dr(dr({},ar),cr);function hr(){var e,t,r=navigator.userAgent.toLocaleLowerCase();if(-1!=r.indexOf("firefox"))e="Firefox";else if(-1!=r.indexOf("trident"))e="IE",-1==r.indexOf("ie")&&(t=11);else if(-1!=r.indexOf("opr"))e="OPR";else if(-1!=r.indexOf("edge"))e="Edge";else if(-1!=r.indexOf("chrome"))e="Chrome";else if(-1!=r.indexOf("safari")){var i;e="Safari",i=(i=r.indexOf("version"))+7+1,t=parseInt(r.slice(i,i+3))}else e="未知浏览器";return void 0===t&&(i=(i=r.indexOf(e.toLocaleLowerCase()))+e.length+1,t=parseInt(r.slice(i,i+3))),{browser:e,version:t}}function pr(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter((function(e){return e in window})).length>0}function fr(){var e=function(){var e=hr(),t=e.browser,r=e.version;return"Chrome"===t?r>=74:"Edge"===t?r>=80:"Firefox"===t?r>=66:"OPR"===t?r>=60:"Safari"===t&&r>=13}(),t=pr(),r=function(){if(!navigator.mediaDevices)return!1;var e=["getUserMedia","enumerateDevices"];return e.filter((function(e){return e in navigator.mediaDevices})).length===e.length}();return new Promise((function(i,n){new Promise((function(e,t){if(pr()){var r=new RTCPeerConnection;r.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then((function(t){var i=!!t.sdp&&t.sdp.toLowerCase().indexOf("h264")>-1;r.close(),r=null,e(i)}),(function(){Logger.onError({c:lr.TOP_ERROR,v:gt.H264_NOT_SUPPORTED}),t(new It({code:gt.H264_NOT_SUPPORTED,message:"h264 not supported"}))})).catch((function(e){Logger.onError({c:lr.TOP_ERROR,v:gt.H264_NOT_SUPPORTED});var r=new It({code:gt.H264_NOT_SUPPORTED,message:e.message});t(r)}))}else e(!1)})).then((function(n){i({result:e&&t&&r&&n,detail:{isBrowserSupported:e,isWebRTCSupported:t,isMediaDevicesSupported:r,isH264Supported:n}})}),(function(e){return n(e)}))}))}function mr(){if(!navigator.mediaDevices)throw Logger.onError({c:lr.TOP_ERROR,v:gt.DEVICE_NOT_FOUND}),new It({code:gt.DEVICE_NOT_FOUND,message:"navigator.mediaDevices is undefined"});return new Promise((function(e,t){navigator.mediaDevices.enumerateDevices().then((function(t){var r=t.filter((function(e){return"audioinput"!==e.kind||"communications"!=e.deviceId})).map((function(e,t){var r=e.label;e.label||(r=e.kind+"_"+t);var i={label:r,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(i.groupId=e.groupId),i}));e(r)}),(function(e){t(e)})).catch((function(e){Logger.onError({c:lr.TOP_ERROR,v:gt.DEVICE_NOT_FOUND});var r=new It({code:gt.DEVICE_NOT_FOUND,message:e.message});t(r)}))}))}function gr(){if(!navigator.mediaDevices)throw Logger.onError({c:lr.TOP_ERROR,v:gt.CAMERAS_NOT_FOUND}),new It({code:gt.CAMERAS_NOT_FOUND,message:"navigator.mediaDevices is undefined"});return new Promise((function(e,t){navigator.mediaDevices.enumerateDevices().then((function(t){var r=t.filter((function(e){return"videoinput"===e.kind})).map((function(e,t){var r=e.label;e.label||(r="camera_"+t);var i={label:r,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(i.groupId=e.groupId),i}));e(r)}),(function(e){t(e)})).catch((function(e){Logger.onError({c:lr.TOP_ERROR,v:gt.CAMERAS_NOT_FOUND});var r=new It({code:gt.CAMERAS_NOT_FOUND,message:e.message});t(r)}))}))}function vr(){if(!navigator.mediaDevices)throw Logger.onError({c:lr.TOP_ERROR,v:gt.MICROPHONES_NOT_FOUND}),new It({code:gt.MICROPHONES_NOT_FOUND,message:"navigator.mediaDevices is undefined"});return new Promise((function(e,t){navigator.mediaDevices.enumerateDevices().then((function(t){var r=t.filter((function(e){return"audioinput"===e.kind&&"communications"!==e.deviceId})).map((function(e,t){var r=e.label;e.label||(r="microphone_"+t);var i={label:r,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(i.groupId=e.groupId),i}));e(r)}),(function(e){t(e)})).catch((function(e){var r=new It({code:gt.MICROPHONES_NOT_FOUND,message:e.message});t(r)}))}))}function yr(){if(!navigator.mediaDevices)throw Logger.onError({c:lr.TOP_ERROR,v:gt.SPEAKERS_NOT_FOUND}),new It({code:gt.SPEAKERS_NOT_FOUND,message:"navigator.mediaDevices is undefined"});return new Promise((function(e,t){navigator.mediaDevices.enumerateDevices().then((function(t){var r=t.filter((function(e){return"audiooutput"===e.kind})).map((function(e,t){var r=e.label;e.label||(r="speaker_"+t);var i={label:r,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(i.groupId=e.groupId),i}));e(r)}),(function(e){t(e)})).catch((function(e){Logger.onError({c:lr.TOP_ERROR,v:gt.SPEAKERS_NOT_FOUND});var r=new It({code:gt.SPEAKERS_NOT_FOUND,message:e.message});t(r)}))}))}function br(){return!!("captureStream"in HTMLCanvasElement.prototype)}function Sr(){return"Safari"!==hr().browser}var Er=function(){function e(t,r,i,n){tt(this,e),this.logger=r,this.streamConfig=t,this.streamId=t.streamId||null,this.mediaStream=t.mediaStream||null,this.type=t.type?t.type:t.screen?ht:null,this.info=t.info||null,this.mixedInfo=t.mixedInfo||null,this.constraints={audio:t.audio,video:t.video},this.roomId=i||null,this.xsigoClient=n||null,this.isPlaying=!1,this.objectFit="cover",this.muted=!1,this.mirror=t.mirror||!1,this.audioPlayer=null,this.videoPlayer=null,this.audioOutputDeviceId="",this.audioOutputGroupId="",this.audioVolume=1,this.isRemote=!1,this.setUserId(t.userId),this.timer=null,this.waterStreamStream=null,this.waterMarkoptions=null,this.waterMarkVideo=null,this.isWaterMark=!1,this.localId="default",this._emitter=new st,this.hasAudioTrack=!1,this.hasVideoTrack=!1,this.audioStreamId="",this.videoStreamId="",this.peerConnections=[],this.audioTrackEnabled=!0,this.videoTrackEnabled=!0,this.pcFailedCount=0,this.audioMuted=!0,this.videoMuted=!0,this.backgroundColor="#000000",this.isAlphaChannels=!1,this.virtualBackground=null,this.virtualBackgroundMix=!1,this.waterMarkImage=null,this.isEleLisenter=!0,this.setAudioOutput("default")}var t,r,i,n,o,s;return it(e,[{key:"setPlayBackground",value:function(e){this.backgroundColor=e}},{key:"play",value:(s=Ze(ot.mark((function e(t,r){var i,n,o;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isPlaying){e.next=3;break}return this.logger.warn("duplicated play() call observed, please stop() firstly"),e.abrupt("return");case 3:if(this.isPlaying=!0,this.logger.info("stream start to play with options: ".concat(JSON.stringify(r))),n="string"==typeof t?document.getElementById(t):t,document.getElementById("player_".concat(this.userId))?i=document.getElementById("player_".concat(this.userId)):((i=document.createElement("div")).setAttribute("id","player_".concat(this.userId)),i.setAttribute("style","width: 100%; height: 100%; position: relative; background-color:".concat(this.backgroundColor,"; overflow: hidden;")),null===(o=n)||void 0===o||o.appendChild(i)),this.div=i,this.isRemote||(this.muted=!0),r&&void 0!==r.muted&&(this.muted=r.muted),this.isRemote&&this.info.video&&"screen"===this.info.video.source&&(this.objectFit="contain"),r&&void 0!==r.objectFit&&(this.objectFit=r.objectFit),r&&r.hasOwnProperty("isEleLisenter")&&(this.isEleLisenter=r.isEleLisenter),!this.hasVideo()||!this.hasAudio()){e.next=17;break}return this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.PLAY_REMOTE_VIDEO_SCREEN:lr.PLAY_REMOTE_VIDEO:this.type===ht?lr.PLAY_LOCAL_VIDEO_SCREEN:lr.PLAY_LOCAL_VIDEO,v:this.addUid()}),this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.PLAY_REMOTE_AUDIO_SCREEN:lr.PLAY_REMOTE_AUDIO:this.type===ht?lr.PLAY_LOCAL_AUDIO_SCREEN:lr.PLAY_LOCAL_AUDIO,v:this.addUid()}),e.abrupt("return",(this.playVideo(),this.playAudio()));case 17:if(!this.hasVideo()){e.next=20;break}return this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.PLAY_REMOTE_VIDEO_SCREEN:lr.PLAY_REMOTE_VIDEO:this.type===ht?lr.PLAY_LOCAL_VIDEO_SCREEN:lr.PLAY_LOCAL_VIDEO,v:this.addUid()}),e.abrupt("return",this.playVideo());case 20:if(!this.hasAudio()){e.next=23;break}return this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.PLAY_REMOTE_AUDIO_SCREEN:lr.PLAY_REMOTE_AUDIO:this.type===ht?lr.PLAY_LOCAL_AUDIO_SCREEN:lr.PLAY_LOCAL_AUDIO,v:this.addUid()}),e.abrupt("return",this.playAudio());case 23:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"stop",value:function(){this.logger.info("is playing:"+this.isPlaying),this.isPlaying&&(this.logger.info("Stop playing audio and video"),this.audioPlayer&&this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.STOP_REMOTE_AUDIO_SCREEN:lr.STOP_REMOTE_AUDIO:this.type===ht?lr.STOP_LOCAL_AUDIO_SCREEN:lr.STOP_LOCAL_AUDIO,v:this.addUid()}),this.videoPlayer&&this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.STOP_REMOTE_VIDEO_SCREEN:lr.STOP_REMOTE_VIDEO:this.type===ht?lr.STOP_LOCAL_VIDEO_SCREEN:lr.STOP_LOCAL_VIDEO,v:this.addUid()}),this.isPlaying=!1,this.stopAudio(),this.stopVideo(),this.div.parentNode&&this.div.parentNode.removeChild(this.div))}},{key:"resume",value:(o=Ze(ot.mark((function e(){return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.logger.info("is playing:"+this.isPlaying),this.isPlaying&&(this.logger.info("stream - resume"),this.audioPlayer&&(this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.RESUME_REMOTE_AUDIO_SCREEN:lr.RESUME_REMOTE_AUDIO:this.type===ht?lr.RESUME_LOCAL_AUDIO_SCREEN:lr.RESUME_LOCAL_AUDIO,v:this.addUid()}),this.audioPlayer.resume()),this.videoPlayer&&(this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.RESUME_REMOTE_VIDEO_SCREEN:lr.RESUME_REMOTE_VIDEO:this.type===ht?lr.RESUME_LOCAL_VIDEO_SCREEN:lr.RESUME_LOCAL_VIDEO,v:this.addUid()}),this.videoPlayer.resume()));case 2:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"close",value:function(){this.logger.info("is playing:"+this.isPlaying),this.isPlaying&&this.stop(),this.mediaStream&&(this.mediaStream.getTracks().forEach((function(e){e.stop()})),this.mediaStream=null)}},{key:"muteAudio",value:function(){return!(!this.mediaStream||!this.audioTrackEnabled)&&(this.logger.info("mute audio"),this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.MUTE_REMOTE_AUDIO_SCREEN:lr.MUTE_REMOTE_AUDIO:this.type===ht?lr.MUTE_LOCAL_AUDIO_SCREEN:lr.MUTE_LOCAL_AUDIO,v:this.addUid()}),this.addRemoteEvent(Wt.AudioMute),this.doEnableTrack("audio",!1))}},{key:"muteVideo",value:function(){return!(!this.mediaStream||!this.videoTrackEnabled)&&(this.logger.info("mute video"),this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.MUTE_REMOTE_VIDEO_SCREEN:lr.MUTE_REMOTE_VIDEO:this.type===ht?lr.MUTE_LOCAL_VIDEO_SCREEN:lr.MUTE_LOCAL_VIDEO,v:this.addUid()}),this.isAlphaChannels&&this.videoPlayer.mute(),this.addRemoteEvent(Wt.VideoMute),this.doEnableTrack("video",!1))}},{key:"unmuteAudio",value:function(){return!(!this.mediaStream||this.audioTrackEnabled)&&(this.logger.info("unmute audio"),this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.UNMUTE_REMOTE_AUDIO_SCREEN:lr.UNMUTE_REMOTE_AUDIO:this.type===ht?lr.UNMUTE_LOCAL_AUDIO_SCREEN:lr.UNMUTE_LOCAL_AUDIO,v:this.addUid()}),this.addRemoteEvent(Wt.AudioUnmute),this.doEnableTrack("audio",!0))}},{key:"unmuteVideo",value:function(){return!(!this.mediaStream||this.videoTrackEnabled)&&(this.logger.info("unmute video"),this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.UNMUTE_REMOTE_VIDEO_SCREEN:lr.UNMUTE_REMOTE_VIDEO:this.type===ht?lr.UNMUTE_LOCAL_VIDEO_SCREEN:lr.UNMUTE_LOCAL_VIDEO,v:this.addUid()}),this.isAlphaChannels&&this.videoPlayer.unmute(),this.addRemoteEvent(Wt.VideoUnmute),this.doEnableTrack("video",!0))}},{key:"updateTrack",value:function(e,t){var r;(r="audio"===e?this.getAudioTrack():this.getVideoTrack())&&this.mediaStream.removeTrack(r),this.mediaStream.addTrack(t)}},{key:"doEnableTrack",value:function(e,t){var r=!1;return"audio"===e?this.mediaStream.getAudioTracks().forEach((function(e){r=!0,e.enabled=t})):this.mediaStream.getVideoTracks().forEach((function(e){r=!0,e.enabled=t})),this.setEnableTrackFlag(e,t),r}},{key:"setEnableTrackFlag",value:function(e,t){"audio"===e?this.audioTrackEnabled=t:this.videoTrackEnabled=t}},{key:"addRemoteEvent",value:function(e,t){var r=this;return new Promise((function(i,n){if(!r.isRemote){var o=function(e,t,r){1===e&&i(!0),0===e&&n(!1)};if(r.xsigoClient)switch(e){case Wt.AudioMute:r.xsigoClient.muteAudio(r.roomId,r.audioStreamId,o,t);break;case Wt.VideoMute:r.xsigoClient.muteVideo(r.roomId,r.videoStreamId,o,t);break;case Wt.AudioUnmute:r.xsigoClient.unmuteAudio(r.roomId,r.audioStreamId,o,t);break;case Wt.VideoUnmute:r.xsigoClient.unmuteVideo(r.roomId,r.videoStreamId,o,t)}else r.logger.info("not xsigoClient")}}))}},{key:"getId",value:function(){return this.streamId||""}},{key:"getUserId",value:function(){return"main"===this.type?this.userId:this.userId.replace("share_","")}},{key:"setUserId",value:function(e){if(this.streamConfig.screen)return this.userId="share_".concat(e);this.userId=e}},{key:"setAudioOutput",value:function(e){this.audioOutputDeviceId=e,this.logger.info("setAudioOutput deviceId",this.userId,e),this.logger.buriedLog({c:lr.SET_AUDIO_OUTPUT,v:"deviceId:".concat(e,",uid:").concat(this.userId)}),this.audioPlayer&&this.audioPlayer.setSinkId(e)}},{key:"getInuseSpeaker",value:(n=Ze(ot.mark((function e(){var t=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.logger.buriedLog({c:lr.GET_DEVICES_INFO_IN_USE,v:"speaker:".concat(this.audioOutputDeviceId)}),!this.audioOutputDeviceId){e.next=6;break}return e.next=4,yr();case 4:this.audioOutputGroupId=e.sent.filter((function(e){return e.deviceId===t.audioOutputDeviceId}))[0].groupId||"";case 6:return e.abrupt("return",{speaker:{deviceId:this.audioOutputDeviceId,groupId:this.audioOutputGroupId}});case 7:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"setAudioVolume",value:function(e){this.audioVolume=e,this.logger.info("setAudioVolume to ".concat(e.toString())),this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.SET_REMOTE_AUDIO_VOLUME_SCREEN:lr.SET_REMOTE_AUDIO_VOLUME:this.type===ht?lr.SET_LOCAL_AUDIO_VOLUME_SCREEN:lr.SET_LOCAL_AUDIO_VOLUME,v:"volume:".concat(e)}),this.audioPlayer&&this.audioPlayer.setVolume(e)}},{key:"getAudioLevel",value:function(){return this.audioPlayer?this.audioPlayer.getAudioLevel():0}},{key:"setHasAudio",value:function(e){this.hasAudioTrack=e}},{key:"hasAudio",value:function(){return!!this.checkMediaStream()&&this.hasAudioTrack}},{key:"setHasVideo",value:function(e){this.hasVideoTrack=e}},{key:"hasVideo",value:function(){return!!this.checkMediaStream()&&this.hasVideoTrack}},{key:"getAudioTrack",value:function(){var e=null;if(this.checkMediaStream()){var t=this.mediaStream.getAudioTracks();t.length>0&&(e=t[0])}return e}},{key:"getVideoTrack",value:function(){var e=null;if(this.checkMediaStream()){var t=this.mediaStream.getVideoTracks();t.length>0&&(e=t[0])}return e}},{key:"getVideoFrame",value:function(){return this.logger.buriedLog({c:this.isRemote?this.type===ht?lr.GET_REMOTE_VIDEO_FRAME_SCREEN:lr.GET_REMOTE_VIDEO_FRAME:this.type===ht?lr.GET_LCOAL_VIDEO_FRAME_SCREEN:lr.GET_LCOAL_VIDEO_FRAME}),this.videoPlayer?this.videoPlayer.getVideoFrame():null}},{key:"on",value:function(e,t){this._emitter.on(e,t)}},{key:"playAudio",value:(i=Ze(ot.mark((function e(){var t,r=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.getAudioTrack(),!this.audioPlayer&&t){e.next=3;break}return e.abrupt("return");case 3:return this.logger.info("stream - create AudioPlayer and play"),this.audioPlayer=new kt({stream:this,track:t,div:this.div,muted:this.muted,volume:this.audioVolume,deviceId:this.audioOutputDeviceId}),this.audioPlayer._emitter.on("player-state-changed",(function(e){r._emitter.emit("player-state-changed",{type:"audio",state:e.state,reason:e.reason}),"track"===e.type&&r._emitter.emit("track-state-changed",{type:"audio",state:e.state,reason:e.reason})})),e.abrupt("return",new Promise((function(e,t){r.audioPlayer.play().then((function(){e()})).catch((function(e){if(r.logger.warn("<audio> play() error:"+e),(e.toString()+" <audio>").startsWith("NotAllowedError")){r.logger.onError({c:lr.TOP_ERROR,v:gt.PLAY_NOT_ALLOWED});var i=new It({code:gt.PLAY_NOT_ALLOWED,message:e.message});r.logger.buriedLog({c:lr.ON_STREAM_ERROR,v:"code:".concat(gt.PLAY_NOT_ALLOWED)}),r._emitter.emit(pt,i),t(i)}}))})));case 7:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"getWaterStreamStream",value:(r=Ze(ot.mark((function e(t){var r,i,n,o,s,a,c,u,d,l=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.mediaStream,this.waterMarkVideo=document.createElement("video"),this.waterMarkVideo.srcObject=r,e.next=5,this.waterMarkVideo.play();case 5:return i=r.getVideoTracks()[0],n=document.createElement("canvas"),o=n.getContext("2d"),s=i.getSettings(),this.logger.info("settings frameRate ====>",1e3/s.frameRate),a=Math.floor(1e3/15),u=Date.now(),n.width=s.width,n.height=s.height,function e(){var r=i.getSettings().frameRate;r&&(a=Math.floor(1e3/r)),a<1e3/15&&(a=Math.floor(1e3/15)),l.timer&&cancelAnimationFrame(l.timer),l.timer=requestAnimationFrame(e),c=Date.now(),(d=c-u)>a&&(u=c-d/a,o.drawImage(l.waterMarkVideo,0,0,n.width,n.height),o.drawImage(t,0,0,s.width,s.height))}(),this.waterStreamStream=n.captureStream(),e.abrupt("return",this.waterStreamStream);case 17:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"startWaterMark",value:function(e,t){var r=this;return this.logger.info(this.userId+" startWaterMark",e),new Promise(function(){var i=Ze(ot.mark((function i(n,o){var s,a;return ot.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!r.waterStreamStream){i.next=2;break}return i.abrupt("return",o("waterMark is starting"));case 2:if(r.waterMarkoptions=e,r.waterMarkImage=t,r.type===ht&&r.isRemote){i.next=6;break}return i.abrupt("return",o("waterMark is only support remoteStream and screenShare"));case 6:if(!r.videoPlayer){i.next=17;break}return i.next=9,r.getWaterStreamStream(t);case 9:s=i.sent.getVideoTracks()[0],(a=new MediaStream).addTrack(s),r.getVideoElement().srcObject=a,i.next=18;break;case 17:r.isWaterMark=!0;case 18:n();case 19:case"end":return i.stop()}}),i)})));return function(e,t){return i.apply(this,arguments)}}())}},{key:"closeWaterMark",value:function(){if(this.waterStreamStream&&(this.logger.info(this.userId+" closeWaterMark"),this.isWaterMark=!1,this.waterStreamStream=null,this.waterMarkImage=null,this.waterMarkoptions=null,this.timer&&(cancelAnimationFrame(this.timer),this.timer=null),this.waterMarkVideo&&(this.waterMarkVideo.srcObject=null,this.waterMarkVideo=null),this.isPlaying)){var e=this.getVideoElement(),t=this.getVideoTrack(),r=new MediaStream;r.addTrack(t),e.srcObject=r}}},{key:"setLocalUserId",value:function(e){this.localId=e}},{key:"playVideo",value:(t=Ze(ot.mark((function e(){var t,r=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.getVideoTrack(),!this.videoPlayer&&t){e.next=3;break}return e.abrupt("return");case 3:if(!this.isWaterMark){e.next=8;break}return e.next=6,this.getWaterStreamStream(this.waterMarkImage);case 6:t=e.sent.getVideoTracks()[0];case 8:return this.logger.info("stream - create VideoPlayer and play"),this.videoPlayer=new Lt({stream:this,track:t,div:this.div,muted:this.muted,objectFit:this.objectFit,mirror:this.mirror,isAlphaChannels:this.isAlphaChannels,virtualBackground:this.virtualBackground,virtualBackgroundMix:this.virtualBackgroundMix,isEleLisenter:this.isEleLisenter}),this.videoPlayer._emitter.on("player-state-changed",(function(e){r._emitter.emit("player-state-changed",{type:"video",state:e.state,reason:e.reason}),"track"===e.type&&r._emitter.emit("track-state-changed",{type:"video",state:e.state,reason:e.reason})})),e.abrupt("return",new Promise((function(e,t){r.videoPlayer.play().then((function(){e()})).catch((function(e){if(r.logger.warn("<video> play() error:"+e),(e.toString()+" <video>").startsWith("NotAllowedError")){r.logger.onError({c:lr.TOP_ERROR,v:gt.PLAY_NOT_ALLOWED});var i=new It({code:gt.PLAY_NOT_ALLOWED,message:e.message});r.logger.buriedLog({c:lr.ON_STREAM_ERROR,v:"code:".concat(gt.PLAY_NOT_ALLOWED)}),r._emitter.emit(pt,i),t(i)}}))})));case 12:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"stopAudio",value:function(){this.audioPlayer&&(this.logger.info("stream - stop AudioPlayer"),this.audioPlayer.stop(),this.audioPlayer=null)}},{key:"stopVideo",value:function(){this.videoPlayer&&(this.logger.info("stream - stop VideoPlayer"),this.videoPlayer.stop(),this.videoPlayer=null)}},{key:"checkMediaStream",value:function(){return!!this.mediaStream}},{key:"restartAudio",value:function(){this.isPlaying&&(this.stopAudio(),this.playAudio())}},{key:"restartVideo",value:function(){this.isPlaying&&(this.stopVideo(),this.playVideo())}},{key:"setMediaStream",value:function(e){this.mediaStream=e}},{key:"setSimulcasts",value:function(e){this.info.video.simulcast=e}},{key:"getSimulcasts",value:function(){try{return this.info.video.simulcast||[]}catch(e){return[]}}},{key:"setInfo",value:function(e){this.info=e}},{key:"getType",value:function(){return this.type||"main"}},{key:"getAudioElement",value:function(){return this.audioPlayer&&this.audioPlayer.getAudioElement()}},{key:"getVideoElement",value:function(){return this.videoPlayer&&this.videoPlayer.getVideoElement()}},{key:"setAudioTrack",value:function(e){e.enabled=this.audioTrackEnabled,this.audioPlayer?this.audioPlayer.setAudioTrack(e):this.playAudio()}},{key:"setVideoTrack",value:function(e){e.enabled=this.videoTrackEnabled,this.videoPlayer?this.videoPlayer.setVideoTrack(e):this.playVideo()}},{key:"setAudioStreamId",value:function(e){this.audioStreamId=e}},{key:"setVideoStreamId",value:function(e){this.videoStreamId=e}},{key:"addUid",value:function(){if(this.isRemote)return"uid:".concat(this.getUserId())}},{key:"getAudioMuted",value:function(){return this.getAudioTrack()&&!this.audioTrackEnabled||this.audioMuted}},{key:"getVideoMuted",value:function(){return this.getVideoTrack()&&!this.videoTrackEnabled||this.videoMuted}},{key:"updatePeerConnectionFailed",value:function(e){if("failed"===e){this.pcFailedCount++,this.logger.onError({c:lr.TOP_ERROR,v:gt.RTCPEERCONNECTION_SATE_FAILED});var t=new It({code:gt.RTCPEERCONNECTION_SATE_FAILED,message:'{"count":'.concat(this.pcFailedCount,"}")});this._emitter.emit(pt,t),this.logger.warn("updatePeerConnectionFailed,count:".concat(this.pcFailedCount))}else"connected"===e&&0!==this.pcFailedCount&&(this.pcFailedCount=0)}},{key:"setMutedState",value:function(e,t){"audio"===e?this.audioMuted=t:"video"===e&&(this.videoMuted=t)}},{key:"setIsAlphaChannels",value:function(e){this.logger.info("set isAlphaChannels",e),this.isAlphaChannels=e}},{key:"hasAlphaChannels",value:function(){return this.isAlphaChannels}},{key:"setVirtualBackground",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.virtualBackground)return this.logger.warn("The virtual background has already been set"),!1;return["IMG","VIDEO"].includes(e.nodeName)?(this.logger.info("set virtual background,element:".concat(e.nodeName,",mix:").concat(t)),this.virtualBackground=e,this.virtualBackgroundMix="VIDEO"===e.nodeName||t,!0):(this.logger.warn("Element must be img or video"),!1)}},{key:"resize",value:function(){return this.isAlphaChannels?this.videoPlayer?void this.videoPlayer.resize():(this.logger.warn("Please play video first"),!1):(this.logger.warn("Please start the stream containing alpha channel first"),!1)}}]),e}(),Cr=new Map;Cr.set("standard",{sampleRate:48e3,channelCount:1,bitrate:40}),Cr.set("high",{sampleRate:48e3,channelCount:1,bitrate:128});var Tr=new Map;Tr.set("120p",{width:160,height:120,frameRate:15,bitrate:200}),Tr.set("180p",{width:320,height:180,frameRate:15,bitrate:350}),Tr.set("240p",{width:320,height:240,frameRate:15,bitrate:400}),Tr.set("360p",{width:640,height:360,frameRate:15,bitrate:800}),Tr.set("480p",{width:640,height:480,frameRate:15,bitrate:900}),Tr.set("720p",{width:1280,height:720,frameRate:15,bitrate:1500}),Tr.set("1080p",{width:1920,height:1080,frameRate:15,bitrate:2e3}),Tr.set("1440p",{width:2560,height:1440,frameRate:30,bitrate:4860}),Tr.set("4K",{width:3840,height:2160,frameRate:30,bitrate:9e3});var Rr=new Map;function _r(e){return("function"==typeof Symbol&&"symbol"==bt(Symbol.iterator)?function(e){return bt(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":bt(e)})(e)}Rr.set("480p",{width:640,height:480,frameRate:5,bitrate:900}),Rr.set("480p_2",{width:640,height:480,frameRate:30,bitrate:1e3}),Rr.set("720p",{width:1280,height:720,frameRate:5,bitrate:1200}),Rr.set("720p_2",{width:1280,height:720,frameRate:30,bitrate:3e3}),Rr.set("1080p",{width:1920,height:1080,frameRate:5,bitrate:1600}),Rr.set("1080p_2",{width:1920,height:1080,frameRate:30,bitrate:4e3});var Ir,wr=window.navigator&&window.navigator.userAgent||"",kr=/Edge\//i.test(wr),Or=(Ir=wr.match(/Chrome\/(\d+)/))&&Ir[1]?parseFloat(Ir[1]):null;function Ar(e,t){return new Promise((function(r,i){var n=document.createElement("canvas"),o=n.getContext("2d");n.width=1920,n.height=1080;var s=document.createElement("canvas");s.width=400,s.height=200,s.style.border="1px solid";var a=s.getContext("2d");a.rotate(-20*Math.PI/180),a.font="".concat(e.fontSize,"px ").concat(e.fontType),a.fillStyle=e.fontColor,a.textBaseline="middle",a.fillText(t,0,90);var c=new Image;c.src=s.toDataURL("image/png"),c.onload=function(){o.fillStyle=o.createPattern(c,"repeat"),o.fillRect(0,0,n.width,n.height);var e=new Image;return e.src=n.toDataURL("image/png"),r(e)}}))}function Pr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function Lr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Pr(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Pr(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var xr=function(e){yt(s,Er);var t,r,i,n,o=function(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Ct(e);if(t){var n=Ct(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return Et(this,r)}}(s);function s(e,t){var r;return tt(this,s),(r=o.call(this,e,t)).screen=e.screen,r.audioProfile=Cr.get("standard"),r.videoProfile=Tr.get("480p"),r.screenProfile=Rr.get("1080p"),r.bitrate={audio:r.audioProfile.bitrate,video:r.screen?r.screenProfile.bitrate:r.videoProfile.bitrate},r.cameraId_=e.cameraId||"",r.cameraGroupId_="",r.microphoneId_=e.microphoneId||"",r.microphoneGroupId_="",r.cameraLabel_="",r.microphoneLabel_="",r.recoverCaptureCount_=0,r.published=!1,r.audioPubState=ut.Create,r.videoPubState=ut.Create,r._emitter.on("track-state-changed",r.onTrackStopped.bind(St(r))),r}return it(s,[{key:"initialize",value:(n=Ze(ot.mark((function e(){var t=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.logger.info("initialize stream audio: ".concat(this.constraints.audio," video: ").concat(this.constraints.video)),e.abrupt("return",new Promise((function(e,r){return t.screen?t.initShareStream({audio:t.streamConfig.audio,screenAudio:t.streamConfig.screenAudio,microphoneId:t.microphoneId_,width:t.screenProfile.width,height:t.screenProfile.height,frameRate:t.screenProfile.frameRate,sampleRate:t.audioProfile.sampleRate,channelCount:t.audioProfile.channelCount}).then((function(r){t.mediaStream=r;var i=r.getAudioTracks().length>0,n=r.getVideoTracks().length>0;t.setHasAudio(i),t.setHasVideo(n),t.setMutedState("audio",!i),t.setMutedState("video",!n),t.listenForScreenSharingStopped(r.getVideoTracks()[0]),t.setVideoContentHint("detail"),t.updateDeviceIdInUse(),e(r),t.logger.info("init share stream success")})).catch((function(e){t.logger.onError({c:lr.TOP_ERROR,v:gt.INIT_STREAM_FAILED},"init share stream failed,".concat(e.name,":").concat(e.message));var i=new It({code:gt.INIT_STREAM_FAILED,message:e.message,name:e.name});r(i)})):t.initAvStream({audio:t.streamConfig.audio,video:t.streamConfig.video,facingMode:t.streamConfig.facingMode,cameraId:t.cameraId_,microphoneId:t.microphoneId_,width:t.videoProfile.width,height:t.videoProfile.height,frameRate:t.videoProfile.frameRate,sampleRate:t.audioProfile.sampleRate,channelCount:t.audioProfile.channelCount}).then((function(r){t.mediaStream=r;var i=r.getAudioTracks().length>0,n=r.getVideoTracks().length>0;t.setHasAudio(i),t.setHasVideo(n),t.setMutedState("audio",!i),t.setMutedState("video",!n),t.updateDeviceIdInUse(),t.videoSetting=n&&r.getVideoTracks()[0].getSettings(),e(r),t.logger.info("init local stream success")})).catch((function(e){t.logger.onError({c:lr.TOP_ERROR,v:gt.INIT_STREAM_FAILED},"init localstream failed,".concat(e.name,":").concat(e.message));var i=new It({code:gt.INIT_STREAM_FAILED,message:e.message,name:e.name});r(i)})).finally(Ze(ot.mark((function e(){return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,mr();case 2:t.logger.info("mediaDevices",JSON.stringify(e.sent,null,4));case 4:case"end":return e.stop()}}),e)}))))})));case 2:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"initAvStream",value:(i=Ze(ot.mark((function e(t){var r,i,n,o,s,a;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(navigator.mediaDevices){e.next=3;break}return this.logger.onError({c:lr.TOP_ERROR,v:gt.DEVICE_NOT_FOUND},"navigator.mediaDevices is undefined"),e.abrupt("return",Promise.reject());case 3:if(i={audio:t.audio,video:t.video},!t.audio){e.next=18;break}return e.next=7,vr();case 7:if(0!==(r=e.sent).length){e.next=13;break}throw this.logger.onError({c:lr.TOP_ERROR,v:gt.DEVICE_NOT_FOUND}),new It({code:gt.DEVICE_NOT_FOUND,message:"no microphone detected, but you are trying to get audio stream, please check your microphone and the configeration on XRTC.createStream."});case 13:(n=r.filter((function(e){return e.deviceId.length>0}))).length>0&&(o=n[0].deviceId),(s=r.filter((function(e){return"default"===e.deviceId}))).length>0&&(a=s[0].deviceId),i.audio={deviceId:{exact:t.microphoneId||a||o},echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0,sampleRate:t.sampleRate,channelCount:t.channelCount};case 18:if(!t.video){e.next=30;break}return e.next=21,gr();case 21:if(0!==e.sent.length){e.next=27;break}throw this.logger.onError({c:lr.TOP_ERROR,v:gt.DEVICE_NOT_FOUND}),new It({code:gt.DEVICE_NOT_FOUND,message:"no camera detected, but you are trying to get video stream, please check your camera and the configeration on XRTC.createStream."});case 27:i.video={width:t.width,height:t.height,frameRate:t.frameRate},t.cameraId&&(i.video=Lr(Lr({},i.video),{},{deviceId:{exact:t.cameraId}})),t.facingMode&&(i.video=Lr(Lr({},i.video),{},{facingMode:t.facingMode}));case 30:return e.abrupt("return",navigator.mediaDevices.getUserMedia(i));case 31:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"initShareStream",value:function(e){if(!navigator.mediaDevices)return this.logger.onError({c:lr.TOP_ERROR,v:gt.DEVICE_NOT_FOUND},"navigator.mediaDevices is undefined"),Promise.reject();if(e.screenAudio)kr||Or<74?this.logger.onError({c:lr.TOP_ERROR,v:gt.BROWSER_NOT_SUPPORTED},"Your browser not support capture system audio"):e.audioConstraints={echoCancellation:!0,noiseSuppression:!0,sampleRate:44100};else if(e.audio){var t={audio:e.microphoneId?{deviceId:{exact:e.microphoneId},sampleRate:e.sampleRate,channelCount:e.channelCount}:{sampleRate:e.sampleRate,channelCount:e.channelCount},video:!1},r=this.setConstraints(e);return this.logger.info("getDisplayMedia with contraints1: "+JSON.stringify(r)),new Promise(function(){var e=Ze(ot.mark((function e(i,n){var o;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getDisplayMedia(r);case 3:o=e.sent,navigator.mediaDevices.getUserMedia(t).then((function(e){o.addTrack(e.getAudioTracks()[0]),i(o)})),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),n(e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,r){return e.apply(this,arguments)}}())}var i=this.setConstraints(e);return this.logger.info("getDisplayMedia with contraints2: "+JSON.stringify(i)),navigator.mediaDevices.getDisplayMedia(i)}},{key:"setAudioProfile",value:function(e){var t;this.mediaStream?this.logger.warn("Please set audio profile before initialize!"):("object"===_r(e)?t=e:void 0===(t=Cr.get(e))&&(t=Cr.get("standard")),this.logger.info("setAudioProfile: "+JSON.stringify(t)),this.logger.buriedLog({c:lr.SET_AUDIO_PROFILE,v:JSON.stringify(t)}),this.audioProfile=t,this.bitrate.audio=t.bitrate)}},{key:"setVideoProfile",value:(r=Ze(ot.mark((function e(t){var r;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.mediaStream){e.next=3;break}return this.logger.warn("Please set video profile before initialize!"),e.abrupt("return");case 3:"object"===_r(t)?r=t:void 0===(r=Tr.get(t))&&(r=Tr.get("480p")),this.logger.info("setVideoProfile "+JSON.stringify(r)),this.logger.buriedLog({c:lr.SET_VIDEO_PROFILE,v:JSON.stringify(r)}),this.videoProfile=r,this.bitrate.video=r.bitrate;case 8:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setScreenProfile",value:function(e){var t;this.mediaStream?this.logger.warn("Please set screen profile before initialize!"):("object"===_r(e)?t=e:void 0===(t=Rr.get(e))&&(t=Rr.get("1080p_2")),this.logger.info("setScreenProfile "+JSON.stringify(t)),this.logger.buriedLog({c:lr.SET_SCREEN_PROFILE,v:JSON.stringify(t)}),this.screenProfile=t,this.bitrate.video=t.bitrate)}},{key:"setConstraints",value:function(e){var t={};return t.video={width:e.width,height:e.height,frameRate:e.frameRate},void 0!==e.audioConstraints&&(t.audio=e.audioConstraints),this.constraints=t,t}},{key:"getBitrate",value:function(){return this.bitrate}},{key:"addTrack",value:function(e){var t=this;if(!this.mediaStream)throw this.logger.onError({c:lr.TOP_ERROR,v:gt.ADD_TRACK_FAILED}),new It({code:gt.ADD_TRACK_FAILED,message:"the local stream is not initialized yet"});if("audio"===e.kind&&this.getAudioTracks().length>0||"video"===e.kind&&this.getVideoTracks().length>0)throw this.logger.onError({c:lr.TOP_ERROR,v:gt.ADD_TRACK_FAILED}),new It({code:gt.ADD_TRACK_FAILED,message:"A Stream has at most one audio track and one video track"});var r=e.getSettings();return"video"===e.kind&&r&&this.videoSetting&&(r.width!==this.videoSetting.width||r.height!==this.videoSetting.height)&&this.logger.warn("video resolution of the track ".concat(r.width," x ").concat(r.height," shall be kept the same as the previous: ").concat(this.videoSetting.width," x ").concat(this.videoSetting.height)),new Promise((function(i,n){t._emitter.once("stream-track-update-result",(function(e){var r=e.code,o=e.message;if(t.logger.info("add track response",r),1===r)i(!0);else{t.logger.onError({c:lr.TOP_ERROR,v:gt.ADD_TRACK_FAILED});var s=new It({code:gt.ADD_TRACK_FAILED,message:o||"add track failed"});n(s)}})),"video"===e.kind?(t.cameraId_=r.deviceId,t.cameraGroupId_=r.groupId):"audio"===e.kind&&(t.microphoneId_=r.deviceId,t.microphoneGroupId_=r.groupId),t.setEnableTrackFlag(e.kind,e.enabled),t.logger.buriedLog({c:"audio"===e.kind?t.type===ht?lr.ADD_AUDIO_TRACK_SCREEN:lr.ADD_AUDIO_TRACK:t.type===ht?lr.ADD_VIDEO_TRACK_SCREEN:lr.ADD_VIDEO_TRACK}),t._emitter.emit("stream-add-track",{track:e,streamId:t.streamId})}))}},{key:"removeTrack",value:function(e){var t=this;if(e&&"audio"===e.kind)throw this.logger.onError({c:lr.TOP_ERROR,v:gt.INVALID_PARAMETER}),new It({code:gt.INVALID_PARAMETER,message:"remove audio track is not supported"});if(!this.mediaStream)throw new It({code:gt.INVALID_OPERATION,message:"the local stream is not initialized yet"});if(-1===this.mediaStream.getTracks().indexOf(e))throw this.logger.onError({c:lr.TOP_ERROR,v:gt.INVALID_PARAMETER}),new It({code:gt.INVALID_PARAMETER,message:"the track to be removed is not being publishing"});if(!this.supportPC())throw new It({code:gt.INVALID_OPERATION,message:"removeTrack is not supported in this browser"});return this.logger.info("remove video track from current published stream"),new Promise((function(r,i){t._emitter.once("stream-track-update-result",(function(e){var n=e.code,o=e.message;if(t.logger.info("remove track response",n),1===n)r(!0);else{t.logger.onError({c:lr.TOP_ERROR,v:gt.REMOVE_TRACK_FAILED});var s=new It({code:gt.REMOVE_TRACK_FAILED,message:o||"remove track failed"});i(s)}})),t.logger.buriedLog({c:t.type===ht?lr.REMOVE_TRACK_SCREEN:lr.REMOVE_TRACK}),t._emitter.emit("stream-remove-track",{track:e,streamId:t.streamId})}))}},{key:"replaceTrack",value:function(e){if(!this.mediaStream)throw new It({code:gt.INVALID_OPERATION,message:"the local stream is not initialized yet"});var t=e.getSettings();if("video"===e.kind&&t&&this.videoSetting&&(t.width!==this.videoSetting.width||t.height!==this.videoSetting.height)&&this.logger.warn("video resolution of the track ".concat(t.width," x ").concat(t.height," shall be kept the same as the previous: ").concat(this.videoSetting.width," x ").concat(this.videoSetting.height)),"audio"===e.kind?(this.mediaStream.removeTrack(this.getAudioTrack()),this.mediaStream.addTrack(e),e.enabled=!this.getAudioMuted(),this.restartAudio()):(this.mediaStream.removeTrack(this.getVideoTrack()),this.mediaStream.addTrack(e),e.enabled=!this.getVideoMuted(),this.restartVideo()),!this.isReplaceTrackAvailable()||!this.supportPC())throw new It({code:gt.INVALID_OPERATION,message:"replaceTrack is not supported in this browser, please use switchDevice or addTrack instead"});this.logger.buriedLog({c:"audio"===e.kind?this.type===ht?lr.REPLACE_AUDIO_TRACK_SCREEN:lr.REPLACE_AUDIO_TRACK:this.type===ht?lr.REPLACE_VIDEO_TRACK_SCREEN:lr.REPLACE_VIDEO_TRACK}),this._emitter.emit("stream-replace-track",{streamId:this.streamId,type:e.kind,track:e})}},{key:"setVideoContentHint",value:function(e){var t=this.getVideoTrack();t&&"contentHint"in t&&(this.logger.info("set video track contentHint to: "+e),t.contentHint=e,t.contentHint!==e&&this.logger.info("Invalid video track contentHint: "+e),this.logger.buriedLog({c:lr.SET_VIDEO_CONTENT_HINT,v:"hint".concat(e)}))}},{key:"switchDevice",value:function(e,t){var r,i,n=this;if(this.screen)throw new It({code:gt.INVALID_OPERATION,message:"switch device is not supported in screen sharing"});if(!t||this.streamConfig.audioSource||this.streamConfig.videoSource)return Promise.reject();if("audio"===e&&this.microphoneId_===t||"video"===e&&this.cameraId_===t)return this.logger.warn("switch device is not supported same device"),Promise.reject("switch device is not supported same device");if(this.logger.info("switchDevice "+e+" to: "+t),"audio"===e&&this.microphoneId_!==t){if(!(r=this.getAudioTrack()))return this.microphoneId_=t,Promise.resolve();r&&r.stop(),this.microphoneId_=t,this.logger.buriedLog({c:lr.SWITCH_DEVICE_AUDIO,v:"deviceId:".concat(t)})}if("video"===e&&this.cameraId_!==t){if(!(i=this.getVideoTrack()))return this.cameraId_=t,Promise.resolve();i&&i.stop(),this.cameraId_=t,this.logger.buriedLog({c:lr.SWITCH_DEVICE_VIDEO,v:"deviceId:".concat(t)})}return new Promise((function(t,o){n.initAvStream({audio:"audio"===e,video:"video"===e,facingMode:n.streamConfig.facingMode,cameraId:n.cameraId_,microphoneId:n.microphoneId_,width:n.videoProfile.width,height:n.videoProfile.height,frameRate:n.videoProfile.frameRate,sampleRate:n.audioProfile.sampleRate,channelCount:n.audioProfile.channelCount}).then((function(o){"audio"===e&&(n.mediaStream.removeTrack(r),(r=o.getAudioTracks()[0])&&n.mediaStream.addTrack(r),r&&n.setHasAudio(!0),r&&n._emitter.emit("stream-switch-device",{streamId:n.streamId,type:e,track:r}),n.updateDeviceIdInUse("audio"),r.enabled=!n.getAudioMuted(),n.restartAudio()),"video"==e&&(n.mediaStream.removeTrack(i),(i=o.getVideoTracks()[0])&&n.mediaStream.addTrack(i),i&&n.setHasVideo(!0),i&&n._emitter.emit("stream-switch-device",{streamId:n.streamId,type:e,track:i}),n.updateDeviceIdInUse("video"),i.enabled=!n.getVideoMuted(),n.restartVideo()),t()})).catch((function(e){n.microphoneId_="",n.cameraId_="",n.logger.onError({c:lr.TOP_ERROR,v:gt.SWITCH_DEVICE_FAILED}),o(new It({code:gt.SWITCH_DEVICE_FAILED,message:"init audio or video stream failed"})),n.logger.onError({c:lr.TOP_ERROR,v:gt.SWITCH_DEVICE_FAILED});var t=new It({code:gt.SWITCH_DEVICE_FAILED,message:e.message});o(t)}))}))}},{key:"updateStream",value:function(e){var t=this;if(this.screen||this.streamConfig.audioSource||this.streamConfig.videoSource)return Promise.reject();var r,i,n=e.audio,o=e.video,s=e.cameraId,a=e.microphoneId;return n&&(r=this.getAudioTrack()),o&&(i=this.getVideoTrack()),new Promise((function(e,c){t.initAvStream({audio:n,video:o,facingMode:t.streamConfig.facingMode,cameraId:s||"",microphoneId:a||"",width:t.videoProfile.width,height:t.videoProfile.height,frameRate:t.videoProfile.frameRate,sampleRate:t.audioProfile.sampleRate,channelCount:t.audioProfile.channelCount}).then((function(s){n&&(t.logger.info("updateStream audio"),r&&r.stop(),t.mediaStream.removeTrack(r),(r=s.getAudioTracks()[0])&&t.mediaStream.addTrack(r),r&&t.setHasAudio(!0),r&&t._emitter.emit("stream-switch-device",{streamId:t.streamId,type:"audio",track:r}),t.updateDeviceIdInUse("audio"),t.setAudioTrack(r)),o&&(t.logger.info("updateStream video"),i&&i.stop(),t.mediaStream.removeTrack(i),(i=s.getVideoTracks()[0])&&t.mediaStream.addTrack(i),i&&t.setHasVideo(!0),i&&t._emitter.emit("stream-switch-device",{streamId:t.streamId,type:"video",track:i}),t.updateDeviceIdInUse("video"),t.setVideoTrack(i)),e()})).catch((function(e){t.logger.warn("NotReadableError"===e.name?"getUserMedia NotReadableError observed":e.name,e.message),t.logger.onError({c:lr.TOP_ERROR,v:gt.DEVICE_AUTO_RECOVER_FAILED});var r=new It({code:gt.DEVICE_AUTO_RECOVER_FAILED,message:e});c(r),t._emitter.emit(pt,r)}))}))}},{key:"getAudioTracks",value:function(){return this.mediaStream.getAudioTracks()}},{key:"getVideoTracks",value:function(){return this.mediaStream.getVideoTracks()}},{key:"isReplaceTrackAvailable",value:function(){return"RTCRtpSender"in window&&"replaceTrack"in window.RTCRtpSender.prototype}},{key:"supportPC",value:function(){return"RTCPeerConnection"in window&&"getSenders"in window.RTCPeerConnection.prototype}},{key:"listenForScreenSharingStopped",value:function(e){var t=this;e.addEventListener("ended",(function(e){t.logger.info("screen sharing was stopped because the video track is ended"),t.logger.buriedLog({c:lr.ON_SCREEN_SHARING_STOPPED}),t._emitter.emit("screen-sharing-stopped")}),{once:!0})}},{key:"updateDeviceIdInUse",value:function(e){if(!this.mediaStream)return this.microphoneId_="",this.microphoneGroupId_="",this.cameraId_="",this.cameraGroupId_="",this.microphoneLabel_="",void(this.cameraLabel_="");for(var t=this.mediaStream.getTracks(),r=t.length,i=0;i<r;i++){var n=t[i].getSettings(),o=n.deviceId,s=n.groupId;if(e&&o){if(e===t[i].kind&&"audio"===t[i].kind){this.microphoneId_=o,this.microphoneGroupId_=s,this.microphoneLabel_=t[i].label;break}if(e===t[i].kind&&"video"===t[i].kind&&!this.screen){this.cameraId_=o,this.cameraGroupId_=s,this.cameraLabel_=t[i].label;break}}else o&&("audio"===t[i].kind?(this.microphoneId_=o,this.microphoneGroupId_=s,this.microphoneLabel_=t[i].label):"video"!==t[i].kind||this.screen||(this.cameraId_=o,this.cameraGroupId_=s,this.cameraLabel_=t[i].label))}var a=this.mediaStream.getAudioTracks(),c=this.mediaStream.getVideoTracks();a&&0===a.length&&(this.microphoneId_="",this.microphoneGroupId_="",this.microphoneLabel_=""),c&&0===c.length&&(this.cameraId_="",this.cameraGroupId_="",this.cameraLabel_=""),this.logger.info("update device id: microphoneId: ".concat(this.microphoneId_,",microphoneLabel:").concat(this.microphoneLabel_,", microphoneGroupId:").concat(this.microphoneGroupId_,",cameraId: ").concat(this.cameraId_,",cameraLabel:").concat(this.cameraLabel_,",cameraGroupId:").concat(this.cameraGroupId_))}},{key:"getDevicesInfoInUse",value:function(){return this.logger.buriedLog({c:lr.GET_DEVICES_INFO_IN_USE,v:"microphone:".concat(this.microphoneId_,",camera:").concat(this.cameraId_)}),{camera:{deviceId:this.cameraId_,groupId:this.cameraGroupId_,label:this.cameraLabel_},microphone:{deviceId:this.microphoneId_,groupId:this.microphoneGroupId_,label:this.microphoneLabel_}}}},{key:"setPubState",value:function(e,t){"audio"===e?this.audioPubState=t:this.videoPubState=t}},{key:"getPubState",value:function(e){return"audio"===e?this.audioPubState:this.videoPubState}},{key:"onTrackAdd",value:function(e){this._emitter.on("stream-add-track",e)}},{key:"onTrackRemove",value:function(e){this._emitter.on("stream-remove-track",e)}},{key:"onSwitchDevice",value:function(e){this._emitter.on("stream-switch-device",e)}},{key:"onReplaceTrack",value:function(e){this._emitter.on("stream-replace-track",e)}},{key:"onTrackStopped",value:(t=Ze(ot.mark((function e(t){var r,i,n,o,s=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.type,this.logger.info("onTrackStopped",i=t.reason,this.recoverCaptureCount_),"audio"!==r||"ended"!==i){e.next=11;break}if(!(this.recoverCaptureCount_<=10)){e.next=9;break}return e.next=6,vr();case 6:n=e.sent.findIndex((function(e){return e.deviceId===s.microphoneId_})),this.microphoneId_&&n>-1&&(this.logger.info("stat-local-audio-ended"),this.recoverCaptureCount_+=1,this.updateStream({audio:!0,video:!1,microphoneId:this.microphoneId_}));case 9:e.next=18;break;case 11:if("video"!==r||"ended"!==i){e.next=18;break}if(!(this.recoverCaptureCount_<=10)){e.next=18;break}return e.next=15,gr();case 15:o=e.sent.findIndex((function(e){return e.deviceId===s.cameraId_})),this.cameraId_&&o>-1&&(this.logger.info("stat-local-video-ended"),this.recoverCaptureCount_+=1,this.updateStream({audio:!1,video:!0,cameraId:this.cameraId_}));case 18:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),s}();var Dr=function(e){yt(r,Er);var t=function(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Ct(e);if(t){var n=Ct(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return Et(this,r)}}(r);function r(e,i){var n;return tt(this,r),(n=t.call(this,e,i)).isRemote=!0,n.subscribed=!1,n.audio=!1,n.video=!1,n.subscriptionId=null,n.audioSubscriptionId=null,n.videoSubscriptionId=null,n.audioSubState=dt.Create,n.videoSubState=dt.Create,n.simulcastType=null,n}return it(r,[{key:"getUserSeq",value:function(){return this.userId}},{key:"setAudio",value:function(e){this.audio=e}},{key:"setVideo",value:function(e){this.video=e}},{key:"setAudioSubscriptionId",value:function(e){this.audioSubscriptionId=e}},{key:"setVideoSubscriptionId",value:function(e){this.videoSubscriptionId=e}},{key:"getStreamKind",value:function(e){return this.audioStreamId===this.videoStreamId?lt.AudioVideo:this.audioStreamId===e?lt.AudioOnly:this.videoStreamId===e?lt.VideoOnly:void 0}},{key:"setSimulcastType",value:function(e){this.simulcastType=e}},{key:"getSimulcastType",value:function(){return this.simulcastType}},{key:"setSubState",value:function(e,t){"audio"===e?this.audioSubState=t:this.videoSubState=t}},{key:"getSubState",value:function(e){return"audio"===e?this.audioSubState:this.videoSubState}}]),r}();function Mr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function Ur(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Mr(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Mr(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var Nr,Vr,jr=Ur(Ur({},ar),cr);function Fr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function Br(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Fr(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Fr(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}!function(e){e[e.Create=0]="Create",e[e.Publishing=1]="Publishing",e[e.Published=2]="Published",e[e.Unpublished=3]="Unpublished"}(Nr||(Nr={})),function(e){e[e.Normal=0]="Normal",e[e.Half=1]="Half"}(Vr||(Vr={}));var Wr=function(){function e(t){tt(this,e),this.options=t,this.userId=t.userId,this.streamId=null,this.localStream=t.mediaStream,this.peerConnection=new RTCPeerConnection({bundlePolicy:"max-bundle",sdpSemantics:"unified-plan"}),this.logger=t.logger,this.xsigoClient=t.xsigoClient,this.roomId=t.roomId,this.state=Nr.Create,this.transceiver=null,this._emitter=new st,this._interval=-1,this.audioBytesSentIs0Count=0,this.videoBytesSentIs0Count=0,this.recoverCaptureCount=0,this.times=2e3,this.timer=null,this.level=Vr.Normal}var t,r;return it(e,[{key:"publish",value:function(){var e=this;return new Promise(function(){var t=Ze(ot.mark((function t(r,i){var n,o,s;return ot.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,e.state!==Nr.Create&&(e.logger.warn("Stream already publishing or published"),i({message:"stream already publishing or published"})),e.logger.info("stream publishing"),e.state=Nr.Publishing,t.next=6,e.createOffer(e.localStream);case 6:n=t.sent,e.logger.info("publishStream track",e.localStream.getTracks()),e.peerConnection.onconnectionstatechange=e.onConnectionstatechange.bind(e,"publish"),o="",s=[],e.peerConnection.onicecandidate=function(t){var a=t.candidate;e.logger.info("peerConnection publish ".concat(JSON.stringify(e.localStream.getTracks()[0].kind),"  IceCandidate data:\n ").concat((null==a?void 0:a.candidate)||"")),null!=a&&a.candidate&&(o=o+"a="+a.candidate+"\r\n"),s.push(a);var c=!1,u=window.setTimeout((function(){c=!0}),e.times);if(!a||c){window.clearTimeout(u),s[0]&&0!==s.length||i({code:gt.CANDIDATE_COLLECT_FAILED,message:"candidate is null"}),s=[];var d=n.sdp;if(d.toLowerCase().includes("audio")&&!d.toLowerCase().includes("opus"))return e.logger.warn("=======publish offer========\n",d),i("opus not supported");if(d.toLowerCase().includes("video")&&!d.toLowerCase().includes("h264"))return e.logger.warn("=======publish offer========\n",d),i("H264 not supported");d.includes("a=candidate")||(d+=o);var l=e.buildPublishParams();l.params.offerSdp=d,e.logger.info("=======publish offer========\n",d),e.streamId=e.xsigoClient.publishStream(e.roomId,l),r(e.streamId)}},t.next=17;break;case 14:t.prev=14,t.t0=t.catch(0),i(t.t0);case 17:case"end":return t.stop()}}),t,null,[[0,14]])})));return function(e,r){return t.apply(this,arguments)}}())}},{key:"republish",value:function(){var e=this;return new Promise(function(){var t=Ze(ot.mark((function t(r,i){var n,o;return ot.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.close(),e.peerConnection=new RTCPeerConnection({bundlePolicy:"max-bundle",sdpSemantics:"unified-plan"}),e.state=Nr.Publishing,t.next=5,e.createOffer(e.localStream);case 5:n=t.sent,e.peerConnection.onconnectionstatechange=e.onConnectionstatechange.bind(e,"republish"),o="",e.peerConnection.onicecandidate=function(t){var i=t.candidate;e.logger.info("peerConnection republish IceCandidate data:\n ".concat((null==i?void 0:i.candidate)||"")),null!=i&&i.candidate&&(o=o+"a="+i.candidate+"\r\n");var s=!1,a=window.setTimeout((function(){s=!0}),e.times);i&&!s||(window.clearTimeout(a),n.sdp.includes("a=candidate")||(n.sdp=n.sdp+o),e.logger.info("=======republish offer========\n",n.sdp),r(n))};case 9:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}())}},{key:"unpublish",value:function(e){var t=this;this.xsigoClient.unpublishStream(this.roomId,this.streamId,(function(r,i,n){1===r&&(t.state=Nr.Unpublished,t.close()),e(r,i,n)}))}},{key:"updateSimulcast",value:function(e,t){this.xsigoClient.updateSimulcast(this.roomId,this.streamId,{simulcast:e},t)}},{key:"createOffer",value:function(e){var t=this;return new Promise(function(){var r=Ze(ot.mark((function r(i,n){var o,s,a,c,u;return ot.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=t.options.minBitrate?t.options.minBitrate:t.options.bitrate.video<200?t.options.bitrate.video:200,r.prev=1,t.localStream.getTracks().forEach((function(r){var i=[];if("video"===r.kind){var n=t.options,s=n.isEnableSmallStream,a=n.smallStreamConfig,c=n.screen,u=r.getSettings();t.captureVideoWidth=u.width,t.captureVideoHeight=u.height,s&&!c&&(i.push({rid:"h",active:!0,scaleResolutionDownBy:1}),i.push({rid:"l",active:!0,scaleResolutionDownBy:t.captureVideoHeight/a.height,maxBitrate:1e3*a.bitrate}),o=t.options.minBitrate?t.options.minBitrate:t.options.bitrate.video<600?t.options.bitrate.video:600)}t.transceiver=t.peerConnection.addTransceiver(r.kind,{direction:"sendonly",sendEncodings:i}),t.peerConnection.addTrack(r,e),t.filterCodecs(r)})),r.next=5,t.peerConnection.createOffer();case 5:a=[],(s=r.sent).sdp.includes("video")&&(c=(c=s.sdp.split("\r\n")).map((function(e){if(e.includes("a=rtpmap")&&!e.toLowerCase().includes("h264")){var t=e.indexOf(":")+1,r=e.indexOf(" ");a.push(e.slice(t,r))}return e.includes("a=fmtp:")&&o?e+";x-google-min-bitrate=".concat(o):e})),a.length&&a.forEach((function(e){c=c.filter((function(t){return!(t.includes("a=rtpmap:"+e)||t.includes("a=fmtp:"+e)||t.includes("a=rtcp-fb:"+e))}))})),s.sdp=c.join("\r\n")),s.sdp.includes("audio")&&((u=s.sdp.split("\r\n")).forEach((function(e){if(e.includes("a=rtpmap")&&!e.toLowerCase().includes("opus")){var t=e.indexOf(":")+1,r=e.indexOf(" ");a.push(e.slice(t,r))}})),a.length&&a.forEach((function(e){u=u.filter((function(t){return!(t.includes("a=rtpmap:"+e)||t.includes("a=fmtp:"+e)||t.includes("a=rtcp-fb:"+e))}))})),s.sdp=u.join("\r\n")),i(s),t.peerConnection.setLocalDescription(s),r.next=18;break;case 13:throw r.prev=13,r.t0=r.catch(1),t.logger.onError({c:jr.TOP_ERROR,v:gt.CREATE_OFFER_FAILED},"code:".concat(gt.CREATE_OFFER_FAILED,",create offer error!, ").concat(r.t0)),t.state=Nr.Create,new It({code:gt.CREATE_OFFER_FAILED,message:"create offer error!,".concat(r.t0)});case 18:case"end":return r.stop()}}),r,null,[[1,13]])})));return function(e,t){return r.apply(this,arguments)}}())}},{key:"onConnectionstatechange",value:function(e){var t=this;["failed","connected"].includes(this.peerConnection.connectionState)&&this._emitter.emit("publish-ice-state",{state:this.peerConnection.connectionState,streamId:this.streamId}),this.logger.info("peerConnection ".concat(e," ICE State: ").concat(this.peerConnection.connectionState)),"connecting"===this.peerConnection.connectionState?-1===this._interval&&(this._interval=window.setInterval((function(){t.getRTCIceCandidatePairStats()}),this.times)):"connected"===this.peerConnection.connectionState?(this.localStream.getTracks().forEach((function(e){(t.peerConnection.getSenders()||[]).forEach((function(t){t.replaceTrack(e)}))})),clearInterval(this._interval)):clearInterval(this._interval)}},{key:"filterCodecs",value:function(e){if(RTCRtpSender.getCapabilities){var t=RTCRtpSender.getCapabilities(e.kind).codecs.filter((function(t){return"audio"===e.kind?-1!=t.mimeType.indexOf("opus"):-1!=t.mimeType.indexOf("H264")}));this.transceiver.setCodecPreferences&&"function"==typeof this.transceiver.setCodecPreferences&&this.transceiver.setCodecPreferences(t)}}},{key:"setRemoteDesc",value:function(e,t){var r=this;return new Promise((function(i,n){r.logger.info("=======publish answer========\n",e),r.state=Nr.Published,r.streamId=t,r.peerConnection.setRemoteDescription({sdp:e,type:"answer"}).then((function(){r.setBandwidth(r.options.bitrate),i(!0)})).catch((function(e){r.logger.error("publish setRemoteDescription error",e),n(e)}))}))}},{key:"getPeerConnection",value:function(){return this.peerConnection}},{key:"close",value:function(){this.peerConnection&&(this.peerConnection.onicecandidate=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.close()),this.peerConnection=null,this.transceiver=null,this._interval&&clearInterval(this._interval),this._interval=null,this.timer&&clearInterval(this.timer),this.timer=null,this.audioBytesSentIs0Count=0,this.videoBytesSentIs0Count=0,this.recoverCaptureCount=0,this.logger.info("close publish stream peerConnection,streamId",this.streamId)}},{key:"setBandwidth",value:function(e){var t=this,r=this.peerConnection.getSenders(),i=e.audio,n=e.video;r.forEach((function(e){var r=e.getParameters();if(r.encodings.length||(r.encodings=[{}]),"video"===e.track.kind){var o=t.options;o.isEnableSmallStream&&!o.screen&&t.onchangeNet(e),r.encodings[0].maxBitrate=t.options.maxBitrate?1e3*t.options.maxBitrate:1e3*n}"audio"===e.track.kind&&(r.encodings[0].maxBitrate=1e3*i),t.logger.info("encodings",JSON.stringify(r.encodings)),e.setParameters(r).then((function(){t.logger.info("".concat(e.track.kind," set bitrate to ").concat(r.encodings[0].maxBitrate," success"))}),(function(r){t.logger.warn("".concat(e.track.kind," set bitrate error"),r)}))}))}},{key:"onchangeNet",value:function(e){var t,r=this,i=0,n=0;this.timer=setInterval(Ze(ot.mark((function o(){var s,a,c,u,d,l,h,p,f;return ot.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:s=r.level,a=Date.now(),c=[],u=[];case 4:if(!(Date.now()-a<4e3)){o.next=13;break}return o.next=7,r.getLocalStats("video");case 7:return(t=o.sent)?(l=(d=t.video.retransmittedPacketsSent-i)<=0?0:Math.floor(d/(t.video.packetsSent-n)*100),i=t.video.retransmittedPacketsSent,n=t.video.packetsSent,c.push(t.rtt),u.push(l)):(c.push(0),u.push(0)),o.next=11,new Promise((function(e){return setTimeout(e,1e3)}));case 11:o.next=4;break;case 13:if(h=c.reduce((function(e,t){return e+t}),0)/c.length,p=u.reduce((function(e,t){return e+t}),0)/c.length,(f=e.getParameters()).encodings.length&&f.encodings[0]){o.next=18;break}return o.abrupt("return");case 18:if(h<150&&p<30?(f.encodings[0].scaleResolutionDownBy=1,r.level=Vr.Normal):(h>=150||p>=30)&&(r.level=Vr.Half,f.encodings[0].scaleResolutionDownBy=2),s!==r.level){o.next=21;break}return o.abrupt("return");case 21:e.setParameters(f).then((function(){r.logger.info("video onchangeBitrite set success ".concat(r.level))}),(function(e){r.logger.warn("video onchangeBitrite set failed ".concat(r.level),e)}));case 22:case"end":return o.stop()}}),o)}))),4e3)}},{key:"replaceMediaStreamTrack",value:function(e){var t=this;this.logger.info("replace mediaStream Track",e),this.peerConnection&&e&&(this.peerConnection.getSenders()||[]).forEach((function(r){if("audio"===e.kind&&r.track&&"audio"===r.track.kind){r.replaceTrack(e);var i=t.localStream.getAudioTracks()[0];i&&t.localStream.removeTrack(i),i&&t.localStream.addTrack(e)}if("video"===e.kind&&r.track&&"video"===r.track.kind){r.replaceTrack(e);var n=t.localStream.getVideoTracks()[0];n&&t.localStream.removeTrack(n),n&&t.localStream.addTrack(e)}}));var r="audio"===e.kind?this.localStream.getAudioTracks()[0]:this.localStream.getVideoTracks()[0];r&&this.localStream.removeTrack(r),r&&this.localStream.addTrack(e)}},{key:"buildPublishParams",value:function(){var e=this,t=this.options||{},r=t.hasAudio,i=t.hasVideo,n=t.screen,o={streamType:Gt.ForwardStream,streamKind:r&&i?Ht.AudioVideo:r?Ht.AudioOnly:i?Ht.VideoOnly:Ht.Invalid,params:{offerSdp:"",audioInfo:{source:n?zt.ScreenShare:zt.Microphone,muted:t.audioMuted,floor:!0},videoInfo:{source:n?Jt.ScreenShare:Jt.Camera,muted:t.videoMuted,floor:!0}},cb:function(t,r,i){1===t?e.setRemoteDesc(i.answer_sdp,i.streamId).then((function(){e.options.onPublish&&e.options.onPublish(t,r,i)})).catch((function(t){e.options.onPublish&&e.options.onPublish(0,t,i)})):e.options.onPublish&&e.options.onPublish(t,r,i)},updateCb:function(){}},s=this.options,a=s.smallStreamConfig,c=[];if(s.isEnableSmallStream&&!n){if(this.logger.info("publish width height",this.captureVideoWidth,this.captureVideoHeight),this.captureVideoWidth>0&&this.captureVideoHeight>0){var u={type:Yt.SmallStream,maxWidth:a.width,maxHeight:a.height};c.push({type:Yt.BigStream,maxWidth:this.captureVideoWidth,maxHeight:this.captureVideoHeight}),c.push(u)}o.params.videoInfo.simulcast=c}return o}},{key:"getTransportStats",value:(r=Ze(ot.mark((function e(){var t=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){if(t.peerConnection){var i,n=(t.peerConnection.getSenders()||[])[0];n&&n.getStats().then((function(r){i=t.getSenderStats({send:r,mediaType:n.track.kind}),e(i)}),(function(e){t.logger.onError({c:jr.TOP_ERROR,v:gt.INVALID_TRANSPORT_STATA},"Get transport stats error, ".concat(e)),r(e.message)}))}})));case 1:case"end":return e.stop()}}),e)}))),function(){return r.apply(this,arguments)})},{key:"getLocalStats",value:(t=Ze(ot.mark((function e(t){var r=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,i){if(r.peerConnection){var n,o=(r.peerConnection.getSenders()||[]).find((function(e){return e.track.kind===t}));o&&o.getStats().then((function(i){n=r.getSenderStats({send:i,mediaType:t}),e(n)})).catch((function(e){i(e.message)}))}})));case 1:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})},{key:"getSenderStats",value:function(e){var t=this,r={audio:{bytesSent:0,packetsSent:0,retransmittedPacketsSent:0,audioLevel:0},video:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,retransmittedPacketsSent:0,framesPerSecond:0,rid:"h"},smallVideo:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,retransmittedPacketsSent:0,framesPerSecond:0,rid:"l"},rtt:0,timestamp:0};return e.send.forEach((function(i){if("outbound-rtp"===i.type)if(r.timestamp=i.timestamp,"video"===e.mediaType&&"l"===i.rid){if(0===i.bytesSent)return;r.smallVideo=Br(Br({},r.smallVideo),{},{bytesSent:i.bytesSent,packetsSent:i.packetsSent,framesEncoded:i.framesEncoded,retransmittedPacketsSent:i.retransmittedPacketsSent||0,framesPerSecond:i.framesPerSecond||0,frameWidth:i.frameWidth||0,frameHeight:i.frameHeight||0,framesSent:i.framesSent,rid:i.rid||"l"})}else if("video"===e.mediaType){if(0===i.bytesSent)return;r.video=Br(Br({},r.video),{},{bytesSent:i.bytesSent,packetsSent:i.packetsSent,framesEncoded:i.framesEncoded,retransmittedPacketsSent:i.retransmittedPacketsSent||0,rid:i.rid||"h"}),void 0!==i.framesPerSecond&&(r.video.framesPerSecond=i.framesPerSecond),void 0!==i.frameWidth&&(r.video.frameWidth=i.frameWidth),void 0!==i.frameHeight&&(r.video.frameHeight=i.frameHeight),void 0!==i.framesSent&&(r.video.framesSent=i.framesSent)}else"audio"===e.mediaType&&(r.audio=Br(Br({},r.audio),{},{bytesSent:i.bytesSent,packetsSent:i.packetsSent,retransmittedPacketsSent:i.retransmittedPacketsSent||0}));else if("candidate-pair"===i.type)"number"==typeof i.currentRoundTripTime&&(r.rtt=1e3*i.currentRoundTripTime);else if("track"===i.type){if(void 0!==i.frameWidth){var n=t.localStream.getVideoTracks();n.length&&n[0].id===i.trackIdentifier&&(r.video.frameWidth=i.frameWidth,r.video.frameHeight=i.frameHeight,r.video.framesSent=i.framesSent)}}else if("media-source"===i.type)if("video"===i.kind){var o=t.localStream.getVideoTracks();o.length&&o[0].id===i.trackIdentifier&&void 0!==i.framesPerSecond&&(r.video.framesPerSecond=i.framesPerSecond)}else"audio"===i.kind&&(r.audio.audioLevel=i.audioLevel||0)})),r}},{key:"onPublishPeerConnectionFailed",value:function(e){this._emitter.on("publish-ice-state",e)}},{key:"getRTCIceCandidatePairStats",value:function(){var e=this;this.peerConnection&&this.peerConnection.getStats().then((function(t){t.forEach((function(t){"candidate-pair"===t.type&&e.logger.warn("publish RTCIceCandidatePairStats",JSON.stringify(t,null,4))}))}))}},{key:"updateBytesSentIs0Count",value:function(e){var t=this;if("audio"===e){var r,i=this.localStream.getAudioTracks();i.length&&"connected"===(null===(r=this.peerConnection)||void 0===r?void 0:r.connectionState)&&(this.audioBytesSentIs0Count+=1,this.audioBytesSentIs0Count>=4&&this.recoverCaptureCount<=5&&(this.recoverCaptureCount+=1,this.audioBytesSentIs0Count=0,i.forEach((function(e){(t.peerConnection.getSenders()||[]).forEach((function(t){"audio"===t.track.kind&&t.replaceTrack(e)}))})),this.logger.info("replace the track because the audio bytes sent is 0,recover count:",this.recoverCaptureCount)))}else if("video"===e){var n,o=this.localStream.getVideoTracks();o.length&&"connected"===(null===(n=this.peerConnection)||void 0===n?void 0:n.connectionState)&&(this.videoBytesSentIs0Count+=1,this.videoBytesSentIs0Count>=4&&this.recoverCaptureCount<=5&&(this.recoverCaptureCount+=1,this.videoBytesSentIs0Count=0,o.forEach((function(e){(t.peerConnection.getSenders()||[]).forEach((function(t){"video"===t.track.kind&&t.replaceTrack(e)}))})),this.logger.info("replace the track because the video bytes sent is 0,recover count:",this.recoverCaptureCount)))}}}]),e}();function Gr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function Hr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Gr(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Gr(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var $r,zr=function(){function e(t){tt(this,e),this.subscribedStreams=new Map,this.subscriptedOptions=new Map,this.subscriptedState=new Map,this.logger=t}return it(e,[{key:"addSubscriptionRecord",value:function(e,t){this.subscribedStreams.set(e,t)}},{key:"setSubscriptionOpts",value:function(e,t){this.logger.debug("set subscribe options:",t),this.subscriptedOptions.set(e,t)}},{key:"getSubscriptionOpts",value:function(e){return this.subscriptedOptions.get(e)||{audio:!0,video:!0,small:!1}}},{key:"updateSubscriptedState",value:function(e,t){var r=Hr(Hr({},this.getSubscriptedState(e)),t);this.subscriptedState.set(e,r),this.logger.info("-----\x3e update subscribe state <----------",e,JSON.stringify(r))}},{key:"getSubscriptedState",value:function(e){return this.subscriptedState.get(e)||{audio:!1,video:!1,small:!1}}},{key:"needSubscribeKind",value:function(e){var t=this.subscriptedState.get(e)||{audio:!1,video:!1},r=this.subscriptedOptions.get(e)||{audio:!1,video:!1};return this.logger.info("subscribe state",t),this.logger.info("subscribe options:",r),r.audio&&!t.audio&&r.video&&!t.video?lt.AudioVideo:r.audio&&!t.audio?lt.AudioOnly:r.video&&!t.video?lt.VideoOnly:void 0}},{key:"reset",value:function(e){if(e)return this.subscriptedState.delete(e),this.subscribedStreams.delete(e),void this.subscriptedOptions.delete(e);this.subscriptedState.clear(),this.subscribedStreams.clear(),this.subscriptedOptions.clear()}}]),e}(),Jr=nt((function(e){var t=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),(t+=null!=e["network-id"]?" network-id %d":"%v")+(null!=e["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",(t+=null!=e.rateNumerator?" rate=%s":"")+(null!=e.rateDenominator?"/%s":"")}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(t).forEach((function(e){t[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))})),Yr=nt((function(e,t){var r=function(e){return String(Number(e))===e?Number(e):e},i=function(e,t,i){var n=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:n&&!t[e.name]&&(t[e.name]={});var o=e.push?{}:n?t[e.name]:t;!function(e,t,i,n){if(n&&!i)t[n]=r(e[1]);else for(var o=0;o<i.length;o+=1)null!=e[o+1]&&(t[i[o]]=r(e[o+1]))}(i.match(e.reg),o,e.names,e.name),e.push&&t[e.push].push(o)},n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},r=[],o=t;return e.split(/(\r\n|\r|\n)/).filter(n).forEach((function(e){var t=e[0],n=e.slice(2);"m"===t&&(r.push({rtp:[],fmtp:[]}),o=r[r.length-1]);for(var s=0;s<(Jr[t]||[]).length;s+=1){var a=Jr[t][s];if(a.reg.test(n))return i(a,o,n)}})),t.media=r,t};var o=function(e,t){var i=t.split(/=(.+)/,2);return 2===i.length?e[i[0]]=r(i[1]):1===i.length&&t.length>1&&(e[i[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],i=e.split(" ").map(r),n=0;n<i.length;n+=3)t.push({component:i[n],ip:i[n+1],port:i[n+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,i=!1;return"~"!==e[0]?t=r(e):(t=r(e.substring(1,e.length)),i=!0),{scid:t,paused:i}}))}))}})),Kr=/%[sdv%]/g,qr=function(e){var t=1,r=arguments,i=r.length;return e.replace(Kr,(function(e){if(t>=i)return e;var n=r[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},Xr=function(e,t,r){var i=[e+"="+(t.format instanceof Function?t.format(t.push?r:r[t.name]):t.format)];if(t.names)for(var n=0;n<t.names.length;n+=1)i.push(t.name?r[t.name][t.names[n]]:r[t.names[n]]);else i.push(r[t.name]);return qr.apply(null,i)},Qr=["v","o","s","i","u","e","p","c","b","t","r","z","a"],Zr=["i","c","b","a"],ei=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var r=t.innerOrder||Zr,i=[];return(t.outerOrder||Qr).forEach((function(t){Jr[t].forEach((function(r){r.name in e&&null!=e[r.name]?i.push(Xr(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach((function(e){i.push(Xr(t,r,e))}))}))})),e.media.forEach((function(e){i.push(Xr("m",Jr.m[0],e)),r.forEach((function(t){Jr[t].forEach((function(r){r.name in e&&null!=e[r.name]?i.push(Xr(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach((function(e){i.push(Xr(t,r,e))}))}))}))})),i.join("\r\n")+"\r\n"},ti=Yr.parse,ri=Yr.parsePayloads;function ii(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function ni(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ii(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ii(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function oi(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return si(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?si(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function si(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}!function(e){e[e.Create=0]="Create",e[e.Subscribing=1]="Subscribing",e[e.Subscribed=2]="Subscribed",e[e.Unsubscribed=3]="Unsubscribed"}($r||($r={}));var ai,ci=function(){function e(t){tt(this,e),this.options=t,this.userId=t.userId,this.logger=t.logger,this.xsigoClient=t.xsigoClient||null,this.roomId=t.roomId,this.peerConnection=new RTCPeerConnection({sdpSemantics:"unified-plan"}),this.peerConnection.onnegotiationneeded=this.onNegotiationNeeded.bind(this),this.peerConnection.ontrack=this.onTrack.bind(this),this.state=$r.Create,this.subscriptionId=null,this._emitter=new st,this._interval=-1,this.times=2e3,this.isAlphaChannels=!1}var t;return it(e,[{key:"getState",value:function(){return this.state}},{key:"subscribe",value:function(){var e=this;return new Promise((function(t,r){e.logger.info("start subscribing to the stream"),e.state=$r.Subscribing,e.addTransceiver(),e.createOffer(),e.peerConnection.onconnectionstatechange=e.onConnectionstatechange.bind(e,"subscribe");var i="";e.peerConnection.onicecandidate=function(n){var o=n.candidate;e.logger.info("peercConnection subscribe IceCandidate data:\n ".concat((null==o?void 0:o.candidate)||"")),null!=o&&o.candidate&&(i=i+"a="+o.candidate+"\r\n");var s=!1,a=window.setTimeout((function(){s=!0}),e.times);if(!o||s){window.clearTimeout(a);var c=e.peerConnection.pendingLocalDescription.sdp;if(c.toLocaleLowerCase().includes("video")&&!c.toLowerCase().includes("h264"))e.logger.warn("=======subscribe offer========\n",c),r("H264 not supported");else{c.includes("a=candidate")||(c+=i);var u=e.buildSubscribeParams();u.params.offerSdp=c,e.logger.info("=======subscribe offer========\n",c),e.subscriptionId=e.xsigoClient.subscribeStream(e.roomId,u),t(e.subscriptionId)}}}}))}},{key:"resubscribe",value:function(){var e=this;return new Promise((function(t,r){e.logger.info("resubscribe stream",e.subscriptionId),e.close(),e.peerConnection=new RTCPeerConnection({sdpSemantics:"unified-plan"}),e.state=$r.Subscribing,e.addTransceiver(),e.createOffer(),e.peerConnection.onconnectionstatechange=e.onConnectionstatechange.bind(e,"resubscribe"),e.peerConnection.ontrack=e.onTrack.bind(e);var i="";e.peerConnection.onicecandidate=function(r){var n=r.candidate;e.logger.info("peercConnection resubscribe IceCandidate data:\n ".concat((null==n?void 0:n.candidate)||"")),null!=n&&n.candidate&&(i=i+"a="+n.candidate+"\r\n");var o=!1,s=window.setTimeout((function(){o=!0}),e.times);if(!n||o){window.clearTimeout(s);var a=e.peerConnection.pendingLocalDescription;a.sdp.includes("a=candidate")||(a.sdp=a.sdp+i),e.logger.info("=======resubscribe offer========\n",a.sdp),t(a)}}}))}},{key:"unsubscribe",value:function(e){var t=this;this.logger.info("unsubscribe subscriptionId",this.subscriptionId),this.xsigoClient.unsubscribeStream(this.roomId,this.subscriptionId,(function(r,i,n){1===r&&(t.state=$r.Unsubscribed,t.close()),e(r,i,n)}))}},{key:"switchSimulcast",value:function(e,t){this.xsigoClient.switchSimulcast(this.roomId,this.subscriptionId,{type:e},t)}},{key:"setRemoteDescription",value:function(e){var t=this;return new Promise((function(r,i){t.logger.info("=======subscribe answer========\n"+e),t.isAlphaChannels=e.includes("a=xrtc-alpha"),t.peerConnection.setRemoteDescription({sdp:e,type:"answer"}).then((function(){t.state=$r.Subscribed,r(!0)})).catch((function(e){t.logger.error("subscribe setRemoteDescription error",e),i(e)}))}))}},{key:"onConnectionstatechange",value:function(e){var t=this;["failed","connected"].includes(this.peerConnection.connectionState)&&this._emitter.emit("subscribe-ice-state",{state:this.peerConnection.connectionState,subscriptionId:this.subscriptionId}),this.logger.info("peerConnection ".concat(e," ICE State: ").concat(this.peerConnection.connectionState)),"connecting"===this.peerConnection.connectionState?-1===this._interval&&(this._interval=window.setInterval((function(){t.getRTCIceCandidatePairStats()}),this.times)):clearInterval(this._interval)}},{key:"addTransceiver",value:function(){if(this.options.hasAudio){var e=this.peerConnection.addTransceiver("audio",{direction:"recvonly"});if(RTCRtpSender.getCapabilities){var t=RTCRtpSender.getCapabilities("audio");e.setCodecPreferences&&"function"==typeof e.setCodecPreferences&&e.setCodecPreferences(t.codecs)}}if(this.options.hasVideo){var r=this.peerConnection.addTransceiver("video",{direction:"recvonly"});if(RTCRtpSender.getCapabilities){var i=RTCRtpSender.getCapabilities("video");r.setCodecPreferences&&"function"==typeof r.setCodecPreferences&&r.setCodecPreferences(i.codecs)}}}},{key:"createOffer",value:function(){var e=this;this.peerConnection.createOffer().then(this.onGotOffer.bind(this)).catch((function(t){e.logger.error("create offer error",t),e.state=$r.Create}))}},{key:"onGotOffer",value:function(e){var t,r=this,i=ti(e.sdp),n=oi(i.media);try{for(n.s();!(t=n.n()).done;){var o,s=t.value,a=oi(ri(s.payloads));try{for(a.s();!(o=a.n()).done;){var c=o.value;s.rtcpFb=s.rtcpFb?[].concat(et(s.rtcpFb),[{payload:c,type:"rrtr"}]):[{payload:c,type:"rrtr"}]}}catch(e){a.e(e)}finally{a.f()}}}catch(e){n.e(e)}finally{n.f()}var u={sdp:ei(i),type:"offer"};this.peerConnection.setLocalDescription(u).then((function(){r.logger.info("Set local description success",r.subscriptionId)})).catch((function(e){r.logger.error("Set local description failure",e)}))}},{key:"onNegotiationNeeded",value:function(){this.logger.info("onNegotiationneeded--")}},{key:"onTrack",value:function(e){this.logger.debug("on track return");var t=this.options||{},r=t.hasAudio,i=r&&t.hasVideo?Ht.AudioVideo:r?Ht.AudioOnly:Ht.VideoOnly,n=e.streams[0],o=e.track;t.audioStreamId||t.videoStreamId?this.options.onRemoteStream(n,o,i,this.isAlphaChannels):this.logger.info("not audio or video")}},{key:"getPeerConnection",value:function(){return this.peerConnection}},{key:"close",value:function(){this.peerConnection&&(this.peerConnection.onicecandidate=null,this.peerConnection.onnegotiationneeded=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.ontrack=null,this.peerConnection.close()),this.peerConnection=null,this._interval&&clearInterval(this._interval),this.logger.info("close subscribe stream peerConnection subscriptionId",this.subscriptionId)}},{key:"buildSubscribeParams",value:function(){var e=this,t=this.options||{},r=t.hasAudio,i=t.hasVideo,n=t.simulcast,o={publisherUserId:t.publisherUserId,streamId:r?t.audioStreamId:t.videoStreamId,streamKind:r&&i?Ht.AudioVideo:r?Ht.AudioOnly:Ht.VideoOnly,params:{offerSdp:"",hasAudio:r,hasVideo:i,type:(null==n?void 0:n.length)>0&&n[0].type},cb:function(t,r,i){1===t?e.setRemoteDescription(i.answer_sdp).then((function(){e.options.onSubscribe&&e.options.onSubscribe(t,r,i)})).catch((function(t){e.logger.error("setRemoteDescription is failed",t),e.options.onSubscribe&&e.options.onSubscribe(0,t,i)})):e.options.onSubscribe&&e.options.onSubscribe(t,r,i)},updateCb:function(){}};return t.small&&i&&((n||[]).find((function(e){return e.type===Yt.SmallStream}))?o.params.type=Yt.SmallStream:this.logger.warn("does not publish small stream")),o}},{key:"getTransportStats",value:(t=Ze(ot.mark((function e(){var t=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){if(t.peerConnection){var i=(t.peerConnection.getReceivers()||[])[0];i&&i.getStats().then((function(r){var n=t.getReceiverStats({send:r,mediaType:i.track.kind});e(n.rtt)})).catch((function(e){r(e)}))}})));case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"getRemoteAudioOrVideoStats",value:function(e){var t=this;return new Promise((function(r,i){if(t.peerConnection){var n=t.peerConnection.getReceivers().find((function(t){return t.track.kind===e}));n&&n.getStats().then((function(i){var n=t.getReceiverStats({send:i,mediaType:e});r(n)})).catch((function(e){i(e)}))}}))}},{key:"getReceiverStats",value:function(e){var t={audio:{bytesReceived:0,packetsReceived:0,packetsLost:0,nackCount:0,audioLevel:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesDecoded:0,frameWidth:0,frameHeight:0,framesPerSecond:0,nackCount:0},rtt:0,timestamp:0};return e.send.forEach((function(r){if("inbound-rtp"===r.type)if(t.timestamp=r.timestamp,"audio"===e.mediaType)t.audio=ni(ni({},t.audio),{},{bytesReceived:r.bytesReceived,packetsReceived:r.packetsReceived,packetsLost:r.packetsLost}),void 0!==r.nackCount&&(t.audio.nackCount=r.nackCount),void 0!==r.audioLevel&&(t.audio.audioLevel=r.audioLevel);else{if(0===r.bytesReceived)return;t.video=ni(ni({},t.video),{},{bytesReceived:r.bytesReceived,packetsReceived:r.packetsReceived,packetsLost:r.packetsLost,framesDecoded:r.framesDecoded,framesPerSecond:r.framesPerSecond||0,nackCount:r.nackCount}),void 0!==r.frameWidth&&(t.video.frameWidth=r.frameWidth),void 0!==r.frameHeight&&(t.video.frameHeight=r.frameHeight)}else"track"===r.type?void 0!==r.frameWidth?t.video=ni(ni({},t.video),{},{frameWidth:r.frameWidth,frameHeight:r.frameHeight}):void 0!==r.audioLevel&&(t.audio.audioLevel=r.audioLevel||0):"candidate-pair"===r.type&&"number"==typeof r.currentRoundTripTime&&(t.rtt=1e3*r.currentRoundTripTime)})),t}},{key:"onSubscribePeerConnectionFailed",value:function(e){this._emitter.on("subscribe-ice-state",e)}},{key:"getRTCIceCandidatePairStats",value:function(){var e=this;this.peerConnection&&this.peerConnection.getStats().then((function(t){t.forEach((function(t){"candidate-pair"===t.type&&e.logger.warn("subscribe RTCIceCandidatePairStats",JSON.stringify(t,null,4))}))}))}}]),e}();function ui(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function di(e){var t,r=new Array,i=function(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return ui(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ui(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}(e);try{for(i.s();!(t=i.n()).done;){var n=t.value,o={type:sr(n.rid),maxWidth:n.maxWidth,maxHeight:n.maxHeight};r.push(o)}}catch(e){i.e(e)}finally{i.f()}return r}function li(e){var t={userId:e.userId,streamId:e.streamId,type:er(e.type)};return e.info&&(t.info={},e.info.audio&&(t.info.audio={source:rr(e.info.audio.source),muted:e.info.audio.muted,floor:e.info.audio.floor}),e.info.video&&(t.info.video={source:nr(e.info.video.source),muted:e.info.video.muted,floor:e.info.video.floor},e.info.video.simulcast&&(t.info.video.simulcast=di(e.info.video.simulcast)))),t}function hi(e){var t={userId:e.userId,streamId:e.streamId,type:er(e.data.type)};return e.data.media.info&&(t.info={},e.data.media.info.audio&&(t.info.audio={source:rr(e.data.media.info.audio.source),muted:e.data.media.info.audio.muted,floor:e.data.media.info.audio.floor}),e.data.media.info.video&&(t.info.video={source:nr(e.data.media.info.video.source),muted:e.data.media.info.video.muted,floor:e.data.media.info.video.floor},e.data.media.info.video.simulcast&&(t.info.video.simulcast=di(e.data.media.info.video.simulcast)))),t}!function(e){e[e.Created=0]="Created",e[e.Entering=1]="Entering",e[e.EnterFailed=2]="EnterFailed",e[e.EnterTimeout=3]="EnterTimeout",e[e.Entered=4]="Entered",e[e.Exiting=5]="Exiting",e[e.ExitFailed=6]="ExitFailed",e[e.ExitTimeout=7]="ExitTimeout",e[e.Exited=8]="Exited",e[e.Destroyed=9]="Destroyed",e[e.StateMax=10]="StateMax"}(ai||(ai={}));var pi,fi=["Created","Entering","EnterFailed","EnterTimeout","Entered","Exiting","ExitFailed","ExitTimeout","Exited","Destroyed"],mi=function(){function e(t){tt(this,e),this.currentState=ai.Created,this.stateTransformTable=new Array,this.logger=t,this.initStateTransformTable()}return it(e,[{key:"setState",value:function(e){return this.checkStateChange(this.currentState,e)?(this.logger.info("RoomState : state change from "+fi[this.currentState]+" to "+fi[e]),this.currentState=e,!0):(this.logger.error("RoomState : INVALID state change from "+fi[this.currentState]+" to "+fi[e]),!1)}},{key:"state",value:function(){return this.currentState}},{key:"checkStateChange",value:function(e,t){return this.stateTransformTable[e][t]}},{key:"initStateTransformTable",value:function(){for(var e=ai.Created;e<ai.StateMax;e++){this.stateTransformTable[e]=new Array;for(var t=ai.Created;t<ai.StateMax;t++)this.stateTransformTable[e][t]=!1}this.stateTransformTable[ai.Created][ai.Entering]=!0,this.stateTransformTable[ai.Created][ai.Destroyed]=!0,this.stateTransformTable[ai.Entering][ai.Entered]=!0,this.stateTransformTable[ai.Entering][ai.EnterFailed]=!0,this.stateTransformTable[ai.Entering][ai.EnterTimeout]=!0,this.stateTransformTable[ai.Entering][ai.Destroyed]=!0,this.stateTransformTable[ai.EnterFailed][ai.Destroyed]=!0,this.stateTransformTable[ai.EnterTimeout][ai.Destroyed]=!0,this.stateTransformTable[ai.Entered][ai.Exiting]=!0,this.stateTransformTable[ai.Entered][ai.Destroyed]=!0,this.stateTransformTable[ai.Exiting][ai.Exited]=!0,this.stateTransformTable[ai.Exiting][ai.ExitTimeout]=!0,this.stateTransformTable[ai.Exiting][ai.Destroyed]=!0,this.stateTransformTable[ai.Exited][ai.Destroyed]=!0}}]),e}();!function(e){e[e.New=0]="New",e[e.Logining=1]="Logining",e[e.LoginFailed=2]="LoginFailed",e[e.LoginTimeout=3]="LoginTimeout",e[e.Logined=4]="Logined",e[e.Relogining=5]="Relogining",e[e.Relogined=6]="Relogined",e[e.Logouting=7]="Logouting",e[e.LogoutTimeout=8]="LogoutTimeout",e[e.Logouted=9]="Logouted",e[e.Destroyed=10]="Destroyed",e[e.StateMax=11]="StateMax"}(pi||(pi={}));var gi,vi,yi=["New","Logining","LoginFailed","LoginTimeout","Logined","Relogining","Relogined","Logouting","LogoutTimeout","Logouted","Destroy"],bi=function(){function e(t){tt(this,e),this.currentState=pi.New,this.stateTransformTable=new Array,this.logger=t,this.initStateTransformTable()}return it(e,[{key:"setState",value:function(e){return this.checkStateChange(this.currentState,e)?(this.logger.info("Login : state change from "+yi[this.currentState]+" to "+yi[e]),this.currentState=e,!0):(this.logger.error("Login : INVALID state change from "+yi[this.currentState]+" to "+yi[e]),!1)}},{key:"state",value:function(){return this.currentState}},{key:"checkStateChange",value:function(e,t){return this.stateTransformTable[e][t]}},{key:"initStateTransformTable",value:function(){for(var e=pi.New;e<pi.StateMax;e++){this.stateTransformTable[e]=new Array;for(var t=pi.New;t<pi.StateMax;t++)this.stateTransformTable[e][t]=!1}this.stateTransformTable[pi.New][pi.Logining]=!0,this.stateTransformTable[pi.New][pi.Destroyed]=!0,this.stateTransformTable[pi.Logining][pi.Logined]=!0,this.stateTransformTable[pi.Logining][pi.LoginFailed]=!0,this.stateTransformTable[pi.Logining][pi.LoginTimeout]=!0,this.stateTransformTable[pi.Logining][pi.Destroyed]=!0,this.stateTransformTable[pi.LoginFailed][pi.Destroyed]=!0,this.stateTransformTable[pi.LoginTimeout][pi.Destroyed]=!0,this.stateTransformTable[pi.Logined][pi.Logouting]=!0,this.stateTransformTable[pi.Logined][pi.Relogining]=!0,this.stateTransformTable[pi.Logined][pi.Destroyed]=!0,this.stateTransformTable[pi.Relogining][pi.Relogining]=!0,this.stateTransformTable[pi.Relogining][pi.Relogined]=!0,this.stateTransformTable[pi.Relogining][pi.Logined]=!0,this.stateTransformTable[pi.Relogining][pi.Destroyed]=!0,this.stateTransformTable[pi.Relogined][pi.Relogining]=!0,this.stateTransformTable[pi.Relogined][pi.Logouting]=!0,this.stateTransformTable[pi.Relogined][pi.Destroyed]=!0,this.stateTransformTable[pi.Logouting][pi.Logouted]=!0,this.stateTransformTable[pi.Logouting][pi.LogoutTimeout]=!0,this.stateTransformTable[pi.Logouting][pi.Destroyed]=!0,this.stateTransformTable[pi.Logouted][pi.Destroyed]=!0}}]),e}();function Si(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function Ei(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Si(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Si(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}!function(e){e[e.LoginSuccess=0]="LoginSuccess",e[e.LoginTimeout=1]="LoginTimeout",e[e.LoginFailed=2]="LoginFailed"}(gi||(gi={})),function(e){e[e.LogoutSuccess=0]="LogoutSuccess",e[e.LogoutTimeout=1]="LogoutTimeout",e[e.LogoutFailed=2]="LogoutFailed"}(vi||(vi={}));var Ci,Ti=function(){function e(t){tt(this,e),this.options=t,this.state=new bi(t.logger),this.connectionStatus=Ft.New,this.timeout=1e4}return it(e,[{key:"login",value:function(){var e=this;if(this.state.setState(pi.Logining)){this.options.logger.info("Login room: ".concat(this.options.roomId));var t=null;this.buildLoginReuqest();var r={method:"login",params:this.loginRequestParams};t||(t=setTimeout((function(){e.options.logger.info("login timeout: ".concat(e.options.roomId)),e.state.setState(pi.LoginTimeout)&&(t&&clearTimeout(t),t=null,e.options.loginCb&&e.options.loginCb(gi.LoginTimeout,null,"login timeout"))}),this.timeout)),this.options.rpcClient.sendRequest(r,(function(r){if(e.state.setState(pi.Logined)&&(t&&clearTimeout(t),t=null,e.options.loginCb)){var i=r.result.room,n={room:Ei(Ei({},i),{},{roomUniqueId:i.roomUniqueId||i.roomId,participants:i.participants||[],streams:i.streams||[]})};e.options.loginCb(gi.LoginSuccess,n)}}),(function(r){e.state.setState(pi.LoginFailed)&&(t&&clearTimeout(t),t=null,e.options.loginCb&&e.options.loginCb(gi.LoginFailed,null,r.error.message))}))||this.options.logger.error("Json Rpc Client send login request error")}}},{key:"logout",value:function(){var e=this;if(this.state.setState(pi.Logouting)){this.options.logger.info("Logout room: ".concat(this.options.roomId));var t=null;this.options.rpcClient.sendRequest({method:"logout"},(function(r){e.state.setState(pi.Logouted)&&(t&&clearTimeout(t),t=null,e.options.logoutCb&&e.options.logoutCb(vi.LogoutSuccess))}),(function(r){e.state.setState(pi.LoginFailed)&&(t&&clearTimeout(t),t=null,e.options.logoutCb&&e.options.logoutCb(vi.LogoutFailed,r.error.message))}))||this.options.logger.error("Json Rpc Client send loginout request error"),t||(t=setTimeout((function(){e.options.logger.info("logout timeout: ".concat(e.options.roomId)),e.state.setState(pi.LogoutTimeout)&&(t&&clearTimeout(t),t=null,e.options.logoutCb&&e.options.logoutCb(vi.LogoutTimeout,"logout timeout"))}),this.timeout))}}},{key:"relogin",value:function(){var e=this;this.state.setState(pi.Relogining)&&(this.buildLoginReuqest(),this.options.logger.info("Relogin room: ".concat(this.options.roomId)),this.options.rpcClient.sendRequest({method:"login",params:this.loginRequestParams},(function(t){if(e.state.setState(pi.Relogined)&&e.options.reloginCb){var r=t.result.room,i={room:Ei(Ei({},r),{},{roomUniqueId:r.roomUniqueId||r.roomId,participants:r.participants||[],streams:r.streams||[]})};e.options.reloginCb(!0,r.sessionTimeout,i)}}),(function(t){e.options.logger.info("relogining failed")}))||this.options.logger.error("Json Rpc Client send relogin request error"))}},{key:"updatePermission",value:function(e){this.options.permission=e}},{key:"onConnectionLost",value:function(){this.connectionStatus=Ft.ConnectionLost}},{key:"onConnectionRecovery",value:function(){this.connectionStatus=Ft.ConnectionRecovery,this.relogin()}},{key:"buildLoginReuqest",value:function(){this.loginRequestParams={appId:this.options.appId,userId:this.options.userId,type:this.options.userType,roomId:this.options.roomId,previousRoomId:this.options.previousRoomId,permission:this.options.permission,userAgent:this.options.userAgent,userData:this.options.userData,protocol:"1.0"}}}]),e}();!function(e){e[e.Create=0]="Create",e[e.Publishing=1]="Publishing",e[e.Published=2]="Published",e[e.Republishing=3]="Republishing",e[e.Republished=4]="Republished",e[e.Unpublishing=5]="Unpublishing",e[e.Unpublished=6]="Unpublished",e[e.Destroyed=7]="Destroyed",e[e.StateMax=8]="StateMax"}(Ci||(Ci={}));var Ri=["Create","Publishing","Published","Republishing","Republished","Unpublishing","Unpublished","Destroy"],_i=function(){function e(t){tt(this,e),this.currentState=Ci.Create,this.stateTransformTable=new Array,this.logger=t,this.initStateTransformTable()}return it(e,[{key:"setState",value:function(e){return this.checkStateChange(this.currentState,e)?(this.logger.info("PublicationState : state change from "+Ri[this.currentState]+" to "+Ri[e]),this.currentState=e,!0):(this.logger.error("PublicationState : INVALID state change from"+Ri[this.currentState]+" to "+Ri[e]),!1)}},{key:"state",value:function(){return this.currentState}},{key:"checkStateChange",value:function(e,t){return this.stateTransformTable[e][t]}},{key:"initStateTransformTable",value:function(){for(var e=Ci.Create;e<Ci.StateMax;e++){this.stateTransformTable[e]=new Array;for(var t=Ci.Create;t<Ci.StateMax;t++)this.stateTransformTable[e][t]=!1}this.stateTransformTable[Ci.Create][Ci.Publishing]=!0,this.stateTransformTable[Ci.Create][Ci.Destroyed]=!0,this.stateTransformTable[Ci.Publishing][Ci.Published]=!0,this.stateTransformTable[Ci.Publishing][Ci.Unpublishing]=!0,this.stateTransformTable[Ci.Publishing][Ci.Destroyed]=!0,this.stateTransformTable[Ci.Publishing][Ci.Republishing]=!0,this.stateTransformTable[Ci.Published][Ci.Unpublishing]=!0,this.stateTransformTable[Ci.Published][Ci.Republishing]=!0,this.stateTransformTable[Ci.Published][Ci.Destroyed]=!0,this.stateTransformTable[Ci.Republishing][Ci.Republishing]=!0,this.stateTransformTable[Ci.Republishing][Ci.Republished]=!0,this.stateTransformTable[Ci.Republishing][Ci.Unpublishing]=!0,this.stateTransformTable[Ci.Republishing][Ci.Published]=!0,this.stateTransformTable[Ci.Republishing][Ci.Destroyed]=!0,this.stateTransformTable[Ci.Republished][Ci.Republishing]=!0,this.stateTransformTable[Ci.Republished][Ci.Unpublishing]=!0,this.stateTransformTable[Ci.Republished][Ci.Destroyed]=!0,this.stateTransformTable[Ci.Unpublishing][Ci.Unpublished]=!0,this.stateTransformTable[Ci.Unpublishing][Ci.Destroyed]=!0,this.stateTransformTable[Ci.Unpublished][Ci.Destroyed]=!0}}]),e}();function Ii(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function wi(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ii(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ii(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var ki=function(){function e(t){tt(this,e),this.options=t,this.state=new _i(t.logger),this.connectionStatus=Ft.ConnectionConnected,t.stream.info&&(t.stream.info.audio&&t.stream.info.video?(this.streamKind=Ht.AudioVideo,this.audioMuteWanted=this.options.stream.info.audio.muted,this.simulcastWanted=this.options.stream.info.video.simulcast,this.videoMuteWanted=this.options.stream.info.video.muted):t.stream.info.audio?(this.streamKind=Ht.AudioOnly,this.audioMuteWanted=this.options.stream.info.audio.muted):t.stream.info.video?(this.streamKind=Ht.VideoOnly,this.simulcastWanted=this.options.stream.info.video.simulcast,this.videoMuteWanted=this.options.stream.info.video.muted):this.options.logger.warn("now not support mix"))}return it(e,[{key:"publish",value:function(){if(this.options.logger.info("Publish stream: ".concat(this.options.stream.streamId)),this.state.setState(Ci.Publishing)){var e=this.options.rpcClient.getWsState().state;["CONNECTED","RECOVERY"].includes(e)&&this.doPublish()}}},{key:"unpublish",value:function(e){if(this.options.logger.info("Unpublish stream: "+this.options.stream.streamId),this.state.setState(Ci.Unpublishing)){this.unpublishCb=e;var t=this.options.rpcClient.getWsState().state;["CONNECTED","RECOVERY"].includes(t)?this.doUnpublish(e):this.options.logger.info("websocketState: ".concat(t,", unpublish has been cached"))}}},{key:"updateSimulcast",value:function(e,t){this.simulcastWanted=e,this.updateSimulcastCb=t;var r=this.options.rpcClient.getWsState().state,i=this.state.state();["CONNECTED","RECOVERY"].includes(r)?i===Ci.Republished||i===Ci.Published?this.doUpdateSimulcast(t):this.options.logger.info("publicationState: ".concat(r,",updateSimulcast has been cached")):this.options.logger.info("websocketState: ".concat(r,",updateSimulcast has been cached"))}},{key:"muteAudio",value:function(e,t,r,i){this.audioMuteWanted=!0,this.muteAudioOption={userId:e,cb:t,userData:i};var n=this.options.rpcClient.getWsState().state,o=this.state.state();["CONNECTED","RECOVERY"].includes(n)?o===Ci.Republished||o===Ci.Published?this.control(e,"mute",t,r,i):this.options.logger.info("publicationState: ".concat(n,",muteAudio has been cached")):this.options.logger.info("websocketState: ".concat(n,",muteAudio has been cached"))}},{key:"muteVideo",value:function(e,t,r,i){this.videoMuteWanted=!0,this.muteVideoOption={userId:e,cb:t,userData:i};var n=this.options.rpcClient.getWsState().state,o=this.state.state();["CONNECTED","RECOVERY"].includes(n)?o===Ci.Republished||o===Ci.Published?this.control(e,"vmute",t,r,i):this.options.logger.info("publicationState: ".concat(n,",muteVideo has been cached")):this.options.logger.info("websocketState: ".concat(n,",muteVideo has been cached"))}},{key:"unmuteAudio",value:function(e,t,r,i){this.audioMuteWanted=!1,this.unmuteAudioOption={userId:e,cb:t,userData:i};var n=this.options.rpcClient.getWsState().state,o=this.state.state();["CONNECTED","RECOVERY"].includes(n)?o===Ci.Republished||o===Ci.Published?this.control(e,"unmute",t,r,i):this.options.logger.info("publicationState: ".concat(n,",unmuteAudio has been cached")):this.options.logger.info("websocketState: ".concat(n,",unmuteAudio has been cached"))}},{key:"unmuteVideo",value:function(e,t,r,i){this.videoMuteWanted=!1,this.unmuteVideoOPtion={userId:e,cb:t,userData:i};var n=this.options.rpcClient.getWsState().state,o=this.state.state();["CONNECTED","RECOVERY"].includes(n)?o===Ci.Republished||o===Ci.Published?this.control(e,"unvmute",t,r,i):this.options.logger.info("publicationState: ".concat(n,",unmuteVideo has been cached")):this.options.logger.info("websocketState: ".concat(n,",unmuteVideo has been cached"))}},{key:"onConnectionLost",value:function(){}},{key:"onConnectionRecovery",value:function(e,t){if(this.options.logger.info("onConnectionRecovery streamId",this.options.stream.streamId,"sessionTimeout",e,"sdp",t),this.state.state()===Ci.Unpublishing)return this.doUnpublish(this.unpublishCb);e?t&&(this.options.offerSdp=t.sdp,this.options.stream.streamId=t.pubId,this.republish()):this.recoveryOperations()}},{key:"republish",value:function(){this.options.logger.info("start republish: "+this.options.stream.streamId),this.state.setState(Ci.Republishing)&&this.doPublish()}},{key:"recoveryOperations",value:function(){var e,t,r,i,n,o;if(this.audioMuteWanted!==(null===(e=this.options.stream.info)||void 0===e||null===(t=e.audio)||void 0===t?void 0:t.muted))if(this.audioMuteWanted){var s=this.muteAudioOption;this.control(s.userId,"mute",s.cb,s.userData)}else{var a=this.unmuteAudioOption;this.control(a.userId,"unmute",a.cb,a.userData)}if(this.videoMuteWanted!==(null===(r=this.options.stream.info)||void 0===r||null===(i=r.video)||void 0===i?void 0:i.muted))if(this.videoMuteWanted){var c=this.muteVideoOption;this.control(c.userId,"vmute",c.cb,c.userData)}else{var u=this.unmuteVideoOPtion;this.control(u.userId,"unvmute",u.cb,u.userData)}this.simulcastWanted&&null!==(n=this.options.stream.info)&&void 0!==n&&null!==(o=n.video)&&void 0!==o&&o.simulcast&&JSON.stringify(this.simulcastWanted)!==JSON.stringify(this.options.stream.info.video.simulcast)&&this.doUpdateSimulcast(this.updateSimulcastCb)}},{key:"buildPublishParams",value:function(){if(this.streamKind===Ht.AudioVideo){var e={streamId:this.options.stream.streamId,type:Zt(this.options.stream.type),media:{audio:{source:tr(this.options.stream.info.audio.source),muted:this.audioMuteWanted,floor:this.options.stream.info.audio.floor},video:{source:ir(this.options.stream.info.video.source),muted:this.videoMuteWanted,floor:this.options.stream.info.video.floor}},sdp:this.options.offerSdp};return this.simulcastWanted&&this.simulcastWanted.length&&(e.media.video.simulcast=this.simulcastWanted.map((function(e){return wi(wi({},e),{},{rid:or(e.type)})}))),e}if(this.streamKind===Ht.AudioOnly)return{streamId:this.options.stream.streamId,type:Zt(this.options.stream.type),media:{audio:{source:tr(this.options.stream.info.audio.source),muted:this.audioMuteWanted,floor:this.options.stream.info.audio.floor}},sdp:this.options.offerSdp};if(this.streamKind===Ht.VideoOnly){var t={streamId:this.options.stream.streamId,type:Zt(this.options.stream.type),media:{video:{source:ir(this.options.stream.info.video.source),muted:this.videoMuteWanted,floor:this.options.stream.info.video.floor}},sdp:this.options.offerSdp};return this.simulcastWanted&&this.simulcastWanted.length&&(t.media.video.simulcast=this.simulcastWanted.map((function(e){return wi(wi({},e),{},{rid:or(e.type)})}))),t}}},{key:"doPublish",value:function(){var e=this;try{var t=this.buildPublishParams();null!==t&&(this.options.rpcClient.sendRequest({method:"publish",params:t},(function(t){if((e.state.state()!==Ci.Publishing||e.state.setState(Ci.Published))&&(e.state.state()!==Ci.Republishing||e.state.setState(Ci.Republished))){if(e.options.publishCb){var r=t.result;e.options.publishCb(Ut.Success,null,{roomId:e.options.roomId,streamId:r.streamId,answer_sdp:r.sdp})}e.recoveryOperations()}}),(function(t){e.options.logger.info("publish stream failed"),e.options.publishCb&&e.options.publishCb(Ut.Failed,t.error.message,{roomId:e.options.roomId,streamId:e.options.stream.streamId})}))||this.options.logger.error("Json Rpc Client send publish request error"))}catch(e){this.options.publishCb&&this.options.publishCb(Ut.Failed,e,{roomId:this.options.roomId}),this.options.logger.error(e)}}},{key:"doUnpublish",value:function(e){var t=this;this.options.rpcClient.sendRequest({method:"unpublish",params:{id:this.options.stream.streamId}},(function(){t.state.setState(Ci.Unpublished)&&e&&(e(Ut.Success,null,{roomId:t.options.roomId}),t.unpublishCb=null)}),(function(r){e&&(t.options.logger.info("unpublish stream failed"),e(Ut.Failed,r.error.message,{roomId:t.options.roomId}),t.unpublishCb=null)}))||this.options.logger.error("Json Rpc Client send unpublish request error")}},{key:"doUpdateSimulcast",value:function(e){var t=this,r={method:"publishControl",params:{type:"simulcast",streamId:this.options.stream.streamId,simulcast:this.simulcastWanted.map((function(e){return{rid:or(e.type),maxWidth:e.maxWidth,maxHeight:e.maxHeight}}))}};this.options.rpcClient.sendRequest(r,(function(r){t.options.logger.info("updateSimulcast ".concat(t.options.stream.streamId," success")),t.options.stream.info.video.simulcast=t.simulcastWanted,e&&e(Ut.Success,null,t.options.roomId)}),(function(r){t.options.logger.info("updateSimulcast ".concat(t.options.stream.streamId," failed")),e&&e(Ut.Failed,r.error.message,null)}))||this.options.logger.error("Json Rpc Client send unsubscribe request error")}},{key:"control",value:function(e,t,r,i,n){var o=this,s={method:"controlCommand",params:{type:t,streamId:this.options.stream.streamId,member:e,userData:n}};this.options.logger.info("control command with",t),this.options.rpcClient.sendRequest(s,(function(n){switch(o.options.logger.info("control command with ".concat(t," success")),t){case"mute":i&&i(o.options.roomId,Bt.MuteLocal,{type:Kt.Amute,userId:e});break;case"unmute":i&&i(o.options.roomId,Bt.MuteLocal,{type:Kt.Aunmute,userId:e}),o.options.stream.info.audio.muted=o.audioMuteWanted;break;case"vmute":i&&i(o.options.roomId,Bt.MuteLocal,{type:Kt.Vmute,userId:e});break;case"unvmute":i&&i(o.options.roomId,Bt.MuteLocal,{type:Kt.Vunmute,userId:e}),o.options.stream.info.video.muted=o.videoMuteWanted}r&&r(Ut.Success,null,{roomId:o.options.roomId})}),(function(e){o.options.logger.info("control command with ".concat(t," failed")),r&&r(Ut.Failed,e.error.message,{roomId:o.options.roomId})}))||this.options.logger.error("Json Rpc Client send ControlCommand request error")}}]),e}(),Oi=function(){function e(t){tt(this,e),this.options=t,this.publiccation=new ki({roomId:this.options.roomId,stream:this.options.stream,offerSdp:this.options.offerSdp,rpcClient:this.options.rpcClient,logger:this.options.logger,publishCb:this.options.publishCb,publishUpdateCb:this.options.publishUpdateCb})}return it(e,[{key:"publish",value:function(){this.publiccation.publish()}},{key:"unpublish",value:function(e){this.publiccation.unpublish(e)}},{key:"updateSimulcast",value:function(e,t){this.publiccation.updateSimulcast(e,t)}},{key:"muteAudio",value:function(e,t,r,i){this.publiccation.muteAudio(e,t,r,i)}},{key:"muteVideo",value:function(e,t,r,i){this.publiccation.muteVideo(e,t,r,i)}},{key:"unmuteAudio",value:function(e,t,r,i){this.publiccation.unmuteAudio(e,t,r,i)}},{key:"unmuteVideo",value:function(e,t,r,i){this.publiccation.unmuteVideo(e,t,r,i)}},{key:"onConnectionLost",value:function(){this.publiccation.onConnectionLost()}},{key:"onConnectionRecovery",value:function(e,t){this.options.logger.info("localStreams onConnectionRecovery"),this.publiccation.onConnectionRecovery(e,t)}}]),e}();function Ai(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var Pi,Li=function(){function e(t){tt(this,e),this.options=t,this.permissionWanted=t.permission,this.permissionCb=null,this.localStreams=new Map}return it(e,[{key:"getUserId",value:function(){return this.options.userId}},{key:"switchPermission",value:function(e,t){this.permissionWanted=e,this.permissionCb=t;var r=this.options.rpcClient.getWsState().state;["CONNECTED","RECOVERY"].includes(r)?this.doSwitchPermission(t):this.options.logger.info("websocketState: ".concat(r,",the operation has been cached"))}},{key:"publishStream",value:function(e,t,r,i,n,o){var s={roomId:this.options.roomId,stream:{userId:this.options.userId,streamId:e,type:t,info:{}},offerSdp:i.offerSdp,rpcClient:this.options.rpcClient,logger:this.options.logger,publishCb:n,publishUpdateCb:o};r===Ht.AudioVideo&&(s.stream.info={audio:i.audioInfo,video:i.videoInfo}),r===Ht.AudioOnly&&(s.stream.info.audio=i.audioInfo),r===Ht.VideoOnly&&(s.stream.info.video=i.videoInfo);var a=new Oi(s);a.publish(),this.localStreams.set(e,a)}},{key:"unpublishStream",value:function(e,t){var r=this;this.localStreams.has(e)&&this.localStreams.get(e).unpublish((function(i,n,o){i===Ut.Success&&r.localStreams.delete(e),t&&t(i,n,o)}))}},{key:"updateSimulcast",value:function(e,t,r){this.localStreams.has(e)&&this.localStreams.get(e).updateSimulcast(t.simulcast,r)}},{key:"muteAudio",value:function(e,t,r,i){this.localStreams.has(e)&&this.localStreams.get(e).muteAudio(this.options.userId,t,r,i)}},{key:"muteVideo",value:function(e,t,r,i){this.localStreams.has(e)&&this.localStreams.get(e).muteVideo(this.options.userId,t,r,i)}},{key:"unmuteAudio",value:function(e,t,r,i){this.localStreams.has(e)&&this.localStreams.get(e).unmuteAudio(this.options.userId,t,r,i)}},{key:"unmuteVideo",value:function(e,t,r,i){this.localStreams.has(e)&&this.localStreams.get(e).unmuteVideo(this.options.userId,t,r,i)}},{key:"onConnectionLost",value:function(){}},{key:"onConnectionRecovery",value:function(e,t){if(this.options.logger.info("localUser onConnectionRecovery",e),e){var r,i=function(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Ai(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ai(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}(new Map(this.localStreams));try{for(i.s();!(r=i.n()).done;){var n=Xe(r.value,2),o=n[0],s=n[1];this.options.logger.info("localUser onConnectionRecovery",o),s.onConnectionRecovery(e,null==t?void 0:t.get(o)),this.localStreams.delete(o);var a=null==t?void 0:t.get(o).pubId;this.localStreams.set(a,s)}}catch(e){i.e(e)}finally{i.f()}JSON.stringify(this.permissionWanted)!==JSON.stringify(this.options.permission)&&this.doSwitchPermission(this.permissionCb)}}},{key:"doSwitchPermission",value:function(e){var t=this;this.options.rpcClient.sendRequest({method:"switchPermission",params:{permission:this.permissionWanted}},(function(r){t.options.logger.info("switch permission success"),t.options.permission=t.permissionWanted,e&&e(Ut.Success,null,t.options.roomId)}),(function(r){t.options.logger.info("switch permission failed"),e&&e(Ut.Failed,r.error.message,t.options.roomId)}))||this.options.logger.error("Json Rpc Client send switch permission request error")}}]),e}();!function(e){e[e.Create=0]="Create",e[e.Subscribing=1]="Subscribing",e[e.Subscribed=2]="Subscribed",e[e.Resubscribing=3]="Resubscribing",e[e.Resubscribed=4]="Resubscribed",e[e.Unsubscribing=5]="Unsubscribing",e[e.Unsubscribed=6]="Unsubscribed",e[e.Destroyed=7]="Destroyed",e[e.StateMax=8]="StateMax"}(Pi||(Pi={}));var xi=["Create","Subscribing","Subscribed","Resubscribing","Resubscribed","Unsubscribing","Unsubscribed","Destroy"],Di=function(){function e(t){tt(this,e),this.currentState=Pi.Create,this.stateTransformTable=new Array,this.logger=t,this.initStateTransformTable()}return it(e,[{key:"setState",value:function(e){return this.checkStateChange(this.currentState,e)?(this.logger.info("SubscriptionState : state change from "+xi[this.currentState]+" to "+xi[e]),this.currentState=e,!0):(this.logger.error("SubscriptionState : INVALID state change from"+xi[this.currentState]+" to "+xi[e]),!1)}},{key:"state",value:function(){return this.currentState}},{key:"checkStateChange",value:function(e,t){return this.stateTransformTable[e][t]}},{key:"initStateTransformTable",value:function(){for(var e=Pi.Create;e<Pi.StateMax;e++){this.stateTransformTable[e]=new Array;for(var t=Pi.Create;t<Pi.StateMax;t++)this.stateTransformTable[e][t]=!1}this.stateTransformTable[Pi.Create][Pi.Subscribing]=!0,this.stateTransformTable[Pi.Create][Pi.Destroyed]=!0,this.stateTransformTable[Pi.Subscribing][Pi.Subscribed]=!0,this.stateTransformTable[Pi.Subscribing][Pi.Unsubscribing]=!0,this.stateTransformTable[Pi.Subscribing][Pi.Destroyed]=!0,this.stateTransformTable[Pi.Subscribing][Pi.Resubscribing]=!0,this.stateTransformTable[Pi.Subscribed][Pi.Unsubscribing]=!0,this.stateTransformTable[Pi.Subscribed][Pi.Resubscribing]=!0,this.stateTransformTable[Pi.Subscribed][Pi.Destroyed]=!0,this.stateTransformTable[Pi.Resubscribing][Pi.Resubscribing]=!0,this.stateTransformTable[Pi.Resubscribing][Pi.Resubscribed]=!0,this.stateTransformTable[Pi.Resubscribing][Pi.Unsubscribing]=!0,this.stateTransformTable[Pi.Resubscribing][Pi.Subscribed]=!0,this.stateTransformTable[Pi.Resubscribing][Pi.Destroyed]=!0,this.stateTransformTable[Pi.Resubscribed][Pi.Resubscribing]=!0,this.stateTransformTable[Pi.Resubscribed][Pi.Unsubscribing]=!0,this.stateTransformTable[Pi.Resubscribed][Pi.Destroyed]=!0,this.stateTransformTable[Pi.Unsubscribing][Pi.Unsubscribed]=!0,this.stateTransformTable[Pi.Unsubscribing][Pi.Destroyed]=!0,this.stateTransformTable[Pi.Unsubscribed][Pi.Destroyed]=!0}}]),e}(),Mi=function(){function e(t){tt(this,e),this.options=t,this.state=new Di(t.logger),this.connectionStatus=Ft.ConnectionConnected,this.options.rid&&(this.ridWanted=this.options.rid),this.switchSimulcastCb=null,this.unsubscribeCb=null}return it(e,[{key:"subscribe",value:function(){if(this.options.logger.info("start subscribe: ".concat(this.options.subscriptionId)),this.state.setState(Pi.Subscribing)){var e=this.options.rpcClient.getWsState().state;["CONNECTED","RECOVERY"].includes(e)&&this.doSubscribe()}}},{key:"unsubscribe",value:function(e){if(this.options.logger.info("unsubscribe: ".concat(this.options.subscriptionId)),this.state.setState(Pi.Unsubscribing)){this.unsubscribeCb=e;var t=this.options.rpcClient.getWsState().state;["CONNECTED","RECOVERY"].includes(t)?this.doUnsubscribe(this.unsubscribeCb):this.options.logger.info("websocketState: ".concat(t,",unsubscribe has been cached"))}}},{key:"switchSimulcast",value:function(e,t){if(this.ridWanted!==e){this.ridWanted=e,this.switchSimulcastCb=t;var r=this.options.rpcClient.getWsState().state,i=this.state.state();["CONNECTED","RECOVERY"].includes(r)?i===Pi.Resubscribed||i===Pi.Subscribed?this.doSwitchSimulcast(t):this.options.logger.info("publicationState: ".concat(r,",switchSimulcast has been cached")):this.options.logger.info("websocketState: ".concat(r,",switchSimulcast has been cached"))}else this.options.logger.info("can not switch the same simulcast")}},{key:"onConnectionLost",value:function(){}},{key:"onConnectionRecovery",value:function(e,t){if(this.options.logger.info("onConnectionRecovery subscriptionId",this.options.subscriptionId,"sessionTimeout",e,"sdp",t),this.state.state()===Pi.Unsubscribing)return this.doUnsubscribe(this.unsubscribeCb);e?t&&(this.options.offerSdp=t.sdp,this.options.subscriptionId=t.subId,this.resubscribe()):this.recoveryOperations()}},{key:"resubscribe",value:function(){this.options.logger.info("start resubscribe: "+this.options.subscriptionId),this.state.setState(Pi.Resubscribing)&&this.doSubscribe()}},{key:"recoveryOperations",value:function(){this.ridWanted&&this.ridWanted!==this.options.rid&&this.doSwitchSimulcast(this.switchSimulcastCb)}},{key:"doSubscribe",value:function(){var e=this;try{var t={userId:this.options.userId,subscriptionId:this.options.subscriptionId,media:{audio:{has:this.options.subAudio},video:{has:this.options.subVideo}},sdp:this.options.offerSdp};this.options.subAudio&&(t.media.audio.streamId=this.options.audioStreamId),this.options.subVideo&&(t.media.video.streamId=this.options.videoStreamId,t.media.video.rid=this.ridWanted),this.options.rpcClient.sendRequest({method:"subscribe",params:t},(function(t){if((e.state.state()!==Pi.Subscribing||e.state.setState(Pi.Subscribed))&&(e.state.state()!==Pi.Resubscribing||e.state.setState(Pi.Resubscribed))){e.options.logger.info("subscribe ".concat(e.options.subscriptionId," success"));var r=t.result;e.options.subscribeCb&&e.options.subscribeCb(Ut.Success,null,{roomId:e.options.roomId,subscriptionId:r.subscriptionId,answer_sdp:r.sdp}),e.recoveryOperations()}}),(function(t){e.options.logger.info("subscribe ".concat(e.options.subscriptionId," failed")),e.options.subscribeCb&&e.options.subscribeCb(Ut.Failed,t.error.message,{roomId:e.options.roomId,subscriptionId:e.options.subscriptionId})}))||this.options.logger.error("Json Rpc Client send subscribe request error")}catch(e){this.options.subscribeCb&&this.options.subscribeCb(Ut.Failed,e,null),this.options.logger.error(e)}}},{key:"doSwitchSimulcast",value:function(e){var t=this;this.options.rpcClient.sendRequest({method:"subscribeControl",params:{subscriptionId:this.options.subscriptionId,type:"simulcast",rid:this.ridWanted}},(function(r){t.options.logger.info("switchSimulcast ".concat(t.options.subscriptionId," success")),t.options.rid=t.ridWanted,e&&e(Ut.Success,null,t.options.roomId)}),(function(r){t.options.logger.info("switchSimulcast ".concat(t.options.subscriptionId," failed")),e&&e(Ut.Failed,r.error.message,null)}))||this.options.logger.error("Json Rpc Client send unsubscribe request error")}},{key:"doUnsubscribe",value:function(e){var t=this;this.options.rpcClient.sendRequest({method:"unsubscribe",params:{id:this.options.subscriptionId}},(function(r){t.state.setState(Pi.Unsubscribed)&&(t.options.logger.info("unsubscribe ".concat(t.options.subscriptionId," success")),e&&(e(Ut.Success,null,{roomId:t.options.roomId}),t.unsubscribeCb=null))}),(function(r){t.options.logger.info("unsubscribe ".concat(t.options.subscriptionId," failed")),e&&(e(Ut.Failed,r.error.message,null),t.unsubscribeCb=null)}))||this.options.logger.error("Json Rpc Client send unsubscribe request error")}}]),e}();function Ui(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Ni(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ni(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function Ni(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var Vi=function(){function e(t){tt(this,e),this.options=t,this.subscriptions=new Map}return it(e,[{key:"subscribe",value:function(e,t,r,i,n,o,s){var a=new Mi({roomId:this.options.roomId,userId:this.options.stream.userId,subscriptionId:e,offerSdp:n,subAudio:t,audioStreamId:this.options.stream.streamId,subVideo:r,videoStreamId:this.options.stream.streamId,rid:i,rpcClient:this.options.rpcClient,logger:this.options.logger,subscribeCb:o,subscribeUpdateCb:s});a.subscribe(),this.options.logger.info("remoteStream subscribe subscriptionId",e),this.subscriptions.set(e,a)}},{key:"unsubscribe",value:function(e,t){var r=this;this.subscriptions.has(e)&&this.subscriptions.get(e).unsubscribe((function(i,n,o){i===Ut.Success&&(r.options.logger.info("remoteStream unsubscribe subscriptionId",e),r.subscriptions.delete(e)),t&&t(i,n,o)}))}},{key:"updateSimulcast",value:function(e){this.options.stream.info.video.simulcast=e}},{key:"updateLiveStatus",value:function(e){e.audio&&(this.options.stream.info.audio.muted=e.audio.muted),e.video&&(this.options.stream.info.video.muted=e.video.muted)}},{key:"switchSimulcast",value:function(e,t,r){this.subscriptions.has(e)&&this.subscriptions.get(e).switchSimulcast(t,r)}},{key:"onConnectionLost",value:function(){var e,t=Ui(this.subscriptions.values());try{for(t.s();!(e=t.n()).done;)e.value.onConnectionLost()}catch(e){t.e(e)}finally{t.f()}}},{key:"onConnectionRecovery",value:function(e,t,r){this.options.logger.info("remoteStream onConnectionRecovery subscriptionId",this.subscriptions,t,r);var i,n=Ui(new Map(this.subscriptions));try{for(n.s();!(i=n.n()).done;){var o=Xe(i.value,2),s=o[1];o[0]===t&&(this.subscriptions.get(t).onConnectionRecovery(e,r),this.subscriptions.delete(t),this.subscriptions.set(null==r?void 0:r.subId,s))}}catch(e){n.e(e)}finally{n.f()}}}]),e}();function ji(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Fi(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Fi(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function Fi(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var Bi=function(){function e(t){tt(this,e),this.options=t,this.remoteStreams=new Map,this.streamIdArray=new Array,this.subPubIdMap=new Map}return it(e,[{key:"addStream",value:function(e){var t=e.streamId;this.remoteStreams.set(t,new Vi({roomId:this.options.roomId,stream:e,rpcClient:this.options.rpcClient,logger:this.options.logger})),this.streamIdArray.push(t)}},{key:"deleteStream",value:function(e){if(this.remoteStreams.has(e)){this.remoteStreams.delete(e);var t=this.streamIdArray.indexOf(e);-1!=t&&this.streamIdArray.splice(t,1);var r,i=null,n=ji(this.subPubIdMap);try{for(n.s();!(r=n.n()).done;){var o=Xe(r.value,2);o[1]===e&&(i=o[0])}}catch(e){n.e(e)}finally{n.f()}i&&this.subPubIdMap.delete(i)}}},{key:"updateStreamSimulcast",value:function(e,t){this.remoteStreams.has(e)&&this.remoteStreams.get(e).updateSimulcast(t)}},{key:"updateStreamStatus",value:function(e,t){this.remoteStreams.has(e)&&this.remoteStreams.get(e).updateLiveStatus(t)}},{key:"subscribeStream",value:function(e,t,r,i,n,o){this.options.logger.info("remote user subscribe stream",this.remoteStreams.has(t)),this.remoteStreams.has(t)&&(this.remoteStreams.get(t).subscribe(e,i.hasAudio,i.hasVideo,or(null==i?void 0:i.type),i.offerSdp,n,o),this.options.logger.info("remoteUser subscribeStream subscriptionId",e),this.subPubIdMap.set(e,t))}},{key:"unsubscribeStream",value:function(e,t){var r=this,i=this.subPubIdMap.get(e);i&&this.remoteStreams.has(i)&&this.remoteStreams.get(i).unsubscribe(e,(function(i,n,o){i===Ut.Success&&r.subPubIdMap.delete(e),t&&t(i,n,o)}))}},{key:"switchSimulcast",value:function(e,t,r){var i=this.subPubIdMap.get(e);i&&this.remoteStreams.has(i)&&this.remoteStreams.get(i).switchSimulcast(e,or(t.type),r)}},{key:"getAllStreamId",value:function(){return this.streamIdArray}},{key:"onConnectionLost",value:function(){}},{key:"onConnectionRecovery",value:function(e,t){this.options.logger.info("remoteUser onConnectionRecovery",e);var r,i=ji(new Map(this.subPubIdMap));try{for(i.s();!(r=i.n()).done;){var n=Xe(r.value,2),o=n[0],s=n[1];if(this.options.logger.info("remoteUser onConnectionRecovery subscriptionId",o,"streamId",s),this.remoteStreams.has(s)){this.remoteStreams.get(s).onConnectionRecovery(e,o,t.get(o)),this.subPubIdMap.delete(o);var a=null==t?void 0:t.get(o).subId;this.subPubIdMap.set(a,s)}}}catch(e){i.e(e)}finally{i.f()}}}]),e}(),Wi=function(){function e(t,r){tt(this,e),this.options=t,this.wsUrlList=et(t.wsUrl),this.userId=t.userId,this.ssl=t.ssl,this.roomId=t.roomId,this.logger=r,this.wsSocket=null,this.pendingRequests=new Array,this.successCallbacks=new Map,this.errorCallbacks=new Map,this.requestTypes=new Map,this.retryTimerId=0,this.retryCount=0,this.maxRetryCount=30,this.currentId=1,this.times=6e4,this.timer=null,this.state="DISCONNECTED",this.prevState="DISCONNECTED",this.autoReconnected=!0,this.lockReconnect=!1,this.heartCheck=this.initHeartCheck()}var t,r;return it(e,[{key:"sendRequest",value:function(e,t,r){if(!e)return!1;e.jsonrpc="2.0",e.id="".concat(this.userId,"_").concat(Date.now(),"_").concat(this.currentId++);var i=this;t||(t=function(e){i.logger.debug("success: "+JSON.stringify(e))}),r||(r=function(e){i.logger.debug("error: "+JSON.stringify(e))});var n=JSON.stringify(e);return!!this.wsSocket&&(this.wsSocket.readyState<1?this.pendingRequests.push(n):(i.logger.info("send message: \n"+JSON.stringify(JSON.parse(n),null,4)),this.sendMessage(n)),this.successCallbacks.set(e.id,t),this.errorCallbacks.set(e.id,r),this.requestTypes.set(e.id,e.method),!0)}},{key:"socketReady",value:function(){return this.logger.info("wsSocket readyState",this.wsSocket&&this.wsSocket.readyState),!(null==this.wsSocket||this.wsSocket.readyState>1)}},{key:"connect",value:(r=Ze(ot.mark((function e(){return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.options.wsUrl||0!==this.options.wsUrl.length){e.next=3;break}return this.logger.error("Websocket url is empty!"),e.abrupt("return",!1);case 3:if(this.retryTimerId&&window.clearTimeout(this.retryTimerId),this.socketReady()){e.next=13;break}return this.prevState=this.state,this.state="CONNECTING",this.options.onWsStateChange(this.prevState,this.state,this.retryCount),e.next=10,this.getWsUrl();case 10:this.wsSocket=new WebSocket(e.sent),this.wsSocket&&(this.wsSocket.onmessage=this.onWsMessage.bind(this),this.wsSocket.onclose=this.onWsClose.bind(this),this.wsSocket.onerror=this.onWsError.bind(this),this.wsSocket.onopen=this.onConnect.bind(this));case 13:return e.abrupt("return",!!this.wsSocket);case 14:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"close",value:function(){this.socketReady()&&(this.autoReconnected=!1,this.pendingRequests=[],this.wsSocket.close(),this.resetWs(),this.timer&&clearTimeout(this.timer),this.retryTimerId&&clearTimeout(this.retryTimerId),this.heartCheck.reset(),this.heartCheck=null,this.logger.info("close websocket"))}},{key:"onConnect",value:function(){var e;for(this.heartCheck.start(),this.prevState=this.state,this.retryTimerId?(window.clearTimeout(this.retryTimerId),this.retryTimerId=null,this.state="RECOVERY"):this.state="CONNECTED",this.options.onConnect(this.state),this.retryCount=0,this.options.onWsStateChange(this.prevState,this.state,this.retryCount);e=this.pendingRequests.shift();)this.logger.info("send message: \n"+e),this.sendMessage(e)}},{key:"onWsMessage",value:function(e){var t;if(this.heartCheck&&this.heartCheck.serverTimeoutObj&&(clearTimeout(this.heartCheck.serverTimeoutObj),this.heartCheck.serverTimeoutObj=null),this.timer&&clearTimeout(this.timer),this.timer=null,"object"!==bt(t=JSON.parse(e.data))||"pong"!==t.method){if(this.logger.info("格式化消息: \n"+JSON.stringify(t,null,4)),"object"===bt(t)&&"jsonrpc"in t&&"2.0"===t.jsonrpc){var r=t.id,i=this.successCallbacks.get(r),n=this.errorCallbacks.get(r);if("result"in t&&i)return i({jsonrpc:"2.0",id:t.id,result:t.result}),this.successCallbacks.delete(r),void this.errorCallbacks.delete(r);if("error"in t&&n){var o={jsonrpc:"2.0",id:t.id,error:t.error};return this.logger.error("信令返回错误: \n"+JSON.stringify(o,null,4)),n(o),this.successCallbacks.delete(r),void this.errorCallbacks.delete(r)}}if("id"in t){if("function"==typeof this.options.onRequest){var s=this.options.onRequest({jsonrpc:"2.0",id:t.id,method:t.method,params:t.params});s.jsonrpc="2.0",s.id=t.id,this.wsSocket&&this.wsSocket.send(JSON.stringify(s))}}else this.options.onNotification({jsonrpc:"2.0",method:t.method,params:t.params})}}},{key:"onWsClose",value:function(e){this.logger.info("onWsClose",e),this.heartCheck&&this.heartCheck.reset(),this.pendingRequests=[],this.prevState=this.state,this.state="DISCONNECTED",this.prevState!==this.state&&this.options.onWsStateChange(this.prevState,this.state,this.retryCount)}},{key:"onWsError",value:function(e){if(this.logger.info("onWsError",e),this.heartCheck&&this.heartCheck.reset(),this.pendingRequests=[],this.prevState=this.state,this.state="DISCONNECTED",this.prevState!==this.state&&this.options.onWsStateChange(this.prevState,this.state,this.retryCount),0===this.retryCount){this.logger.onError({c:lr.TOP_ERROR,v:gt.SIGNAL_CHANNEL_SETUP_FAILED});var t=new It({code:gt.SIGNAL_CHANNEL_SETUP_FAILED,message:"WebSocket connect failed"});"function"==typeof this.options.onError&&this.options.onError(t)}}},{key:"reconnect",value:function(){var e=this;!this.autoReconnected&&this.lockReconnect||(this.lockReconnect=!0,this.prevState=this.state,this.retryTimerId&&clearTimeout(this.retryTimerId),this.retryCount<this.maxRetryCount?this.retryTimerId=window.setTimeout((function(){e.retryCount++,e.logger.info("".concat((new Date).toLocaleString()," Try to reconnect, count: ").concat(e.retryCount)),e.state="RECONNECTING",e.options.onWsStateChange(e.prevState,e.state,e.retryCount),e.resetWs(),e.connect(),e.lockReconnect=!1}),this.getReconnectDelay(this.retryCount)):(this.logger.warn("SDK has tried reconnect signal channel for ".concat(this.maxRetryCount," times, but all failed. please check your network")),this.options.onWsReconnectFailed&&this.options.onWsReconnectFailed()))}},{key:"sendMessage",value:function(e){var t=this;this.wsSocket.send(e),this.timer||(this.timer=setTimeout((function(){t.logger.onError({c:lr.TOP_ERROR,v:gt.SERVER_TIMEOUT},"websocket connection timeout!");var e=new It({code:gt.SERVER_TIMEOUT,message:"server timeout"});"function"==typeof t.options.onError&&t.options.onError(e)}),this.times))}},{key:"getWsState",value:function(){return{state:this.state,prevState:this.prevState}}},{key:"resetWs",value:function(){this.wsSocket&&(this.wsSocket.onmessage=null,this.wsSocket.onclose=null,this.wsSocket.onerror=null,this.wsSocket.onopen=null,this.wsSocket=null)}},{key:"initHeartCheck",value:function(){var e=this;return{timeout:2e3,serverTimeout:1e4,timeoutObj:null,serverTimeoutObj:null,reset:function(){return clearInterval(this.timeoutObj),clearTimeout(this.serverTimeoutObj),this.timeoutObj=null,this.serverTimeoutObj=null,this},start:function(){var t=this;this.reset(),this.timeoutObj=setInterval((function(){e.sendMessage(JSON.stringify({jsonrpc:"2.0",id:0,method:"ping",params:{}})),t.serverTimeoutObj||(t.serverTimeoutObj=setTimeout((function(){e.logger.info((new Date).toLocaleString(),"not received pong, close the websocket"),e.onWsError()}),t.serverTimeout))}),this.timeout)}}}},{key:"getReconnectDelay",value:function(e){return Math.round(e/2)+1>6?13e3:3e3}},{key:"getWsUrl",value:(t=Ze(ot.mark((function e(){var t,r,i,n,o,s,a,c,u,d,l,h,p,f;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t="","string"==typeof this.options.wsUrl?t="".concat(this.options.wsUrl,"/xsigo?roomNum=").concat(this.roomId,"&userId=").concat(this.userId,"&appKey=").concat(this.options.appId):(r=this.getWsUrlList(),t="".concat(this.ssl?"wss":"ws","://").concat(r,"/xsigo?roomNum=").concat(this.roomId,"&userId=").concat(this.userId,"&appKey=").concat(this.options.appId)),this.options.privateKey&&(t+="&privateKey=".concat(this.options.privateKey)),this.options.extendInfo&&this.options.extendInfo.location&&(t+="&location=".concat(this.options.extendInfo.location)),!(i=this.options.onCustomSignParam)){e.next=13;break}return e.next=8,i();case 8:if("object"===bt((n=e.sent).getHeader)&&"{}"!==JSON.stringify(n.getHeader)&&(o=n.getHeader,"[object Object]"===Object.prototype.toString.call(o)&&"{}"!==JSON.stringify(o)))for(s=0,a=Object.entries(o);s<a.length;s++)c=Xe(a[s],2),u=c[1],t+="&".concat(c[0],"=").concat(u);if("object"===bt(n.getQuery)&&"{}"!==JSON.stringify(n.getQuery)&&(d=n.getQuery,"[object Object]"===Object.prototype.toString.call(d)&&"{}"!==JSON.stringify(d)))for(l=0,h=Object.entries(d);l<h.length;l++)p=Xe(h[l],2),f=p[1],t+="&".concat(p[0],"=").concat(f);e.next=14;break;case 13:i||(t="".concat(t,"&Authorization=").concat(this.options.userSig));case 14:return e.abrupt("return",t);case 15:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"getWsUrlList",value:function(){var e=this.options.wsUrl.length;if(1===e)return this.options.wsUrl[0];if(e&&!this.wsUrlList.length&&(this.wsUrlList=et(this.options.wsUrl)),e===this.wsUrlList.length)for(;e;){var t=Math.floor(Math.random()*e--),r=[this.wsUrlList[e],this.wsUrlList[t]];this.wsUrlList[t]=r[0],this.wsUrlList[e]=r[1]}return this.wsUrlList.shift()}}]),e}();function Gi(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Hi(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Hi(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function Hi(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var $i=function(){function e(t){tt(this,e),this.options=t,this.isFirstLogin=!0;var r=t.roomCbs;this.roomCbs={connectionLostCb:r.connectionLostCb,connectionRecoveryCb:r.connectionRecoveryCb,tryToReconnectCb:r.tryToReconnectCb,notificationCb:r.notificationCb,onWsStateChange:r.onWsStateChange,onWsError:r.onWsError,onWsReconnectFailed:r.onWsReconnectFailed},this.remoteUsers=new Map,this.remoteUserIdArray=new Array,this.remoteStreams=new Map,this.remoteStreamIdArray=new Array,this.subUserIdMap=new Map,this.state=new mi(this.options.logger),this.connectionStatus=Ft.New}var t,r,i,n;return it(e,[{key:"enter",value:(n=Ze(ot.mark((function e(t,r,i,n,o,s,a,c,u,d,l,h,p){return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.loginParams={appId:r,userId:n,userType:o,previousRoomId:s,permission:a,userData:c,extendInfo:u},this.state.setState(ai.Entering)){e.next=3;break}return e.abrupt("return");case 3:return this.options.logger.info("Enter Room "+this.options.roomId),this.roomCbs.enterRoomCb=l,e.next=7,this.initJsonRpcClient(t,r,i,n,d,u,h,p);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,r,i,o,s,a,c,u,d,l,h,p){return n.apply(this,arguments)})},{key:"exit",value:function(e){this.state.setState(ai.Exiting)&&(this.options.logger.info("Exit Room "+this.options.roomId),this.isFirstLogin=!0,this.roomCbs.exitRoomCb=e,this.login.logout())}},{key:"publishStream",value:function(e,t,r,i,n,o){if(this.state.state()==ai.Entered)return this.localUser.publishStream(e,t,r,i,n,o);this.options.logger.info("We are not enter room, can not publish stream")}},{key:"unpublishStream",value:function(e,t){if(this.state.state()==ai.Entered)return this.localUser.unpublishStream(e,t);this.options.logger.info("We are not enter room, can not unpublish stream")}},{key:"updateSimulcast",value:function(e,t,r){if(this.state.state()==ai.Entered)return this.localUser.updateSimulcast(e,t,r);this.options.logger.info("We arn not enter room, can not publish updateSimulcast")}},{key:"muteLocalAudio",value:function(e,t,r){this.state.state()==ai.Entered?this.localUser.muteAudio(e,t,this.roomCbs.notificationCb,r):this.options.logger.info("We are not enter room, can not muteLocalAudio")}},{key:"muteLocalVideo",value:function(e,t,r){this.state.state()==ai.Entered?this.localUser.muteVideo(e,t,this.roomCbs.notificationCb,r):this.options.logger.info("We are not enter room, can not muteLocalVideo")}},{key:"unmuteLocalAudio",value:function(e,t,r){this.state.state()==ai.Entered?this.localUser.unmuteAudio(e,t,this.roomCbs.notificationCb,r):this.options.logger.info("We are not enter room, can not unmuteLocalAudio")}},{key:"unmuteLocalVideo",value:function(e,t,r){this.state.state()==ai.Entered?this.localUser.unmuteVideo(e,t,this.roomCbs.notificationCb,r):this.options.logger.info("We are not enter room, can not unmuteLocalVideo")}},{key:"subscribeStream",value:function(e,t,r,i,n,o,s){this.state.state()==ai.Entered?(this.options.logger.info("room subscribe stream",this.remoteUsers.has(t)),this.remoteUsers.has(t)&&(this.remoteUsers.get(t).subscribeStream(e,r,i,n,o,s),this.subUserIdMap.set(e,t))):this.options.logger.info("We are not enter room, can not subscribe stream")}},{key:"unsubscribeStream",value:function(e,t){if(this.state.state()==ai.Entered)if(this.options.logger.debug("subUserIdMap",this.subUserIdMap,e),this.subUserIdMap.has(e)){var r=this.subUserIdMap.get(e);this.remoteUsers.has(r)?(this.remoteUsers.get(r).unsubscribeStream(e,t),this.subUserIdMap.delete(e)):this.options.logger.info("unsubscription: "+e+"  no related user")}else this.options.logger.info("unsubscription: "+e+"  no related user");else this.options.logger.info("We are not enter room, can not unsubscribe stream")}},{key:"switchSimulcast",value:function(e,t,r){if(this.state.state()==ai.Entered)if(this.subUserIdMap.has(e)){var i=this.subUserIdMap.get(e);this.remoteUsers.has(i)&&this.remoteUsers.get(i).switchSimulcast(e,t,r)}else this.options.logger.info("Subscription: "+e+" not exist");else this.options.logger.info("We are not enter room, can not switchSimulcast")}},{key:"switchPermission",value:function(e,t){var r=this;this.state.state()==ai.Entered?this.localUser.switchPermission(e,(function(i,n,o){1===i&&r.login.updatePermission(e),t&&t(i,n,o)})):this.options.logger.info("We are not enter room, can not switchPermission")}},{key:"getWsState",value:function(){return this.rpcClient.getWsState()}},{key:"onLogin",value:function(e,t,r){if(e===gi.LoginSuccess){if(this.connectionStatus=Ft.ConnectionConnected,!this.state.setState(ai.Entered))return;this.options.logger.info("Enter Room ".concat(this.options.roomId," success")),this.roomCbs.enterRoomCb&&this.roomCbs.enterRoomCb(Ut.Success,null,{roomId:this.options.roomId,roomUniqueId:t.room.roomUniqueId,participants:t.room.participants});var i=this.buildRemoteUserAndCollectNotification(t,!1),n=this.buildRemoteStreamsAndCollectNotification(t,!1),o=setTimeout((function(){var e,t=Gi(i);try{for(t.s();!(e=t.n()).done;)(0,e.value)()}catch(e){t.e(e)}finally{t.f()}var r,s=Gi(n);try{for(s.s();!(r=s.n()).done;)(0,r.value)()}catch(e){s.e(e)}finally{s.f()}o&&clearTimeout(o),o=null}),300)}else if(e===gi.LoginTimeout){if(!this.state.setState(ai.EnterTimeout))return;this.options.logger.info("Enter Room ".concat(this.options.roomId," timeout")),this.roomCbs.enterRoomCb&&this.roomCbs.enterRoomCb(Ut.Timeout,r,{roomId:this.options.roomId})}else if(e===gi.LoginFailed){if(!this.state.setState(ai.EnterFailed))return;this.options.logger.info("Enter Room ".concat(this.options.roomId," failed")),this.roomCbs.enterRoomCb&&this.roomCbs.enterRoomCb(Ut.Failed,r,{roomId:this.options.roomId})}else this.options.logger.error("Enter room result type is invalid!")}},{key:"onRelogin",value:(i=Ze(ot.mark((function e(t,r,i){var n,o,s,a,c,u,d,l,h,p,f,m,g,v,y,b,S,E,C,T,R,_,I,w;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=22;break}if(this.connectionStatus=Ft.ConnectionRecovery,this.options.logger.info("onRelogin:",t,r,i),n=this.buildRemoteUserAndCollectNotification(i,!0),o=this.buildRemoteStreamsAndCollectNotification(i,!0),s=i.room.roomUniqueId,a=null,!this.roomCbs.connectionRecoveryCb){e.next=16;break}return e.next=10,this.roomCbs.connectionRecoveryCb(this.options.roomId,s,r);case 10:this.localUser.onConnectionRecovery(r,null===(c=a=e.sent)||void 0===c?void 0:c.publishOfferSdp),u=new Map(this.subUserIdMap),this.options.logger.info("subUserIdMap",u,a),d=Gi(u);try{for(d.s();!(l=d.n()).done;)f=Xe(l.value,2),m=f[0],g=f[1],null!==(h=a)&&void 0!==h&&null!==(p=h.subscribeOfferSdp)&&void 0!==p&&p.has(m)&&(S=null===(v=a)||void 0===v||null===(y=v.subscribeOfferSdp)||void 0===y||null===(b=y.get(m))||void 0===b?void 0:b.subId,this.subUserIdMap.delete(m),this.subUserIdMap.set(S,g))}catch(e){d.e(e)}finally{d.f()}case 16:E=Gi(this.remoteUsers.values());try{for(E.s();!(C=E.n()).done;)C.value.onConnectionRecovery(r,null===(T=a)||void 0===T?void 0:T.subscribeOfferSdp)}catch(e){E.e(e)}finally{E.f()}R=Gi(n);try{for(R.s();!(_=R.n()).done;)(0,_.value)()}catch(e){R.e(e)}finally{R.f()}I=Gi(o);try{for(I.s();!(w=I.n()).done;)(0,w.value)()}catch(e){I.e(e)}finally{I.f()}case 22:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return i.apply(this,arguments)})},{key:"onLogout",value:function(e,t){if(e===vi.LogoutSuccess){if(!this.state.setState(ai.Exited))return;this.options.logger.info("Exit Room "+this.options.roomId+" success"),this.roomCbs.exitRoomCb&&this.roomCbs.exitRoomCb(Ut.Success,null,{roomId:this.options.roomId,reason:Nt.ActivelyLeave}),this.rpcClient&&(this.rpcClient.close(),this.rpcClient=null)}else if(e===vi.LogoutFailed){if(!this.state.setState(ai.ExitFailed))return;this.roomCbs.exitRoomCb&&(this.options.logger.info("exit room failed"),this.roomCbs.exitRoomCb(Ut.Failed,t,{roomId:this.options.roomId,reason:Nt.ActivelyLeave})),this.rpcClient&&(this.rpcClient.close(),this.rpcClient=null)}else if(e===vi.LogoutTimeout){if(!this.state.setState(ai.ExitTimeout))return;this.options.logger.info("Exit Room "+this.options.roomId+" timeout"),this.roomCbs.exitRoomCb&&(this.options.logger.info("exit room timeout"),this.roomCbs.exitRoomCb(Ut.Failed,t,{roomId:this.options.roomId,reason:Nt.ActivelyLeave})),this.rpcClient&&(this.rpcClient.close(),this.rpcClient=null)}else this.options.logger.error("Exit room result type is invalid!")}},{key:"onNotification",value:function(e){this.options.logger.info("room: "+this.options.roomId+" receive notification message");var t,r=e.method;if(r)if("participant"===r){var i=e.params.type;if("join"===i){var n=e.params,o={participant:{userId:n.userId,previousRoomId:n.previousRoomId,userData:n.userData}};this.buildRemoteUser(o.participant),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+o.participant.userId+"join notification"),this.roomCbs.notificationCb(this.options.roomId,Bt.ParticipantJoin,o))}else if("leave"===i){var s=e.params,a={userId:s.userId,reason:s.reason};this.remoteUsers.has(a.userId)&&this.deleteRemoteUser(a.userId),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+a.userId+" leave notification",this.remoteStreams,this.remoteUsers,this.remoteStreamIdArray),this.roomCbs.notificationCb(this.options.roomId,Bt.ParticipantLeave,a))}else this.options.logger.error("participant notification type error!!!")}else if("stream"===r){var c=e.params.type;if("add"===c){var u={stream:hi(e.params)};this.options.logger.info("room-add ",this.remoteStreams,this.remoteUsers,u),this.remoteUsers.has(u.stream.userId)&&!this.remoteStreams.has(u.stream.streamId)&&(this.buildRemoteStream(u.stream),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+u.stream.userId+", stream "+u.stream.streamId+" add notification"),this.roomCbs.notificationCb(this.options.roomId,Bt.StreamAdd,u)))}else if("remove"===c){var d=e.params,l={userId:d.userId,streamId:d.streamId};this.remoteStreams.has(l.streamId)&&(this.deleteRemoteStream(l.streamId),this.options.logger.info("room-remove ",this.remoteStreams,this.remoteUsers,l),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+l.userId+", stream "+l.streamId+" remove notification"),this.roomCbs.notificationCb(this.options.roomId,Bt.StreamRemove,l)))}else if("update"===c){var h=e.params,p={userId:h.userId,streamId:h.streamId,liveStatus:h.data.liveStatus,userData:h.userData};h.data.simulcast&&this.remoteStreams.has(p.streamId)&&(p.simulcast=di(h.data.simulcast),this.remoteStreams.get(p.streamId).info.video.simulcast=p.simulcast,this.remoteUsers.get(p.userId).updateStreamSimulcast(p.streamId,p.simulcast)),h.data.liveStatus&&(p.liveStatus=h.data.liveStatus,this.remoteStreams.has(p.streamId)&&(p.liveStatus.audio&&(this.remoteStreams.get(p.streamId).info.audio.muted=p.liveStatus.audio.muted),p.liveStatus.video&&(this.remoteStreams.get(p.streamId).info.video.muted=p.liveStatus.video.muted),this.remoteUsers.get(p.userId).updateStreamStatus(p.streamId,p.liveStatus))),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+p.userId+", stream "+p.streamId+" update notification"),this.roomCbs.notificationCb(this.options.roomId,Bt.StreamUpdate,p))}else this.options.logger.error("Stream notification type error!!!")}else if("drop"===r){var f={cause:(t=e.params.cause,"kicked"==t?jt.Kicked:"repeatlogin"==t?jt.RepeatLogin:"disbanded"==t?jt.RoomDissolved:jt.Unknown)};if(!this.state.setState(ai.Destroyed))return;this.roomCbs.notificationCb&&(this.options.logger.info("drop notification"),this.roomCbs.notificationCb(this.options.roomId,Bt.Drop,f)),this.rpcClient&&(this.rpcClient.close(),this.rpcClient=null)}else if("permission"===r){var m=e.params,g={userId:m.userId,publish:m.publish,subscribe:m.subscribe,control:m.control};this.roomCbs.notificationCb&&(this.options.logger.info("permission change notification"),this.roomCbs.notificationCb(this.options.roomId,Bt.PermissionChange,g));var v=g.publish&&(g.publish.audio||g.publish.video);if(this.remoteUsers.has(g.userId)){if(!v){this.deleteRemoteUser(g.userId);var y={userId:g.userId,reason:Vt.Normal};this.roomCbs.notificationCb&&(this.options.logger.info("user: "+y.userId+"leave notification"),this.roomCbs.notificationCb(this.options.roomId,Bt.ParticipantLeave,y))}}else if(v){var b={userId:g.userId,previousRoomId:"",userData:{userId:g.userId,userName:""}};this.buildRemoteUser(b),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+b.userId+"join notification"),this.roomCbs.notificationCb(this.options.roomId,Bt.ParticipantJoin,{participant:b}))}}}},{key:"onRpcStateChange",value:function(e,t,r){this.options.logger.info("prevState: ".concat(e,",state: ").concat(t)),"DISCONNECTED"===t?this.onConnectionLost():"RECONNECTING"===t&&this.onTryToReconenct(),this.roomCbs.onWsStateChange&&this.roomCbs.onWsStateChange(this.options.roomId,e,t)}},{key:"onConnectionLost",value:function(){this.options.logger.info("room: "+this.options.roomId+" connection lost!!!"),this.connectionStatus=Ft.ConnectionLost;var e,t=Gi(this.remoteUsers.values());try{for(t.s();!(e=t.n()).done;)e.value.onConnectionLost()}catch(e){t.e(e)}finally{t.f()}this.roomCbs.connectionLostCb&&this.roomCbs.connectionLostCb(this.options.roomId),this.rpcClient.reconnect()}},{key:"onTryToReconenct",value:function(){this.options.logger.info("room: "+this.options.roomId+" connection retring ......"),this.connectionStatus=Ft.ConnectionRetring,this.roomCbs.tryToReconnectCb&&this.roomCbs.tryToReconnectCb(this.options.roomId)}},{key:"onConnectionRecovery",value:function(){this.options.logger.info("room: ".concat(this.options.roomId," connection recovery!!!")),this.state.state()!=ai.Entering&&this.login.onConnectionRecovery()}},{key:"onRpcReconnectFailed",value:function(){this.options.logger.info("room: "+this.options.roomId+" reconnection failed!!!"),this.roomCbs.onWsReconnectFailed&&this.roomCbs.onWsReconnectFailed(this.options.roomId)}},{key:"initJsonRpcClient",value:(r=Ze(ot.mark((function e(t,r,i,n,o,s,a,c){var u;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u={onCustomSignParam:t,appId:r,userSig:i,userId:n,privateKey:o,extendInfo:s,wsUrl:this.options.serverUrl,ssl:a,roomId:c,onRequest:null,onNotification:this.onNotification.bind(this),onError:this.roomCbs.onWsError,onConnect:this.initLoginAndLocalUser.bind(this),onWsStateChange:this.onRpcStateChange.bind(this),onWsReconnectFailed:this.onRpcReconnectFailed.bind(this)},this.rpcClient=new Wi(u,this.options.logger),e.next=4,this.rpcClient.connect();case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,i,n,o,s,a,c){return r.apply(this,arguments)})},{key:"initLoginAndLocalUser",value:(t=Ze(ot.mark((function e(){var t,r,i,n,o,s,a,c,u,d;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isFirstLogin){e.next=2;break}return e.abrupt("return",this.onConnectionRecovery());case 2:return this.isFirstLogin=!1,r=(t=this.loginParams).appId,i=t.userId,n=t.userType,o=t.previousRoomId,s=t.permission,a=t.userData,c=t.extendInfo,e.next=6,new Promise(function(){var e=Ze(ot.mark((function e(t){var r;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={sdk:{type:"WebRTC",version:"4.7.0"},device:{osName:"",osVersion:"".concat(Xt,"/").concat(Qt),netType:xt()},capabilities:{isp:"unknown",location:"unknown",trikleIce:!1,secure:!0}},e.prev=1,e.next=4,new Promise(function(){var e=Ze(ot.mark((function e(t,r){return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!Dt.any()){e.next=5;break}t(Dt.getOsName()),e.next=9;break;case 5:return e.next=7,new Promise(function(){var e=Ze(ot.mark((function e(t,r){var i,n,o,s,a,c,u,d;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i="-",n=navigator.appVersion,o=navigator.userAgent,s=i,a=[{s:"Chrome OS",r:/CrOS/},{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}],c=0;case 6:if(!(u=a[c])){e.next=13;break}if(!u.r.test(o)){e.next=10;break}return s=u.s,e.abrupt("break",13);case 10:c++,e.next=6;break;case 13:if(d=i,!/Windows/.test(s)){e.next=28;break}if(!/Windows (.*)/.test(s)){e.next=27;break}if(10!=(d=/Windows (.*)/.exec(s)[1])){e.next=27;break}return e.prev=18,e.next=21,new Promise((function(e){navigator&&navigator.userAgentData&&navigator.userAgentData.getHighEntropyValues?navigator.userAgentData.getHighEntropyValues(["platformVersion"]).then((function(t){if(navigator.userAgentData.platform&&"windows"===navigator.userAgentData.platform.toLowerCase()&&t.platformVersion){var r=parseInt(t.platformVersion.split(".")[0]);e(r>=13?11:10)}else e(10)})).catch((function(){e(10)})):e(10)}));case 21:d=e.sent,e.next=27;break;case 24:e.prev=24,e.t0=e.catch(18),d=10;case 27:s="Windows";case 28:e.t1=s,e.next="Mac OS X"===e.t1?31:"Android"===e.t1?33:"iOS"===e.t1?35:37;break;case 31:return/Mac OS X (10[/._\d]+)/.test(o)&&(d=/Mac OS X (10[\.\_\d]+)/.exec(o)[1]),e.abrupt("break",37);case 33:return/Android ([\.\_\d]+)/.test(o)&&(d=/Android ([\.\_\d]+)/.exec(o)[1]),e.abrupt("break",37);case 35:return/OS (\d+)_(\d+)_?(\d+)?/.test(o)&&(d=(d=/OS (\d+)_(\d+)_?(\d+)?/.exec(n))[1]+"."+d[2]+"."+(0|d[3])),e.abrupt("break",37);case 37:t({osName:s+d,type:"desktop"});case 38:case"end":return e.stop()}}),e,null,[[18,24]])})));return function(t,r){return e.apply(this,arguments)}}());case 7:t(e.sent);case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),r(e.t0);case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(t,r){return e.apply(this,arguments)}}());case 4:r.device.osName=e.sent.osName,t(r),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(1),t(r);case 12:case"end":return e.stop()}}),e,null,[[1,9]])})));return function(t){return e.apply(this,arguments)}}());case 6:u=e.sent,c&&c.location&&(u.capabilities.location=c.location),d={appId:r,userId:i,userType:n,roomId:this.options.roomId,previousRoomId:o,userAgent:u,permission:s,userData:a,rpcClient:this.rpcClient,logger:this.options.logger,loginCb:this.onLogin.bind(this),reloginCb:this.onRelogin.bind(this),logoutCb:this.onLogout.bind(this)},this.login=new Ti(d),this.localUser=new Li({userId:i,roomId:this.options.roomId,previousRoomId:o,userAgent:d.userAgent,permission:s,userData:a,rpcClient:this.rpcClient,logger:this.options.logger}),this.login.login();case 13:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"buildRemoteUser",value:function(e){var t=e.userId,r=new Bi({roomId:this.options.roomId,participant:e,rpcClient:this.rpcClient,logger:this.options.logger});this.remoteUsers.set(t,r),this.remoteUserIdArray.push(t),this.options.logger.info("this.remoteUsers",JSON.stringify(this.remoteUsers,null,4))}},{key:"deleteRemoteStream",value:function(e){if(this.options.logger.info("delete-streamId",e,this.remoteStreams),this.remoteStreams.has(e)){var t=this.remoteStreams.get(e).userId;this.remoteUsers.has(t)&&this.remoteUsers.get(t).deleteStream(e),this.remoteStreams.delete(e);var r=this.remoteStreamIdArray.indexOf(e);-1!=r&&this.remoteStreamIdArray.splice(r,1)}}},{key:"deleteRemoteUser",value:function(e){if(this.remoteUsers.has(e)){var t,r=Gi(JSON.parse(JSON.stringify(this.remoteUsers.get(e).getAllStreamId())));try{for(r.s();!(t=r.n()).done;)this.deleteRemoteStream(t.value)}catch(e){r.e(e)}finally{r.f()}this.remoteUsers.delete(e);var i=this.remoteUserIdArray.indexOf(e);-1!=i&&this.remoteUserIdArray.splice(i,1)}}},{key:"buildRemoteStream",value:function(e){var t=e.streamId;this.remoteUsers.get(e.userId).addStream(e),this.remoteStreams.set(t,e),this.remoteStreamIdArray.push(t)}},{key:"buildRemoteUserAndCollectNotification",value:function(e,t){var r=this,i=new Array;if(t){var n,o=Gi(e.room.participants);try{var s=function(){var e=n.value,t={participant:e},o=e.userId;if(o===r.localUser.getUserId())return"continue";r.remoteUsers.has(o)||(r.buildRemoteUser(e),i.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+t.participant.userId+"join notification"),r.roomCbs.notificationCb(r.options.roomId,Bt.ParticipantJoin,t))})))};for(o.s();!(n=o.n()).done;)s()}catch(e){o.e(e)}finally{o.f()}var a,c=Gi(JSON.parse(JSON.stringify(this.remoteUserIdArray)));try{for(c.s();!(a=c.n()).done;){var u,d=a.value,l=!0,h=Gi(e.room.participants);try{for(h.s();!(u=h.n()).done;)u.value.userId===d&&(l=!1)}catch(e){h.e(e)}finally{h.f()}if(l){this.deleteRemoteUser(d);var p={userId:d,reason:Vt.Normal};this.roomCbs.notificationCb&&(this.options.logger.info("user: "+p.userId+"leave notification"),this.roomCbs.notificationCb(this.options.roomId,Bt.ParticipantLeave,p))}}}catch(e){c.e(e)}finally{c.f()}}else{var f,m=Gi(e.room.participants);try{var g=function(){var e=f.value,t={participant:e};if(e.userId===r.localUser.getUserId())return"continue";r.buildRemoteUser(e),i.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: ".concat(t.participant.userId," join notification")),r.roomCbs.notificationCb(r.options.roomId,Bt.ParticipantJoin,t))}))};for(m.s();!(f=m.n()).done;)g()}catch(e){m.e(e)}finally{m.f()}}return i}},{key:"buildRemoteStreamsAndCollectNotification",value:function(e,t){var r=this,i=new Array;if(t){var n,o=Gi(JSON.parse(JSON.stringify(this.remoteStreamIdArray)));try{for(o.s();!(n=o.n()).done;){var s,a=n.value,c=!0,u=Gi(e.room.streams);try{for(u.s();!(s=u.n()).done;)s.value.streamId===a&&(c=!1)}catch(e){u.e(e)}finally{u.f()}if(c&&this.remoteStreams.has(a)){var d=this.remoteStreams.get(a).userId;this.deleteRemoteStream(a);var l={userId:d,streamId:a};this.roomCbs.notificationCb&&(this.options.logger.info("user: "+l.userId+", stream "+l.streamId+" remove notification"),this.roomCbs.notificationCb(this.options.roomId,Bt.StreamRemove,l))}}}catch(e){o.e(e)}finally{o.f()}var h,p=Gi(e.room.streams);try{var f=function(){var e=h.value,t={stream:li(e)},n=e.userId,o=e.streamId;if(n===r.localUser.getUserId())return"continue";if(r.remoteStreams.has(o)){if(e.info.audio&&e.info.audio.muted!=r.remoteStreams.get(o).info.audio.muted){var s={audio:{muted:e.info.audio.muted,floor:e.info.audio.floor}};r.remoteStreams.get(o).info.audio.muted=e.info.audio.muted,r.remoteStreams.get(o).info.audio.floor=e.info.audio.floor,r.remoteUsers.get(n).updateStreamStatus(o,s);var a={userId:n,streamId:o,liveStatus:s};i.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+n+", stream "+o+" update notification"),r.roomCbs.notificationCb(r.options.roomId,Bt.StreamUpdate,a))}))}if(e.info.video&&e.info.video.muted!=r.remoteStreams.get(o).info.video.muted){var c={video:{muted:e.info.video.muted,floor:e.info.video.floor}};r.remoteStreams.get(o).info.video.muted=e.info.video.muted,r.remoteStreams.get(o).info.video.floor=e.info.video.floor,r.remoteUsers.get(n).updateStreamStatus(o,c);var u={userId:n,streamId:o,liveStatus:c};i.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+n+", stream "+o+" update notification"),r.roomCbs.notificationCb(r.options.roomId,Bt.StreamUpdate,u))}))}if(e.info.video&&e.info.video.simulcast&&e.info.video.simulcast.length!=r.remoteStreams.get(o).info.video.simulcast.length){var d=di(e.info.video.simulcast);r.remoteStreams.get(o).info.video.simulcast=d,r.remoteUsers.get(n).updateStreamSimulcast(o,d);var l={userId:n,streamId:o,simulcast:d};i.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+n+", stream "+o+" update notification"),r.roomCbs.notificationCb(r.options.roomId,Bt.StreamUpdate,l))}))}}else{if(!r.remoteUsers.has(n))return r.options.logger.error("Stream "+o+" no related user!"),{v:i};r.buildRemoteStream(t.stream),i.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+n+", stream "+o+" add notification"),r.roomCbs.notificationCb(r.options.roomId,Bt.StreamAdd,t))}))}};for(p.s();!(h=p.n()).done;){var m=f();if("continue"!==m&&"object"===bt(m))return m.v}}catch(e){p.e(e)}finally{p.f()}}else{var g,v=Gi(e.room.streams);try{var y=function(){var e=g.value,t={stream:li(e)},n=e.userId,o=e.streamId;return n===r.localUser.getUserId()?"continue":r.remoteUsers.has(n)?(r.buildRemoteStream(t.stream),void i.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+n+", stream "+o+" add notification"),r.roomCbs.notificationCb(r.options.roomId,Bt.StreamAdd,t))}))):(r.options.logger.error("Stream "+o+" no related user!"),{v:i})};for(v.s();!(g=v.n()).done;){var b=y();if("continue"!==b&&"object"===bt(b))return b.v}}catch(e){v.e(e)}finally{v.f()}}return i}}]),e}();function zi(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var Ji,Yi=function(){function e(t,r){tt(this,e),this.rooms=new Map,this.logger=t,this.roomCbs=r}return it(e,[{key:"enterRoom",value:function(e,t){var r=t.onCustomSignParam,i=t.appId,n=t.userSig,o=t.userId,s=t.userType,a=t.previousRoomId,c=t.permission,u=t.userData,d=t.extendInfo,l=t.serverUrl,h=t.privateKey,p=t.enterRoomCb,f=t.ssl;if(this.logger.info("XsigoStackClient enterRoom: "+e),!this.rooms.has(e)){var m=new $i({roomId:e,serverUrl:l,logger:this.logger,roomCbs:this.roomCbs});this.rooms.set(e,m)}this.rooms.get(e).enter(r,i,n,o,s,a,c,u,d,h,p,f,e)}},{key:"exitRoom",value:function(e,t){if(this.logger.info("XsigoStackClient exitRoom: "+e),this.rooms.has(e))return this.rooms.get(e).exit(t),void this.rooms.delete(e);this.logger.error("XsigoStackClient exitRoom: "+e+"error, room not exist")}},{key:"publishStream",value:function(e,t){var r=t.streamType,i=t.streamKind,n=t.params,o=t.cb,s=t.updateCb,a=zi();if(this.logger.info("XsigoStackClient publishStream :  "+a+" in room"+e,this.rooms.has(e)),this.rooms.has(e))return this.rooms.get(e).publishStream(a,r,i,n,o,s),a}},{key:"unpublishStream",value:function(e,t,r){this.logger.info("XsigoStackClient unpublishStream :  "+t+" in room"+e),this.rooms.has(e)&&this.rooms.get(e).unpublishStream(t,r)}},{key:"updateSimulcast",value:function(e,t,r,i){this.rooms.has(e)&&this.rooms.get(e).updateSimulcast(t,r,i)}},{key:"muteAudio",value:function(e,t,r,i){this.rooms.has(e)&&this.rooms.get(e).muteLocalAudio(t,r,i)}},{key:"muteVideo",value:function(e,t,r,i){this.rooms.has(e)&&this.rooms.get(e).muteLocalVideo(t,r,i)}},{key:"unmuteAudio",value:function(e,t,r,i){this.rooms.has(e)&&this.rooms.get(e).unmuteLocalAudio(t,r,i)}},{key:"unmuteVideo",value:function(e,t,r,i){this.rooms.has(e)&&this.rooms.get(e).unmuteLocalVideo(t,r,i)}},{key:"subscribeStream",value:function(e,t){var r=t.publisherUserId,i=t.streamId,n=t.streamKind,o=t.params,s=t.cb,a=t.updateCb;this.logger.info("XsigoStackClient subscribeStream :  "+i+" in room"+e);var c=zi();return this.rooms.has(e)?(this.rooms.get(e).subscribeStream(c,r,i,n,o,s,a),c):""}},{key:"unsubscribeStream",value:function(e,t,r){this.logger.info("XsigoStackClient unsubscribe :  "+t+" in room"+e),this.rooms.has(e)&&this.rooms.get(e).unsubscribeStream(t,r)}},{key:"switchSimulcast",value:function(e,t,r,i){this.rooms.has(e)&&this.rooms.get(e).switchSimulcast(t,r,i)}},{key:"switchPermission",value:function(e,t,r){this.rooms.has(e)&&this.rooms.get(e).switchPermission(t,r)}},{key:"getWsState",value:function(e){if(this.rooms.has(e))return this.rooms.get(e).getWsState()}},{key:"isDisconnected",value:function(e){var t=this.getWsState(e).state;return["CONNECTED","RECOVERY"].includes(t)||this.logger.warn("cannot operate during network disconnection"),!["CONNECTED","RECOVERY"].includes(t)}}]),e}();function Ki(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function qi(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ki(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ki(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}!function(e){e[e.AuthTypeHeader=0]="AuthTypeHeader",e[e.AuthTypeQuery=1]="AuthTypeQuery"}(Ji||(Ji={}));var Xi={appKey:null,authorization:"",timeout:1e4,extendInfo:{},ssl:!0,onCustomSignParam:null,path:"",privateKey:"",timeoutObj:{},init:function(e){var t=e.sdkAppId,r=e.userSig,i=e.onCustomSignParam,n=e.extendInfo,o=e.userId;this.ssl=e.ssl,this.userId=o,this.appKey=t,this.authorization=r,this.onCustomSignParam=i,this.extendInfo=n},timeoutPromise:function(e,t,r){var i=this;return new Promise((function(n,o){i.timeoutObj[r]=setTimeout((function(){n(new Response("timeout",{status:408,statusText:"request timeout"})),t.abort()}),e)}))},getHeader:function(){var e=this;return Ze(ot.mark((function t(){var r,i;return ot.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.onCustomSignParam){t.next=18;break}return t.next=3,e.onCustomSignParam();case 3:if((r=t.sent).getHeader){t.next=6;break}return t.abrupt("return",new Headers({"Content-Type":"application/json",appKey:e.appKey,userId:e.userId}));case 6:if("object"!==bt(r.getHeader)){t.next=15;break}if(i=r.getHeader,"[object Object]"!==Object.prototype.toString.call(i)){t.next=12;break}return t.abrupt("return",new Headers(qi({"Content-Type":"application/json",appKey:e.appKey},i)));case 12:throw new Error("onCustomSignParam.getHeader result is not an object");case 13:t.next=16;break;case 15:throw new Error("onCustomSignParam.getHeader is not a object");case 16:t.next=19;break;case 18:return t.abrupt("return",new Headers({"Content-Type":"application/json",appKey:e.appKey,Authorization:e.authorization,userId:e.userId}));case 19:case"end":return t.stop()}}),t)})))()},getQuerys:function(){var e=this;return Ze(ot.mark((function t(){var r,i,n,o,s,a,c;return ot.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.onCustomSignParam){t.next=20;break}return t.next=3,e.onCustomSignParam();case 3:if((r=t.sent).getQuery){t.next=6;break}return t.abrupt("return","");case 6:if("object"!==bt(r.getQuery)){t.next=17;break}if(i=r.getQuery,"[object Object]"!==Object.prototype.toString.call(i)){t.next=14;break}for(n="",o=0,s=Object.entries(i);o<s.length;o++)a=Xe(s[o],2),c=a[1],n+="&".concat(a[0],"=").concat(c);return t.abrupt("return",n.slice(1));case 14:throw new Error("onCustomSignParam.getQuery result is not an object");case 15:t.next=18;break;case 17:throw new Error("onCustomSignParam.getQuery is not a object");case 18:t.next=21;break;case 20:return t.abrupt("return","");case 21:case"end":return t.stop()}}),t)})))()},baseUrl:function(e){return e.includes("https://")||e.includes("http://")?e:"".concat(this.ssl?"https://":"http://").concat(e)},getAppConfig:function(e,t){var r=this;return Ze(ot.mark((function i(){var n,o,s,a,c;return ot.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return r.path=r.baseUrl(e),i.next=3,r.getQuerys();case 3:return n=i.sent,i.next=6,r.getHeader();case 6:return o=i.sent,s=new AbortController,a="".concat(r.path,"/api/v1/app/config/get?").concat(n&&n+"&","appId=").concat(r.appKey),r.extendInfo&&r.extendInfo.location&&(a+="&location=".concat(r.extendInfo.location)),t&&(r.privateKey=t,a+="&privateKey=".concat(t)),c=function(){return fetch(a,{method:"GET",headers:o,signal:s.signal})},i.abrupt("return",Promise.race([r.timeoutPromise(r.timeout,s,"getAppConfig"),c()]).then((function(e){if(e.ok)return e.json();throw new It(401===e.status?{code:gt.AUTHORIZATION_FAILED,message:"Authorization failed: /api/v1/app/config/get?appId"}:404===e.status?{code:gt.GET_SERVER_NODE_FAILED,message:"404: /api/v1/app/config/get?appId"}:408===e.status?{code:gt.REQUEST_TIMEOUT,message:"".concat(e.statusText,": /api/v1/app/config/get?appId")}:{code:gt.SERVER_UNKNOWN_ERROR,message:"Server unknown error: /api/v1/app/config/get?appId"})})).catch((function(e){return Promise.reject(a+e)})).finally((function(){r.timeoutObj.getAppConfig&&clearTimeout(r.timeoutObj.getAppConfig),r.timeoutObj.getAppConfig=null})));case 13:case"end":return i.stop()}}),i)})))()},getWsUrl:function(e,t,r){var i=this;return Ze(ot.mark((function n(){var o,s,a,c,u;return ot.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return i.path=i.baseUrl(t),n.next=3,i.getQuerys();case 3:return o=n.sent,n.next=6,i.getHeader();case 6:return s=n.sent,a="".concat(i.path,"/api/v1/dispatch/get-can-use?").concat(o&&o+"&","mucNum=").concat(e),i.extendInfo&&i.extendInfo.location&&(a+="&location=".concat(i.extendInfo.location)),r&&(a+="&privateKey=".concat(r)),c=new AbortController,u=function(){return fetch(a,{method:"GET",headers:s,signal:c.signal})},n.abrupt("return",Promise.race([i.timeoutPromise(i.timeout,c,"getWsUrl"),u()]).then((function(e){if(e.ok)return e.json();throw new It(401===e.status?{code:gt.AUTHORIZATION_FAILED,message:"Authorization failed: /api/v1/dispatch/get-can-use?mucNum"}:404===e.status?{code:gt.GET_SERVER_NODE_FAILED,message:"404: /api/v1/dispatch/get-can-use?mucNum"}:408===e.status?{code:gt.REQUEST_TIMEOUT,message:"".concat(e.statusText,": /api/v1/dispatch/get-can-use?mucNum")}:{code:gt.SERVER_UNKNOWN_ERROR,message:"Server unknown error: /api/v1/dispatch/get-can-use?mucNum"})})).catch((function(e){return Promise.reject(a+e)})).finally((function(){i.timeoutObj.getWsUrl&&clearTimeout(i.timeoutObj.getWsUrl),i.timeoutObj.getWsUrl=null})));case 13:case"end":return n.stop()}}),n)})))()},upload:function(e){var t=this;return Ze(ot.mark((function r(){var i,n,o;return ot.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.getQuerys();case 2:return i=r.sent,r.next=5,t.getHeader();case 5:return n=r.sent,o="".concat(t.path,"/api/v1/logging/collect/list").concat(i&&"?".concat(i)),t.extendInfo&&t.extendInfo.location&&(o+=i?"&location=".concat(t.extendInfo.location):"?location=".concat(t.extendInfo.location)),t.privateKey&&(o+=i?"&privateKey=".concat(t.privateKey):"?privateKey=".concat(t.privateKey)),r.abrupt("return",fetch(o,{method:"POST",body:JSON.stringify(e),headers:n}).then((function(e){if(e.ok)return e.json();throw new It({code:e.status,message:e.statusText})})).catch((function(e){return Promise.reject(e)})));case 10:case"end":return r.stop()}}),r)})))()}};function Qi(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function Zi(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Qi(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Qi(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function en(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return tn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?tn(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function tn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var rn,nn,on=function(){function e(t,r){tt(this,e),this.logger=r,this.ssl=!!t.ssl||!!t.wsUrl.includes("https")||!t.wsUrl.includes("http"),this.wsUrl=t.wsUrl,this.wsUrlList=t.backupWsUrlList?et(new Set([this.wsUrl].concat(et(t.backupWsUrlList)))):[this.wsUrl],this.userId=t.userId,this.userName="undefined"!==t.userName&&t.userName?t.userName:"",this.mode=t.mode,this.sdkAppId=t.sdkAppId,this.userSig=t.userSig,this.onCustomSignParam=t.onCustomSignParam,this.extendInfo=t.extendInfo,this.appConfig=null,this.reconnectCount=0,this.init()}var t,r,i,n,o,s,a,c,u,d,l,h,p,f,m;return it(e,[{key:"init",value:function(){var e=this;this.publications=new Map,this.subscriptions=new Map,this.roomId=null,this.roomUniqueId=null,this.role="anchor",this.remoteStreams=new Map,this.state=ct.New,this.localStreams=[],this.enablemicVolume=!1,this.soundMeter=null,this.timer=null,this.micStream=null,this.isEnableSmallStream=!1,this._emitter=new st(this.logger),this.subscribeManager=new zr(this.logger),this._interval=-1,this._remoteMutedStateMap=new Map,this.audioVolumeInterval=null,this.isWaterMark=!1,this.waterMarkoptions=null,this.waterMarkImage=null,this.smallStreamConfig={width:160,height:120,bitrate:100,framerate:15},this.logger.setUserId(this.userId),this.logger.setServerUrl(this.wsUrl),Xi.init({userId:this.userId,ssl:this.ssl,sdkAppId:this.sdkAppId,userSig:this.userSig,onCustomSignParam:this.onCustomSignParam,extendInfo:this.extendInfo}),this.xsigoClient=new Yi(this.logger,{notificationCb:this.notificationCb.bind(this),connectionLostCb:this.connectionLostCb.bind(this),tryToReconnectCb:this.tryToReconnectCb.bind(this),connectionRecoveryCb:this.connectionRecoveryCb.bind(this),onWsStateChange:this.onWsStateChange.bind(this),onWsError:this.onError.bind(this),onWsReconnectFailed:this.onWsReconnectFailed.bind(this)}),this.ssl&&navigator.mediaDevices&&mr().then((function(t){e._preDiviceList=t,e.logger.info("mediaDevices",JSON.stringify(e._preDiviceList,null,4))})).catch((function(){e._preDiviceList=[]})),this.senderStats=new Map,this.receiverStats=new Map,this.senderLocalStats=new Map,this.deviceChange=this.onDeviceChange.bind(this),this.visibilitychange=this.onVisibilitychange.bind(this),this.logger.info("userAgent:",navigator.userAgent)}},{key:"setAppConfig",value:function(e){var t=e.serverTs,r=e.logPeriod,i=e.enableLog,n=e.eventPeriod,o=e.enableEvent,s=e.metricCollectPeriod;this.appConfig={serverTs:t,timeDiff:t?Date.now()-t:0,logPeriod:r,enableLog:!1!==i,eventPeriod:n,enableEvent:!1!==o,metricCollectPeriod:s},this.logger.setApppConfig(this.appConfig),this.logger.info("get app config",JSON.stringify(this.appConfig,null,4))}},{key:"reset",value:function(){this.publications=new Map,this.subscriptions=new Map,this.localStreams=[],this.remoteStreams.clear(),this.subscribeManager.reset(),this._remoteMutedStateMap.clear(),this.appConfig=null,this._interval&&window.clearInterval(this._interval),this._interval=-1,this.reconnectCount=0,this.audioVolumeInterval&&window.clearInterval(this.audioVolumeInterval),this.audioVolumeInterval=null,this.removeEventListenser("devicechange"),this.removeEventListenser("visibilitychange"),this.logger.setServerUrl(null),this.logger.setApppConfig(null),this.closeWaterMark()}},{key:"notificationCb",value:function(e,t,r){if(t===Bt.ParticipantJoin){var i=r.participant,n=i.userId,o=i.previousRoomId,s=i.userData;this.logger.info("======notification: participant join======"),this.updateRemoteMutedState(n),this.logger.buriedLog({c:lr.ON_PEER_JOIN,v:"uid:".concat(n)}),this._emitter.emit("peer-join",{userId:n,previousRoomId:o,userData:s})}if(t===Bt.ParticipantLeave){var a=r.userId;this.logger.info("======notification: participant leave======"),this.onParticipantLeave(a)}if(t===Bt.StreamAdd&&(this.logger.info("======notification: stream add======"),this.onStreamAdd(r.stream)),t===Bt.StreamRemove&&(this.logger.info("======notification: stream remove======"),this.onStreamChange(r.userId,r.streamId)),t===Bt.Drop){var c=r.cause;this.logger.info("======notification: participant drop======"),this.onClientBanned(c)}if(t===Bt.StreamUpdate&&(this.logger.info("======notification: stream update======"),this.onStreamUpdate(r.userId,r.streamId,r.liveStatus,r.simulcast)),t===Bt.PermissionChange){var u=r;this.logger.info("======notification: role change======",u.userId,u.publish)}if(t===Bt.MuteLocal){var d=r.type,l=r.userId;this.logger.info("======notification: muteLocal ======",d),this.onMuteLocal(d,l)}}},{key:"connectionLostCb",value:function(e){this.logger&&(this.logger.info("room: ".concat(e," connection lost")),this.logger.buriedLog({c:lr.CONNECTIONLOST_CB}))}},{key:"tryToReconnectCb",value:function(e){this.logger.info("room: ".concat(e," connection retring ......"))}},{key:"connectionRecoveryCb",value:function(e,t,r){var i=this;return new Promise(function(){var n=Ze(ot.mark((function n(o,s){var a,c,u,d,l,h,p,f,m,g,v,y,b,S;return ot.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(i.logger.info("room: ".concat(e," connection recovery")),i.logger.buriedLog({c:lr.CONNECTION_RECOVERY_CB}),!r){n.next=50;break}if(i.roomUniqueId=t,i.logger.setRoomUniqueId(t),a=new Map,c=new Map,u=new Map(i.publications),!i.publications.size){n.next=25;break}d=en(u.entries()),n.prev=10,h=ot.mark((function e(){var t,r,n,o,s,c,u;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Xe(l.value,2),r=t[0],n=t[1],e.next=3,n.republish();case 3:(o=e.sent)&&(s=zi(),a.set(r,{sdp:o.sdp,pubId:s}),i.publications.delete(r),i.publications.set(s,n),(c=i.localStreams.find((function(e){return[e.audioStreamId,e.videoStreamId].includes(r)})))&&(u=c.screen?"share_".concat(c.getUserId()):c.getUserId(),i.senderStats.delete(u),c.streamId=s));case 5:case"end":return e.stop()}}),e)})),d.s();case 13:if((l=d.n()).done){n.next=17;break}return n.delegateYield(h(),"t0",15);case 15:n.next=13;break;case 17:n.next=22;break;case 19:n.prev=19,n.t1=n.catch(10),d.e(n.t1);case 22:return n.prev=22,d.f(),n.finish(22);case 25:if(!i.subscriptions.size){n.next=48;break}p=new Map(i.subscriptions),f=en(p.entries()),n.prev=28,f.s();case 30:if((m=f.n()).done){n.next=40;break}return g=Xe(m.value,2),y=g[1],i.logger.info("resubscribe stream",v=g[0]),n.next=35,y.subscriber.resubscribe();case 35:b=n.sent,i.receiverStats.delete(y.stream.getUserSeq()),b&&(S=zi(),c.set(v,{sdp:b.sdp,subId:S}),i.subscriptions.delete(v),i.subscriptions.set(S,y));case 38:n.next=30;break;case 40:n.next=45;break;case 42:n.prev=42,n.t2=n.catch(28),f.e(n.t2);case 45:return n.prev=45,f.f(),n.finish(45);case 48:i.logger.info("publishOfferSdp==>",a,"subscribeOfferSdp==>",c),o({publishOfferSdp:a,subscribeOfferSdp:c});case 50:case"end":return n.stop()}}),n,null,[[10,19,22,25],[28,42,45,48]])})));return function(e,t){return n.apply(this,arguments)}}())}},{key:"join",value:function(e){var t=this;if(this.logger.info("join room with options",JSON.stringify(e)),this.logger.buriedLog({c:lr.JOIN}),this.logger.buriedLog({c:lr.JOIN_FIRST}),[ct.New,ct.Leaved].includes(this.state))return new Promise(function(){var r=Ze(ot.mark((function r(i,n){var o,s,a,c,u,d,l,h,p,f,m,g;return ot.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.isJoinRoomSupported();case 2:if(s=(o=r.sent).code,a=o.message,o.isSupported){r.next=11;break}return t.logger.buriedLog({c:lr.JOIN_FAILED},!0),c="join room failed,".concat(a),t.logger.onError({c:lr.TOP_ERROR,v:gt.JOIN_ROOM_FAILED},c,!0),r.abrupt("return",n(new It({code:s,message:a})));case 11:if(d=e.role,l="",e.privateKey&&(l=e.privateKey),h=/^[A-Za-z0-9_-]+$/g,!(u=e.roomId)||h.test(u)){r.next=20;break}return p="join room failed,roomId:".concat(u,' is invalid，roomId can only be numbers, letters and "-" '),t.logger.buriedLog({c:lr.JOIN_FAILED},!0),t.logger.onError({c:lr.TOP_ERROR,v:gt.JOIN_ROOM_FAILED},p,!0),r.abrupt("return",n(new It({code:gt.INVALID_OPERATION,message:p})));case 20:if(!(t.wsUrl&&t.sdkAppId&&(t.userSig||t.onCustomSignParam)&&u&&t.userId)){r.next=28;break}t.roomId=u,t.role="live"===t.mode&&d||t.role,t.logger.setRoomId(t.roomId),f=function(r){t.state=ct.Joining;var o={onCustomSignParam:t.onCustomSignParam,appId:t.sdkAppId,userSig:t.userSig,userId:t.userId,userType:$t.Normal,previousRoomId:"",permission:at.get(t.role),userData:{userId:t.userId,userName:t.userName,extra:e.extra},extendInfo:t.extendInfo,serverUrl:r,privateKey:l,ssl:t.ssl,enterRoomCb:function(e,r,o){if(1===e){t.state=ct.Joined;var s=o.participants,a=o.roomUniqueId;t.getNetworkQuality(),t.addEventListenser("devicechange"),t.addEventListenser("visibilitychange"),t.roomUniqueId=a,t.logger.setRoomUniqueId(a),t.logger.buriedLog({c:lr.JOIN_SUCCESS}),t._emitter.emit("members",s),t.logger.info("join room ".concat(t.roomId," success")),i(!0)}else if(2===e){t.state=ct.New;var c="".concat(gt.JOIN_ROOM_FAILED," join room timeout");t.logger.onError({c:lr.TOP_ERROR,v:gt.JOIN_ROOM_FAILED},c,!0),t.logger.buriedLog({c:lr.JOIN_FAILED},!0),n(new It({code:gt.JOIN_ROOM_FAILED,message:"join room timeout"}))}else{t.state=ct.New;var u="join room failed:, ".concat(r);t.logger.onError({c:lr.TOP_ERROR,v:gt.JOIN_ROOM_FAILED},u,!0),t.logger.buriedLog({c:lr.JOIN_FAILED},!0),n(new It({code:gt.JOIN_ROOM_FAILED,message:r}))}}};t.xsigoClient.enterRoom(t.roomId,o)},t.getWsUrl(l,f,n),r.next=35;break;case 28:return r.next=30,t.onCustomSignParam();case 30:m=r.sent,g="join room failed, options is invalid,wsUrl:".concat(t.wsUrl,",sdkAppId:").concat(t.sdkAppId,",userSig:").concat(t.userSig,",onCustomSignParam:").concat(JSON.stringify(m),",roomId:").concat(e.roomId,",userId:").concat(t.userId),t.logger.error(g),t.logger.buriedLog({c:lr.JOIN_FAILED},!0),n(new It({code:gt.INVALID_OPERATION,message:g}));case 35:case"end":return r.stop()}}),r)})));return function(e,t){return r.apply(this,arguments)}}());this.logger.buriedLog({c:lr.JOIN_FAILED});var r="join room failed,client state is error ,state:".concat(this.state);this.logger.onError({c:lr.TOP_ERROR,v:gt.JOIN_ROOM_FAILED},r,!0)}},{key:"getWsUrl",value:(m=Ze(ot.mark((function e(t,r,i){var n,o,s,a,c,u,d,l,h,p;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=[],this.logger.info("wsUrlList,".concat(this.wsUrlList)),o=this.wsUrlList.shift(),this.wsUrlList.push(o),!o.includes("ws:")&&!o.includes("wss:")){e.next=9;break}return r(o),e.abrupt("return");case 9:return e.prev=9,e.next=12,Xi.getAppConfig(o,t);case 12:return(s=e.sent)&&this.setAppConfig(s.data),e.next=16,Xi.getWsUrl(this.roomId,o,t);case 16:c=((a=e.sent).data||{}).metadata,(o.includes("https://")||o.includes("http://"))&&(o=o.split("//")[1]),u=o.split(":").length-1>=2,c?u?(l=c.hostV6,(d=c.sslHostV6).includes(":")&&(d=c.sslHostV6.includes("[")?c.sslHostV6:"[".concat(d),d=c.sslHostV6.includes("]")?c.sslHostV6:"".concat(d,"]")),l.includes(":")&&(l=c.hostV6.includes("[")?c.hostV6:"[".concat(l),l=c.hostV6.includes("]")?c.hostV6:"".concat(l,"]")),n=this.ssl?"wss://".concat(d,":").concat(c.sslPort):"ws://".concat(l,":").concat(c.port)):n=this.ssl?"wss://".concat(c.sslHost,":").concat(c.sslPort):"ws://".concat(c.host,":").concat(c.port):n="wss://".concat(a.data.host,":").concat(a.data.port),this.logger.info(" httpUrl==>".concat(o,"  , serverIPUrl==>").concat(n)),r(n),e.next=40;break;case 25:if(e.prev=25,e.t0=e.catch(9),this.reconnectCount++,!(this.reconnectCount<this.wsUrlList.length)){e.next=36;break}if(this.state!==ct.Leaved&&this.state!==ct.Leaving){e.next=31;break}return e.abrupt("return");case 31:h="http connect faild ,sdk is reconnecting,count:".concat(this.reconnectCount," ==>").concat(e.t0),this.logger.warn(h),this.getWsUrl(t,r,i),e.next=40;break;case 36:p="http connect faild, SDK has tried reconnect , but faild,  please check your network and server ==>".concat(e.t0),this.logger.onError({c:lr.TOP_ERROR,v:gt.JOIN_ROOM_FAILED},p,!0),this.logger.buriedLog({c:lr.JOIN_FAILED},!0),i(new It({code:gt.JOIN_ROOM_FAILED,message:e.t0}));case 40:case"end":return e.stop()}}),e,this,[[9,25]])}))),function(e,t,r){return m.apply(this,arguments)})},{key:"leave",value:(f=Ze(ot.mark((function e(){var t=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(![ct.Leaving,ct.Leaved].includes(this.state)){e.next=2;break}return e.abrupt("return");case 2:return this.logger.buriedLog({c:lr.LEAVE}),e.abrupt("return",new Promise((function(e,r){var i,n=en(t.publications.entries());try{var o=function(){var e=Xe(i.value,2),r=e[0],n=e[1],o=t.localStreams.find((function(e){return e.streamId===r}));o&&o.close(),n.close()};for(n.s();!(i=n.n()).done;)o()}catch(e){n.e(e)}finally{n.f()}var s,a=en(t.subscriptions.values());try{for(a.s();!(s=a.n()).done;){var c=s.value;c.stream.close(),c.subscriber.close()}}catch(e){a.e(e)}finally{a.f()}t.state=ct.Leaving,t.xsigoClient.exitRoom(t.roomId,(function(r,i,n){if(1===r)t.logger.info("leave room success");else{var o="leave room failed:, ".concat(i);t.logger.onError({c:lr.TOP_ERROR,v:gt.LEAVE_ROOM_FAILED},o,!0)}t.logger.buriedLog({c:lr.LEAVE_SUCCESS},!0),t.state=ct.Leaved,t.reset(),e(!0)}))})));case 4:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"publish",value:(p=Ze(ot.mark((function e(t){var r,i,n=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.logger.info("publish stream"),t){e.next=5;break}throw this.logger.error("stream is undefined or null"),new It({code:gt.INVALID_OPERATION,message:"stream is undefined or null"});case 5:if(!(r=[ut.Publishing,ut.Published]).includes(t.getPubState("audio"))||!r.includes(t.getPubState("video"))){e.next=8;break}throw new It({code:gt.INVALID_OPERATION,message:"duplicate publishing, please unpublish and then re-publish"});case 8:if("live"!==this.mode||"audience"!==this.role){e.next=10;break}throw new It({code:gt.INVALID_OPERATION,message:'no permission to publish() under live/audience, please call swithRole("anchor") firstly before publish()'});case 10:if(t.mediaStream){e.next=12;break}throw new It({code:gt.INVALID_OPERATION,message:"stream not initialized!"});case 12:return this.logger.buriedLog({c:t.screen?lr.PUBLISH_STREAM_SCREEN:lr.PUBLISH_STREAM}),i=t.mediaStream.getTracks().map((function(e){return new Promise((function(i,o){var s=new MediaStream;s.addTrack(e);var a="audio"===e.kind,c=a&&!e.enabled,u="video"===e.kind,d=u&&!e.enabled;if(r.includes(t.getPubState(e.kind)))n.logger.warn("".concat(a?"audio":"video"," is publishing or published"));else{t.setPubState(e.kind,ut.Publishing);var l={localStream:t,mediaStream:s,screen:t.screen,hasAudio:a,audioMuted:c,hasVideo:u,videoMuted:d,bitrate:t.getBitrate(),videoProfile:t.videoProfile};n.doPublish(l,(function(r,s,c){if(n.logger.info("xsigo client publish stream success",c&&c.streamId),t.getPubState(e.kind)!==ut.Unpublished)if(1===r)t.published||(t.published=!0,t.roomId=c.roomId,t.streamId=c.streamId,t.xsigoClient=n.xsigoClient,-1===n.localStreams.findIndex((function(e){return e.streamId===c.streamId}))&&(n.localStreams.push(t),t.onTrackAdd(n.onAddTrack.bind(n)),t.onTrackRemove(n.onRemoveTrack.bind(n)),t.onSwitchDevice(n.onReplaceTrack.bind(n)),t.onReplaceTrack(n.onReplaceTrack.bind(n)))),a&&(t.setHasAudio(!!a),t.setAudioStreamId(c.streamId)),u&&(t.setHasVideo(!!u),t.setVideoStreamId(c.streamId)),n.logger.buriedLog({c:t.screen?lr.PUBLISH_STREAM_SCREEN_SUCCESS:lr.PUBLISH_STREAM_SUCCESS,v:a?"audio":"video"}),t.setPubState(e.kind,ut.Published),i(t);else if(n.logger.buriedLog({c:t.screen?lr.PUBLISH_STREAM_SCREEN_FAILED:lr.PUBLISH_STREAM_FAILED,v:a?"audio":"video"}),c&&n.publications.delete(c.streamId),t.setPubState(e.kind,ut.Create),"H264 not supported"===s){n.logger.onError({c:lr.TOP_ERROR,v:gt.H264_NOT_SUPPORTED});var d=new It({code:gt.H264_NOT_SUPPORTED,message:"publish stream failed h264 not supported"});n._emitter.emit(pt,d),o(d)}else n.logger.onError({c:lr.TOP_ERROR,v:gt.PUBLISH_STREAM_FAILED},s),o(new It({code:gt.PUBLISH_STREAM_FAILED,message:s}))}))}}))})),e.abrupt("return",Promise.all(i));case 16:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"onAddTrack",value:function(e){var t=this,r=e.track,i=e.streamId,n=new MediaStream;n.addTrack(r);var o="audio"===r.kind,s=o&&!r.enabled,a="video"===r.kind,c=a&&!r.enabled,u=this.localStreams.find((function(e){return e.streamId===i}));if(this.logger.info("PublishState",u&&u.getPubState(r.kind)),u&&![ut.Publishing,ut.Published].includes(u.getPubState(r.kind))){var d={localStream:u,screen:!1,hasAudio:o,audioMuted:s,hasVideo:a,videoMuted:c,mediaStream:n,bitrate:u.getBitrate(),videoProfile:u.videoProfile};u.setPubState(r.kind,ut.Publishing),this.doPublish(d,(function(e,i,n){u.getPubState(r.kind)!==ut.Unpublished&&(1===e?(u.mediaStream.addTrack(r),u.published=!0,o&&(u.setHasAudio(o),u.setAudioStreamId(n.streamId),u.setAudioTrack(r)),a&&(u.setHasVideo(a),u.setVideoStreamId(n.streamId),u.setVideoTrack(r)),u.setPubState(r.kind,ut.Published)):(n&&t.publications.delete(n.streamId),u.setPubState(r.kind,ut.Create)),t.logger.buriedLog({c:1===e?lr.PUBLISH_STREAM_SUCCESS:lr.PUBLISH_STREAM_FAILED,v:o?"addAudioTrack":"addVideoTrack"}),u._emitter.emit("stream-track-update-result",{code:e,message:i}))}))}else r.stop(),this.logger.warn(u?"same track is publishing or published":"stream is not published")}},{key:"doPublish",value:(h=Ze(ot.mark((function e(t,r){var i,n,o,s,a,c,u,d;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,c=(o=t||{}).localStream,u=new Wr({roomId:this.roomId,userId:this.userId,mediaStream:o.mediaStream,screen:o.screen,bitrate:o.bitrate,isEnableSmallStream:this.isEnableSmallStream,smallStreamConfig:this.smallStreamConfig,hasAudio:s=o.hasAudio,audioMuted:o.audioMuted,hasVideo:a=o.hasVideo,videoMuted:o.videoMuted,minBitrate:(null===(i=t.videoProfile)||void 0===i?void 0:i.minBitrate)||0,maxBitrate:(null===(n=t.videoProfile)||void 0===n?void 0:n.maxBitrate)||0,logger:this.logger,xsigoClient:this.xsigoClient,onPublish:r}),e.next=5,u.publish();case 5:"string"!=typeof(d=e.sent)||this.publications.has(d)||(u.onPublishPeerConnectionFailed(this.onPublishPeerConnectionFailed.bind(this)),this.publications.set(d,u),c.streamId=d,s&&c.setAudioStreamId(d),a&&c.setVideoStreamId(d)),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),r&&r(0,e.t0);case 12:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(e,t){return h.apply(this,arguments)})},{key:"onPublishPeerConnectionFailed",value:function(e){var t=this,r=e.state,i=e.streamId,n=this.xsigoClient.getWsState(this.roomId);if(this.publications.has(i)){var o=this.localStreams.find((function(e){return[e.audioStreamId,e.videoStreamId].includes(i)}));o&&("failed"===r&&n&&["CONNECTED","RECOVERY"].includes(n.state)?(this.logger.warn("publish peerConnection failed try to republish streamId:".concat(i)),o.updatePeerConnectionFailed(r),this.doUnpublish(o,i).then((function(){var e=new MediaStream,r=o.audioStreamId===i,n=o.videoStreamId===i,s=r?o.getAudioTrack():o.getVideoTrack(),a=r&&!s.enabled,c=n&&!s.enabled;t.logger.info("publish ".concat(r?"audio":"video",",trackId:").concat(s&&s.id)),e.addTrack(s);var u={localStream:o,screen:o.screen,hasAudio:r,audioMuted:a,hasVideo:n,videoMuted:c,mediaStream:e,bitrate:o.getBitrate()};t.doPublish(u,(function(e,i,s){1===e?(o.published=!0,r&&(o.setHasAudio(r),o.setAudioStreamId(s.streamId)),n&&(o.setHasVideo(n),o.setVideoStreamId(s.streamId))):s&&t.publications.delete(s.streamId)}))}))):"connected"===r&&o.updatePeerConnectionFailed(r))}}},{key:"onRemoveTrack",value:function(e){var t=this,r=e.track,i=e.streamId,n=r.kind,o=this.localStreams.find((function(e){return e.streamId===i}));if(o&&![ut.Create,ut.Unpublished].includes(o.getPubState(r.kind))){var s="audio"===n?o.audioStreamId:o.videoStreamId;o.mediaStream.removeTrack(r),"audio"===n&&o.setHasAudio(!1),"video"===n&&o.setHasVideo(!1),this.doUnpublish(o,s,(function(e,r){1===e&&t.logger.info("remove track success"),o._emitter.emit("stream-track-update-result",{code:e,message:r})}))}else this.logger.warn("stream is not published")}},{key:"onReplaceTrack",value:function(e){var t=e.streamId,r=e.type,i=e.track,n=this.localStreams.find((function(e){return e.streamId===t}));if(n){var o="audio"===r?n.audioStreamId:n.videoStreamId;o&&this.publications.has(o)&&this.publications.get(o).replaceMediaStreamTrack(i)}}},{key:"unpublish",value:function(e){var t=this;if(this.logger.info("unpublish stream"),!e)throw this.logger.error("stream is undefined or null"),new It({code:gt.INVALID_OPERATION,message:"stream is undefined or null"});this.logger.buriedLog({c:e.screen?lr.UNPUBLISH_STREAM_SCREEN:lr.UNPUBLISH_STREAM});var r,i=[],n=en(this.publications.keys());try{for(n.s();!(r=n.n()).done;){var o=r.value;[e.audioStreamId,e.videoStreamId].includes(o)&&i.push(this.doUnpublish(e,o))}}catch(e){n.e(e)}finally{n.f()}return Promise.all(i).then((function(){var r=t.localStreams.findIndex((function(t){return t.getId()===e.getId()}));-1!==r&&t.localStreams.splice(r,1)}))}},{key:"doUnpublish",value:function(e,t,r){var i=this;return new Promise((function(n,o){var s=i.publications.get(t);if(s){i.publications.delete(t),e.audioStreamId===t&&e.setHasAudio(!1),e.videoStreamId===t&&e.setHasVideo(!1);var a=e.screen?"share_".concat(e.getUserId()):e.getUserId();if(e.hasAudio()||e.hasVideo()||(e.published=!1),e.setPubState(e.audioStreamId===t?"audio":"video",ut.Unpublished),i.senderStats.has(a)){var c=Zi({},i.senderStats.get(a));e.hasAudio()||(c.audio={bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0}),e.hasVideo()||(c.video={bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0},c.smallVideo={bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0}),i.senderStats.set(a,c)}n(!0),s.unpublish((function(n,o,s){1===n?(i.logger.info("unpublish stream success",t),r&&r(n,o),i.logger.buriedLog({c:e.screen?lr.UNPUBLISH_STREAM_SCREEN_SUCCESS:lr.UNPUBLISH_STREAM_SUCCESS,v:e.audioStreamId===t?"audio":"video"})):(i.logger.buriedLog({c:e.screen?lr.UNPUBLISH_STREAM_SCREEN_FAILED:lr.UNPUBLISH_STREAM_FAILED,v:e.audioStreamId===t?"audio":"video"}),r&&r(n,o),i.logger.onError({c:lr.TOP_ERROR,v:gt.UNPUBLISH_STREAM_FAILED},"unpublish stream with response:, ".concat(n,",").concat(o)))}))}else i.logger.warn("stream is not published",t),n(!0)}))}},{key:"subscribe",value:(l=Ze(ot.mark((function e(t,r){var i,n,o;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}throw this.logger.error("stream is undefined or null"),new It({code:gt.INVALID_OPERATION,message:"stream is undefined or null"});case 3:if(t.isRemote){e.next=6;break}throw this.logger.error("try to subscribe a local stream"),new It({code:gt.INVALID_OPERATION,message:"try to subscribe a local stream"});case 6:if(!(i=[dt.Subscribing,dt.Subscribed]).includes(t.getSubState("audio"))||!i.includes(t.getSubState("video"))){e.next=10;break}throw this.logger.error("Stream already subscribing or subscribed"),new It({code:gt.INVALID_OPERATION,message:"Stream already subscribing or subscribed"});case 10:return!r&&(r={audio:!0,video:!0,small:!1}),n=t.getUserSeq(),t=this.remoteStreams.get(n),this.logger.info("subscribe with options:",JSON.stringify(r,null,4),t),this.subscribeManager.setSubscriptionOpts(n,r),o=[],t&&t.audioStreamId&&!i.includes(t.getSubState("audio"))?r.audio&&o.push(this.doSubscribe(t,{audio:!0,video:!1,small:!!r.small&&r.small})):i.includes(t.getSubState("audio"))&&this.logger.warn("audio is subscribing or subscribed"),t&&t.videoStreamId&&!i.includes(t.getSubState("video"))?r.video&&o.push(this.doSubscribe(t,{audio:!1,video:!0,small:!!r.small&&r.small})):i.includes(t.getSubState("video"))&&this.logger.warn("video is subscribing or subscribed"),e.abrupt("return",Promise.all(o));case 19:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"doSubscribe",value:(d=Ze(ot.mark((function e(t,r,i){var n=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=Ze(ot.mark((function e(o,s){var a,c,u,d,l,h,p,f,m,g;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n.logger.info("doSubscribe options",JSON.stringify(r,null,4)),a=t.getUserSeq(),c=t.getSimulcasts(),l=!!r.small&&r.small,n.logger.info("---do subscribe options",u=r.audio?t.audio:r.audio,d=r.video?t.video:r.video),n.logger.buriedLog({c:t.getType()===ht?lr.SUBSCRIBE_STREAM_SCREEN:lr.SUBSCRIBE_STREAM,v:"uid:".concat(t.getUserId(),",").concat(u?"audio":"video")}),t.setSubState(u?"audio":"video",dt.Subscribing),u&&n.subscribeManager.updateSubscriptedState(a,{audio:u,small:l}),d&&n.subscribeManager.updateSubscriptedState(a,{video:d,small:l}),h=0,p=0,f=new ci({userId:t.userId,publisherUserId:t.getUserId(),hasAudio:u,hasVideo:d,simulcast:c,audioStreamId:u?t.audioStreamId:null,videoStreamId:d?t.videoStreamId:null,logger:n.logger,xsigoClient:n.xsigoClient,roomId:n.roomId,small:l,onRemoteStream:function(){var e=Ze(ot.mark((function e(r,s,c,l){var f,m,g;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!u||t.getSubState("audio")!==dt.Unsubscribed){e.next=2;break}return e.abrupt("return");case 2:if(!d||t.getSubState("video")!==dt.Unsubscribed){e.next=4;break}return e.abrupt("return");case 4:f=n.remoteStreams.get(a),"audio"===s.kind&&h++,"video"===s.kind&&p++,f&&(c!==Ht.AudioVideo&&c!==Ht.VideoOnly||f.setIsAlphaChannels(l),f.mediaStream||f.setMediaStream(r),"audio"===s.kind&&(h>1||i||!f.getAudioTrack())&&(f.updateTrack("audio",s),i||h>1?f.setAudioTrack(s):f.restartAudio()),"video"===s.kind&&(p>1||i||!f.getVideoTrack())&&(f.updateTrack("video",s),i||p>1?f.setVideoTrack(s):f.restartVideo()),n.subscribeManager.addSubscriptionRecord(a,f),m=t.getType()===ht?"share_".concat(t.getUserId()):t.getUserId(),f.subscribed?(n._emitter.emit("stream-updated",{stream:f}),g="",c===Ht.AudioOnly?g=f.audioMuted?"mute-audio":"unmute-audio":c===Ht.VideoOnly&&(g=f.videoMuted?"mute-video":"unmute-video"),n._emitter.emit(g,{userId:m})):(f.subscribed=!0,n.logger.buriedLog({c:t.getType()===ht?lr.ON_STREAM_SUBSCRIBED_SCREEN:lr.ON_STREAM_SUBSCRIBED,v:"uid:".concat(t.getUserId())}),n._emitter.emit("stream-subscribed",{stream:f}),f.getType()===ht&&n.isWaterMark&&f.startWaterMark(n.waterMarkoptions,n.waterMarkImage),c===Ht.AudioOnly?n._emitter.emit(f.audioMuted?"mute-audio":"unmute-audio",{userId:m}):c===Ht.VideoOnly&&n._emitter.emit(f.videoMuted?"mute-video":"unmute-video",{userId:m})),t.setSubState(u?"audio":"video",dt.Subscribed),o(!0));case 8:case"end":return e.stop()}}),e)})));return function(t,r,i,n){return e.apply(this,arguments)}}(),onSubscribe:function(e,r,i){var o=n.subscribeManager.getSubscriptedState(a);if(!(u&&t.getSubState("audio")===dt.Unsubscribed||d&&t.getSubState("video")===dt.Unsubscribed))if(1===e)u&&(o.audio=!0),d&&(o.video=!0),n.subscribeManager.updateSubscriptedState(a,o),c.length&&(l?c.find((function(e){return e.type===Yt.SmallStream}))&&t.setSimulcastType(Yt.SmallStream):t.setSimulcastType(c[0].type)),n.logger.info("subscribe stream success"),n.logger.buriedLog({c:t.getType()===ht?lr.SUBSCRIBE_STREAM_SCREEN_SUCCESS:lr.SUBSCRIBE_STREAM_SUCCESS,v:"uid:".concat(t.getUserId(),",").concat(u?"audio":"video")});else{n.logger.onError({c:lr.TOP_ERROR,v:gt.SUBSCRIBE_FAILED},"on subscribe stream with response:, ".concat(e,", ").concat(r)),n.logger.buriedLog({c:t.getType()===ht?lr.SUBSCRIBE_STREAM_SCREEN_FAILED:lr.SUBSCRIBE_STREAM_FAILED,v:"uid:".concat(t.getUserId(),",").concat(u?"audio":"video")}),n.subscriptions.delete(i.subscriptionId),t.setSubState(u?"audio":"video",dt.Create);var h=n.subscribeManager.getSubscriptedState(a),p=n.subscribeManager.needSubscribeKind(a);p===Ht.AudioVideo&&h.audio&&h.video&&(u&&n.subscribeManager.updateSubscriptedState(a,{audio:!1}),d&&n.subscribeManager.updateSubscriptedState(a,{video:!1})),p===Ht.VideoOnly&&d&&n.subscribeManager.updateSubscriptedState(a,{video:!1}),p===Ht.AudioVideo&&u&&n.subscribeManager.updateSubscriptedState(a,{audio:!1}),s(new It({code:gt.SUBSCRIBE_FAILED,message:r}))}}}),e.next=17,f.subscribe();case 17:if(m=e.sent,n.logger.info("time Date.now doSubscribe",n.remoteStreams.has(a),t.audioStreamId,t.videoStreamId),!u||t.audioStreamId){e.next=21;break}return e.abrupt("return",f.close());case 21:if(!d||t.videoStreamId){e.next=23;break}return e.abrupt("return",f.close());case 23:n.subscriptions.has(m)||(f.onSubscribePeerConnectionFailed(n.onSubscribePeerConnectionFailed.bind(n)),n.subscriptions.set(m,{subscriber:f,stream:t})),u&&t.setAudioSubscriptionId(m),d&&t.setVideoSubscriptionId(m),e.next=31;break;case 28:e.prev=28,e.t0=e.catch(0),"H264 not supported"===e.t0?(n.logger.onError({c:lr.TOP_ERROR,v:gt.H264_NOT_SUPPORTED},"subscribe stream failed h264 not supported"),g=new It({code:gt.H264_NOT_SUPPORTED,message:"subscribe stream failed h264 not supported"}),n._emitter.emit(pt,g)):(n.logger.onError({c:lr.TOP_ERROR,v:gt.SUBSCRIBE_FAILED},"subscribe stream error:, ".concat(e.t0,"}")),s(new It({code:gt.SUBSCRIBE_FAILED,message:e.t0})));case 31:case"end":return e.stop()}}),e,null,[[0,28]])})));return function(t,r){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),function(e,t,r){return d.apply(this,arguments)})},{key:"onSubscribePeerConnectionFailed",value:function(e){var t=this,r=e.state,i=e.subscriptionId,n=this.xsigoClient.getWsState(this.roomId);if(this.subscriptions.has(i)){var o=this.subscribeManager.getSubscriptionOpts(this.userId),s=this.subscriptions.get(i).stream;if(s)if("failed"===r&&n&&["CONNECTED","RECOVERY"].includes(n.state)){this.logger.warn("subscribe peerConnection failed try to resubscribe subscriptionId:".concat(i)),s.updatePeerConnectionFailed(r);var a=s.audioSubscriptionId,c=s.videoSubscriptionId;this.doUnsubscribe(s,i).then((function(){a===i&&o.audio&&t.doSubscribe(s,{audio:!0,video:!1,small:!!o.small&&o.small},!0),c===i&&o.video&&t.doSubscribe(s,{audio:!1,video:!0,small:!!o.small&&o.small},!0)}))}else"connected"===r&&s.updatePeerConnectionFailed(r)}}},{key:"unsubscribe",value:function(e){if(!e)throw this.logger.error("stream is undefined or null"),new It({code:gt.INVALID_OPERATION,message:"stream is undefined or null"});var t=[],r=this.subscribeManager.getSubscriptionOpts(e.getUserSeq());return e.setSubState("audio",dt.Unsubscribed),e.setSubState("video",dt.Unsubscribed),r.audio&&e.audioSubscriptionId&&(t.push(this.doUnsubscribe(e,e.audioSubscriptionId)),e.setEnableTrackFlag("audio",!0)),r.video&&e.videoSubscriptionId&&(t.push(this.doUnsubscribe(e,e.videoSubscriptionId)),e.setEnableTrackFlag("video",!0)),Promise.all(t)}},{key:"doUnsubscribe",value:function(e,t){var r=this,i=e.audioSubscriptionId&&e.audioSubscriptionId===t,n=e.videoSubscriptionId&&e.videoSubscriptionId===t;this.logger.buriedLog({c:e.getType()===ht?lr.UNSUBSCRIBE_STREAM_SCREEN:lr.UNSUBSCRIBE_STREAM,v:"uid:".concat(e.getUserId(),",").concat(i?"audio":"video")});var o=e.getUserSeq(),s=this.remoteStreams.get(o),a=this.subscribeManager.getSubscriptedState(o);return s&&i&&(s.getAudioTrack()&&s.mediaStream.removeTrack(s.getAudioTrack()),s.setSubState("audio",dt.Unsubscribed),e.setAudioSubscriptionId(null),this.subscribeManager.updateSubscriptedState(o,Zi(Zi({},a),{},{audio:!1,small:!1}))),s&&n&&(s.getVideoTrack()&&s.mediaStream.removeTrack(s.getVideoTrack()),s.setSubState("video",dt.Unsubscribed),e.setVideoSubscriptionId(null),this.subscribeManager.updateSubscriptedState(o,Zi(Zi({},a),{},{video:!1,small:!1}))),!s||e.getAudioTrack()||e.getVideoTrack()||(s.subscribed=!1,s.mediaStream=null),this.receiverStats.has(o)&&this.receiverStats.delete(o),new Promise((function(n,o){if(r.subscriptions.has(t)){var s=r.subscriptions.get(t);r.subscriptions.delete(t),n(!0),s.subscriber.unsubscribe((function(t,n,o){1===t?(r.logger.info("unsubscribe stream success"),r.logger.buriedLog({c:e.getType()===ht?lr.UNSUBSCRIBE_STREAM_SCREEN_SUCCESS:lr.UNSUBSCRIBE_STREAM_SUCCESS,v:"uid:".concat(e.getUserId(),",").concat(i?"audio":"video")})):(r.logger.buriedLog({c:e.getType()===ht?lr.UNSUBSCRIBE_STREAM_SCREEN_FAILED:lr.UNSUBSCRIBE_STREAM_FAILED,v:"uid:".concat(e.getUserId(),",").concat(i?"audio":"video")}),r.logger.onError({c:lr.TOP_ERROR,v:gt.UNSUBSCRIBE_FAILED},"unsubscribe stream with response:,".concat(t,", ").concat(n)))}))}else r.logger.warn("stream is not subscribed",e.getUserId()),r.logger.buriedLog({c:e.getType()===ht?lr.UNSUBSCRIBE_STREAM_SCREEN_SUCCESS:lr.UNSUBSCRIBE_STREAM_SUCCESS,v:"uid:".concat(e.getUserId(),",").concat(i?"audio":"video")}),n(!0)}))}},{key:"updateSimulcast",value:function(e,t){var r=this;return new Promise((function(i,n){var o=r.publications.get(e.videoStreamId);if(!o&&e.screen)throw new It({code:gt.INVALID_OPERATION,message:"stream is invalid"});var s=t.map((function(e){return{type:sr(e.rid),maxWidth:e.maxWidth,maxHeight:e.maxHeight}})),a=e.getSimulcasts();if(JSON.stringify(s)===JSON.stringify(a))return r.logger.warn("simulcast  ".concat(t," is same"));r.logger.info("Update Simulcast ".concat(t)),o.updateSimulcast(s,(function(e,o,s){if(1===e)i(!0),r.logger.info("Update Simulcast ".concat(t," Success"));else{r.logger.onError({c:lr.TOP_ERROR,v:gt.LOCAL_SWITCH_SIMULCAST});var a=new It({code:gt.LOCAL_SWITCH_SIMULCAST,message:o});n(a)}}))}))}},{key:"setRemoteVideoStreamType",value:function(e,t){var r=this;if(!e||!t)throw this.logger.error("stream or status is undefined or null"),new It({code:gt.INVALID_OPERATION,message:"stream or status is undefined or null"});return new Promise((function(i,n){var o={big:"h",small:"l"}[t];if(!o)throw new It({code:gt.INVALID_OPERATION,message:"status: ".concat(t," is invalid")});var s=r.getRemoteMutedState().filter((function(t){return t.userId===e.getUserId()}))[0];if("small"===t&&s&&!s.hasSmall)throw new It({code:gt.INVALID_OPERATION,message:"does not publish small stream"});var a=r.subscriptions.get(e.videoSubscriptionId);if(!a)throw new It({code:gt.INVALID_OPERATION,message:"remoteStream is invalid"});var c=sr(o);if(e.getSimulcastType()===c)return r.logger.warn("status ".concat(t," is same"));r.logger.info("Set Remote Video Stream Type ".concat(t)),r.logger.buriedLog({c:c===Yt.SmallStream?lr.SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL:lr.SET_REMOTE_VIDEO_STREAM_TYPE_BIG}),a.subscriber.switchSimulcast(c,(function(o,s,a){if(1===o)e.setSimulcastType(c),r.logger.info("Set Remote Video Stream Type ".concat(t," Success")),r.logger.buriedLog({c:c===Yt.SmallStream?lr.SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL_SUCCESS:lr.SET_REMOTE_VIDEO_STREAM_TYPE_BIG_SUCCESSE}),i(!0);else{var u=new It({code:gt.REMOTE_SWITCH_SIMULCAST,message:s});r.logger.onError({c:lr.TOP_ERROR,v:gt.LOCAL_SWITCH_SIMULCAST},s),r.logger.buriedLog({c:c===Yt.SmallStream?lr.SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL_FAILED:lr.SET_REMOTE_VIDEO_STREAM_TYPE_BIG_FAILED}),n(u)}}))}))}},{key:"switchRole",value:(u=Ze(ot.mark((function e(t){var r,i,n,o=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}throw new It({code:gt.INVALID_OPERATION,message:"role is undefined or null"});case 2:if("rtc"!==this.mode){e.next=4;break}throw new It({code:gt.INVALID_OPERATION,message:"role is only valid in live mode"});case 4:if("anchor"===t||"audience"===t){e.next=7;break}throw this.logger.onError({c:lr.TOP_ERROR,v:gt.INVALID_PARAMETER}),new It({code:gt.INVALID_PARAMETER,message:"role could only be set to a value as anchor or audience"});case 7:if(t!==this.role){e.next=10;break}return this.logger.warn("can not switch the same role"),e.abrupt("return",Promise.resolve(!0));case 10:if(this.logger.buriedLog({c:"anchor"===t?lr.SWITCH_ROLE_ANCHOR:lr.SWITCH_ROLE_AUDIENCE}),"audience"===t){r=en(this.publications.keys());try{for(n=function(){var e=i.value,t=o.localStreams.find((function(t){return[t.audioStreamId,t.videoStreamId].includes(e)}));t&&o.doUnpublish(t,e)},r.s();!(i=r.n()).done;)n()}catch(e){r.e(e)}finally{r.f()}}return e.abrupt("return",new Promise(function(){var e=Ze(ot.mark((function e(r,i){return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o.xsigoClient.switchPermission(o.roomId,at.get(t),(function(e,n,s){if(1===e)o.logger.info("switch role from ".concat(o.role," to ").concat(t)),o.role=t,o.localStreams=[],o.logger.buriedLog({c:"anchor"===t?lr.SWITCH_ROLE_ANCHOR_SUCCESS:lr.SWITCH_ROLE_AUDIENCE_SUCCESS}),r(!0);else{o.logger.buriedLog({c:"anchor"===t?lr.SWITCH_ROLE_ANCHOR_FAILED:lr.SWITCH_ROLE_AUDIENCE_FAILED}),o.logger.onError({c:lr.TOP_ERROR,v:gt.SWITCH_ROLE_ERROR});var a=new It({code:gt.SWITCH_ROLE_ERROR,message:n});i(a)}}));case 1:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()));case 13:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"on",value:function(e,t){this._emitter.on(e,t)}},{key:"off",value:function(e,t){this.logger&&this.logger.buriedLog({c:lr["OFF_".concat(e.replace("-","_").toUpperCase())]}),this._emitter.off(e,t)}},{key:"getRemoteMutedState",value:function(){this.logger.buriedLog({c:lr.GET_REMOTE_MUTED_STATE});var e,t=[],r=en(this._remoteMutedStateMap);try{for(r.s();!(e=r.n()).done;){var i=Xe(e.value,2);t.push(Zi({userId:i[0]},i[1]))}}catch(e){r.e(e)}finally{r.f()}return t.filter((function(e){return!e.userId.includes("share_")}))}},{key:"updateRemoteMutedState",value:function(e,t){if(![e,"share_".concat(e)].includes(this.userId)){var r={hasAudio:!1,hasVideo:!1,audioMuted:!0,videoMuted:!0,hasSmall:!1};t=t||r;var i=this._remoteMutedStateMap.get(e)||r;this._remoteMutedStateMap.set(e,Zi(Zi({},i),t))}}},{key:"getTransportStats",value:(c=Ze(ot.mark((function e(){var t,r,i,n=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.publications.size){e.next=2;break}throw new It({code:gt.INVALID_OPERATION,message:"local stream is not published"});case 2:t=null,r=en(this.publications.values()),e.prev=4,r.s();case 6:if((i=r.n()).done){e.next=12;break}return t=i.value,e.abrupt("break",12);case 10:e.next=6;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(4),r.e(e.t0);case 17:return e.prev=17,r.f(),e.finish(17);case 20:return e.abrupt("return",new Promise((function(e,r){t.getTransportStats().then((function(r){var i=t.userId,o=0;if(n.senderStats.has(i)){var s=n.senderStats.get(i);s.video.timestamp?o=s.video.packetLossRate:s.audio.timestamp?o=s.audio.packetLossRate:s.smallVideo.timestamp&&(o=s.smallVideo.packetLossRate)}r.packetLossRate=o,e(r)})).catch((function(e){n.logger.onError({c:lr.TOP_ERROR,v:gt.INVALID_TRANSPORT_STATA});var t=new It({code:gt.INVALID_TRANSPORT_STATA,message:e});r(t)}))})));case 21:case"end":return e.stop()}}),e,this,[[4,14,17,20]])}))),function(){return c.apply(this,arguments)})},{key:"getRemoteTransportStats",value:(a=Ze(ot.mark((function e(){var t=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){try{var r,i=[],n=[],o=[],s=function(e,t,r){e.getTransportStats().then((function(e){-1===o.findIndex((function(e){return e.userId===t}))&&o.push({userId:t,packetLossRate:r,rtt:e})})).catch((function(){-1===o.findIndex((function(e){return e.userId===t}))&&o.push({userId:t,packetLossRate:-1,rtt:-1})}))},a=en(t.subscriptions.values());try{for(a.s();!(r=a.n()).done;){var c=r.value,u=c.subscriber.userId,d=0;if(t.receiverStats.has(u)){var l=t.receiverStats.get(u);l.video.timestamp?s(c.subscriber,u,d=l.video.packetLossRate):l.audio.timestamp&&s(c.subscriber,u,d=l.audio.packetLossRate)}n.push(d),i.push(c.subscriber.getTransportStats())}}catch(e){a.e(e)}finally{a.f()}Promise.all(i).then((function(r){et(t._remoteMutedStateMap.keys()).forEach((function(e){-1===o.findIndex((function(t){return t.userId===e}))&&o.push({userId:e,packetLossRate:-1,rtt:-1})}));var i=r.length>0?r.reduce((function(e,t){return e+t}))/r.length:-1,s=n.length>0?n.reduce((function(e,t){return e+t}))/n.length:-1;e({packetLossRate:s,rtt:i,list:o})}))}catch(r){var h=et(t._remoteMutedStateMap.keys()).map((function(e){return{userId:e,packetLossRate:-1,rtt:-1}}));e({packetLossRate:-1,rtt:-1,list:h})}})));case 1:case"end":return e.stop()}}),e)}))),function(){return a.apply(this,arguments)})},{key:"getNetworkQuality",value:function(){var e=this;if(-1===this._interval){var t={uplinkNetworkQuality:0,downlinkNetworkQuality:0,downlinkNetworkQualityList:[]};this._interval=window.setInterval((function(){if(e.xsigoClient){var r,i=e.xsigoClient.getWsState(e.roomId),n=i||{},o=n.state;i&&("DISCONNECTED"===o||"RECONNECTING"===o||"CONNECTING"===o&&"RECONNECTING"===n.prevState)?(t.uplinkNetworkQuality=6,t.downlinkNetworkQuality=6,t.downlinkNetworkQualityList=et(e._remoteMutedStateMap.keys()).map((function(e){return{userId:e,downlinkNetworkQuality:6}}))):(e.getTransportStats().then((function(r){t.uplinkNetworkQuality=e.networkLevel(r.packetLossRate,r.rtt)})).catch((function(){t.uplinkNetworkQuality=0})),e.getRemoteTransportStats().then((function(r){t.downlinkNetworkQuality=e.networkLevel(r.packetLossRate,r.rtt),r.list&&(t.downlinkNetworkQualityList=r.list.map((function(t){return{userId:t.userId,downlinkNetworkQuality:e.networkLevel(t.packetLossRate,t.rtt)}})))})).catch((function(e){t.downlinkNetworkQuality=0,t.downlinkNetworkQualityList=e.list.map((function(e){return{userId:e.userId,downlinkNetworkQuality:0}}))}))),(t.uplinkNetworkQuality>=3||t.downlinkNetworkQuality>=3)&&e.logger.warn("network-quality",JSON.stringify(t,null,4)),e._emitter.emit("network-quality",t),null!==(r=e.appConfig)&&void 0!==r&&r.enableEvent&&(e.getSenderStats(),e.getReceiverStats())}}),2e3)}else this.logger.warn("network quality calculating is already started")}},{key:"getSenderStats",value:(s=Ze(ot.mark((function e(){var t,r,i,n,o,s,a,c,u,d,l,h,p,f,m,g,v,y,b,S,E,C,T,R,_,I,w,k,O,A,P,L,x,D,M,U,N,V,j,F,B,W,G,H,$;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=en(this.publications.entries()),e.prev=1,t.s();case 3:if((r=t.n()).done){e.next=27;break}i=Xe(r.value,2),n=i[0],o=i[1],e.t0=ot.keys(this.localStreams);case 6:if((e.t1=e.t0()).done){e.next=25;break}if(a=(s=this.localStreams[e.t1.value]).screen?"share_".concat(s.getUserId()):s.getUserId(),this.senderStats.has(a)||this.senderStats.set(a,{audio:{bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0},video:{bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0},smallVideo:{bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0}}),!s.audioStreamId||s.audioStreamId!==n||s.screen){e.next=18;break}return c=this.senderStats.get(a),d=(u=c.audio).bytesSent,l=u.timestamp,h=u.retransmittedPacketsSent,p=u.packetsSent,e.next=16,o.getLocalStats("audio");case 16:(f=e.sent)&&(g=(f.timestamp-l)/1e3,y=(v=(m=f.audio).bytesSent-d)<=0?0:Number((8*v/g/1024).toFixed(2)),S=(b=m.retransmittedPacketsSent-h)<=0?0:parseFloat((b/(m.packetsSent-p)).toFixed(6)),this.senderStats.set(a,Zi(Zi({},c),{},{audio:{bytesSent:m.bytesSent,timestamp:f.timestamp,packetsSent:m.packetsSent,retransmittedPacketsSent:m.retransmittedPacketsSent,packetLossRate:S}})),this.logger.mediaLog({med_type:"mic",pub:!0,ruid:this.roomUniqueId,uid:this.userId,streams:[{rate:y,lost:S,rtt:f.rtt}]}),E=this.xsigoClient.getWsState(this.roomId),["CONNECTED","RECOVERY"].includes((E||{}).state)&&0===m.bytesSent&&o.updateBytesSentIs0Count("audio"));case 18:if(!s.videoStreamId||s.videoStreamId!==n){e.next=23;break}return e.next=21,o.getLocalStats("video");case 21:(C=e.sent)&&(T={med_type:s.screen?"screen":"camera",pub:!0,ruid:this.roomUniqueId,uid:this.userId,sess_id:n,streams:[]},R=this.senderStats.get(a),w=(_=R.video).retransmittedPacketsSent,k=_.packetsSent,A=(C.timestamp-_.timestamp)/1e3,L=(P=(O=C.video).bytesSent-(I=_.bytesSent))<=0?0:(8*P/A/1024).toFixed(2),this.logger.debug("video vStats.bytesSent:".concat(O.bytesSent,",bytesSent:").concat(I,",bitrate:").concat(L)),D=(x=O.retransmittedPacketsSent-w)<=0?0:parseFloat((x/(O.packetsSent-k)).toFixed(6)),T.streams.push({rate:L,lost:D,rtt:C.rtt,fps:O.framesPerSecond,rid:O.rid,width:O.frameWidth,height:O.frameHeight}),M=R.smallVideo,!s.screen&&this.isEnableSmallStream&&(N=(U=M).retransmittedPacketsSent,V=U.packetsSent,F=(C.timestamp-U.timestamp)/1e3,W=(B=(j=C.smallVideo).bytesSent-U.bytesSent)<=0?0:(8*B/F/1024).toFixed(2),H=(G=j.retransmittedPacketsSent-N)<=0?0:parseFloat((G/(j.packetsSent-V)).toFixed(6)),M={bytesSent:j.bytesSent,timestamp:C.timestamp,packetsSent:j.packetsSent,retransmittedPacketsSent:j.retransmittedPacketsSent,packetLossRate:H},T.streams.push({rate:W,lost:H,rtt:C.rtt,fps:j.framesPerSecond,rid:j.rid,width:j.frameWidth,height:j.frameHeight})),this.senderStats.set(a,Zi(Zi({},R),{},{video:{bytesSent:O.bytesSent,timestamp:C.timestamp,packetsSent:O.packetsSent,retransmittedPacketsSent:O.retransmittedPacketsSent,packetLossRate:D},smallVideo:M})),this.logger.mediaLog(T),$=this.xsigoClient.getWsState(this.roomId),["CONNECTED","RECOVERY"].includes(($||{}).state)&&0===O.bytesSent&&o.updateBytesSentIs0Count("video"));case 23:e.next=6;break;case 25:e.next=3;break;case 27:e.next=32;break;case 29:e.prev=29,e.t2=e.catch(1),t.e(e.t2);case 32:return e.prev=32,t.f(),e.finish(32);case 35:case"end":return e.stop()}}),e,this,[[1,29,32,35]])}))),function(){return s.apply(this,arguments)})},{key:"getReceiverStats",value:(o=Ze(ot.mark((function e(){var t,r,i,n,o,s,a,c,u,d,l,h,p,f,m,g,v,y,b,S,E,C,T,R,_,I,w,k,O,A,P,L,x,D,M,U,N,V,j,F,B;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=en(this.subscriptions.entries()),e.prev=1,t.s();case 3:if((r=t.n()).done){e.next=25;break}if(i=Xe(r.value,2),n=i[0],s=(o=i[1]).stream.getUserSeq(),a=o.stream.getUserId(),this.receiverStats.has(s)||this.receiverStats.set(s,{audio:{bytesReceived:0,timestamp:0,packetsReceived:0,packetsLost:0,nackCount:0,packetLossRate:0},video:{bytesReceived:0,timestamp:0,packetsReceived:0,packetsLost:0,nackCount:0,packetLossRate:0}}),c=o.stream.getType(),n!==o.stream.audioSubscriptionId||c===ht){e.next=16;break}return u=this.receiverStats.get(s),l=(d=u.audio).bytesReceived,h=d.timestamp,p=d.packetsLost,f=d.packetsReceived,m=d.nackCount,e.next=14,o.subscriber.getRemoteAudioOrVideoStats("audio");case 14:(g=e.sent)&&(y=(g.timestamp-h)/1e3,S=(b=(v=g.audio).bytesReceived-l)<=0?0:Number((8*b/y/1024).toFixed(2)),E=v.packetsLost-p,C=v.packetsReceived-f,0,R=(T=v.nackCount-m)<=0||C<=0?0:T>C?100:E<0?parseFloat((T/C).toFixed(6)):parseFloat(((E+T)/(E+C)).toFixed(6)),this.receiverStats.set(s,Zi(Zi({},u),{},{audio:{bytesReceived:v.bytesReceived,timestamp:g.timestamp,packetsReceived:v.packetsReceived,packetsLost:v.packetsLost,nackCount:v.nackCount,packetLossRate:R}})),this.logger.mediaLog({med_type:"mic",pub:!1,ruid:this.roomUniqueId,uid:a,streams:[{rate:S,lost:R,rtt:g.rtt}]}));case 16:if(n!==o.stream.videoSubscriptionId){e.next=23;break}return _=this.receiverStats.get(s),w=(I=_.video).bytesReceived,k=I.timestamp,O=I.packetsLost,A=I.packetsReceived,P=I.nackCount,e.next=21,o.subscriber.getRemoteAudioOrVideoStats("video");case 21:(L=e.sent)&&(D=(L.timestamp-k)/1e3,U=(M=(x=L.video).bytesReceived-w)<=0?0:Number((8*M/D/1024).toFixed(2)),N=x.packetsLost-O,V=x.packetsReceived-A,0,F=(j=x.nackCount-P)<=0||V<=0?0:j>V?100:N<0?parseFloat((j/V).toFixed(6)):parseFloat(((N+j)/(N+V)).toFixed(6)),this.receiverStats.set(s,Zi(Zi({},_),{},{video:{bytesReceived:x.bytesReceived,timestamp:L.timestamp,packetsReceived:x.packetsReceived,packetsLost:x.packetsLost,nackCount:x.nackCount,packetLossRate:F}})),B=o.stream.getSimulcastType(),this.logger.mediaLog({med_type:c!==ht?"camera":"screen",pub:!1,ruid:this.roomUniqueId,uid:a,streams:[{rate:U,lost:F,rtt:L.rtt,fps:x.framesPerSecond,rid:B===Yt.SmallStream?"l":"h",width:x.frameWidth,height:x.frameHeight}]}));case 23:e.next=3;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(1),t.e(e.t0);case 30:return e.prev=30,t.f(),e.finish(30);case 33:case"end":return e.stop()}}),e,this,[[1,27,30,33]])}))),function(){return o.apply(this,arguments)})},{key:"networkLevel",value:function(e,t){return e>50||t>500?5:e>30||t>350?4:e>20||t>200?3:e>10||t>100?2:e>=0||t>=0?1:0}},{key:"getLocalAudioStats",value:function(){return this.getLocalStatsMap("audio")}},{key:"getLocalVideoStats",value:function(){return this.getLocalStatsMap("video")}},{key:"getLocalStatsMap",value:(n=Ze(ot.mark((function e(t){var r,i,n,o,s,a,c,u,d,l,h,p,f,m,g,v,y,b;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.localStreams.some((function(e){return e.published&&("audio"===t?e.audioStreamId:e.videoStreamId)}))){e.next=3;break}throw new It({code:gt.INVALID_OPERATION,message:"local stream is not published"});case 3:r=new Map,e.prev=4,i=en(this.publications.entries()),e.prev=6,i.s();case 8:if((n=i.n()).done){e.next=25;break}o=Xe(n.value,2),s=o[0],a=o[1],e.t0=ot.keys(this.localStreams);case 11:if((e.t1=e.t0()).done){e.next=23;break}if(c=this.localStreams[e.t1.value],!("audio"===t?c.audioStreamId===s:c.videoStreamId===s)){e.next=21;break}return u=c.screen?"share_".concat(c.getUserId()):c.getUserId(),e.next=18,a.getLocalStats(t);case 18:d=e.sent,"audio"===t&&d&&(this.senderLocalStats.has(u)||this.senderLocalStats.set(u,{audio:{bytesSent:0,timestamp:0,packetsSent:0}}),l=this.senderLocalStats.get(u),f=(h=d[t]).packetsSent,m=(d.timestamp-l.audio.timestamp)/1e3,v=(g=(p=h.bytesSent)-l.audio.bytesSent)<=0?0:Number((8*g/m/1024).toFixed()),r.set(u,{bytesSent:p,packetsSent:f,bitrate:v}),this.senderLocalStats.set(c.getUserId(),Zi(Zi({},l),{},{audio:{bytesSent:p,timestamp:d.timestamp,packetsSent:f}}))),"video"===t&&d&&r.set(u,{bytesSent:(y=d[t]).bytesSent,packetsSent:y.packetsSent,framesEncoded:y.framesEncoded,frameWidth:y.frameWidth,frameHeight:y.frameHeight,framesSent:y.framesSent});case 21:e.next=11;break;case 23:e.next=8;break;case 25:e.next=30;break;case 27:e.prev=27,e.t2=e.catch(6),i.e(e.t2);case 30:return e.prev=30,i.f(),e.finish(30);case 33:return e.abrupt("return",Promise.resolve(r));case 36:return e.prev=36,e.t3=e.catch(4),this.logger.info("Get local ".concat(t," stats failed"),e.t3),this.logger.onError({c:lr.TOP_ERROR,v:"audio"===t?gt.LOCAL_AUDIO_STATA_ERROR:gt.LOCAL_VIDEO_STATA_ERROR}),b=new It({code:"audio"===t?gt.LOCAL_AUDIO_STATA_ERROR:gt.LOCAL_VIDEO_STATA_ERROR,message:e.t3.message}),e.abrupt("return",Promise.reject(b));case 42:case"end":return e.stop()}}),e,this,[[4,36],[6,27,30,33]])}))),function(e){return n.apply(this,arguments)})},{key:"getRemoteAudioStats",value:function(){var e=this;return new Promise(function(){var t=Ze(ot.mark((function t(r,i){var n,o,s,a,c,u,d,l,h;return ot.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=new Map,t.prev=1,e.logger.info("get remote audio Stats",e.subscriptions),o=en(e.subscriptions.entries()),t.prev=4,o.s();case 6:if((s=o.n()).done){t.next=16;break}if(a=Xe(s.value,2),c=a[0],d=(u=a[1]).stream.getUserSeq(),c!==u.stream.audioSubscriptionId){t.next=14;break}return t.next=12,u.subscriber.getRemoteAudioOrVideoStats("audio");case 12:(l=t.sent)&&n.set(d,l.audio);case 14:t.next=6;break;case 16:t.next=21;break;case 18:t.prev=18,t.t0=t.catch(4),o.e(t.t0);case 21:return t.prev=21,o.f(),t.finish(21);case 24:r(n),t.next=32;break;case 27:t.prev=27,t.t1=t.catch(1),e.logger.onError({c:lr.TOP_ERROR,v:gt.REMOTE_AUDIO_STATA_ERROR},"Get Remote Audio Stats Failed, ".concat(t.t1)),h=new It({code:gt.REMOTE_AUDIO_STATA_ERROR,message:t.t1.message}),i(h);case 32:case"end":return t.stop()}}),t,null,[[1,27],[4,18,21,24]])})));return function(e,r){return t.apply(this,arguments)}}())}},{key:"getRemoteVideoStats",value:function(){var e=this;return new Promise(function(){var t=Ze(ot.mark((function t(r,i){var n,o,s,a,c,u,d,l,h,p;return ot.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=new Map,t.prev=1,e.logger.info("get remote video Stats",e.subscriptions),o=en(e.subscriptions.entries()),t.prev=4,o.s();case 6:if((s=o.n()).done){t.next=16;break}if(a=Xe(s.value,2),c=a[0],d=(u=a[1]).stream.getUserSeq(),c!==u.stream.videoSubscriptionId){t.next=14;break}return t.next=12,u.subscriber.getRemoteAudioOrVideoStats("video");case 12:(l=t.sent)&&n.set(d,{bytesReceived:(h=l.video).bytesReceived,packetsReceived:h.packetsReceived,packetsLost:h.packetsLost,framesDecoded:h.framesDecoded,frameWidth:h.frameWidth,frameHeight:h.frameHeight});case 14:t.next=6;break;case 16:t.next=21;break;case 18:t.prev=18,t.t0=t.catch(4),o.e(t.t0);case 21:return t.prev=21,o.f(),t.finish(21);case 24:r(n),t.next=32;break;case 27:t.prev=27,t.t1=t.catch(1),e.logger.onError({c:lr.TOP_ERROR,v:gt.REMOTE_VIDEO_STATA_ERROR},"Get Remote Video Stats Failed, ".concat(t.t1)),p=new It({code:gt.REMOTE_VIDEO_STATA_ERROR,message:t.t1.message}),i(p);case 32:case"end":return t.stop()}}),t,null,[[1,27],[4,18,21,24]])})));return function(e,r){return t.apply(this,arguments)}}())}},{key:"onWsStateChange",value:function(e,t,r){this.logger.info("Ws state from ".concat(t," to ").concat(r)),this._emitter.emit("connection-state-changed",{state:r,prevState:t})}},{key:"onError",value:function(e){this.logger.buriedLog({c:lr.ON_ERROR,v:"".concat(e.message)}),this._emitter.emit(pt,e)}},{key:"onWsReconnectFailed",value:function(e){this.logger.warn("room: ".concat(e," reconnection failed")),this.logger.onError({c:lr.TOP_ERROR,v:gt.SIGNAL_CHANNEL_RECONNECTION_FAILED});var t=new It({code:gt.SIGNAL_CHANNEL_RECONNECTION_FAILED,message:"signal channel reconnection failed, please check your network"});this._emitter.emit(pt,t),this.leave()}},{key:"onParticipantLeave",value:function(e){var t=this;this.logger.info("======notification: ".concat(e," leave======"));try{var r="share_".concat(e),i=this.remoteStreams.get(e),n=this.remoteStreams.get(r),o=function(r,i){t.logger.buriedLog({c:r.type===ht?lr.ON_STREAM_REMOVED_SCREEN:lr.ON_STREAM_REMOVED,v:"uid:".concat(e)}),t._emitter.emit("stream-removed",{stream:r}),r.close(),t.remoteStreams.delete(i),t.subscribeManager.subscriptedState.delete(i),t.receiverStats.has(i)&&t.receiverStats.delete(i);var n,o=en(t.subscriptions.entries());try{for(o.s();!(n=o.n()).done;){var s=Xe(n.value,2),a=s[0],c=s[1];[r.audioSubscriptionId,r.videoSubscriptionId].includes(a)&&(c.subscriber.close(),t.subscriptions.delete(a))}}catch(e){o.e(e)}finally{o.f()}};i&&o(i,e),n&&o(n,r),this._remoteMutedStateMap.has(e)&&this._remoteMutedStateMap.delete(e)}catch(e){this.logger.info(e)}this.logger.buriedLog({c:lr.ON_PEER_LEVAE,v:"uid:".concat(e)}),this._emitter.emit("peer-leave",{userId:e})}},{key:"onStreamAdd",value:function(e){var t=e||{},r=t.userId,i=t.streamId,n=t.info,o=t.mixedInfo,s=n||{},a=s.audio,c=s.video;if(this.logger.info("time  Date.now stream-add",Date.now()),r!==this.userId){var u=(a||c||{}).source;u===Jt.ScreenShare&&(r="share_".concat(r));var d=this.remoteStreams.get(r);if(this.logger.info("userId: "+r,"remote stream",d),d){var l=this.subscribeManager.needSubscribeKind(r),h=this.subscribeManager.getSubscriptionOpts(r);this.logger.info("userId: "+r,l,h,null,4);var p={audio:!1,video:!1,small:h.small};if(l===Ht.AudioOnly&&(p.audio=!0),l===Ht.VideoOnly&&(p.video=!0),l===Ht.AudioVideo&&(p.audio=!0,p.video=!0),a&&(d.setAudio(!!a),d.setHasAudio(!!a),d.setAudioStreamId(i),d.setMutedState("audio",a.muted),this.updateRemoteMutedState(r,{hasAudio:!0,audioMuted:a.muted})),c){d.setVideo(!!c),d.setHasVideo(!!c),d.setVideoStreamId(i),d.setInfo(n);var f=(c.simulcast||[]).find((function(e){return e.type===Yt.SmallStream}));d.setMutedState("video",c.muted),this.updateRemoteMutedState(r,{hasVideo:!0,videoMuted:c.muted,hasSmall:!!f})}this._emitter.emit("stream-updated",{stream:d}),this.logger.info("Auto subscribe options",JSON.stringify(p)),(p.audio||p.video)&&this.doSubscribe(d,p)}else{if(d=new Dr({userId:r,type:u===Jt.ScreenShare?ht:"main",info:n,mixedInfo:o},this.logger),u===Jt.ScreenShare&&d.setLocalUserId(this.userId),d.streamId=i,this.remoteStreams.set(r,d),a&&(d.setAudio(!!a),d.setHasAudio(!!a),d.setAudioStreamId(i),d.setMutedState("audio",a.muted),this.updateRemoteMutedState(r,{hasAudio:!0,audioMuted:a.muted})),c){d.setVideo(!!c),d.setHasVideo(!!c),d.setVideoStreamId(i);var m=(c.simulcast||[]).find((function(e){return e.type===Yt.SmallStream}));d.setMutedState("video",c.muted),this.updateRemoteMutedState(r,{hasVideo:!0,videoMuted:c.muted,hasSmall:!!m})}this.logger.buriedLog({c:d.type===ht?lr.ON_STREAM_ADDED_SCREEN:lr.ON_STREAM_ADDED,v:"uid:".concat(d.getUserId())}),this._emitter.emit("stream-added",{stream:d})}}}},{key:"onStreamChange",value:function(e,t){var r=e;this.getType(t)===ht&&(r="share_".concat(r),this.remoteStreams.get(r).closeWaterMark()),this.logger.info("time  Date.now stream-remove",Date.now());var i=this.remoteStreams.get(r);if(r!==this.userId&&r!=="share_".concat(r)&&i){var n=this.subscribeManager.getSubscriptedState(r);if(i&&i.getStreamKind(t)===Ht.AudioOnly){if(!i.videoStreamId)return void this.doStreamRemove(r);if(i.audioStreamId){if(i.hasAudio()){var o=i.getAudioTrack();o&&i.mediaStream.removeTrack(o)}n.audio=!1,i.setHasAudio(!1),i.setAudioStreamId(null),this.subscriptions.has(i.audioSubscriptionId)&&(this.subscriptions.get(i.audioSubscriptionId).subscriber.close(),this.subscriptions.delete(i.audioSubscriptionId),i.setAudioSubscriptionId(null)),i.setMutedState("audio",!0),this.updateRemoteMutedState(r,{hasAudio:!1,audioMuted:!0}),this.receiverStats.has(r)&&(this.receiverStats.get(r).audio={bytesReceived:0,timestamp:0,packetsReceived:0,packetsLost:0,nackCount:0,packetLossRate:0}),this._emitter.emit("mute-audio",{userId:r})}}if(i&&i.getStreamKind(t)===Ht.VideoOnly){if(!i.audioStreamId)return void this.doStreamRemove(r);if(i.videoStreamId){if(i.hasVideo()){var s=i.getVideoTrack();s&&i.mediaStream.removeTrack(s)}n.video=!1,i.setHasVideo(!1),i.setVideoStreamId(null),this.subscriptions.has(i.videoSubscriptionId)&&(this.subscriptions.get(i.videoSubscriptionId).subscriber.close(),this.subscriptions.delete(i.videoSubscriptionId),i.setVideoSubscriptionId(null)),i.setSimulcasts([]),i.setMutedState("video",!0),this.updateRemoteMutedState(r,{hasVideo:!1,videoMuted:!0,hasSmall:!1}),this.receiverStats.has(r)&&(this.receiverStats.get(r).video={bytesReceived:0,timestamp:0,packetsReceived:0,packetsLost:0,nackCount:0,packetLossRate:0}),this._emitter.emit("mute-video",{userId:r})}}this.subscribeManager.updateSubscriptedState(r,n),this._emitter.emit("stream-updated",{stream:i})}}},{key:"doStreamRemove",value:function(e){var t=this,r=this.remoteStreams.get(e),i=this.subscribeManager.getSubscriptedState(e);if(i.audio=!1,i.video=!1,this.subscribeManager.updateSubscriptedState(e,i),r){r.getType()===ht&&r.closeWaterMark(),r.setAudioStreamId(null),r.setVideoStreamId(null),r.setMutedState("audio",!0),r.setMutedState("video",!0),this.remoteStreams.delete(e),this.logger.info("time  Date.now delete remoteStreams",Date.now(),r.audioSubscriptionId,r.videoSubscriptionId),this.receiverStats.has(e)&&this.receiverStats.delete(e);var n=[];r.audioSubscriptionId&&n.push(r.audioSubscriptionId),r.videoSubscriptionId&&n.push(r.videoSubscriptionId),n.forEach((function(e){t.subscriptions.has(e)&&(t.subscriptions.get(e).subscriber.close(),t.subscriptions.delete(e),e===r.audioSubscriptionId&&r.setAudioSubscriptionId(null),e===r.videoSubscriptionId&&r.setVideoSubscriptionId(null))})),this.logger.info("do stream remove with ",this.subscriptions),this.logger.buriedLog({c:r.type===ht?lr.ON_STREAM_REMOVED_SCREEN:lr.ON_STREAM_REMOVED,v:"uid:".concat(r.getUserId())}),this.updateRemoteMutedState(e),this._emitter.emit("stream-removed",{stream:r})}}},{key:"onClientBanned",value:function(e){var t=this;this.logger.buriedLog({c:lr.ON_CLIENT_BANNED,v:"cause:".concat(e)},!0);var r,i=en(this.publications.entries());try{var n=function(){var e=Xe(r.value,2),i=e[0],n=e[1],o=t.localStreams.find((function(e){return e.streamId===i}));o&&o.close(),n.close()};for(i.s();!(r=i.n()).done;)n()}catch(e){i.e(e)}finally{i.f()}var o,s=en(this.subscriptions.values());try{for(s.s();!(o=s.n()).done;){var a=o.value;a.stream.close(),a.subscriber.close()}}catch(e){s.e(e)}finally{s.f()}this.state=ct.Leaved,this.reset(),this._emitter.emit("client-banned",{cause:e})}},{key:"onStreamUpdate",value:function(e,t,r,i){var n=e;if(this.remoteStreams.has("share_".concat(e))){var o=this.remoteStreams.get("share_".concat(e));[o.audioStreamId,o.videoStreamId].includes(t)&&(n="share_".concat(e))}var s=this.localStreams.find((function(e){return[e.audioStreamId,e.videoStreamId].includes(t)}));if(s||(s=this.remoteStreams.get(n)),null!=r&&r.audio&&(e!==this.userId&&(this.logger.buriedLog({c:r.audio.muted?lr.ON_MUTE_AUDIO:lr.ON_UNMUTE_AUDIO,v:"uid:".concat(e)}),this._emitter.emit(r.audio.muted?"mute-audio":"unmute-audio",{userId:n})),s.setMutedState("audio",r.audio.muted),this.updateRemoteMutedState(e,{audioMuted:r.audio.muted})),null!=r&&r.video&&(e!==this.userId&&(this.logger.buriedLog({c:r.video.muted?lr.ON_MUTE_VIDEO:lr.ON_UNMUTE_VIDEO,v:"uid:".concat(e)}),this._emitter.emit(r.video.muted?"mute-video":"unmute-video",{userId:n})),s.setMutedState("video",r.video.muted),this.updateRemoteMutedState(e,{videoMuted:r.video.muted})),i&&i.length){var a=(i||[]).find((function(e){return e.type===Yt.SmallStream}));if(this.remoteStreams.has(e)){var c=this.remoteStreams.get(e);c.setSimulcasts(i),this.logger.buriedLog({c:c.getType()===ht?lr.ON_STREAM_UPDATED_SCREEN:lr.ON_STREAM_UPDATED,v:"uid:".concat(c.getUserId())}),this._emitter.emit("stream-updated",{stream:c}),a||c.getSimulcastType()===Yt.SmallStream&&(this.logger.info("auto setRemoteVideoStreamType big"),this.setRemoteVideoStreamType(c,"big"))}this.updateRemoteMutedState(e,{hasVideo:!0,hasSmall:!!a})}}},{key:"onMuteLocal",value:function(e,t){switch(e){case Kt.Amute:this._emitter.emit("mute-audio",{userId:t});break;case Kt.Aunmute:this._emitter.emit("unmute-audio",{userId:t});break;case Kt.Vmute:this._emitter.emit("mute-video",{userId:t});break;case Kt.Vunmute:this._emitter.emit("unmute-video",{userId:t})}}},{key:"getType",value:function(e){var t,r,i=en(this.remoteStreams);try{for(i.s();!(r=i.n()).done;){var n=Xe(r.value,2)[1];if(n.audioStreamId===e||n.videoStreamId===e){t=n.getType();break}}}catch(e){i.e(e)}finally{i.f()}return t}},{key:"hasPublishedStream",value:function(){return this.localStreams.some((function(e){return e.published}))}},{key:"getClientState",value:function(){return this.state}},{key:"onDeviceChange",value:(i=Ze(ot.mark((function e(){var t,r,i,n,o,s,a,c,u,d,l,h,p,f,m,g,v,y,b,S,E,C,T,R=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,mr();case 3:if(t=e.sent,r=JSON.parse(JSON.stringify(this._preDiviceList)),this._preDiviceList=t,(i=t.filter((function(e){return-1===r.findIndex((function(t){return t.deviceId===e.deviceId}))}))).length&&this.logger.info("onDeviceChange addedDevices",JSON.stringify(i,null,4)),(n=r.filter((function(e){return-1===t.findIndex((function(t){return t.deviceId===e.deviceId}))}))).length&&this.logger.info("onDeviceChange removedDevices",JSON.stringify(n,null,4)),o=this.localStreams.find((function(e){return!e.screen})),s=i.filter((function(e){return"audiooutput"===e.kind})),a=t.filter((function(e){return"default"===e.deviceId})),!o){e.next=63;break}if(c=t.filter((function(e){return"audioinput"===e.kind&&"default"===e.deviceId})),!i||!i.length){e.next=42;break}if(u=r.find((function(e){return"audioinput"===e.kind})),d=r.find((function(e){return"videoinput"===e.kind})),l=i.filter((function(e){return"audioinput"===e.kind})),h=i.filter((function(e){return"videoinput"===e.kind})),p=!u&&l.length>0&&o.hasAudio(),f=!d&&h.length>0&&o.hasVideo(),!p||!f){e.next=30;break}return this.logger.warn("new microphone and camera detected, but there was no device before."),e.next=26,o.updateStream({audio:!0,video:!0,cameraId:h[0].deviceId,microphoneId:c.length?c[0].deviceId:l[0].deviceId});case 26:this._emitter.emit("auto-switch-device",{type:"audio",deviceId:c.length?c[0].deviceId:l[0].deviceId}),this._emitter.emit("auto-switch-device",{type:"video",deviceId:h[0].deviceId}),e.next=42;break;case 30:if(!p){e.next=37;break}return this.logger.warn("new microphone  detected, but there was no device before."),e.next=34,o.updateStream({audio:!0,video:!1,microphoneId:l[0].deviceId});case 34:this._emitter.emit("auto-switch-device",{type:"audio",deviceId:l[0].deviceId}),e.next=42;break;case 37:if(!f){e.next=42;break}return this.logger.warn("new camera  detected, but there was no device before."),e.next=41,o.updateStream({audio:!1,video:!0,cameraId:h[0].deviceId});case 41:this._emitter.emit("auto-switch-device",{type:"video",deviceId:h[0].deviceId});case 42:if(!n||!n.length){e.next=63;break}if(m=o.getDevicesInfoInUse(),g=m.microphone,v=m.camera,this.logger.warn("Devices in use microphone:".concat(JSON.stringify(g,null,4),",camera:").concat(JSON.stringify(v,null,4))),y=n.find((function(e){return e.groupId&&g.groupId?e.deviceId===g.deviceId&&e.groupId===g.groupId:e.deviceId===g.deviceId})),b=n.find((function(e){return e.groupId&&v.groupId?e.deviceId===v.deviceId&&e.groupId===v.groupId:e.deviceId===v.deviceId})),S=t.find((function(e){return"audioinput"===e.kind})),E=t.find((function(e){return"videoinput"===e.kind})),C=y&&o.hasAudio(),T=b&&o.hasVideo(),!C){e.next=57;break}if(this.logger.warn("current microphone in use is lost, deviceId: ".concat(g.deviceId)),!S){e.next=57;break}return e.next=56,o.updateStream({audio:!0,video:!1});case 56:this._emitter.emit("auto-switch-device",{type:"audio"});case 57:if(!T){e.next=63;break}if(this.logger.warn("current camera in use is lost, deviceId: ".concat(v.deviceId)),!E){e.next=63;break}return e.next=62,o.updateStream({audio:!1,video:!0});case 62:this._emitter.emit("auto-switch-device",{type:"video"});case 63:s.length&&a.length&&this.remoteStreams.forEach((function(e){e.setAudioOutput("default")})),i.forEach((function(e){switch(e.kind){case"audioinput":R.logger.info("The new microphone device be detected is",e.label),R._emitter.emit("recording-device-changed",{deviceId:e.deviceId,state:"ADD"});break;case"videoinput":R.logger.info("The new camera device be detected is",e.label),R._emitter.emit("camera-changed",{deviceId:e.deviceId,state:"ADD"});break;case"audiooutput":R.logger.info("The new speaker device be detected is",e.label),R._emitter.emit("playback-device-changed",{deviceId:e.deviceId,state:"ADD"})}})),n.forEach((function(e){switch(e.kind){case"audioinput":R.logger.info("The microphone device is detected to be removed: ",e.label),R._emitter.emit("recording-device-changed",{deviceId:e.deviceId,state:"REMOVE"});break;case"videoinput":R.logger.info("The camera device is detected to be removed: ",e.label),R._emitter.emit("camera-changed",{deviceId:e.deviceId,state:"REMOVE"});break;case"audiooutput":R.logger.info("The speaker device is detected to be removed: ",e.label),R._emitter.emit("playback-device-changed",{deviceId:e.deviceId,state:"REMOVE"})}})),e.next=71;break;case 68:e.prev=68,e.t0=e.catch(0),this.logger.onError({c:lr.TOP_ERROR,v:gt.SWITCH_DEVICE_FAILED},"on device change error, ".concat(e.t0));case 71:case"end":return e.stop()}}),e,this,[[0,68]])}))),function(){return i.apply(this,arguments)})},{key:"enableAudioVolumeEvaluation",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2e3;if(this.logger.info("enableAudioVolumeEvaluation with interval: "+t),this.logger.buriedLog({c:lr.ENABLE_AUDIO_VOLUME_EVALUATION,v:"time:".concat(t)}),"number"!=typeof t)throw this.logger.onError({c:lr.TOP_ERROR,v:gt.INVALID_PARAMETER}),new It({code:gt.INVALID_PARAMETER,message:"parameter must be numeric type"});t<=0?(window.clearInterval(this.audioVolumeInterval),this.audioVolumeInterval=null):(this.audioVolumeInterval&&(window.clearInterval(this.audioVolumeInterval),this.audioVolumeInterval=null),this.audioVolumeInterval=window.setInterval((function(){var t=[];e.localStreams.forEach((function(e){if(!e.screen&&e.published){var r=Math.floor(100*e.getAudioLevel());t.push({userId:e.getUserId(),audioVolume:r,stream:e})}}));var r,i=en(e.remoteStreams);try{for(i.s();!(r=i.n()).done;){var n=Xe(r.value,2)[1];if("main"===n.getType()&&n.subscribed){var o=Math.floor(100*n.getAudioLevel());t.push({userId:n.getUserId(),audioVolume:o,stream:n})}}}catch(e){i.e(e)}finally{i.f()}e._emitter.emit("audio-volume",{result:t})}),Math.floor(Math.max(t,16))))}},{key:"addEventListenser",value:function(e){this.ssl&&navigator.mediaDevices&&"devicechange"===e&&navigator.mediaDevices.addEventListener(e,this.deviceChange),"visibilitychange"===e&&document.addEventListener(e,this.visibilitychange)}},{key:"removeEventListenser",value:function(e){this.ssl&&navigator.mediaDevices&&"devicechange"===e&&navigator.mediaDevices.removeEventListener(e,this.deviceChange),"visibilitychange"===e&&document.removeEventListener(e,this.visibilitychange)}},{key:"startWaterMark",value:(r=Ze(ot.mark((function e(t){var r,i,n,o,s=this;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isWaterMark){e.next=2;break}return e.abrupt("return");case 2:return this.isWaterMark=!0,r={fontColor:"rgba(200,200,200,0.6)",fontSize:"12",fontType:"Microsoft Yahei"},i=t.fontColor,n=t.fontSize,o=t.fontType,t&&(i&&(r.fontColor=i),n&&(r.fontSize=n),o&&(r.fontType=o)),e.next=8,Ar(r,this.userId);case 8:this.waterMarkImage=e.sent,this.waterMarkoptions=r,this.remoteStreams.size&&this.remoteStreams.forEach(function(){var e=Ze(ot.mark((function e(t){return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.getType()!==ht){e.next=3;break}return e.next=3,t.startWaterMark(r,s.waterMarkImage);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"closeWaterMark",value:function(){this.isWaterMark&&(this.isWaterMark=!1,this.waterMarkImage=null,this.remoteStreams.size&&this.remoteStreams.forEach((function(e){e.getType()===ht&&e.closeWaterMark()})))}},{key:"enableSmallStream",value:function(){var e=this.localStreams.find((function(e){return e.videoStreamId&&!e.screen}));if(e&&e.published)throw new It({code:gt.INVALID_OPERATION,message:"Cannot enable small stream after localStream published."});if(!br())throw new It({code:gt.INVALID_OPERATION,message:"Your browser does not support opening small stream"});return this.setIsEnableSmallStream(!0),this.logger.info("SmallStream successfully enabled"),this.logger.buriedLog({c:lr.ENABLE_SMALL_STREAM}),Promise.resolve(!0)}},{key:"disableSmallStream",value:function(){var e=this.localStreams.find((function(e){return e.videoStreamId&&!e.screen}));if(e&&e.published)throw new It({code:gt.INVALID_OPERATION,message:"Cannot enable small stream after having published."});return this.setIsEnableSmallStream(!1),this.logger.info("SmallStream successfully disabled"),this.logger.buriedLog({c:lr.DISABLE_SMALL_STREAM}),Promise.resolve(!0)}},{key:"setSmallStreamProfile",value:function(e){var t=e.width,r=e.height,i=e.bitrate,n=e.framerate;if(this.logger.info("setSmallStreamProfile:width=".concat(t,",height=").concat(r,",bitrate=").concat(i,",framerate=").concat(n)),t<0||r<0||i<0||n<0)throw new It({code:gt.INVALID_OPERATION,message:"Small stream profile is invalid."});this.logger.buriedLog({c:lr.SET_SMALL_STREAM_PROFILE,v:JSON.stringify(e)}),this.smallStreamConfig={width:t,height:r,bitrate:i,framerate:n}}},{key:"setIsEnableSmallStream",value:function(e){this.isEnableSmallStream=e}},{key:"onVisibilitychange",value:function(){"visible"===document.visibilityState?(this.logger.warn("User enter the page"),this._emitter.emit("page-visibility-state",{state:"visible"})):"hidden"===document.visibilityState&&(this.logger.warn("User leave the pag"),this._emitter.emit("page-visibility-state",{state:"hidden"}))}},{key:"isJoinRoomSupported",value:(t=Ze(ot.mark((function e(){var t,r,i,n,o,s,a,c,u;return ot.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Dt.specil()){e.next=4;break}return e.abrupt("return",Promise.resolve({isSupported:!0,code:0,message:""}));case 4:if(!Dt.any()){e.next=6;break}return e.abrupt("return",Promise.resolve({isSupported:!1,code:gt.OS_NOT_SUPPORTED,message:"".concat(Dt.getOsName().osName," is not supported!")}));case 6:return e.next=8,fr();case 8:if(r=(t=e.sent.detail).isBrowserSupported,n=t.isH264Supported,(i=t.isWebRTCSupported)&&n&&r){e.next=15;break}return o=Mt(),s=o.browser,a=o.version,c=i?n?gt.BROWSER_NOT_SUPPORTED:gt.H264_NOT_SUPPORTED:gt.WEBRTC_NOT_SUPPORTED,u=i?n?"".concat(s).concat(a," browser is not supported"):"your device does not support H.264 encoding.":"your browser does NOT support WebRTC!",e.abrupt("return",Promise.resolve({isSupported:!1,code:c,message:u}));case 15:return e.abrupt("return",Promise.resolve({isSupported:!0,code:0,message:""}));case 16:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"enableMicVolume",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,t=arguments.length>1?arguments[1]:void 0,r=this;if(e>=0){if("number"!=typeof e)throw new It({code:gt.INVALID_PARAMETER,message:"parameter must be numeric type"});navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:t}}}).then((function(t){r.logger.info("microphone permission is ok"),r.micStream=t,r.soundMeter=new wt,r.soundMeter.connectToSource(r.micStream.getAudioTracks()[0]),r.timer=setInterval((function(){r._emitter.emit("mic-volume",{volumes:Math.round(100*r.soundMeter.getVolume())})}),Math.floor(Math.max(e,100)))})).catch((function(e){r.logger.error("init error ",e)}))}else clearInterval(r.timer),r.timer=null,r.micStream&&r.micStream.getAudioTracks()[0].stop()}}]),e}();function sn(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function an(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?sn(Object(r),!0).forEach((function(t){Ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):sn(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}!function(e){e[e.TRACE=0]="TRACE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.NONE=5]="NONE"}(rn||(rn={})),function(e){e.NORMAL="normal",e.POINT="point",e.MEDIA="media"}(nn||(nn={}));var cn=function(){function e(){tt(this,e),this.LogLevel={TRACE:rn.TRACE,DEBUG:rn.DEBUG,INFO:rn.INFO,WARN:rn.WARN,ERROR:rn.ERROR,NONE:rn.NONE},this.level=rn.INFO,this.myConsole=window.console,this.uploadLog=!1,this.logList=[],this.buriedLogList=[],this.mediaLogList=[],this.maxNumber=10,this.timeout=1e4,this._interval=0,this._intervalBuried=0,this.roomId=null,this.serverUrl="",this.appConfig=null,this.roomUniqueId=null,this.reUploadMaxCount=30,this.logReUploadCount=0,this.buriedlogReUploadCount=0,this.enableUploadLog(),window.addEventListener("beforeunload",this.beforeUnload.bind(this),{once:!0})}return it(e,[{key:"setLogLevel",value:function(e){this.level=e,this.buriedLog({c:jr.SET_LOG_LEVEL,v:["TRACE","DEBUG","INFO","WARN","ERROR","NONE"][e]})}},{key:"getLogLevel",value:function(){return this.level}},{key:"setUserId",value:function(e){this.userId=e}},{key:"setRoomId",value:function(e){this.roomId=e}},{key:"setRoomUniqueId",value:function(e){this.roomUniqueId=e}},{key:"setServerUrl",value:function(e){e||(this.uploadLogList=this.logList.splice(0,this.logList.length),this.upload(this.uploadLogList)),this.serverUrl=e}},{key:"setApppConfig",value:function(e){var t,r;this.appConfig=e,null!==(t=this.appConfig)&&void 0!==t&&t.enableLog?this.enableUploadLog():this.disableUploadLog(),null!==(r=this.appConfig)&&void 0!==r&&r.enableEvent?this.enableUploadBuriedLogs():this.disableUploadBuriedLogs()}},{key:"debug",value:function(e){var t;if(!(this.level===rn.NONE||rn.DEBUG<this.level)){for(var r=arguments.length,i=new Array(r>1?r-1:0),n=1;n<r;n++)i[n-1]=arguments[n];(t=this.myConsole).debug.apply(t,["XRTC <Debug> ".concat(this.userId?"[".concat(this.userId,"]"):""),e].concat(i)),this.collect(rn.DEBUG,e,i)}}},{key:"info",value:function(e){for(var t,r=arguments.length,i=new Array(r>1?r-1:0),n=1;n<r;n++)i[n-1]=arguments[n];this.collect(rn.INFO,e,i),this.level===rn.NONE||rn.INFO<this.level||(t=this.myConsole).info.apply(t,["XRTC <Info> ".concat(this.userId?"[".concat(this.userId,"]"):""),e].concat(i))}},{key:"warn",value:function(e){for(var t,r=arguments.length,i=new Array(r>1?r-1:0),n=1;n<r;n++)i[n-1]=arguments[n];this.collect(rn.WARN,e,i),this.level===rn.NONE||rn.WARN<this.level||(t=this.myConsole).warn.apply(t,["XRTC <Warn> ".concat(this.userId?"[".concat(this.userId,"]"):""),e].concat(i))}},{key:"error",value:function(e){for(var t,r=arguments.length,i=new Array(r>1?r-1:0),n=1;n<r;n++)i[n-1]=arguments[n];this.collect(rn.ERROR,e,i),this.level===rn.NONE||rn.ERROR<this.level||(t=this.myConsole).error.apply(t,["XRTC <Error> ".concat(this.userId?"[".concat(this.userId,"]"):""),e].concat(i))}},{key:"enableUploadLog",value:function(){var e=this;this._interval||(this.uploadLog=!0,this._interval=window.setInterval((function(){e.roomId&&e.logList.length>0&&(e.uploadLogList=e.logList.splice(0,e.logList.length),e.upload(e.uploadLogList))}),this.timeout),this.buriedLog({c:jr.ENABLE_UPLOAD_LOG}))}},{key:"disableUploadLog",value:function(){this.uploadLog=!1,window.clearInterval(this._interval),this._interval=0,this.buriedLog({c:jr.DISABLE_UPLOAD_LOG})}},{key:"collect",value:function(e,t,r){this.uploadLog&&(this.logList.push({t:Date.now(),lv:e,mdu:"XRTC",msg:"XRTC ".concat(this.userId?"[".concat(this.userId,"]"):""," ").concat(t," ").concat((r||[]).join(" "),"\r\n")}),this.roomId&&this.logList.length>=this.maxNumber&&(this.uploadLogList=this.logList.splice(0,this.logList.length),this.upload(this.uploadLogList)))}},{key:"upload",value:function(e){var t=this;this.serverUrl&&Xi.upload({type:nn.NORMAL,app:Xi.appKey,rid:this.roomId,uid:this.userId,pf:"web",list:e}).then((function(){})).catch((function(){t.logReUploadCount=t.logReUploadCount+1,t.logReUploadCount>t.reUploadMaxCount?(t.logList=[],t.logReUploadCount=0,t.info("SDK has tried reupload log ".concat(t.reUploadMaxCount," times, but all failed, and old log cleared"))):t.logList=[].concat(et(e),et(t.logList))}))}},{key:"buriedLog",value:function(e,t){var r,i=this;if((!this.appConfig||this.appConfig.enableEvent)&&(this.buriedLogList.push(an(an({},e),{},{t:this.adjustServerTime(Date.now())})),e.c===jr.JOIN_SUCCESS&&this.buriedLogList.forEach((function(e){e.c!==jr.JOIN_SUCCESS&&(e.t=i.adjustServerTime(e.t))})),null!==(r=this.appConfig)&&void 0!==r&&r.enableEvent&&this.roomUniqueId&&(t||this.buriedLogList.length>=this.maxNumber))){var n=this.buriedLogList.splice(0,this.buriedLogList.length);this.uploadBuriedLogs(n,nn.POINT)}}},{key:"mediaLog",value:function(e,t){var r;if((!this.appConfig||this.appConfig.enableEvent)&&(this.mediaLogList.push(an(an({},e),{},{t:this.adjustServerTime(Date.now())})),null!==(r=this.appConfig)&&void 0!==r&&r.enableEvent&&this.roomUniqueId&&(t||this.mediaLogList.length>=this.maxNumber))){var i=this.mediaLogList.splice(0,this.mediaLogList.length);this.uploadBuriedLogs(i,nn.MEDIA)}}},{key:"uploadBuriedLogs",value:function(e,t){var r=this;!this.serverUrl||this.appConfig&&!this.appConfig.enableEvent||Xi.upload({type:t,app:Xi.appKey,ruid:this.roomUniqueId,uid:this.userId,pf:"web",list:e}).then((function(){})).catch((function(i){r.buriedlogReUploadCount=r.buriedlogReUploadCount+1,r.buriedlogReUploadCount>r.reUploadMaxCount?(t===nn.POINT&&(r.buriedLogList=[]),t===nn.MEDIA&&(r.mediaLogList=[]),r.buriedlogReUploadCount=0,r.info("SDK has tried reupload buried log ".concat(r.reUploadMaxCount," times, but all failed, and old log cleared"))):t===nn.POINT?r.buriedLogList=[].concat(et(e),et(r.buriedLogList)):t===nn.MEDIA&&(r.mediaLogList=[].concat(et(e),et(r.mediaLogList)))}))}},{key:"enableUploadBuriedLogs",value:function(){var e=this;this._intervalBuried||(this._intervalBuried=window.setInterval((function(){if(e.buriedLogList.length>0){var t=e.buriedLogList.splice(0,e.buriedLogList.length);e.uploadBuriedLogs(t,nn.POINT)}if(e.mediaLogList.length>0){var r=e.mediaLogList.splice(0,e.mediaLogList.length);e.uploadBuriedLogs(r,nn.MEDIA)}}),this.timeout))}},{key:"disableUploadBuriedLogs",value:function(){window.clearInterval(this._intervalBuried),this._intervalBuried=0}},{key:"beforeUnload",value:function(){if(this.logList.length>0){var e=this.logList.splice(0,this.logList.length);this.upload(e)}if(this.buriedLogList.length>0){var t=this.buriedLogList.splice(0,this.buriedLogList.length);this.uploadBuriedLogs(t,nn.POINT)}if(this.mediaLogList.length>0){var r=this.mediaLogList.splice(0,this.mediaLogList.length);this.uploadBuriedLogs(r,nn.MEDIA)}this.disableUploadLog(),this.disableUploadBuriedLogs()}},{key:"adjustServerTime",value:function(e){var t;return null!==(t=this.appConfig)&&void 0!==t&&t.timeDiff?e-this.appConfig.timeDiff:e}},{key:"onError",value:function(e,t,r){r?this.buriedLog(e,r):this.buriedLog(e),t&&this.error(t)}}]),e}();let un=!0,dn=!0;function ln(e,t,r){const i=e.match(t);return i&&i.length>=r&&parseInt(i[r],10)}function hn(e,t,r){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,n=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return n.apply(this,arguments);const o=e=>{const t=r(e);t&&(i.handleEvent?i.handleEvent(t):i(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(i,o),n.apply(this,[e,o])};const o=i.removeEventListener;i.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(r))return o.apply(this,arguments);const i=this._eventMap[t].get(r);return this._eventMap[t].delete(r),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function pn(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(un=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function fn(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(dn=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function mn(){if("object"==typeof window){if(un)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function gn(e,t){dn&&console.warn(e+" is deprecated, please use "+t+" instead.")}function vn(e){return"[object Object]"===Object.prototype.toString.call(e)}function yn(e){return vn(e)?Object.keys(e).reduce((function(t,r){const i=vn(e[r]),n=i?yn(e[r]):e[r],o=i&&!Object.keys(n).length;return void 0===n||o?t:Object.assign(t,{[r]:n})}),{}):e}function bn(e,t,r){t&&!r.has(t.id)&&(r.set(t.id,t),Object.keys(t).forEach((i=>{i.endsWith("Id")?bn(e,e.get(t[i]),r):i.endsWith("Ids")&&t[i].forEach((t=>{bn(e,e.get(t),r)}))})))}function Sn(e,t,r){const i=r?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;const o=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((t=>{e.forEach((r=>{r.type===i&&r.trackId===t.id&&bn(e,r,n)}))})),n}const En=mn;function Cn(e,t){const r=e&&e.navigator;if(!r.mediaDevices)return;const i=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((r=>{if("require"===r||"advanced"===r||"mediaSource"===r)return;const i="object"==typeof e[r]?e[r]:{ideal:e[r]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);const n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];let e={};"number"==typeof i.ideal?(e[n("min",r)]=i.ideal,t.optional.push(e),e={},e[n("max",r)]=i.ideal,t.optional.push(e)):(e[n("",r)]=i.ideal,t.optional.push(e))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",r)]=i.exact):["min","max"].forEach((e=>{void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,r)]=i[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},n=function(e,n){if(t.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=i(e.audio)}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const s=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!r.mediaDevices.getSupportedConstraints||!r.mediaDevices.getSupportedConstraints().facingMode||s)){let t;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?t=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(t=["front"]),t)return r.mediaDevices.enumerateDevices().then((r=>{let s=(r=r.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!s&&r.length&&t.includes("back")&&(s=r[r.length-1]),s&&(e.video.deviceId=o.exact?{exact:s.deviceId}:{ideal:s.deviceId}),e.video=i(e.video),En("chrome: "+JSON.stringify(e)),n(e)}))}e.video=i(e.video)}return En("chrome: "+JSON.stringify(e)),n(e)},o=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(r.getUserMedia=function(e,t,i){n(e,(e=>{r.webkitGetUserMedia(e,t,(e=>{i&&i(o(e))}))}))}.bind(r),r.mediaDevices.getUserMedia){const e=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(t){return n(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(o(e))))))}}}function Tn(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function Rn(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(r=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===r.track.id)):{track:r.track};const n=new Event("track");n.track=r.track,n.receiver=i,n.transceiver={receiver:i},n.streams=[t.stream],this.dispatchEvent(n)})),t.stream.getTracks().forEach((r=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===r.id)):{track:r};const n=new Event("track");n.track=r,n.receiver=i,n.transceiver={receiver:i},n.streams=[t.stream],this.dispatchEvent(n)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else hn(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function _n(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&(this._dtmf="audio"===t.kind?e.createDTMFSender(t):null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){let n=r.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&(this._dtmf="audio"===this.track.kind?this._pc.createDTMFSender(this.track):null),this._dtmf}})}}function In(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,i]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const n=function(e){const t={};return e.result().forEach((e=>{const r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{r[t]=e.stat(t)})),t[r.id]=r})),t},o=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};return arguments.length>=2?t.apply(this,[function(e){r(o(n(e)))},e]):new Promise(((e,r)=>{t.apply(this,[function(t){e(o(n(t)))},r])})).then(r,i)}}function wn(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Sn(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),hn(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Sn(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,r,i;return this.getSenders().forEach((r=>{r.track===e&&(t?i=!0:t=r)})),this.getReceivers().forEach((t=>(t.track===e&&(r?i=!0:r=t),t.track===e))),i||t&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function kn(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const i=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(i)&&this._shimmedLocalStreams[r.id].push(i):this._shimmedLocalStreams[r.id]=[r,i],i};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();r.apply(this,arguments);const i=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(i)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const r=this._shimmedLocalStreams[t].indexOf(e);-1!==r&&this._shimmedLocalStreams[t].splice(r,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),n.apply(this,arguments)}}function On(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return kn(e);const r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=r.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const r=new e.MediaStream(t.getTracks());this._streams[t.id]=r,this._reverseStreams[r.id]=t,t=r}i.apply(this,[t])};const n=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t];r=r.replace(new RegExp(e._streams[i.id].id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:r})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const n=this.getSenders().find((e=>e.track===t));if(n)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const o=this._streams[r.id];if(o)o.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const i=new e.MediaStream([t]);this._streams[r.id]=i,this._reverseStreams[i.id]=r,this.addStream(i)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[t=>{const r=o(this,t);e[0].apply(null,[r])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):r.apply(this,arguments).then((e=>o(this,e)))}}[t]}));const s=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t],n=e._streams[i.id];r=r.replace(new RegExp(i.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:r})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=a.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((r=>{this._streams[r].getTracks().find((t=>e.track===t))&&(t=this._streams[r])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function An(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}}[t]}))}function Pn(e,t){hn(e,"negotiationneeded",(e=>{const r=e.target;if(!(t.version<72||r.getConfiguration&&"plan-b"===r.getConfiguration().sdpSemantics)||"stable"===r.signalingState)return e}))}var Ln=Object.freeze({__proto__:null,shimMediaStream:Tn,shimOnTrack:Rn,shimGetSendersWithDtmf:_n,shimGetStats:In,shimSenderReceiverGetStats:wn,shimAddTrackRemoveTrackWithNative:kn,shimAddTrackRemoveTrack:On,shimPeerConnection:An,fixNegotiationNeeded:Pn,shimGetUserMedia:Cn,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then((t=>{const i=r.video&&r.video.width,n=r.video&&r.video.height;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:r.video&&r.video.frameRate||3}},i&&(r.video.mandatory.maxWidth=i),n&&(r.video.mandatory.maxHeight=n),e.navigator.mediaDevices.getUserMedia(r)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}});function xn(e,t){const r=e&&e.navigator,i=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,i){gn("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,i)},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){const e=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},t=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(r){return"object"==typeof r&&"object"==typeof r.audio&&(r=JSON.parse(JSON.stringify(r)),e(r.audio,"autoGainControl","mozAutoGainControl"),e(r.audio,"noiseSuppression","mozNoiseSuppression")),t(r)},i&&i.prototype.getSettings){const t=i.prototype.getSettings;i.prototype.getSettings=function(){const r=t.apply(this,arguments);return e(r,"mozAutoGainControl","autoGainControl"),e(r,"mozNoiseSuppression","noiseSuppression"),r}}if(i&&i.prototype.applyConstraints){const t=i.prototype.applyConstraints;i.prototype.applyConstraints=function(r){return"audio"===this.kind&&"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)),e(r,"autoGainControl","mozAutoGainControl"),e(r,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[r])}}}}function Dn(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Mn(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}}[t]}));const r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,o]=arguments;return i.apply(this,[e||null]).then((e=>{if(t.version<53&&!n)try{e.forEach((e=>{e.type=r[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,i)=>{e.set(i,Object.assign({},t,{type:r[t.type]||t.type}))}))}return e})).then(n,o)}}function Un(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Nn(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),hn(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Vn(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){gn("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function jn(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function Fn(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach((e=>{if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const i=t.apply(this,arguments);if(r){const{sender:t}=i,r=t.getParameters();(!("encodings"in r)||1===r.encodings.length&&0===Object.keys(r.encodings[0]).length)&&(r.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(r).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return i})}function Bn(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function Wn(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function Gn(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var Hn=Object.freeze({__proto__:null,shimOnTrack:Dn,shimPeerConnection:Mn,shimSenderGetStats:Un,shimReceiverGetStats:Nn,shimRemoveStream:Vn,shimRTCDataChannel:jn,shimAddTransceiver:Fn,shimGetParameters:Bn,shimCreateOffer:Wn,shimCreateAnswer:Gn,shimGetUserMedia:xn,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}});function $n(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((r=>t.call(this,r,e))),e.getVideoTracks().forEach((r=>t.call(this,r,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...r){return r&&r.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const r=e.getTracks();this.getSenders().forEach((e=>{r.includes(e.track)&&this.removeTrack(e)}))})}}function zn(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}))}),t.apply(e,arguments)}}}function Jn(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,r=t.createOffer,i=t.createAnswer,n=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],n=r.apply(this,[i]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){const r=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[r]);return t?(n.then(e,t),Promise.resolve()):n};let a=function(e,t,r){const i=n.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i};t.setLocalDescription=a,a=function(e,t,r){const i=o.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.setRemoteDescription=a,a=function(e,t,r){const i=s.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.addIceCandidate=a}function Yn(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,r=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>r(Kn(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,i){t.mediaDevices.getUserMedia(e).then(r,i)}.bind(t))}function Kn(e){return e&&void 0!==e.video?Object.assign({},e,{video:yn(e.video)}):e}function qn(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){const t=[];for(let r=0;r<e.iceServers.length;r++){let i=e.iceServers[r];!i.hasOwnProperty("urls")&&i.hasOwnProperty("url")?(gn("RTCIceServer.url","RTCIceServer.urls"),i=JSON.parse(JSON.stringify(i)),i.urls=i.url,delete i.url,t.push(i)):t.push(e.iceServers[r])}e.iceServers=t}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function Xn(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Qn(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const r=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveVideo||r||this.addTransceiver("video")}return t.apply(this,arguments)}}function Zn(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var eo=Object.freeze({__proto__:null,shimLocalStreamsAPI:$n,shimRemoteStreamsAPI:zn,shimCallbacksAPI:Jn,shimGetUserMedia:Yn,shimConstraints:Kn,shimRTCIceServerUrls:qn,shimTrackEventTransceiver:Xn,shimCreateOfferLegacy:Qn,shimAudioContext:Zn}),to=nt((function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const r=t.splitSections(e);return r&&r[0]},t.getMediaSections=function(e){const r=t.splitSections(e);return r.shift(),r},t.matchPrefix=function(e,r){return t.splitLines(e).filter((e=>0===e.indexOf(r)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const r={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let e=8;e<t.length;e+=2)switch(t[e]){case"raddr":r.relatedAddress=t[e+1];break;case"rport":r.relatedPort=parseInt(t[e+1],10);break;case"tcptype":r.tcpType=t[e+1];break;case"ufrag":r.ufrag=t[e+1],r.usernameFragment=t[e+1];break;default:void 0===r[t[e]]&&(r[t[e]]=t[e+1])}return r},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const r=e.component;t.push("rtp"===r?1:"rtcp"===r?2:r),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){let t=e.substr(9).split(" ");const r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){const t={};let r;const i=e.substr(e.indexOf(" ")+1).split(";");for(let e=0;e<i.length;e++)r=i[e].trim().split("="),t[r[0].trim()]=r[1];return t},t.writeFmtp=function(e){let t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const i=[];Object.keys(e.parameters).forEach((t=>{i.push(void 0!==e.parameters[t]?t+"="+e.parameters[t]:t)})),t+="a=fmtp:"+r+" "+i.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(r.attribute=e.substr(t+1,i-t-1),r.value=e.substr(i+1)):r.attribute=e.substr(t+1),r},t.parseSsrcGroup=function(e){const t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const r=t.matchPrefix(e,"a=mid:")[0];if(r)return r.substr(6)},t.parseFingerprint=function(e){const t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,r){return{role:"auto",fingerprints:t.matchPrefix(e+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},t.parseCryptoLine=function(e){const t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,r){return t.matchPrefix(e+r,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,r){const i=t.matchPrefix(e+r,"a=ice-ufrag:")[0],n=t.matchPrefix(e+r,"a=ice-pwd:")[0];return i&&n?{usernameFragment:i.substr(12),password:n.substr(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=t.splitLines(e)[0].split(" ");for(let n=3;n<i.length;n++){const o=i[n],s=t.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(s){const i=t.parseRtpMap(s),n=t.matchPrefix(e,"a=fmtp:"+o+" ");switch(i.parameters=n.length?t.parseFmtp(n[0]):{},i.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(t.parseRtcpFb),r.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(i.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((e=>{r.headerExtensions.push(t.parseExtmap(e))})),r},t.writeRtpDescription=function(e,r){let i="";i+="m="+e+" ",i+=r.codecs.length>0?"9":"0",i+=" UDP/TLS/RTP/SAVPF ",i+=r.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",r.codecs.forEach((e=>{i+=t.writeRtpMap(e),i+=t.writeFmtp(e),i+=t.writeRtcpFb(e)}));let n=0;return r.codecs.forEach((e=>{e.maxptime>n&&(n=e.maxptime)})),n>0&&(i+="a=maxptime:"+n+"\r\n"),r.headerExtensions&&r.headerExtensions.forEach((e=>{i+=t.writeExtmap(e)})),i},t.parseRtpEncodingParameters=function(e){const r=[],i=t.parseRtpParameters(e),n=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=s.length>0&&s[0].ssrc;let c;const u=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substr(17).split(" ").map((e=>parseInt(e,10)))));u.length>0&&u[0].length>1&&u[0][0]===a&&(c=u[0][1]),i.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c}),r.push(t),n&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:o?"red+ulpfec":"red"},r.push(t))}})),0===r.length&&a&&r.push({ssrc:a});let d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,r.forEach((e=>{e.maxBitrate=d}))),r},t.parseRtcpParameters=function(e){const r={},i=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];i&&(r.cname=i.value,r.ssrc=i.ssrc);const n=t.matchPrefix(e,"a=rtcp-rsize");r.reducedSize=n.length>0,r.compound=0===n.length;const o=t.matchPrefix(e,"a=rtcp-mux");return r.mux=o.length>0,r},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let r;const i=t.matchPrefix(e,"a=msid:");if(1===i.length)return r=i[0].substr(7).split(" "),{stream:r[0],track:r[1]};const n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return n.length>0?(r=n[0].value.split(" "),{stream:r[0],track:r[1]}):void 0},t.parseSctpDescription=function(e){const r=t.parseMLine(e),i=t.matchPrefix(e,"a=max-message-size:");let n;i.length>0&&(n=parseInt(i[0].substr(19),10)),isNaN(n)&&(n=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substr(12),10),protocol:r.fmt,maxMessageSize:n};const s=t.matchPrefix(e,"a=sctpmap:");if(s.length>0){const e=s[0].substr(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:n}}},t.writeSctpDescription=function(e,t){let r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,r,i){let n;const o=void 0!==r?r:2;return n=e||t.generateSessionId(),"v=0\r\no="+(i||"thisisadapterortc")+" "+n+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,r){const i=t.splitLines(e);for(let e=0;e<i.length;e++)switch(i[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[e].substr(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const r=t.splitLines(e)[0].substr(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(e){const r=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const r=t.splitLines(e);for(let e=0;e<r.length;e++)if(r[e].length<2||"="!==r[e].charAt(1))return!1;return!0},e.exports=t})),ro=Object.freeze(Object.assign(Object.create(null),to,{default:to}));function io(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const r=new t(e),i=to.parseCandidate(e.candidate),n=Object.assign(r,i);return n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}},n}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,hn(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function no(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const r=function(e){let r=65536;return"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},i=function(e,r){let i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);const n=to.matchPrefix(e.sdp,"a=max-message-size:");return n.length>0?i=parseInt(n[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(i=2147483637),i},n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(e){if(!e||!e.sdp)return!1;const t=to.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=to.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const r=parseInt(t[1],10);return r!=r?-1:r}(arguments[0]),t=r(e),n=i(arguments[0],e);let o;o=0===t&&0===n?Number.POSITIVE_INFINITY:0===t||0===n?Math.max(t,n):Math.min(t,n);const s={};Object.defineProperty(s,"maxMessageSize",{get:()=>o}),this._sctp=s}return n.apply(this,arguments)}}function oo(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const r=e.send;e.send=function(){const i=arguments[0],n=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}const r=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=r.apply(this,arguments);return t(e,this),e},hn(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function so(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const r=new Event("connectionstatechange",e);t.dispatchEvent(r)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}}))}function ao(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const r=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:r}):t.sdp=r}return r.apply(this,arguments)}}function co(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const r=e.RTCPeerConnection.prototype.addIceCandidate;r&&0!==r.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function uo(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const r=e.RTCPeerConnection.prototype.setLocalDescription;r&&0!==r.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return r.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return r.apply(this,[e]);return("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>r.apply(this,[e])))})}var lo=Object.freeze({__proto__:null,shimRTCIceCandidate:io,shimMaxMessageSize:no,shimSendThrowTypeError:oo,shimConnectionState:so,removeExtmapAllowMixed:ao,shimAddIceCandidateNullOrEmpty:co,shimParameterlessSetLocalDescription:uo});const ho=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const r=mn,i=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:r}=e;if(r.mozGetUserMedia)t.browser="firefox",t.version=ln(r.userAgent,/Firefox\/(\d+)\./,1);else if(r.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=ln(r.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!r.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=ln(r.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),n={browserDetails:i,commonShim:lo,extractVersion:ln,disableLog:pn,disableWarnings:fn,sdp:ro};switch(i.browser){case"chrome":if(!Ln||!An||!t.shimChrome)return r("Chrome shim is not included in this adapter release."),n;if(null===i.version)return r("Chrome shim can not determine version, not shimming."),n;r("adapter.js shimming chrome."),n.browserShim=Ln,co(e,i),uo(e),Cn(e,i),Tn(e),An(e,i),Rn(e),On(e,i),_n(e),In(e),wn(e),Pn(e,i),io(e),so(e),no(e,i),oo(e),ao(e,i);break;case"firefox":if(!Hn||!Mn||!t.shimFirefox)return r("Firefox shim is not included in this adapter release."),n;r("adapter.js shimming firefox."),n.browserShim=Hn,co(e,i),uo(e),xn(e,i),Mn(e,i),Dn(e),Vn(e),Un(e),Nn(e),jn(e),Fn(e),Bn(e),Wn(e),Gn(e),io(e),so(e),no(e,i),oo(e);break;case"safari":if(!eo||!t.shimSafari)return r("Safari shim is not included in this adapter release."),n;r("adapter.js shimming safari."),n.browserShim=eo,co(e,i),uo(e),qn(e),Qn(e),Jn(e),$n(e),zn(e),Xn(e),Yn(e),Zn(e),io(e),no(e,i),oo(e),ao(e,i);break;default:r("Unsupported browser!")}return n}({window:"undefined"==typeof window?void 0:window});var po;(po=(po=window)||self).RTCBeautyPlugin=function(e){function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),e}e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;var n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function o(e,t){return e(t={exports:{}},t.exports),t.exports}var s,a,c=function(e){return e&&e.Math==Math&&e},u=c("object"==("undefined"==typeof globalThis?"undefined":bt(globalThis))&&globalThis)||c("object"==("undefined"==typeof window?"undefined":bt(window))&&window)||c("object"==("undefined"==typeof self?"undefined":bt(self))&&self)||c("object"==bt(n)&&n)||function(){return this}()||Function("return this")(),d=function(e){try{return!!e()}catch(e){return!0}},l=!d((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),h={}.propertyIsEnumerable,p=Object.getOwnPropertyDescriptor,f={f:p&&!h.call({1:2},1)?function(e){var t=p(this,e);return!!t&&t.enumerable}:h},m=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},g={}.toString,v=function(e){return g.call(e).slice(8,-1)},y="".split,b=d((function(){return!Object("z").propertyIsEnumerable(0)}))?function(e){return"String"==v(e)?y.call(e,""):Object(e)}:Object,S=function(e){if(null==e)throw TypeError("Can't call method on "+e);return e},E=function(e){return b(S(e))},C=function(e){return"object"==bt(e)?null!==e:"function"==typeof e},T=function(e,t){return arguments.length<2?function(e){return"function"==typeof e?e:void 0}(u[e]):u[e]&&u[e][t]},R=T("navigator","userAgent")||"",_=u.process,I=u.Deno,w=_&&_.versions||I&&I.version,k=w&&w.v8;k?a=(s=k.split("."))[0]<4?1:s[0]+s[1]:R&&(!(s=R.match(/Edge\/(\d+)/))||s[1]>=74)&&(s=R.match(/Chrome\/(\d+)/))&&(a=s[1]);var O=a&&+a,A=!!Object.getOwnPropertySymbols&&!d((function(){var e=Symbol();return!String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&O&&O<41})),P=A&&!Symbol.sham&&"symbol"==bt(Symbol.iterator),L=P?function(e){return"symbol"==bt(e)}:function(e){var t=T("Symbol");return"function"==typeof t&&Object(e)instanceof t},x=function(e,t){try{Object.defineProperty(u,e,{value:t,configurable:!0,writable:!0})}catch(r){u[e]=t}return t},D=u["__core-js_shared__"]||x("__core-js_shared__",{}),M=o((function(e){(e.exports=function(e,t){return D[e]||(D[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.16.0",mode:"global",copyright:"© 2021 Denis Pushkarev (zloirock.ru)"})})),U=function(e){return Object(S(e))},N={}.hasOwnProperty,V=Object.hasOwn||function(e,t){return N.call(U(e),t)},j=0,F=Math.random(),B=function(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++j+F).toString(36)},W=M("wks"),G=u.Symbol,H=P?G:G&&G.withoutSetter||B,$=function(e){return V(W,e)&&(A||"string"==typeof W[e])||(W[e]=A&&V(G,e)?G[e]:H("Symbol."+e)),W[e]},z=$("toPrimitive"),J=function(e){var t=function(e,t){if(!C(e)||L(e))return e;var r,i=e[z];if(void 0!==i){if(void 0===t&&(t="default"),r=i.call(e,t),!C(r)||L(r))return r;throw TypeError("Can't convert object to primitive value")}return void 0===t&&(t="number"),function(e,t){var r,i;if("string"===t&&"function"==typeof(r=e.toString)&&!C(i=r.call(e)))return i;if("function"==typeof(r=e.valueOf)&&!C(i=r.call(e)))return i;if("string"!==t&&"function"==typeof(r=e.toString)&&!C(i=r.call(e)))return i;throw TypeError("Can't convert object to primitive value")}(e,t)}(e,"string");return L(t)?t:String(t)},Y=u.document,K=C(Y)&&C(Y.createElement),q=function(e){return K?Y.createElement(e):{}},X=!l&&!d((function(){return 7!=Object.defineProperty(q("div"),"a",{get:function(){return 7}}).a})),Q=Object.getOwnPropertyDescriptor,Z={f:l?Q:function(e,t){if(e=E(e),t=J(t),X)try{return Q(e,t)}catch(e){}if(V(e,t))return m(!f.f.call(e,t),e[t])}},ee=function(e){if(!C(e))throw TypeError(String(e)+" is not an object");return e},te=Object.defineProperty,re={f:l?te:function(e,t,r){if(ee(e),t=J(t),ee(r),X)try{return te(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported");return"value"in r&&(e[t]=r.value),e}},ie=l?function(e,t,r){return re.f(e,t,m(1,r))}:function(e,t,r){return e[t]=r,e},ne=Function.toString;"function"!=typeof D.inspectSource&&(D.inspectSource=function(e){return ne.call(e)});var oe,se,ae,ce=D.inspectSource,ue=u.WeakMap,de="function"==typeof ue&&/native code/.test(ce(ue)),le=M("keys"),he=function(e){return le[e]||(le[e]=B(e))},pe={},fe=u.WeakMap;if(de||D.state){var me=D.state||(D.state=new fe),ge=me.get,ve=me.has,ye=me.set;oe=function(e,t){if(ve.call(me,e))throw new TypeError("Object already initialized");return t.facade=e,ye.call(me,e,t),t},se=function(e){return ge.call(me,e)||{}},ae=function(e){return ve.call(me,e)}}else{var be=he("state");pe[be]=!0,oe=function(e,t){if(V(e,be))throw new TypeError("Object already initialized");return t.facade=e,ie(e,be,t),t},se=function(e){return V(e,be)?e[be]:{}},ae=function(e){return V(e,be)}}var Se={set:oe,get:se,has:ae,enforce:function(e){return ae(e)?se(e):oe(e,{})},getterFor:function(e){return function(t){var r;if(!C(t)||(r=se(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return r}}},Ee=o((function(e){var t=Se.get,r=Se.enforce,i=String(String).split("String");(e.exports=function(e,t,n,o){var s,a=!!o&&!!o.unsafe,c=!!o&&!!o.enumerable,d=!!o&&!!o.noTargetGet;"function"==typeof n&&("string"!=typeof t||V(n,"name")||ie(n,"name",t),(s=r(n)).source||(s.source=i.join("string"==typeof t?t:""))),e!==u?(a?!d&&e[t]&&(c=!0):delete e[t],c?e[t]=n:ie(e,t,n)):c?e[t]=n:x(t,n)})(Function.prototype,"toString",(function(){return"function"==typeof this&&t(this).source||ce(this)}))})),Ce=Math.ceil,Te=Math.floor,Re=function(e){return isNaN(e=+e)?0:(e>0?Te:Ce)(e)},_e=Math.min,Ie=function(e){return e>0?_e(Re(e),9007199254740991):0},we=Math.max,ke=Math.min,Oe=function(e,t){var r=Re(e);return r<0?we(r+t,0):ke(r,t)},Ae=function(e){return function(t,r,i){var n,o=E(t),s=Ie(o.length),a=Oe(i,s);if(e&&r!=r){for(;s>a;)if((n=o[a++])!=n)return!0}else for(;s>a;a++)if((e||a in o)&&o[a]===r)return e||a||0;return!e&&-1}},Pe={includes:Ae(!0),indexOf:Ae(!1)},Le=Pe.indexOf,xe=function(e,t){var r,i=E(e),n=0,o=[];for(r in i)!V(pe,r)&&V(i,r)&&o.push(r);for(;t.length>n;)V(i,r=t[n++])&&(~Le(o,r)||o.push(r));return o},De=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Me=De.concat("length","prototype"),Ue={f:Object.getOwnPropertyNames||function(e){return xe(e,Me)}},Ne={f:Object.getOwnPropertySymbols},Ve=T("Reflect","ownKeys")||function(e){var t=Ue.f(ee(e)),r=Ne.f;return r?t.concat(r(e)):t},je=function(e,t){for(var r=Ve(t),i=re.f,n=Z.f,o=0;o<r.length;o++){var s=r[o];V(e,s)||i(e,s,n(t,s))}},Fe=/#|\.prototype\./,Be=function(e,t){var r=Ge[We(e)];return r==$e||r!=He&&("function"==typeof t?d(t):!!t)},We=Be.normalize=function(e){return String(e).replace(Fe,".").toLowerCase()},Ge=Be.data={},He=Be.NATIVE="N",$e=Be.POLYFILL="P",ze=Be,Je=Z.f,Ye=function(e,t){var r,i,n,o,s,a=e.target,c=e.global,d=e.stat;if(r=c?u:d?u[a]||x(a,{}):(u[a]||{}).prototype)for(i in t){if(o=t[i],n=e.noTargetGet?(s=Je(r,i))&&s.value:r[i],!ze(c?i:a+(d?".":"#")+i,e.forced)&&void 0!==n){if(bt(o)==bt(n))continue;je(o,n)}(e.sham||n&&n.sham)&&ie(o,"sham",!0),Ee(r,i,o,e)}},Ke=function(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e},qe=function(e,t,r){if(Ke(e),void 0===t)return e;switch(r){case 0:return function(){return e.call(t)};case 1:return function(r){return e.call(t,r)};case 2:return function(r,i){return e.call(t,r,i)};case 3:return function(r,i,n){return e.call(t,r,i,n)}}return function(){return e.apply(t,arguments)}},Xe=Array.isArray||function(e){return"Array"==v(e)},Qe=$("species"),Ze=function(e,t){return new(function(e){var t;return Xe(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!Xe(t.prototype)?C(t)&&null===(t=t[Qe])&&(t=void 0):t=void 0),void 0===t?Array:t}(e))(0===t?0:t)},et=[].push,tt=function(e){var t=1==e,r=2==e,i=3==e,n=4==e,o=6==e,s=7==e,a=5==e||o;return function(c,u,d,l){for(var h,p,f=U(c),m=b(f),g=qe(u,d,3),v=Ie(m.length),y=0,S=l||Ze,E=t?S(c,v):r||s?S(c,0):void 0;v>y;y++)if((a||y in m)&&(p=g(h=m[y],y,f),e))if(t)E[y]=p;else if(p)switch(e){case 3:return!0;case 5:return h;case 6:return y;case 2:et.call(E,h)}else switch(e){case 4:return!1;case 7:et.call(E,h)}return o?-1:i||n?n:E}},rt={forEach:tt(0),map:tt(1),filter:tt(2),some:tt(3),every:tt(4),find:tt(5),findIndex:tt(6),filterReject:tt(7)},it=$("species"),nt=rt.filter,ot=O>=51||!d((function(){var e=[];return(e.constructor={})[it]=function(){return{foo:1}},1!==e.filter(Boolean).foo}));Ye({target:"Array",proto:!0,forced:!ot},{filter:function(e){return nt(this,e,arguments.length>1?arguments[1]:void 0)}});var st=Date.prototype,at=st.toString,ct=st.getTime;"Invalid Date"!=String(new Date(NaN))&&Ee(st,"toString",(function(){var e=ct.call(this);return e==e?at.call(this):"Invalid Date"}));var ut=[].slice,dt={};Ye({target:"Function",proto:!0},{bind:Function.bind||function(e){var t=Ke(this),r=ut.call(arguments,1),i=function i(){var n=r.concat(ut.call(arguments));return this instanceof i?function(e,t,r){if(!(t in dt)){for(var i=[],n=0;n<t;n++)i[n]="a["+n+"]";dt[t]=Function("C,a","return new C("+i.join(",")+")")}return dt[t](e,r)}(t,n.length,n):t.apply(e,n)};return C(t.prototype)&&(i.prototype=t.prototype),i}});var lt=[].slice,ht=/MSIE .\./.test(R),pt=function(e){return function(t,r){var i=arguments.length>2,n=i?lt.call(arguments,2):void 0;return e(i?function(){("function"==typeof t?t:Function(t)).apply(this,n)}:t,r)}};Ye({global:!0,bind:!0,forced:ht},{setTimeout:pt(u.setTimeout),setInterval:pt(u.setInterval)});var ft,mt=Object.keys||function(e){return xe(e,De)},gt=l?Object.defineProperties:function(e,t){ee(e);for(var r,i=mt(t),n=i.length,o=0;n>o;)re.f(e,r=i[o++],t[r]);return e},vt=T("document","documentElement"),yt=he("IE_PROTO"),St=function(){},Et=function(e){return"<script>"+e+"<\/script>"},Ct=function(e){e.write(Et("")),e.close();var t=e.parentWindow.Object;return e=null,t},Tt=function(){try{ft=new ActiveXObject("htmlfile")}catch(e){}Tt=document.domain&&ft?Ct(ft):function(){var e,t=q("iframe");if(t.style)return t.style.display="none",vt.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write(Et("document.F=Object")),e.close(),e.F}()||Ct(ft);for(var e=De.length;e--;)delete Tt.prototype[De[e]];return Tt()};pe[yt]=!0;var Rt=Object.create||function(e,t){var r;return null!==e?(St.prototype=ee(e),r=new St,St.prototype=null,r[yt]=e):r=Tt(),void 0===t?r:gt(r,t)},_t=$("unscopables"),It=Array.prototype;null==It[_t]&&re.f(It,_t,{configurable:!0,value:Rt(null)});var wt,kt,Ot,At=function(e){It[_t][e]=!0},Pt={},Lt=!d((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),xt=he("IE_PROTO"),Dt=Object.prototype,Mt=Lt?Object.getPrototypeOf:function(e){return e=U(e),V(e,xt)?e[xt]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?Dt:null},Ut=$("iterator"),Nt=!1;[].keys&&("next"in(Ot=[].keys())?(kt=Mt(Mt(Ot)))!==Object.prototype&&(wt=kt):Nt=!0),(null==wt||d((function(){var e={};return wt[Ut].call(e)!==e})))&&(wt={}),V(wt,Ut)||ie(wt,Ut,(function(){return this}));var Vt={IteratorPrototype:wt,BUGGY_SAFARI_ITERATORS:Nt},jt=re.f,Ft=$("toStringTag"),Bt=function(e,t,r){e&&!V(e=r?e:e.prototype,Ft)&&jt(e,Ft,{configurable:!0,value:t})},Wt=Vt.IteratorPrototype,Gt=function(){return this},Ht=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,r={};try{(e=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(r,[]),t=r instanceof Array}catch(e){}return function(r,i){return ee(r),function(e){if(!C(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype")}(i),t?e.call(r,i):r.__proto__=i,r}}():void 0),$t=Vt.IteratorPrototype,zt=Vt.BUGGY_SAFARI_ITERATORS,Jt=$("iterator"),Yt=function(){return this},Kt=function(e,t,r,i,n,o,s){!function(e,t,r){var i=t+" Iterator";e.prototype=Rt(Wt,{next:m(1,r)}),Bt(e,i,!1),Pt[i]=Gt}(r,t,i);var a,c,u,d=function(e){if(e===n&&g)return g;if(!zt&&e in p)return p[e];switch(e){case"keys":case"values":case"entries":return function(){return new r(this,e)}}return function(){return new r(this)}},l=t+" Iterator",h=!1,p=e.prototype,f=p[Jt]||p["@@iterator"]||n&&p[n],g=!zt&&f||d(n),v="Array"==t&&p.entries||f;if(v&&(a=Mt(v.call(new e)),$t!==Object.prototype&&a.next&&(Mt(a)!==$t&&(Ht?Ht(a,$t):"function"!=typeof a[Jt]&&ie(a,Jt,Yt)),Bt(a,l,!0))),"values"==n&&f&&"values"!==f.name&&(h=!0,g=function(){return f.call(this)}),p[Jt]!==g&&ie(p,Jt,g),Pt[t]=g,n)if(c={values:d("values"),keys:o?g:d("keys"),entries:d("entries")},s)for(u in c)(zt||h||!(u in p))&&Ee(p,u,c[u]);else Ye({target:t,proto:!0,forced:zt||h},c);return c},qt=Se.set,Xt=Se.getterFor("Array Iterator"),Qt=Kt(Array,"Array",(function(e,t){qt(this,{type:"Array Iterator",target:E(e),index:0,kind:t})}),(function(){var e=Xt(this),t=e.target,r=e.kind,i=e.index++;return!t||i>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==r?{value:i,done:!1}:"values"==r?{value:t[i],done:!1}:{value:[i,t[i]],done:!1}}),"values");Pt.Arguments=Pt.Array,At("keys"),At("values"),At("entries");var Zt=Ue.f,er={}.toString,tr="object"==("undefined"==typeof window?"undefined":bt(window))&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],rr={f:function(e){return tr&&"[object Window]"==er.call(e)?function(e){try{return Zt(e)}catch(e){return tr.slice()}}(e):Zt(E(e))}},ir=!d((function(){return Object.isExtensible(Object.preventExtensions({}))})),nr=o((function(e){var t=re.f,r=!1,i=B("meta"),n=0,o=Object.isExtensible||function(){return!0},s=function(e){t(e,i,{value:{objectID:"O"+n++,weakData:{}}})},a=e.exports={enable:function(){a.enable=function(){},r=!0;var e=Ue.f,t=[].splice,n={};n[i]=1,e(n).length&&(Ue.f=function(r){for(var n=e(r),o=0,s=n.length;o<s;o++)if(n[o]===i){t.call(n,o,1);break}return n},Ye({target:"Object",stat:!0,forced:!0},{getOwnPropertyNames:rr.f}))},fastKey:function(e,t){if(!C(e))return"symbol"==bt(e)?e:("string"==typeof e?"S":"P")+e;if(!V(e,i)){if(!o(e))return"F";if(!t)return"E";s(e)}return e[i].objectID},getWeakData:function(e,t){if(!V(e,i)){if(!o(e))return!0;if(!t)return!1;s(e)}return e[i].weakData},onFreeze:function(e){return ir&&r&&o(e)&&!V(e,i)&&s(e),e}};pe[i]=!0})),or=$("iterator"),sr=Array.prototype,ar=function(e){return void 0!==e&&(Pt.Array===e||sr[or]===e)},cr={};cr[$("toStringTag")]="z";var ur="[object z]"===String(cr),dr=$("toStringTag"),lr="Arguments"==v(function(){return arguments}()),hr=ur?v:function(e){var t,r,i;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),dr))?r:lr?v(t):"Object"==(i=v(t))&&"function"==typeof t.callee?"Arguments":i},pr=$("iterator"),fr=function(e){if(null!=e)return e[pr]||e["@@iterator"]||Pt[hr(e)]},mr=function(e){var t=e.return;if(void 0!==t)return ee(t.call(e)).value},gr=function(e,t){this.stopped=e,this.result=t},vr=function(e,t,r){var i,n,o,s,a,c,u,d=!(!r||!r.AS_ENTRIES),l=!(!r||!r.IS_ITERATOR),h=!(!r||!r.INTERRUPTED),p=qe(t,r&&r.that,1+d+h),f=function(e){return i&&mr(i),new gr(!0,e)},m=function(e){return d?(ee(e),h?p(e[0],e[1],f):p(e[0],e[1])):h?p(e,f):p(e)};if(l)i=e;else{if("function"!=typeof(n=fr(e)))throw TypeError("Target is not iterable");if(ar(n)){for(o=0,s=Ie(e.length);s>o;o++)if((a=m(e[o]))&&a instanceof gr)return a;return new gr(!1)}i=n.call(e)}for(c=i.next;!(u=c.call(i)).done;){try{a=m(u.value)}catch(e){throw mr(i),e}if("object"==bt(a)&&a&&a instanceof gr)return a}return new gr(!1)},yr=function(e,t,r){if(!(e instanceof t))throw TypeError("Incorrect "+(r?r+" ":"")+"invocation");return e},br=$("iterator"),Sr=!1;try{var Er=0,Cr={next:function(){return{done:!!Er++}},return:function(){Sr=!0}};Cr[br]=function(){return this},Array.from(Cr,(function(){throw 2}))}catch(e){}var Tr=function(e,t){if(!t&&!Sr)return!1;var r=!1;try{var i={};i[br]=function(){return{next:function(){return{done:r=!0}}}},e(i)}catch(e){}return r},Rr=function(e,t,r){var i,n;return Ht&&"function"==typeof(i=t.constructor)&&i!==r&&C(n=i.prototype)&&n!==r.prototype&&Ht(e,n),e},_r=function(e,t,r){for(var i in t)Ee(e,i,t[i],r);return e},Ir=$("species"),wr=function(e){var t=T(e);l&&t&&!t[Ir]&&(0,re.f)(t,Ir,{configurable:!0,get:function(){return this}})},kr=re.f,Or=nr.fastKey,Ar=Se.set,Pr=Se.getterFor,Lr=(function(e,t,r){var i=-1!==e.indexOf("Map"),n=-1!==e.indexOf("Weak"),o=i?"set":"add",s=u[e],a=s&&s.prototype,c=s,l={},h=function(e){var t=a[e];Ee(a,e,"add"==e?function(e){return t.call(this,0===e?0:e),this}:"delete"==e?function(e){return!(n&&!C(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return n&&!C(e)?void 0:t.call(this,0===e?0:e)}:"has"==e?function(e){return!(n&&!C(e))&&t.call(this,0===e?0:e)}:function(e,r){return t.call(this,0===e?0:e,r),this})};if(ze(e,"function"!=typeof s||!(n||a.forEach&&!d((function(){(new s).entries().next()})))))c=r.getConstructor(t,e,i,o),nr.enable();else if(ze(e,!0)){var p=new c,f=p[o](n?{}:-0,1)!=p,m=d((function(){p.has(1)})),g=Tr((function(e){new s(e)})),v=!n&&d((function(){for(var e=new s,t=5;t--;)e[o](t,t);return!e.has(-0)}));g||((c=t((function(t,r){yr(t,c,e);var n=Rr(new s,t,c);return null!=r&&vr(r,n[o],{that:n,AS_ENTRIES:i}),n}))).prototype=a,a.constructor=c),(m||v)&&(h("delete"),h("has"),i&&h("get")),(v||f)&&h(o),n&&a.clear&&delete a.clear}l[e]=c,Ye({global:!0,forced:c!=s},l),Bt(c,e),n||r.setStrong(c,e,i)}("Map",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),{getConstructor:function(e,t,r,i){var n=e((function(e,o){yr(e,n,t),Ar(e,{type:t,index:Rt(null),first:void 0,last:void 0,size:0}),l||(e.size=0),null!=o&&vr(o,e[i],{that:e,AS_ENTRIES:r})})),o=Pr(t),s=function(e,t,r){var i,n,s=o(e),c=a(e,t);return c?c.value=r:(s.last=c={index:n=Or(t,!0),key:t,value:r,previous:i=s.last,next:void 0,removed:!1},s.first||(s.first=c),i&&(i.next=c),l?s.size++:e.size++,"F"!==n&&(s.index[n]=c)),e},a=function(e,t){var r,i=o(e),n=Or(t);if("F"!==n)return i.index[n];for(r=i.first;r;r=r.next)if(r.key==t)return r};return _r(n.prototype,{clear:function(){for(var e=o(this),t=e.index,r=e.first;r;)r.removed=!0,r.previous&&(r.previous=r.previous.next=void 0),delete t[r.index],r=r.next;e.first=e.last=void 0,l?e.size=0:this.size=0},delete:function(e){var t=o(this),r=a(this,e);if(r){var i=r.next,n=r.previous;delete t.index[r.index],r.removed=!0,n&&(n.next=i),i&&(i.previous=n),t.first==r&&(t.first=i),t.last==r&&(t.last=n),l?t.size--:this.size--}return!!r},forEach:function(e){for(var t,r=o(this),i=qe(e,arguments.length>1?arguments[1]:void 0,3);t=t?t.next:r.first;)for(i(t.value,t.key,this);t&&t.removed;)t=t.previous},has:function(e){return!!a(this,e)}}),_r(n.prototype,r?{get:function(e){var t=a(this,e);return t&&t.value},set:function(e,t){return s(this,0===e?0:e,t)}}:{add:function(e){return s(this,e=0===e?0:e,e)}}),l&&kr(n.prototype,"size",{get:function(){return o(this).size}}),n},setStrong:function(e,t,r){var i=t+" Iterator",n=Pr(t),o=Pr(i);Kt(e,t,(function(e,t){Ar(this,{type:i,target:e,state:n(e),kind:t,last:void 0})}),(function(){for(var e=o(this),t=e.kind,r=e.last;r&&r.removed;)r=r.previous;return e.target&&(e.last=r=r?r.next:e.state.first)?"keys"==t?{value:r.key,done:!1}:"values"==t?{value:r.value,done:!1}:{value:[r.key,r.value],done:!1}:(e.target=void 0,{value:void 0,done:!0})}),r?"entries":"values",!r,!0),wr(t)}}),ur?{}.toString:function(){return"[object "+hr(this)+"]"});ur||Ee(Object.prototype,"toString",Lr,{unsafe:!0});var xr=function(e){if(L(e))throw TypeError("Cannot convert a Symbol value to a string");return String(e)},Dr=function(e){return function(t,r){var i,n,o=xr(S(t)),s=Re(r),a=o.length;return s<0||s>=a?e?"":void 0:(i=o.charCodeAt(s))<55296||i>56319||s+1===a||(n=o.charCodeAt(s+1))<56320||n>57343?e?o.charAt(s):i:e?o.slice(s,s+2):n-56320+(i-55296<<10)+65536}},Mr={codeAt:Dr(!1),charAt:Dr(!0)},Ur=Mr.charAt,Nr=Se.set,Vr=Se.getterFor("String Iterator");Kt(String,"String",(function(e){Nr(this,{type:"String Iterator",string:xr(e),index:0})}),(function(){var e,t=Vr(this),r=t.string,i=t.index;return i>=r.length?{value:void 0,done:!0}:(e=Ur(r,i),t.index+=e.length,{value:e,done:!1})}));var jr={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Fr=$("iterator"),Br=$("toStringTag"),Wr=Qt.values;for(var Gr in jr){var Hr=u[Gr],$r=Hr&&Hr.prototype;if($r){if($r[Fr]!==Wr)try{ie($r,Fr,Wr)}catch(e){$r[Fr]=Wr}if($r[Br]||ie($r,Br,Gr),jr[Gr])for(var zr in Qt)if($r[zr]!==Qt[zr])try{ie($r,zr,Qt[zr])}catch(e){$r[zr]=Qt[zr]}}}var Jr="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,Yr=function(e){if(void 0===e)return 0;var t=Re(e),r=Ie(t);if(t!==r)throw RangeError("Wrong length or index");return r},Kr=Math.abs,qr=Math.pow,Xr=Math.floor,Qr=Math.log,Zr=Math.LN2,ei=function(e){for(var t=U(this),r=Ie(t.length),i=arguments.length,n=Oe(i>1?arguments[1]:void 0,r),o=i>2?arguments[2]:void 0,s=void 0===o?r:Oe(o,r);s>n;)t[n++]=e;return t},ti=Ue.f,ri=re.f,ii=Se.get,ni=Se.set,oi=u.ArrayBuffer,si=oi,ai=u.DataView,ci=ai&&ai.prototype,ui=Object.prototype,di=u.RangeError,li=function(e,t,r){var i,n,o,s=new Array(r),a=8*r-t-1,c=(1<<a)-1,u=c>>1,d=23===t?qr(2,-24)-qr(2,-77):0,l=e<0||0===e&&1/e<0?1:0,h=0;for((e=Kr(e))!=e||1/0===e?(n=e!=e?1:0,i=c):(i=Xr(Qr(e)/Zr),e*(o=qr(2,-i))<1&&(i--,o*=2),(e+=i+u>=1?d/o:d*qr(2,1-u))*o>=2&&(i++,o/=2),i+u>=c?(n=0,i=c):i+u>=1?(n=(e*o-1)*qr(2,t),i+=u):(n=e*qr(2,u-1)*qr(2,t),i=0));t>=8;s[h++]=255&n,n/=256,t-=8);for(i=i<<t|n,a+=t;a>0;s[h++]=255&i,i/=256,a-=8);return s[--h]|=128*l,s},hi=function(e,t){var r,i=e.length,n=8*i-t-1,o=(1<<n)-1,s=o>>1,a=n-7,c=i-1,u=e[c--],d=127&u;for(u>>=7;a>0;d=256*d+e[c],c--,a-=8);for(r=d&(1<<-a)-1,d>>=-a,a+=t;a>0;r=256*r+e[c],c--,a-=8);if(0===d)d=1-s;else{if(d===o)return r?NaN:u?-1/0:1/0;r+=qr(2,t),d-=s}return(u?-1:1)*r*qr(2,d-t)},pi=function(e){return[255&e]},fi=function(e){return[255&e,e>>8&255]},mi=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},gi=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},vi=function(e){return li(e,23,4)},yi=function(e){return li(e,52,8)},bi=function(e,t){ri(e.prototype,t,{get:function(){return ii(this)[t]}})},Si=function(e,t,r,i){var n=Yr(r),o=ii(e);if(n+t>o.byteLength)throw di("Wrong index");var s=ii(o.buffer).bytes,a=n+o.byteOffset,c=s.slice(a,a+t);return i?c:c.reverse()},Ei=function(e,t,r,i,n,o){var s=Yr(r),a=ii(e);if(s+t>a.byteLength)throw di("Wrong index");for(var c=ii(a.buffer).bytes,u=s+a.byteOffset,d=i(+n),l=0;l<t;l++)c[u+l]=d[o?l:t-l-1]};if(Jr){if(!d((function(){oi(1)}))||!d((function(){new oi(-1)}))||d((function(){return new oi,new oi(1.5),new oi(NaN),"ArrayBuffer"!=oi.name}))){for(var Ci,Ti=(si=function(e){return yr(this,si),new oi(Yr(e))}).prototype=oi.prototype,Ri=ti(oi),_i=0;Ri.length>_i;)(Ci=Ri[_i++])in si||ie(si,Ci,oi[Ci]);Ti.constructor=si}Ht&&Mt(ci)!==ui&&Ht(ci,ui);var Ii=new ai(new si(2)),wi=ci.setInt8;Ii.setInt8(0,2147483648),Ii.setInt8(1,2147483649),!Ii.getInt8(0)&&Ii.getInt8(1)||_r(ci,{setInt8:function(e,t){wi.call(this,e,t<<24>>24)},setUint8:function(e,t){wi.call(this,e,t<<24>>24)}},{unsafe:!0})}else si=function(e){yr(this,si,"ArrayBuffer");var t=Yr(e);ni(this,{bytes:ei.call(new Array(t),0),byteLength:t}),l||(this.byteLength=t)},ai=function(e,t,r){yr(this,ai,"DataView"),yr(e,si,"DataView");var i=ii(e).byteLength,n=Re(t);if(n<0||n>i)throw di("Wrong offset");if(n+(r=void 0===r?i-n:Ie(r))>i)throw di("Wrong length");ni(this,{buffer:e,byteLength:r,byteOffset:n}),l||(this.buffer=e,this.byteLength=r,this.byteOffset=n)},l&&(bi(si,"byteLength"),bi(ai,"buffer"),bi(ai,"byteLength"),bi(ai,"byteOffset")),_r(ai.prototype,{getInt8:function(e){return Si(this,1,e)[0]<<24>>24},getUint8:function(e){return Si(this,1,e)[0]},getInt16:function(e){var t=Si(this,2,e,arguments.length>1?arguments[1]:void 0);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=Si(this,2,e,arguments.length>1?arguments[1]:void 0);return t[1]<<8|t[0]},getInt32:function(e){return gi(Si(this,4,e,arguments.length>1?arguments[1]:void 0))},getUint32:function(e){return gi(Si(this,4,e,arguments.length>1?arguments[1]:void 0))>>>0},getFloat32:function(e){return hi(Si(this,4,e,arguments.length>1?arguments[1]:void 0),23)},getFloat64:function(e){return hi(Si(this,8,e,arguments.length>1?arguments[1]:void 0),52)},setInt8:function(e,t){Ei(this,1,e,pi,t)},setUint8:function(e,t){Ei(this,1,e,pi,t)},setInt16:function(e,t){Ei(this,2,e,fi,t,arguments.length>2?arguments[2]:void 0)},setUint16:function(e,t){Ei(this,2,e,fi,t,arguments.length>2?arguments[2]:void 0)},setInt32:function(e,t){Ei(this,4,e,mi,t,arguments.length>2?arguments[2]:void 0)},setUint32:function(e,t){Ei(this,4,e,mi,t,arguments.length>2?arguments[2]:void 0)},setFloat32:function(e,t){Ei(this,4,e,vi,t,arguments.length>2?arguments[2]:void 0)},setFloat64:function(e,t){Ei(this,8,e,yi,t,arguments.length>2?arguments[2]:void 0)}});Bt(si,"ArrayBuffer"),Bt(ai,"DataView");var ki={ArrayBuffer:si,DataView:ai},Oi=$("species"),Ai=function(e,t){var r,i=ee(e).constructor;return void 0===i||null==(r=ee(i)[Oi])?t:Ke(r)},Pi=ki.ArrayBuffer,Li=ki.DataView,xi=Pi.prototype.slice,Di=d((function(){return!new Pi(2).slice(1,void 0).byteLength}));Ye({target:"ArrayBuffer",proto:!0,unsafe:!0,forced:Di},{slice:function(e,t){if(void 0!==xi&&void 0===t)return xi.call(ee(this),e);for(var r=ee(this).byteLength,i=Oe(e,r),n=Oe(void 0===t?r:t,r),o=new(Ai(this,Pi))(Ie(n-i)),s=new Li(this),a=new Li(o),c=0;i<n;)a.setUint8(c++,s.getUint8(i++));return o}});var Mi,Ui,Ni,Vi=re.f,ji=u.Int8Array,Fi=ji&&ji.prototype,Bi=u.Uint8ClampedArray,Wi=Bi&&Bi.prototype,Gi=ji&&Mt(ji),Hi=Fi&&Mt(Fi),$i=Object.prototype,zi=$i.isPrototypeOf,Ji=$("toStringTag"),Yi=B("TYPED_ARRAY_TAG"),Ki=B("TYPED_ARRAY_CONSTRUCTOR"),qi=Jr&&!!Ht&&"Opera"!==hr(u.opera),Xi=!1,Qi={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},Zi={BigInt64Array:8,BigUint64Array:8},en=function(e){if(!C(e))return!1;var t=hr(e);return V(Qi,t)||V(Zi,t)};for(Mi in Qi)(Ni=(Ui=u[Mi])&&Ui.prototype)?ie(Ni,Ki,Ui):qi=!1;for(Mi in Zi)(Ni=(Ui=u[Mi])&&Ui.prototype)&&ie(Ni,Ki,Ui);if((!qi||"function"!=typeof Gi||Gi===Function.prototype)&&(Gi=function(){throw TypeError("Incorrect invocation")},qi))for(Mi in Qi)u[Mi]&&Ht(u[Mi],Gi);if((!qi||!Hi||Hi===$i)&&(Hi=Gi.prototype,qi))for(Mi in Qi)u[Mi]&&Ht(u[Mi].prototype,Hi);if(qi&&Mt(Wi)!==Hi&&Ht(Wi,Hi),l&&!V(Hi,Ji))for(Mi in Xi=!0,Vi(Hi,Ji,{get:function(){return C(this)?this[Yi]:void 0}}),Qi)u[Mi]&&ie(u[Mi],Yi,Mi);var tn={NATIVE_ARRAY_BUFFER_VIEWS:qi,TYPED_ARRAY_CONSTRUCTOR:Ki,TYPED_ARRAY_TAG:Xi&&Yi,aTypedArray:function(e){if(en(e))return e;throw TypeError("Target is not a typed array")},aTypedArrayConstructor:function(e){if(Ht&&!zi.call(Gi,e))throw TypeError("Target is not a typed array constructor");return e},exportTypedArrayMethod:function(e,t,r){if(l){if(r)for(var i in Qi){var n=u[i];if(n&&V(n.prototype,e))try{delete n.prototype[e]}catch(e){}}Hi[e]&&!r||Ee(Hi,e,r?t:qi&&Fi[e]||t)}},exportTypedArrayStaticMethod:function(e,t,r){var i,n;if(l){if(Ht){if(r)for(i in Qi)if((n=u[i])&&V(n,e))try{delete n[e]}catch(e){}if(Gi[e]&&!r)return;try{return Ee(Gi,e,r?t:qi&&Gi[e]||t)}catch(e){}}for(i in Qi)!(n=u[i])||n[e]&&!r||Ee(n,e,t)}},isView:function(e){if(!C(e))return!1;var t=hr(e);return"DataView"===t||V(Qi,t)||V(Zi,t)},isTypedArray:en,TypedArray:Gi,TypedArrayPrototype:Hi},rn=u.ArrayBuffer,nn=u.Int8Array,on=!tn.NATIVE_ARRAY_BUFFER_VIEWS||!d((function(){nn(1)}))||!d((function(){new nn(-1)}))||!Tr((function(e){new nn,new nn(null),new nn(1.5),new nn(e)}),!0)||d((function(){return 1!==new nn(new rn(2),1,void 0).length})),sn=Math.floor,an=function(e,t){var r=function(e){var t=Re(e);if(t<0)throw RangeError("The argument can't be less than 0");return t}(e);if(r%t)throw RangeError("Wrong offset");return r},cn=tn.aTypedArrayConstructor,un=function(e){var t,r,i,n,o,s,a=U(e),c=arguments.length,u=c>1?arguments[1]:void 0,d=void 0!==u,l=fr(a);if(null!=l&&!ar(l))for(s=(o=l.call(a)).next,a=[];!(n=s.call(o)).done;)a.push(n.value);for(d&&c>2&&(u=qe(u,arguments[2],2)),r=Ie(a.length),i=new(cn(this))(r),t=0;r>t;t++)i[t]=d?u(a[t],t):a[t];return i};o((function(e){var t=Ue.f,r=rt.forEach,i=Se.get,n=Se.set,o=re.f,s=Z.f,a=Math.round,c=u.RangeError,d=ki.ArrayBuffer,h=ki.DataView,p=tn.NATIVE_ARRAY_BUFFER_VIEWS,f=tn.TYPED_ARRAY_CONSTRUCTOR,g=tn.TYPED_ARRAY_TAG,v=tn.TypedArray,y=tn.TypedArrayPrototype,b=tn.aTypedArrayConstructor,S=tn.isTypedArray,E=function(e,t){for(var r=0,i=t.length,n=new(b(e))(i);i>r;)n[r]=t[r++];return n},T=function(e,t){o(e,t,{get:function(){return i(this)[t]}})},R=function(e){var t;return e instanceof d||"ArrayBuffer"==(t=hr(e))||"SharedArrayBuffer"==t},_=function(e,t){return S(e)&&!L(t)&&t in e&&!C(r=+t)&&isFinite(r)&&sn(r)===r&&t>=0;var r},I=function(e,t){return t=J(t),_(e,t)?m(2,e[t]):s(e,t)},w=function(e,t,r){return t=J(t),!(_(e,t)&&C(r)&&V(r,"value"))||V(r,"get")||V(r,"set")||r.configurable||V(r,"writable")&&!r.writable||V(r,"enumerable")&&!r.enumerable?o(e,t,r):(e[t]=r.value,e)};l?(p||(Z.f=I,re.f=w,T(y,"buffer"),T(y,"byteOffset"),T(y,"byteLength"),T(y,"length")),Ye({target:"Object",stat:!0,forced:!p},{getOwnPropertyDescriptor:I,defineProperty:w}),e.exports=function(e,s,l){var m=e.match(/\d+$/)[0]/8,b=e+(l?"Clamped":"")+"Array",T="get"+e,_="set"+e,I=u[b],w=I,k=w&&w.prototype,O={},A=function(e,t){o(e,t,{get:function(){return function(e,t){var r=i(e);return r.view[T](t*m+r.byteOffset,!0)}(this,t)},set:function(e){return function(e,t,r){var n=i(e);l&&(r=(r=a(r))<0?0:r>255?255:255&r),n.view[_](t*m+n.byteOffset,r,!0)}(this,t,e)},enumerable:!0})};p?on&&(w=s((function(e,t,r,i){return yr(e,w,b),Rr(C(t)?R(t)?void 0!==i?new I(t,an(r,m),i):void 0!==r?new I(t,an(r,m)):new I(t):S(t)?E(w,t):un.call(w,t):new I(Yr(t)),e,w)})),Ht&&Ht(w,v),r(t(I),(function(e){e in w||ie(w,e,I[e])})),w.prototype=k):(w=s((function(e,t,r,i){yr(e,w,b);var o,s,a,u=0,l=0;if(C(t)){if(!R(t))return S(t)?E(w,t):un.call(w,t);o=t,l=an(r,m);var p=t.byteLength;if(void 0===i){if(p%m)throw c("Wrong length");if((s=p-l)<0)throw c("Wrong length")}else if((s=Ie(i)*m)+l>p)throw c("Wrong length");a=s/m}else a=Yr(t),o=new d(s=a*m);for(n(e,{buffer:o,byteOffset:l,byteLength:s,length:a,view:new h(o)});u<a;)A(e,u++)})),Ht&&Ht(w,v),k=w.prototype=Rt(y)),k.constructor!==w&&ie(k,"constructor",w),ie(k,f,w),g&&ie(k,g,b),O[b]=w,Ye({global:!0,forced:w!=I,sham:!p},O),"BYTES_PER_ELEMENT"in w||ie(w,"BYTES_PER_ELEMENT",m),"BYTES_PER_ELEMENT"in k||ie(k,"BYTES_PER_ELEMENT",m),wr(b)}):e.exports=function(){}}))("Float32",(function(e){return function(t,r,i){return e(this,t,r,i)}}));var dn=Math.min,ln=[].copyWithin||function(e,t){var r=U(this),i=Ie(r.length),n=Oe(e,i),o=Oe(t,i),s=arguments.length>2?arguments[2]:void 0,a=dn((void 0===s?i:Oe(s,i))-o,i-n),c=1;for(o<n&&n<o+a&&(c=-1,o+=a-1,n+=a-1);a-- >0;)o in r?r[n]=r[o]:delete r[n],n+=c,o+=c;return r},hn=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("copyWithin",(function(e,t){return ln.call(hn(this),e,t,arguments.length>2?arguments[2]:void 0)}));var pn=rt.every,fn=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("every",(function(e){return pn(fn(this),e,arguments.length>1?arguments[1]:void 0)}));var mn=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("fill",(function(e){return ei.apply(mn(this),arguments)}));var gn=tn.TYPED_ARRAY_CONSTRUCTOR,vn=tn.aTypedArrayConstructor,yn=function(e){return vn(Ai(e,e[gn]))},bn=rt.filter,Sn=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("filter",(function(e){return function(e,t){return function(e,t){for(var r=0,i=t.length,n=new e(i);i>r;)n[r]=t[r++];return n}(yn(e),t)}(this,bn(Sn(this),e,arguments.length>1?arguments[1]:void 0))}));var En=rt.find,Cn=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("find",(function(e){return En(Cn(this),e,arguments.length>1?arguments[1]:void 0)}));var Tn=rt.findIndex,Rn=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("findIndex",(function(e){return Tn(Rn(this),e,arguments.length>1?arguments[1]:void 0)}));var _n=rt.forEach,In=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("forEach",(function(e){_n(In(this),e,arguments.length>1?arguments[1]:void 0)}));var wn=Pe.includes,kn=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("includes",(function(e){return wn(kn(this),e,arguments.length>1?arguments[1]:void 0)}));var On=Pe.indexOf,An=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("indexOf",(function(e){return On(An(this),e,arguments.length>1?arguments[1]:void 0)}));var Pn=$("iterator"),Ln=u.Uint8Array,xn=Qt.values,Dn=Qt.keys,Mn=Qt.entries,Un=tn.aTypedArray,Nn=tn.exportTypedArrayMethod,Vn=Ln&&Ln.prototype[Pn],jn=!!Vn&&("values"==Vn.name||null==Vn.name),Fn=function(){return xn.call(Un(this))};Nn("entries",(function(){return Mn.call(Un(this))})),Nn("keys",(function(){return Dn.call(Un(this))})),Nn("values",Fn,!jn),Nn(Pn,Fn,!jn);var Bn=tn.aTypedArray,Wn=[].join;(0,tn.exportTypedArrayMethod)("join",(function(e){return Wn.apply(Bn(this),arguments)}));var Gn=function(e,t){var r=[][e];return!!r&&d((function(){r.call(null,t||function(){throw 1},1)}))},Hn=Math.min,$n=[].lastIndexOf,zn=!!$n&&1/[1].lastIndexOf(1,-0)<0,Jn=Gn("lastIndexOf"),Yn=zn||!Jn?function(e){if(zn)return $n.apply(this,arguments)||0;var t=E(this),r=Ie(t.length),i=r-1;for(arguments.length>1&&(i=Hn(i,Re(arguments[1]))),i<0&&(i=r+i);i>=0;i--)if(i in t&&t[i]===e)return i||0;return-1}:$n,Kn=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("lastIndexOf",(function(e){return Yn.apply(Kn(this),arguments)}));var qn=rt.map,Xn=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("map",(function(e){return qn(Xn(this),e,arguments.length>1?arguments[1]:void 0,(function(e,t){return new(yn(e))(t)}))}));var Qn=function(e){return function(t,r,i,n){Ke(r);var o=U(t),s=b(o),a=Ie(o.length),c=e?a-1:0,u=e?-1:1;if(i<2)for(;;){if(c in s){n=s[c],c+=u;break}if(c+=u,e?c<0:a<=c)throw TypeError("Reduce of empty array with no initial value")}for(;e?c>=0:a>c;c+=u)c in s&&(n=r(n,s[c],c,o));return n}},Zn={left:Qn(!1),right:Qn(!0)},eo=Zn.left,to=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("reduce",(function(e){return eo(to(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var ro=Zn.right,io=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("reduceRight",(function(e){return ro(io(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var no=tn.aTypedArray,oo=Math.floor;(0,tn.exportTypedArrayMethod)("reverse",(function(){for(var e,t=no(this).length,r=oo(t/2),i=0;i<r;)e=this[i],this[i++]=this[--t],this[t]=e;return this}));var so=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("set",(function(e){so(this);var t=an(arguments.length>1?arguments[1]:void 0,1),r=this.length,i=U(e),n=Ie(i.length),o=0;if(n+t>r)throw RangeError("Wrong length");for(;o<n;)this[t+o]=i[o++]}),d((function(){new Int8Array(1).set({})})));var ao=tn.aTypedArray,co=[].slice;(0,tn.exportTypedArrayMethod)("slice",(function(e,t){for(var r=co.call(ao(this),e,t),i=yn(this),n=0,o=r.length,s=new i(o);o>n;)s[n]=r[n++];return s}),d((function(){new Int8Array(1).slice()})));var uo=rt.some,lo=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("some",(function(e){return uo(lo(this),e,arguments.length>1?arguments[1]:void 0)}));var ho=Math.floor,po=function(e,t){for(var r,i,n=e.length,o=1;o<n;){for(i=o,r=e[o];i&&t(e[i-1],r)>0;)e[i]=e[--i];i!==o++&&(e[i]=r)}return e},fo=function(e,t,r){for(var i=e.length,n=t.length,o=0,s=0,a=[];o<i||s<n;)a.push(o<i&&s<n?r(e[o],t[s])<=0?e[o++]:t[s++]:o<i?e[o++]:t[s++]);return a},mo=function e(t,r){var i=t.length,n=ho(i/2);return i<8?po(t,r):fo(e(t.slice(0,n),r),e(t.slice(n),r),r)},go=R.match(/firefox\/(\d+)/i),vo=!!go&&+go[1],yo=/MSIE|Trident/.test(R),bo=R.match(/AppleWebKit\/(\d+)\./),So=!!bo&&+bo[1],Eo=tn.aTypedArray,Co=tn.exportTypedArrayMethod,To=u.Uint16Array,Ro=To&&To.prototype.sort,_o=!!Ro&&!d((function(){var e=new To(2);e.sort(null),e.sort({})})),Io=!!Ro&&!d((function(){if(O)return O<74;if(vo)return vo<67;if(yo)return!0;if(So)return So<602;var e,t,r=new To(516),i=Array(516);for(e=0;e<516;e++)t=e%4,r[e]=515-e,i[e]=e-2*t+3;for(r.sort((function(e,t){return(e/4|0)-(t/4|0)})),e=0;e<516;e++)if(r[e]!==i[e])return!0}));Co("sort",(function(e){if(void 0!==e&&Ke(e),Io)return Ro.call(this,e);Eo(this);var t,r=Ie(this.length),i=Array(r);for(t=0;t<r;t++)i[t]=this[t];for(i=mo(this,function(e){return function(t,r){return void 0!==e?+e(t,r)||0:r!=r?-1:t!=t?1:0===t&&0===r?1/t>0&&1/r<0?1:-1:t>r}}(e)),t=0;t<r;t++)this[t]=i[t];return this}),!Io||_o);var wo=tn.aTypedArray;(0,tn.exportTypedArrayMethod)("subarray",(function(e,t){var r=wo(this),i=r.length,n=Oe(e,i);return new(yn(r))(r.buffer,r.byteOffset+n*r.BYTES_PER_ELEMENT,Ie((void 0===t?i:Oe(t,i))-n))}));var ko=u.Int8Array,Oo=tn.aTypedArray,Ao=tn.exportTypedArrayMethod,Po=[].toLocaleString,Lo=[].slice,xo=!!ko&&d((function(){Po.call(new ko(1))}));Ao("toLocaleString",(function(){return Po.apply(xo?Lo.call(Oo(this)):Oo(this),arguments)}),d((function(){return[1,2].toLocaleString()!=new ko([1,2]).toLocaleString()}))||!d((function(){ko.prototype.toLocaleString.call([1,2])})));var Do=tn.exportTypedArrayMethod,Mo=u.Uint8Array,Uo=Mo&&Mo.prototype||{},No=[].toString,Vo=[].join;d((function(){No.call({})}))&&(No=function(){return Vo.call(this)}),Do("toString",No,Uo.toString!=No);var jo=function(){var e=ee(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t},Fo=function(e,t){return RegExp(e,t)},Bo={UNSUPPORTED_Y:d((function(){var e=Fo("a","y");return e.lastIndex=2,null!=e.exec("abcd")})),BROKEN_CARET:d((function(){var e=Fo("^r","gy");return e.lastIndex=2,null!=e.exec("str")}))},Wo=d((function(){var e=RegExp(".","string".charAt(0));return!(e.dotAll&&e.exec("\n")&&"s"===e.flags)})),Go=d((function(){var e=RegExp("(?<a>b)","string".charAt(5));return"b"!==e.exec("b").groups.a||"bc"!=="b".replace(e,"$<a>c")})),Ho=Se.get,$o=RegExp.prototype.exec,zo=M("native-string-replace",String.prototype.replace),Jo=$o,Yo=function(){var e=/a/,t=/b*/g;return $o.call(e,"a"),$o.call(t,"a"),0!==e.lastIndex||0!==t.lastIndex}(),Ko=Bo.UNSUPPORTED_Y||Bo.BROKEN_CARET,qo=void 0!==/()??/.exec("")[1];(Yo||qo||Ko||Wo||Go)&&(Jo=function(e){var t,r,i,n,o,s,a,c=this,u=Ho(c),d=xr(e),l=u.raw;if(l)return l.lastIndex=c.lastIndex,t=Jo.call(l,d),c.lastIndex=l.lastIndex,t;var h=u.groups,p=Ko&&c.sticky,f=jo.call(c),m=c.source,g=0,v=d;if(p&&(-1===(f=f.replace("y","")).indexOf("g")&&(f+="g"),v=d.slice(c.lastIndex),c.lastIndex>0&&(!c.multiline||c.multiline&&"\n"!==d.charAt(c.lastIndex-1))&&(m="(?: "+m+")",v=" "+v,g++),r=new RegExp("^(?:"+m+")",f)),qo&&(r=new RegExp("^"+m+"$(?!\\s)",f)),Yo&&(i=c.lastIndex),n=$o.call(p?r:c,v),p?n?(n.input=n.input.slice(g),n[0]=n[0].slice(g),n.index=c.lastIndex,c.lastIndex+=n[0].length):c.lastIndex=0:Yo&&n&&(c.lastIndex=c.global?n.index+n[0].length:i),qo&&n&&n.length>1&&zo.call(n[0],r,(function(){for(o=1;o<arguments.length-2;o++)void 0===arguments[o]&&(n[o]=void 0)})),n&&h)for(n.groups=s=Rt(null),o=0;o<h.length;o++)s[(a=h[o])[0]]=n[a[1]];return n});var Xo=Jo;Ye({target:"RegExp",proto:!0,forced:/./.exec!==Xo},{exec:Xo});$("species");var Qo=RegExp.prototype,Zo=Mr.charAt,es=function(e,t,r){return t+(r?Zo(e,t).length:1)},ts=Math.floor,rs="".replace,is=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,ns=/\$([$&'`]|\d{1,2})/g,os=function(e,t,r,i,n,o){var s=r+e.length,a=i.length,c=ns;return void 0!==n&&(n=U(n),c=is),rs.call(o,c,(function(o,c){var u;switch(c.charAt(0)){case"$":return"$";case"&":return e;case"`":return t.slice(0,r);case"'":return t.slice(s);case"<":u=n[c.slice(1,-1)];break;default:var d=+c;if(0===d)return o;if(d>a){var l=ts(d/10);return 0===l?o:l<=a?void 0===i[l-1]?c.charAt(1):i[l-1]+c.charAt(1):o}u=i[d-1]}return void 0===u?"":u}))},ss=function(e,t){var r=e.exec;if("function"==typeof r){var i=r.call(e,t);if("object"!=bt(i))throw TypeError("RegExp exec method returned something other than an Object or null");return i}if("RegExp"!==v(e))throw TypeError("RegExp#exec called on incompatible receiver");return Xo.call(e,t)},as=$("replace"),cs=Math.max,us=Math.min,ds="$0"==="a".replace(/./,"$0"),ls=!!/./[as]&&""===/./[as]("a","$0");!function(e,t,r,i){var n=$(e),o=!d((function(){var t={};return t[n]=function(){return 7},7!=""[e](t)})),s=o&&!d((function(){var e=!1,t=/a/;return t.exec=function(){return e=!0,null},t[n](""),!e}));if(!o||!s||r){var a=/./[n],c=function(e,t,r){var i=ls?"$":"$0";return[function(e,r){var i=S(this),n=null==e?void 0:e[as];return void 0!==n?n.call(e,i,r):t.call(xr(i),e,r)},function(e,n){var o=ee(this),s=xr(e);if("string"==typeof n&&-1===n.indexOf(i)&&-1===n.indexOf("$<")){var a=r(t,o,s,n);if(a.done)return a.value}var c="function"==typeof n;c||(n=xr(n));var u=o.global;if(u){var d=o.unicode;o.lastIndex=0}for(var l=[];;){var h=ss(o,s);if(null===h)break;if(l.push(h),!u)break;""===xr(h[0])&&(o.lastIndex=es(s,Ie(o.lastIndex),d))}for(var p,f="",m=0,g=0;g<l.length;g++){for(var v=xr((h=l[g])[0]),y=cs(us(Re(h.index),s.length),0),b=[],S=1;S<h.length;S++)b.push(void 0===(p=h[S])?p:String(p));var E=h.groups;if(c){var C=[v].concat(b,y,s);void 0!==E&&C.push(E);var T=xr(n.apply(void 0,C))}else T=os(v,s,y,b,E,n);y>=m&&(f+=s.slice(m,y)+T,m=y+v.length)}return f+s.slice(m)}]}(0,""[e],(function(e,t,r,i,n){var s=t.exec;return s===Xo||s===Qo.exec?o&&!n?{done:!0,value:a.call(t,r,i)}:{done:!0,value:e.call(r,t,i)}:{done:!1}}));Ee(String.prototype,e,c[0]),Ee(Qo,n,c[1])}}("replace",0,!!d((function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")}))||!ds||ls);var hs=RegExp.prototype,ps=hs.toString,fs=d((function(){return"/a/b"!=ps.call({source:"a",flags:"b"})})),ms="toString"!=ps.name;(fs||ms)&&Ee(RegExp.prototype,"toString",(function(){var e=ee(this),t=xr(e.source),r=e.flags;return"/"+t+"/"+xr(void 0===r&&e instanceof RegExp&&!("flags"in hs)?jo.call(e):r)}),{unsafe:!0});var gs=$("match"),vs=re.f,ys=Ue.f,bs=Se.enforce,Ss=$("match"),Es=u.RegExp,Cs=Es.prototype,Ts=/^\?<[^\s\d!#%&*+<=>@^][^\s!#%&*+<=>@^]*>/,Rs=/a/g,_s=/a/g,Is=new Es(Rs)!==Rs,ws=Bo.UNSUPPORTED_Y,ks=l&&(!Is||ws||Wo||Go||d((function(){return _s[Ss]=!1,Es(Rs)!=Rs||Es(_s)==_s||"/a/i"!=Es(Rs,"i")})));if(ze("RegExp",ks)){for(var Os=function e(t,r){var i,n,o,s,a,c,u,d,l=this instanceof e,h=C(i=t)&&(void 0!==(n=i[gs])?!!n:"RegExp"==v(i)),p=void 0===r,f=[],m=t;if(!l&&h&&p&&t.constructor===e)return t;if((h||t instanceof e)&&(t=t.source,p&&(r="flags"in m?m.flags:jo.call(m))),t=void 0===t?"":xr(t),r=void 0===r?"":xr(r),m=t,Wo&&"dotAll"in Rs&&(s=!!r&&r.indexOf("s")>-1)&&(r=r.replace(/s/g,"")),o=r,ws&&"sticky"in Rs&&(a=!!r&&r.indexOf("y")>-1)&&(r=r.replace(/y/g,"")),Go&&(t=(c=function(e){for(var t,r=e.length,i=0,n="",o=[],s={},a=!1,c=!1,u=0,d="";i<=r;i++){if("\\"===(t=e.charAt(i)))t+=e.charAt(++i);else if("]"===t)a=!1;else if(!a)switch(!0){case"["===t:a=!0;break;case"("===t:Ts.test(e.slice(i+1))&&(i+=2,c=!0),n+=t,u++;continue;case">"===t&&c:if(""===d||V(s,d))throw new SyntaxError("Invalid capture group name");s[d]=!0,o.push([d,u]),c=!1,d="";continue}c?d+=t:n+=t}return[n,o]}(t))[0],f=c[1]),u=Rr(Es(t,r),l?this:Cs,e),(s||a||f.length)&&(d=bs(u),s&&(d.dotAll=!0,d.raw=e(function(e){for(var t,r=e.length,i=0,n="",o=!1;i<=r;i++)"\\"!==(t=e.charAt(i))?o||"."!==t?("["===t?o=!0:"]"===t&&(o=!1),n+=t):n+="[\\s\\S]":n+=t+e.charAt(++i);return n}(t),o)),a&&(d.sticky=!0),f.length&&(d.groups=f)),t!==m)try{ie(u,"source",""===m?"(?:)":m)}catch(e){}return u},As=function(e){e in Os||vs(Os,e,{configurable:!0,get:function(){return Es[e]},set:function(t){Es[e]=t}})},Ps=ys(Es),Ls=0;Ps.length>Ls;)As(Ps[Ls++]);Cs.constructor=Os,Os.prototype=Cs,Ee(u,"RegExp",Os)}wr("RegExp");var xs=[].join,Ds=b!=Object,Ms=Gn("join",",");function Us(e,t,r){var i=function(e,t,r){var i=new RegExp("\\b".concat(t," \\w+ (\\w+)"),"ig");e.replace(i,(function(e,t){return r[t]=0,e}))},n=function(e,t,r){var i=e.createShader(r);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)?i:(console.log(e.getShaderInfoLog(i)),null)};this.uniform={},this.attribute={};var o=n(e,t,e.VERTEX_SHADER),s=n(e,r,e.FRAGMENT_SHADER);for(var a in this.id=e.createProgram(),e.attachShader(this.id,o),e.attachShader(this.id,s),e.linkProgram(this.id),e.getProgramParameter(this.id,e.LINK_STATUS)||console.log(e.getProgramInfoLog(this.id)),e.useProgram(this.id),i(t,"attribute",this.attribute),this.attribute)this.attribute[a]=e.getAttribLocation(this.id,a);for(var c in i(t,"uniform",this.uniform),i(r,"uniform",this.uniform),this.uniform)this.uniform[c]=e.getUniformLocation(this.id,c)}Ye({target:"Array",proto:!0,forced:Ds||!Ms},{join:function(e){return xs.call(E(this),void 0===e?",":e)}});var Ns=function(){function e(r){t(this,e),this.canvas=r.canvas,this.width=r.width||640,this.height=r.height||480,this.gl=this.createGL(r.canvas),this.sourceTexture=this.gl.createTexture(),this.vertexBuffer=null,this.currentProgram=null,this.applied=!1,this.beautyParams={beauty:.5,brightness:.5,ruddy:.5}}return i(e,[{key:"setRect",value:function(e,t){this.width=e,this.height=t}},{key:"apply",value:function(e){if(!this.vertexBuffer){var t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,-1,1,0,0,1,-1,1,1,1,1,1,0]);this.vertexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0)}this.gl.viewport(0,0,this.width,this.height),this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.applied?this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,0,0,this.gl.RGB,this.gl.UNSIGNED_BYTE,e):(this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,e),this.applied=!0),this.beauty()}},{key:"beauty",value:function(){var e=this.beautyParams,t=e.beauty,r=e.brightness,i=e.ruddy,n=2/this.width,o=2/this.height,s=this.compileBeautyShader();this.gl.uniform2f(s.uniform.singleStepOffset,n,o);var a=new Float32Array([1-.8*t,1-.6*t,.1+.45*i,.1+.45*i]);this.gl.uniform4fv(s.uniform.params,a),this.gl.uniform1f(s.uniform.brightness,.12*r),this.draw()}},{key:"draw",value:function(){this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.uniform1f(this.currentProgram.uniform.flipY,1),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}},{key:"compileBeautyShader",value:function(){if(this.currentProgram)return this.currentProgram;this.currentProgram=new Us(this.gl,["precision highp float;","attribute vec2 pos;","attribute vec2 uv;","varying vec2 vUv;","uniform float flipY;","void main(void) {","vUv = uv;","gl_Position = vec4(pos.x, pos.y*flipY, 0.0, 1.);","}"].join("\n"),["precision highp float;","uniform vec2 singleStepOffset;","uniform sampler2D texture;","uniform vec4 params;","uniform float brightness;","varying vec2 vUv;","const highp vec3 W = vec3(0.299,0.587,0.114);","const mat3 saturateMatrix = mat3(1.1102,-0.0598,-0.061,-0.0774,1.0826,-0.1186,-0.0228,-0.0228,1.1772);","vec2 blurCoordinates[24];","float hardLight(float color){","if(color <= 0.5){","color = color * color * 2.0;","} else {","color = 1.0 - ((1.0 - color)*(1.0 - color) * 2.0);","}","return color;","}","void main(){","vec3 centralColor = texture2D(texture, vUv).rgb;","blurCoordinates[0] = vUv.xy + singleStepOffset * vec2(0.0, -10.0);","blurCoordinates[1] = vUv.xy + singleStepOffset * vec2(0.0, 10.0);","blurCoordinates[2] = vUv.xy + singleStepOffset * vec2(-10.0, 0.0);","blurCoordinates[3] = vUv.xy + singleStepOffset * vec2(10.0, 0.0);","blurCoordinates[4] = vUv.xy + singleStepOffset * vec2(5.0, -8.0);","blurCoordinates[5] = vUv.xy + singleStepOffset * vec2(5.0, 8.0);","blurCoordinates[6] = vUv.xy + singleStepOffset * vec2(-5.0, 8.0);","blurCoordinates[7] = vUv.xy + singleStepOffset * vec2(-5.0, -8.0);","blurCoordinates[8] = vUv.xy + singleStepOffset * vec2(8.0, -5.0);","blurCoordinates[9] = vUv.xy + singleStepOffset * vec2(8.0, 5.0);","blurCoordinates[10] = vUv.xy + singleStepOffset * vec2(-8.0, 5.0);","blurCoordinates[11] = vUv.xy + singleStepOffset * vec2(-8.0, -5.0);","blurCoordinates[12] = vUv.xy + singleStepOffset * vec2(0.0, -6.0);","blurCoordinates[13] = vUv.xy + singleStepOffset * vec2(0.0, 6.0);","blurCoordinates[14] = vUv.xy + singleStepOffset * vec2(6.0, 0.0);","blurCoordinates[15] = vUv.xy + singleStepOffset * vec2(-6.0, 0.0);","blurCoordinates[16] = vUv.xy + singleStepOffset * vec2(-4.0, -4.0);","blurCoordinates[17] = vUv.xy + singleStepOffset * vec2(-4.0, 4.0);","blurCoordinates[18] = vUv.xy + singleStepOffset * vec2(4.0, -4.0);","blurCoordinates[19] = vUv.xy + singleStepOffset * vec2(4.0, 4.0);","blurCoordinates[20] = vUv.xy + singleStepOffset * vec2(-2.0, -2.0);","blurCoordinates[21] = vUv.xy + singleStepOffset * vec2(-2.0, 2.0);","blurCoordinates[22] = vUv.xy + singleStepOffset * vec2(2.0, -2.0);","blurCoordinates[23] = vUv.xy + singleStepOffset * vec2(2.0, 2.0);","float sampleColor = centralColor.g * 22.0;","sampleColor += texture2D(texture, blurCoordinates[0]).g;","sampleColor += texture2D(texture, blurCoordinates[1]).g;","sampleColor += texture2D(texture, blurCoordinates[2]).g;","sampleColor += texture2D(texture, blurCoordinates[3]).g;","sampleColor += texture2D(texture, blurCoordinates[4]).g;","sampleColor += texture2D(texture, blurCoordinates[5]).g;","sampleColor += texture2D(texture, blurCoordinates[6]).g;","sampleColor += texture2D(texture, blurCoordinates[7]).g;","sampleColor += texture2D(texture, blurCoordinates[8]).g;","sampleColor += texture2D(texture, blurCoordinates[9]).g;","sampleColor += texture2D(texture, blurCoordinates[10]).g;","sampleColor += texture2D(texture, blurCoordinates[11]).g;","sampleColor += texture2D(texture, blurCoordinates[12]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[13]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[14]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[15]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[16]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[17]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[18]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[19]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[20]).g * 3.0;","sampleColor += texture2D(texture, blurCoordinates[21]).g * 3.0;","sampleColor += texture2D(texture, blurCoordinates[22]).g * 3.0;","sampleColor += texture2D(texture, blurCoordinates[23]).g * 3.0;","sampleColor = sampleColor / 62.0;","float highPass = centralColor.g - sampleColor + 0.5;","for(int i = 0; i < 5;i++){","highPass = hardLight(highPass);","}","float luminance = dot(centralColor, W);","float alpha = pow(luminance, params.r);","vec3 smoothColor = centralColor + (centralColor-vec3(highPass))*alpha*0.1;","smoothColor.r = clamp(pow(smoothColor.r, params.g),0.0,1.0);","smoothColor.g = clamp(pow(smoothColor.g, params.g),0.0,1.0);","smoothColor.b = clamp(pow(smoothColor.b, params.g),0.0,1.0);","vec3 screen = vec3(1.0) - (vec3(1.0)-smoothColor) * (vec3(1.0)-centralColor);","vec3 lighten = max(smoothColor, centralColor);","vec3 softLight = 2.0 * centralColor*smoothColor + centralColor*centralColor - 2.0 * centralColor*centralColor * smoothColor;","gl_FragColor = vec4(mix(centralColor, screen, alpha), 1.0);","gl_FragColor.rgb = mix(gl_FragColor.rgb, lighten, alpha);","gl_FragColor.rgb = mix(gl_FragColor.rgb, softLight, params.b);","vec3 satColor = gl_FragColor.rgb * saturateMatrix;","gl_FragColor.rgb = mix(gl_FragColor.rgb, satColor, params.a);","gl_FragColor.rgb = vec3(gl_FragColor.rgb + vec3(brightness));","}"].join("\n"));var e=Float32Array.BYTES_PER_ELEMENT,t=4*e;return this.gl.enableVertexAttribArray(this.currentProgram.attribute.pos),this.gl.vertexAttribPointer(this.currentProgram.attribute.pos,2,this.gl.FLOAT,!1,t,0),this.gl.enableVertexAttribArray(this.currentProgram.attribute.uv),this.gl.vertexAttribPointer(this.currentProgram.attribute.uv,2,this.gl.FLOAT,!1,t,2*e),this.currentProgram}},{key:"createGL",value:function(e){var t=e.getContext("webgl");if(t||e.getContext("experimental-webgl",{preserveDrawingBuffer:!0}),!t)throw"Couldn't get WebGL context";return t}},{key:"setBeautyParams",value:function(e){this.beautyParams=e}},{key:"reset",value:function(){this.applied=!1}}]),e}(),Vs=function(e){return"number"==typeof e},js=function(){function r(){t(this,r),this.video=document.createElement("video"),this.video.loop=!0,this.video.autoplay=!0,this.canvas=document.createElement("canvas"),this.filter=new Ns({canvas:this.canvas}),this.beautyParams={beauty:.5,brightness:.5,ruddy:.5},this.timeoutId=null,this.rafId=null,this.startTime=null,this.originTrack=null,this.beautyTrack=null,this.localStream=null,this.frameRate=null,this.disableStatus=!1}return i(r,[{key:"generateBeautyStream",value:function(e){var t=e.getVideoTrack();if(!t)throw new Error("Your localStream does not contain video track.");var r=this.generateBeautyTrack(t);return e.replaceTrack(r),this.localStream=e,e.setBeautyStatus&&e.setBeautyStatus(!0),e}},{key:"generateBeautyTrack",value:function(e){var t=this;this.reset();var r=e.getSettings();this.frameRate=r.frameRate,this.filter.setRect(r.width,r.height),this.setRect(r.width,r.height);var i=new MediaStream;i.addTrack(e),this.video.srcObject=i,this.video.play();var n=this.generateVideoTrackFromCanvasCapture(r.frameRate||15);return this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame((function(){t.startTime=(new Date).getTime(),t.render()})),this.installEvents(),this.setBeautyTrack({originTrack:e,beautyTrack:n}),this.originTrack=e,this.beautyTrack=n,n}},{key:"draw",value:function(){this.video&&this.video.readyState===this.video.HAVE_ENOUGH_DATA&&this.filter.apply(this.video)}},{key:"render",value:function(){var e=this,t=(new Date).getTime();t-this.startTime>1e3/this.frameRate&&(this.draw(),this.startTime=t),document.hidden?(clearTimeout(this.timeoutId),this.timeoutId=setTimeout((function(){e.render()}),1e3/this.frameRate)):(this.timeoutId&&clearTimeout(this.timeoutId),this.rafId&&cancelAnimationFrame(this.rafId),requestAnimationFrame(this.render.bind(this)))}},{key:"setBeautyParam",value:function(e){var t=e.beauty,r=e.brightness,i=e.ruddy;Vs(t)&&(this.beautyParams.beauty=t),Vs(r)&&(this.beautyParams.brightness=r),Vs(i)&&(this.beautyParams.ruddy=i),this.filter.setBeautyParams(this.beautyParams),this.getClose()&&!this.disableStatus&&this.disable(),!this.getClose()&&this.disableStatus&&this.enable()}},{key:"setRect",value:function(e,t){var r=e||640,i=t||480;this.video.height=i,this.video.width=r,this.canvas.height=i,this.canvas.width=r}},{key:"reset",value:function(){cancelAnimationFrame(this.rafId),clearTimeout(this.timeoutId),this.video.pause(),this.filter.reset(),this.beautyTrack&&this.beautyTrack.stop(),this.originTrack&&this.originTrack.stop()}},{key:"destroy",value:function(){cancelAnimationFrame(this.rafId),clearTimeout(this.timeoutId),this.canvas&&(this.canvas.width=0,this.canvas.height=0,this.canvas.remove(),delete this.canvas),this.video&&(this.video.pause(),this.video.removeAttribute("srcObject"),this.video.removeAttribute("src"),this.video.load(),this.video.width=0,this.video.height=0,this.video.remove(),delete this.video),this.beautyTrack&&this.beautyTrack.stop(),this.originTrack&&this.originTrack.stop(),this.uninstallEvents()}},{key:"generateVideoTrackFromCanvasCapture",value:function(e){return this.canvas.captureStream(e).getVideoTracks()[0]}},{key:"setBeautyTrack",value:function(t){var r=t.originTrack,i=t.beautyTrack;e&&(e.beautyTrackMap||(e.beautyTrackMap=new Map),e.beautyTrackMap.set(i.id,{originTrack:r,beautyTrack:i,param:this.beautyParams,pluginInstance:this}))}},{key:"disable",value:function(){this.localStream&&this.originTrack&&(this.localStream.replaceTrack(this.originTrack),cancelAnimationFrame(this.rafId),clearTimeout(this.timeoutId),this.disableStatus=!0)}},{key:"enable",value:function(){this.localStream&&this.beautyTrack&&(this.localStream.replaceTrack(this.beautyTrack),this.render(),this.disableStatus=!1)}},{key:"installEvents",value:function(){document.addEventListener("visibilitychange",this.render.bind(this))}},{key:"uninstallEvents",value:function(){document.removeEventListener("visibilitychange",this.render.bind(this))}},{key:"getClose",value:function(){return 0===this.beautyParams.beauty&&0===this.beautyParams.brightness&&0===this.beautyParams.ruddy}}]),r}();return e&&(e.getRTCBeautyPlugin=function(){return new js}),js}(po.XRTC);var fo=RTCBeautyPlugin,mo=function(){function e(t){tt(this,e),this.logger=t,this.beautyParams={beauty:.5,brightness:.5,ruddy:.5},this.isBeautyStreamSupported=Sr(),this.isBeautyStreamSupported&&(this.rtcBeautyPlugin=new fo)}return it(e,[{key:"generateBeautyStream",value:function(e){return this.logger.info("generate beauty stream ,streamId ".concat(e.streamId)),this.isBeautyStreamSupported?this.rtcBeautyPlugin.generateBeautyStream(e):e}},{key:"setBeautyParam",value:function(e){var t,r;if(!this.isBeautyStreamSupported)return this.logger.warn("The current browser does not support beauty");var i=null===(t=this.rtcBeautyPlugin)||void 0===t||null===(r=t.localStream)||void 0===r?void 0:r.getVideoTrack();if(null==i||!i.enabled)return this.logger.warn("cannot set beauty param when video track is muted");var n,o=e.beauty,s=e.brightness,a=e.ruddy;return o>=0&&o<=1&&s>=0&&s<=1&&a>=0&&a<=1?(this.beautyParams=e,this.logger.info("set beauty param beauty:".concat(o,",brightness:").concat(s,",ruddy:").concat(a)),o>.5&&(this.beautyParams.beauty=Number((.6*(o-.5)+.5).toFixed(2))),null===(n=this.rtcBeautyPlugin)||void 0===n?void 0:n.setBeautyParam(this.beautyParams)):void 0}},{key:"destroy",value:function(){var e=this,t=setTimeout((function(){clearTimeout(t),e.rtcBeautyPlugin=null,e.logger=null,e.beautyParams=null}),100);return this.logger.info("destroy beauty"),this.rtcBeautyPlugin&&this.rtcBeautyPlugin.destroy()}},{key:"updateBeautyStream",value:function(e){if(!this.isBeautyStreamSupported)return this.logger.warn("The current browser does not support beauty");this.logger.info("update beauty stream"),this.rtcBeautyPlugin.reset();var t=e.getVideoTrack();t.enabled=!0,t&&(this.rtcBeautyPlugin.generateBeautyTrack(t),this.rtcBeautyPlugin.enable())}}]),e}(),go=new cn;go.info("browserDetails.browser",ho.browserDetails),window.Logger=go;var vo,yo,bo,So,Eo,Co,To,Ro,_o,Io,wo,ko,Oo,Ao,Po={VERSION:"4.7.0",Logger:go,checkSystemRequirements:fr,isScreenShareSupported:function(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)},isSmallStreamSupported:br,isBeautyStreamSupported:Sr,getDevices:mr,getCameras:gr,getMicrophones:vr,getSpeakers:yr,createClient:function(e){return go.info("create client with config",JSON.stringify(e)),new on(e,go)},createStream:function(e){return go.info("create stream with config",JSON.stringify(e)),new xr(e,go)},createBeauty:function(){return go.info("create beauty"),new mo(go)}};class Lo extends $e{constructor(){super(),vo.add(this),yo.set(this,!1),bo.set(this,1),So.set(this,void 0),Eo.set(this,void 0),Co.set(this,void 0),To.set(this,void 0),Ro.set(this,!1),_o.set(this,void 0),Io.set(this,void 0),wo.set(this,!1),ko.set(this,(r=>{try{switch(r.state){case"PLAYING":"unmute"===r.reason&&"video"===r.type?this.emit(Je.playing):"playing"===r.reason&&(e(this,wo)||(t(this,wo,!0),this.emit(Je.play)));break;case"PAUSED":"mute"===r.reason&&"video"===r.type&&this.emit(Je.waiting)}console.log(`${r.type} player is ${r.state} because of ${r.reason}`)}catch(e){console.error(e)}})),Oo.set(this,(()=>{e(this,To)?.off("stream-added",e(this,_o)),e(this,To)?.off("stream-subscribed",e(this,Io)),e(this,Ro)&&e(this,To)?.leave().catch((()=>console.log(""))),e(this,Ao).call(this),Po.Logger.disableUploadLog()})),Ao.set(this,(()=>{e(this,Co)?.stop(),e(this,To)&&e(this,Co)&&e(this,To).unsubscribe?.(e(this,Co))})),Po.Logger.setLogLevel(Po.Logger.LogLevel.WARN)}get muted(){let t=e(this,yo);if(e(this,Co))try{t=e(this,Co).getAudioMuted()}catch(e){console.log(e)}return t}set muted(r){t(this,yo,r),e(this,Co)&&(r?e(this,Co).muteAudio():(e(this,Co).resume(),e(this,Co).unmuteAudio()))}get volume(){return e(this,bo)}set volume(r){r>1&&(r=1),t(this,bo,r),e(this,Co)&&e(this,Co).setAudioVolume(r)}set stream(e){t(this,So,e)}set videoWrapper(e){t(this,Eo,e)}async play(){if(!e(this,So))throw new de(xe.message,xe.code,Ge.MediaError);t(this,wo,!1);const{server:r,auth:i,appid:n,userId:o,roomId:s}=e(this,So),a=t(this,To,Po.createClient({wsUrl:r,mode:"live",sdkAppId:n,userId:o,userSig:i})),{promise:c,controller:u}=he();t(this,Io,(t=>{const r=t.stream;r.on("player-state-changed",e(this,ko)),r?.on("error",(e=>{console.warn(e,r.getAudioMuted());const t=e?.getCode();16451===t&&(this.emit(Je.playNotAllowed,De.code),this.muted=!0)})),r?.play(e(this,Eo),{isEleLisenter:!1,objectFit:"cover"}).then((()=>{r.setAudioVolume(e(this,bo)),r.resize(),e(this,yo)?r.muteAudio():r.unmuteAudio()})).then(u.resolve)?.catch?.((t=>{16451===t.getCode()?u.resolve?.(De.code):(e(this,Oo).call(this),u.reject?.(t))}))})),a.on("stream-subscribed",e(this,Io));const{promise:d,controller:l}=he();t(this,_o,(r=>{const i=t(this,Co,r.stream);i.setPlayBackground("#00000000"),e(this,To).subscribe(i,{audio:!0,video:!0}).then(l.resolve).catch((t=>{e(this,Oo).call(this),l.reject?.(t)}))})),a.on("stream-added",e(this,_o)),Po.Logger.enableUploadLog();try{this.emit(Je.waiting),await a.join({roomId:s,role:"audience"}).then((()=>{t(this,Ro,!0)})).catch((t=>(e(this,Oo).call(this),Promise.reject(t)))),await d;16451===await c&&(this.emit(Je.playNotAllowed,De.code),this.muted=!0)}catch(e){throw this.emit(Je.stop),e}}resume(){e(this,Co)&&e(this,Co).resume()}stop(){e(this,vo).call(this),e(this,Oo).call(this),t(this,Ro,!1)}async setSinkId(t){await(e(this,Co)?.setAudioOutput(t))}async getSinkId(){const t=await(e(this,Co)?.getInuseSpeaker());return t?.speaker?.deviceId||""}destroy(){this.stop(),super.destroy()}resize(){e(this,Co)&&e(this,Co).resize()}}yo=new WeakMap,bo=new WeakMap,So=new WeakMap,Eo=new WeakMap,Co=new WeakMap,To=new WeakMap,Ro=new WeakMap,_o=new WeakMap,Io=new WeakMap,wo=new WeakMap,ko=new WeakMap,Oo=new WeakMap,Ao=new WeakMap,vo=new WeakSet;var xo="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Do(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var r=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,i.get?i:{enumerable:!0,get:function(){return e[t]}})})),r}function Mo(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Uo,No,Vo,jo,Fo,Bo,Wo,Go,Ho,$o,zo,Jo,Yo,Ko,qo,Xo,Qo,Zo,es,ts,rs,is,ns,os,ss,as,cs,us,ds,ls,hs,ps,fs,ms,gs,vs,ys,bs,Ss,Es,Cs,Ts,Rs,_s,Is,ws,ks,Os,As,Ps,Ls,xs,Ds,Ms,Us,Ns,Vs,js,Fs,Bs,Ws={exports:{}};Ws.exports=function e(t,r,i){function n(s,a){if(!r[s]){if(!t[s]){if(!a&&Mo)return Mo(s);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=r[s]={exports:{}};t[s][0].call(u.exports,(function(e){return n(t[s][1][e]||e)}),u,u.exports,e,t,r,i)}return r[s].exports}for(var o=Mo,s=0;s<i.length;s++)n(i[s]);return n}({1:[function(e,t,r){var i=(0,e("./adapter_factory.js").adapterFactory)({window:window});t.exports=i},{"./adapter_factory.js":2}],2:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.adapterFactory=function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).window,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},r=i.log,u=i.detectBrowser(e),d={browserDetails:u,commonShim:c,extractVersion:i.extractVersion,disableLog:i.disableLog,disableWarnings:i.disableWarnings};switch(u.browser){case"chrome":if(!n||!n.shimPeerConnection||!t.shimChrome)return r("Chrome shim is not included in this adapter release."),d;r("adapter.js shimming chrome."),d.browserShim=n,n.shimGetUserMedia(e),n.shimMediaStream(e),n.shimPeerConnection(e),n.shimOnTrack(e),n.shimAddTrackRemoveTrack(e),n.shimGetSendersWithDtmf(e),n.shimGetStats(e),n.shimSenderReceiverGetStats(e),n.fixNegotiationNeeded(e),c.shimRTCIceCandidate(e),c.shimConnectionState(e),c.shimMaxMessageSize(e),c.shimSendThrowTypeError(e),c.removeAllowExtmapMixed(e);break;case"firefox":if(!s||!s.shimPeerConnection||!t.shimFirefox)return r("Firefox shim is not included in this adapter release."),d;r("adapter.js shimming firefox."),d.browserShim=s,s.shimGetUserMedia(e),s.shimPeerConnection(e),s.shimOnTrack(e),s.shimRemoveStream(e),s.shimSenderGetStats(e),s.shimReceiverGetStats(e),s.shimRTCDataChannel(e),s.shimAddTransceiver(e),s.shimCreateOffer(e),s.shimCreateAnswer(e),c.shimRTCIceCandidate(e),c.shimConnectionState(e),c.shimMaxMessageSize(e),c.shimSendThrowTypeError(e);break;case"edge":if(!o||!o.shimPeerConnection||!t.shimEdge)return r("MS edge shim is not included in this adapter release."),d;r("adapter.js shimming edge."),d.browserShim=o,o.shimGetUserMedia(e),o.shimGetDisplayMedia(e),o.shimPeerConnection(e),o.shimReplaceTrack(e),c.shimMaxMessageSize(e),c.shimSendThrowTypeError(e);break;case"safari":if(!a||!t.shimSafari)return r("Safari shim is not included in this adapter release."),d;r("adapter.js shimming safari."),d.browserShim=a,a.shimRTCIceServerUrls(e),a.shimCreateOfferLegacy(e),a.shimCallbacksAPI(e),a.shimLocalStreamsAPI(e),a.shimRemoteStreamsAPI(e),a.shimTrackEventTransceiver(e),a.shimGetUserMedia(e),c.shimRTCIceCandidate(e),c.shimMaxMessageSize(e),c.shimSendThrowTypeError(e),c.removeAllowExtmapMixed(e);break;default:r("Unsupported browser!")}return d};var i=u(e("./utils")),n=u(e("./chrome/chrome_shim")),o=u(e("./edge/edge_shim")),s=u(e("./firefox/firefox_shim")),a=u(e("./safari/safari_shim")),c=u(e("./common_shim"));function u(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return n.shimGetUserMedia}});var o=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return o.shimGetDisplayMedia}}),r.shimMediaStream=function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},r.shimOnTrack=function(e){if("object"!==(void 0===e?"undefined":i(e))||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)s.wrapPeerConnectionEvent(e,"track",(function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e}));else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var r=this;return this._ontrackpoly||(this._ontrackpoly=function(t){t.stream.addEventListener("addtrack",(function(i){var n=void 0;n=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===i.track.id})):{track:i.track};var o=new Event("track");o.track=i.track,o.receiver=n,o.transceiver={receiver:n},o.streams=[t.stream],r.dispatchEvent(o)})),t.stream.getTracks().forEach((function(i){var n=void 0;n=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===i.id})):{track:i};var o=new Event("track");o.track=i,o.receiver=n,o.transceiver={receiver:n},o.streams=[t.stream],r.dispatchEvent(o)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}},r.shimGetSendersWithDtmf=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){var n=r.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};var n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}var o=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._senders=this._senders||[],o.apply(this,[e]),e.getTracks().forEach((function(e){r._senders.push(t(r,e))}))};var s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._senders=this._senders||[],s.apply(this,[e]),e.getTracks().forEach((function(e){var r=t._senders.find((function(t){return t.track===e}));r&&t._senders.splice(t._senders.indexOf(r),1)}))}}else if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var a=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=a.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},r.shimGetStats=function(e){if(e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var e=this,r=Array.prototype.slice.call(arguments),i=r[0],n=r[1],o=r[2];if(arguments.length>0&&"function"==typeof i)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof i))return t.apply(this,[]);var s=function(e){var t={};return e.result().forEach((function(e){var r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((function(t){r[t]=e.stat(t)})),t[r.id]=r})),t},a=function(e){return new Map(Object.keys(e).map((function(t){return[t,e[t]]})))};if(arguments.length>=2){var c=function(e){n(a(s(e)))};return t.apply(this,[c,i])}return new Promise((function(r,i){t.apply(e,[function(e){r(a(s(e)))},i])})).then(n,o)}}},r.shimSenderReceiverGetStats=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return s.filterStats(t,e.track,!0)}))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var n=e.RTCPeerConnection.prototype.getReceivers;n&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=n.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t}),s.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return s.filterStats(t,e.track,!1)}))}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){var t=arguments[0],r=void 0,i=void 0,n=void 0;return this.getSenders().forEach((function(e){e.track===t&&(r?n=!0:r=e)})),this.getReceivers().forEach((function(e){return e.track===t&&(i?n=!0:i=e),e.track===t})),n||r&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return o.apply(this,arguments)}}}},r.shimAddTrackRemoveTrackWithNative=c,r.shimAddTrackRemoveTrack=function(e){if(e.RTCPeerConnection){var t=s.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return c(e);var r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=r.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map((function(t){return e._reverseStreams[t.id]}))};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var r=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((function(e){if(r.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){var n=new e.MediaStream(t.getTracks());this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n}i.apply(this,[t])};var n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){var i=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find((function(e){return e===t})))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var o=this.getSenders().find((function(e){return e.track===t}));if(o)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var s=this._streams[r.id];if(s)s.addTrack(t),Promise.resolve().then((function(){i.dispatchEvent(new Event("negotiationneeded"))}));else{var a=new e.MediaStream([t]);this._streams[r.id]=a,this._reverseStreams[a.id]=r,this.addStream(a)}return this.getSenders().find((function(e){return e.track===t}))},["createOffer","createAnswer"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t],i=a({},t,(function(){var e=this,t=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[function(r){var i=d(e,r);t[0].apply(null,[i])},function(e){t[1]&&t[1].apply(null,e)},arguments[2]]):r.apply(this,arguments).then((function(t){return d(e,t)}))}));e.RTCPeerConnection.prototype[t]=i[t]}));var o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=l(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};var u=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=u.get.apply(this);return""===e.type?e:d(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var r=void 0;Object.keys(this._streams).forEach((function(i){t._streams[i].getTracks().find((function(t){return e.track===t}))&&(r=t._streams[i])})),r&&(1===r.getTracks().length?this.removeStream(this._reverseStreams[r.id]):r.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function d(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var i=e._reverseStreams[t],n=e._streams[i.id];r=r.replace(new RegExp(n.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:r})}function l(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var i=e._reverseStreams[t],n=e._streams[i.id];r=r.replace(new RegExp(i.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:r})}},r.shimPeerConnection=function(e){var t=s.detectBrowser(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection){t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t],i=a({},t,(function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}));e.RTCPeerConnection.prototype[t]=i[t]}));var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?t.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}},r.fixNegotiationNeeded=function(e){s.wrapPeerConnectionEvent(e,"negotiationneeded",(function(e){if("stable"===e.target.signalingState)return e}))};var s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils.js"));function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((function(t){return e._shimmedLocalStreams[t][0]}))};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var i=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(i)&&this._shimmedLocalStreams[r.id].push(i):this._shimmedLocalStreams[r.id]=[r,i],i};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((function(e){if(t.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")}));var i=this.getSenders();r.apply(this,arguments);var n=this.getSenders().filter((function(e){return-1===i.indexOf(e)}));this._shimmedLocalStreams[e.id]=[e].concat(n)};var i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};var n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((function(r){var i=t._shimmedLocalStreams[r].indexOf(e);-1!==i&&t._shimmedLocalStreams[r].splice(i,1),1===t._shimmedLocalStreams[r].length&&delete t._shimmedLocalStreams[r]})),n.apply(this,arguments)}}},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then((function(t){var i=r.video&&r.video.width,n=r.video&&r.video.height,o=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},i&&(r.video.mandatory.maxWidth=i),n&&(r.video.mandatory.maxHeight=n),e.navigator.mediaDevices.getUserMedia(r)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}},{}],5:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices){var r=n.detectBrowser(e),s=function(e){if("object"!==(void 0===e?"undefined":i(e))||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach((function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var n="object"===i(e[r])?e[r]:{ideal:e[r]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);var o=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];var s={};"number"==typeof n.ideal?(s[o("min",r)]=n.ideal,t.optional.push(s),(s={})[o("max",r)]=n.ideal,t.optional.push(s)):(s[o("",r)]=n.ideal,t.optional.push(s))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[o("",r)]=n.exact):["min","max"].forEach((function(e){void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[o(e,r)]=n[e])}))}})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},a=function(e,n){if(r.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"===i(e.audio)){var a=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};a((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),a(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=s(e.audio)}if(e&&"object"===i(e.video)){var c=e.video.facingMode;c=c&&("object"===(void 0===c?"undefined":i(c))?c:{ideal:c});var u=r.version<66;if(c&&("user"===c.exact||"environment"===c.exact||"user"===c.ideal||"environment"===c.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||u)){delete e.video.facingMode;var d=void 0;if("environment"===c.exact||"environment"===c.ideal?d=["back","rear"]:"user"!==c.exact&&"user"!==c.ideal||(d=["front"]),d)return t.mediaDevices.enumerateDevices().then((function(t){var r=(t=t.filter((function(e){return"videoinput"===e.kind}))).find((function(e){return d.some((function(t){return e.label.toLowerCase().includes(t)}))}));return!r&&t.length&&d.includes("back")&&(r=t[t.length-1]),r&&(e.video.deviceId=c.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=s(e.video),o("chrome: "+JSON.stringify(e)),n(e)}))}e.video=s(e.video)}return o("chrome: "+JSON.stringify(e)),n(e)},c=function(e){return r.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,r,i){a(e,(function(e){t.webkitGetUserMedia(e,r,(function(e){i&&i(c(e))}))}))}.bind(t),t.mediaDevices.getUserMedia){var u=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return a(e,(function(e){return u(e).then((function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((function(e){e.stop()})),new DOMException("","NotFoundError");return t}),(function(e){return Promise.reject(c(e))}))}))}}}};var n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils.js")),o=n.log},{"../utils.js":15}],6:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimRTCIceCandidate=function(e){if(!(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var r=new t(e),n=o.default.parseCandidate(e.candidate),s=Object.assign(r,n);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,s.wrapPeerConnectionEvent(e,"icecandidate",(function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t}))}},r.shimMaxMessageSize=function(e){if(e.RTCPeerConnection){var t=s.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var r=function(e){if(!e||!e.sdp)return!1;var t=o.default.splitSections(e.sdp);return t.shift(),t.some((function(e){var t=o.default.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},i=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var r=parseInt(t[1],10);return r!=r?-1:r},n=function(e){var r=65536;return"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},a=function(e,r){var i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);var n=o.default.matchPrefix(e.sdp,"a=max-message-size:");return n.length>0?i=parseInt(n[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(i=2147483637),i},c=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76&&"plan-b"===this.getConfiguration().sdpSemantics&&Object.defineProperty(this,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0}),r(arguments[0])){var e=i(arguments[0]),o=n(e),s=a(arguments[0],e),u=void 0;u=0===o&&0===s?Number.POSITIVE_INFINITY:0===o||0===s?Math.max(o,s):Math.min(o,s);var d={};Object.defineProperty(d,"maxMessageSize",{get:function(){return u}}),this._sctp=d}return c.apply(this,arguments)}}},r.shimSendThrowTypeError=function(e){if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var t=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=t.apply(this,arguments);return r(e,this),e},s.wrapPeerConnectionEvent(e,"datachannel",(function(e){return r(e.channel,e.target),e}))}function r(e,t){var r=e.send;e.send=function(){var i=arguments[0],n=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}},r.shimConnectionState=function(e){if(e.RTCPeerConnection&&!("connectionState"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((function(e){var r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(e){var t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;var r=new Event("connectionstatechange",e);t.dispatchEvent(r)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}}))}},r.removeAllowExtmapMixed=function(e){if(e.RTCPeerConnection){var t=s.detectBrowser(e);if(!("chrome"===t.browser&&t.version>=71)){var r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter((function(e){return"a=extmap-allow-mixed"!==e.trim()})).join("\n")),r.apply(this,arguments)}}}};var n,o=(n=e("sdp"))&&n.__esModule?n:{default:n},s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("./utils"))},{"./utils":15,sdp:17}],7:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return i.shimGetUserMedia}});var n=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return n.shimGetDisplayMedia}}),r.shimPeerConnection=function(e){var t=s.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){r.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var i=(0,c.default)(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=(0,a.filterIceServers)(e.iceServers,t.version),s.log("ICE servers after filtering:",e.iceServers)),new i(e)},e.RTCPeerConnection.prototype=i.prototype},r.shimReplaceTrack=function(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)};var o,s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils")),a=e("./filtericeservers"),c=(o=e("rtcpeerconnection-shim"))&&o.__esModule?o:{default:o}},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.filterIceServers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&i.deprecated("RTCIceServer.url","RTCIceServer.urls");var n="string"==typeof t;return n&&(t=[t]),t=t.filter((function(e){if(0===e.indexOf("stun:"))return!1;var t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!r?(r=!0,!0):t&&!r})),delete e.url,e.urls=n?t[0]:t,!!t.length}}))};var i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15}],9:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}},{}],10:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetUserMedia=function(e){var t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch((function(e){return Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))}))}}},{}],11:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return n.shimGetUserMedia}});var o=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return o.shimGetDisplayMedia}}),r.shimOnTrack=function(e){"object"===(void 0===e?"undefined":i(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},r.shimPeerConnection=function(e){var t=s.detectBrowser(e);if("object"===(void 0===e?"undefined":i(e))&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t],i=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}({},t,(function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}));e.RTCPeerConnection.prototype[t]=i[t]})),t.version<68){var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}var n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var e=Array.prototype.slice.call(arguments),r=e[0],i=e[1],s=e[2];return o.apply(this,[r||null]).then((function(e){if(t.version<53&&!i)try{e.forEach((function(e){e.type=n[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach((function(t,r){e.set(r,Object.assign({},t,{type:n[t.type]||t.type}))}))}return e})).then(i,s)}}},r.shimSenderGetStats=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpSender.prototype))){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},r.shimReceiverGetStats=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpReceiver.prototype))){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r}),s.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},r.shimRemoveStream=function(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;s.deprecated("removeStream","removeTrack"),this.getSenders().forEach((function(r){r.track&&e.getTracks().includes(r.track)&&t.removeTrack(r)}))})},r.shimRTCDataChannel=function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)},r.shimAddTransceiver=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];var e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach((function(e){if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));var i=t.apply(this,arguments);if(r){var n=i.sender,o=n.getParameters();"encodings"in o||(o.encodings=e.sendEncodings,this.setParametersPromises.push(n.setParameters(o).catch((function(){}))))}return i})}},r.shimCreateOffer=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){var e=this,r=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((function(){return t.apply(e,r)})).finally((function(){e.setParametersPromises=[]})):t.apply(this,arguments)}}},r.shimCreateAnswer=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){var e=this,r=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((function(){return t.apply(e,r)})).finally((function(){e.setParametersPromises=[]})):t.apply(this,arguments)}}};var s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){var i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,Promise.reject(i)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}},{}],13:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=function(e){var t=n.detectBrowser(e),r=e&&e.navigator,o=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,i){n.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,i)},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var s=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},a=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(e){return"object"===(void 0===e?"undefined":i(e))&&"object"===i(e.audio)&&(e=JSON.parse(JSON.stringify(e)),s(e.audio,"autoGainControl","mozAutoGainControl"),s(e.audio,"noiseSuppression","mozNoiseSuppression")),a(e)},o&&o.prototype.getSettings){var c=o.prototype.getSettings;o.prototype.getSettings=function(){var e=c.apply(this,arguments);return s(e,"mozAutoGainControl","autoGainControl"),s(e,"mozNoiseSuppression","noiseSuppression"),e}}if(o&&o.prototype.applyConstraints){var u=o.prototype.applyConstraints;o.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"===(void 0===e?"undefined":i(e))&&(e=JSON.parse(JSON.stringify(e)),s(e,"autoGainControl","mozAutoGainControl"),s(e,"noiseSuppression","mozNoiseSuppression")),u.apply(this,[e])}}}};var n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15}],14:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimLocalStreamsAPI=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((function(i){return t.call(r,i,e)})),e.getVideoTracks().forEach((function(i){return t.call(r,i,e)}))},e.RTCPeerConnection.prototype.addTrack=function(e){var r=arguments[1];return r&&(this._localStreams?this._localStreams.includes(r)||this._localStreams.push(r):this._localStreams=[r]),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._localStreams||(this._localStreams=[]);var r=this._localStreams.indexOf(e);if(-1!==r){this._localStreams.splice(r,1);var i=e.getTracks();this.getSenders().forEach((function(e){i.includes(e.track)&&t.removeTrack(e)}))}})}},r.shimRemoteStreamsAPI=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var t=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach((function(e){if(t._remoteStreams||(t._remoteStreams=[]),!t._remoteStreams.includes(e)){t._remoteStreams.push(e);var r=new Event("addstream");r.stream=e,t.dispatchEvent(r)}}))})}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(e._remoteStreams.indexOf(t)>=0)){e._remoteStreams.push(t);var r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}}))}),t.apply(e,arguments)}}},r.shimCallbacksAPI=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,r=t.createOffer,n=t.createAnswer,o=t.setLocalDescription,s=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){var i=arguments.length>=2?arguments[2]:arguments[0],n=r.apply(this,[i]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){var r=arguments.length>=2?arguments[2]:arguments[0],i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i};var c=function(e,t,r){var i=o.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i};t.setLocalDescription=c,c=function(e,t,r){var i=s.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.setRemoteDescription=c,c=function(e,t,r){var i=a.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.addIceCandidate=c}},r.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){var r=t.mediaDevices,i=r.getUserMedia.bind(r);t.mediaDevices.getUserMedia=function(e){return i(o(e))}}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,i){t.mediaDevices.getUserMedia(e).then(r,i)}.bind(t))},r.shimConstraints=o,r.shimRTCIceServerUrls=function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){for(var i=[],o=0;o<e.iceServers.length;o++){var s=e.iceServers[o];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(n.deprecated("RTCIceServer.url","RTCIceServer.urls"),(s=JSON.parse(JSON.stringify(s))).urls=s.url,delete s.url,i.push(s)):i.push(e.iceServers[o])}e.iceServers=i}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},r.shimTrackEventTransceiver=function(e){"object"===(void 0===e?"undefined":i(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},r.shimCreateOfferLegacy=function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var r=this.getTransceivers().find((function(e){return"audio"===e.receiver.track.kind}));!1===e.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveAudio||r||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var i=this.getTransceivers().find((function(e){return"video"===e.receiver.track.kind}));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video")}return t.apply(this,arguments)}};var n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"));function o(e){return e&&void 0!==e.video?Object.assign({},e,{video:n.compactObject(e.video)}):e}},{"../utils":15}],15:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.extractVersion=s,r.wrapPeerConnectionEvent=function(e,t,r){if(e.RTCPeerConnection){var i=e.RTCPeerConnection.prototype,n=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return n.apply(this,arguments);var o=function(e){var t=r(e);t&&i(t)};return this._eventMap=this._eventMap||{},this._eventMap[i]=o,n.apply(this,[e,o])};var o=i.removeEventListener;i.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return o.apply(this,arguments);var i=this._eventMap[r];return delete this._eventMap[r],o.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}},r.disableLog=function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":i(e))+". Please use a boolean."):(n=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},r.disableWarnings=function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":i(e))+". Please use a boolean."):(o=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},r.log=function(){if("object"===("undefined"==typeof window?"undefined":i(window))){if(n)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},r.deprecated=function(e,t){o&&console.warn(e+" is deprecated, please use "+t+" instead.")},r.detectBrowser=function(e){var t=e.navigator,r={browser:null,version:null};if(void 0===e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=s(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)r.browser="chrome",r.version=s(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=s(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return r.browser="Not a supported browser.",r;r.browser="safari",r.version=s(t.userAgent,/AppleWebKit\/(\d+)\./,1),r.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return r},r.compactObject=function e(t){return a(t)?Object.keys(t).reduce((function(r,i){var n=a(t[i]),o=n?e(t[i]):t[i],s=n&&!Object.keys(o).length;return void 0===o||s?r:Object.assign(r,function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}({},i,o))}),{}):t},r.walkStats=c,r.filterStats=function(e,t,r){var i=r?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;var o=[];return e.forEach((function(e){"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((function(t){e.forEach((function(r){r.type===i&&r.trackId===t.id&&c(e,r,n)}))})),n};var n=!0,o=!0;function s(e,t,r){var i=e.match(t);return i&&i.length>=r&&parseInt(i[r],10)}function a(e){return"[object Object]"===Object.prototype.toString.call(e)}function c(e,t,r){t&&!r.has(t.id)&&(r.set(t.id,t),Object.keys(t).forEach((function(i){i.endsWith("Id")?c(e,e.get(t[i]),r):i.endsWith("Ids")&&t[i].forEach((function(t){c(e,e.get(t),r)}))})))}},{}],16:[function(e,t,r){var i=e("sdp");function n(e,t,r,n,o){var s=i.writeRtpDescription(e.kind,t);if(s+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":o||"active"),s+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var a=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=a;var c="msid:"+(n?n.id:"-")+" "+a+"\r\n";s+="a="+c,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+i.localCName+"\r\n"),s}function o(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},i=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},n=function(e,t,r,n){var o=i(e.parameters.apt,r),s=i(t.parameters.apt,n);return o&&s&&o.name.toLowerCase()===s.name.toLowerCase()};return e.codecs.forEach((function(i){for(var o=0;o<t.codecs.length;o++){var s=t.codecs[o];if(i.name.toLowerCase()===s.name.toLowerCase()&&i.clockRate===s.clockRate){if("rtx"===i.name.toLowerCase()&&i.parameters&&s.parameters.apt&&!n(i,s,e.codecs,t.codecs))continue;(s=JSON.parse(JSON.stringify(s))).numChannels=Math.min(i.numChannels,s.numChannels),r.codecs.push(s),s.rtcpFeedback=s.rtcpFeedback.filter((function(e){for(var t=0;t<i.rtcpFeedback.length;t++)if(i.rtcpFeedback[t].type===e.type&&i.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var i=0;i<t.headerExtensions.length;i++){var n=t.headerExtensions[i];if(e.uri===n.uri){r.headerExtensions.push(n);break}}})),r}function s(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function a(e,t){var r=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return r||e.addRemoteCandidate(t),!r}function c(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}t.exports=function(e,t){function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function u(t,r,i,n){var o=new Event("track");o.track=r,o.receiver=i,o.transceiver={receiver:i},o.streams=n,e.setTimeout((function(){t._dispatchEvent("track",o)}))}var d=function(r){var n=this,o=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){n[e]=o[e].bind(o)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require"),r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all"}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced"}if(r.iceServers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var i=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var n="string"==typeof i;return n&&(i=[i]),i=i.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||r?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(r=!0,!0)})),delete e.url,e.urls=n?i[0]:i,!!i.length}}))}(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var s=r.iceCandidatePoolSize;s>0;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=i.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(d.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(d.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),d.prototype.onicecandidate=null,d.prototype.onaddstream=null,d.prototype.ontrack=null,d.prototype.onremovestream=null,d.prototype.onsignalingstatechange=null,d.prototype.oniceconnectionstatechange=null,d.prototype.onconnectionstatechange=null,d.prototype.onicegatheringstatechange=null,d.prototype.onnegotiationneeded=null,d.prototype.ondatachannel=null,d.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},d.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},d.prototype.getConfiguration=function(){return this._config},d.prototype.getLocalStreams=function(){return this.localStreams},d.prototype.getRemoteStreams=function(){return this.remoteStreams},d.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0,i={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)i.iceTransport=this.transceivers[0].iceTransport,i.dtlsTransport=this.transceivers[0].dtlsTransport;else{var n=this._createIceAndDtlsTransports();i.iceTransport=n.iceTransport,i.dtlsTransport=n.dtlsTransport}return t||this.transceivers.push(i),i},d.prototype.addTrack=function(t,r){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var i;if(this.transceivers.find((function(e){return e.track===t})))throw c("InvalidAccessError","Track already exists.");for(var n=0;n<this.transceivers.length;n++)this.transceivers[n].track||this.transceivers[n].kind!==t.kind||(i=this.transceivers[n]);return i||(i=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),i.track=t,i.stream=r,i.rtpSender=new e.RTCRtpSender(t,i.dtlsTransport),i.rtpSender},d.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach((function(t){r.addTrack(t,e)}));else{var i=e.clone();e.getTracks().forEach((function(e,t){var r=i.getTracks()[t];e.addEventListener("enabled",(function(e){r.enabled=e.enabled}))})),i.getTracks().forEach((function(e){r.addTrack(e,i)}))}},d.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var r=this.transceivers.find((function(e){return e.rtpSender===t}));if(!r)throw c("InvalidAccessError","Sender was not created by this connection.");var i=r.stream;r.rtpSender.stop(),r.rtpSender=null,r.track=null,r.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(i)&&this.localStreams.indexOf(i)>-1&&this.localStreams.splice(this.localStreams.indexOf(i),1),this._maybeFireNegotiationNeeded()},d.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var r=t.getSenders().find((function(t){return t.track===e}));r&&t.removeTrack(r)}))},d.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},d.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},d.prototype._createIceGatherer=function(t,r){var i=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var n=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(n,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;n.state=r?"completed":"gathering",null!==i.transceivers[t].bufferedCandidateEvents&&i.transceivers[t].bufferedCandidateEvents.push(e)},n.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),n},d.prototype._gather=function(t,r){var n=this,o=this.transceivers[r].iceGatherer;if(!o.onlocalcandidate){var s=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,o.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),o.onlocalcandidate=function(e){if(!(n.usingBundle&&r>0)){var s=new Event("icecandidate");s.candidate={sdpMid:t,sdpMLineIndex:r};var a=e.candidate,c=!a||0===Object.keys(a).length;if(c)"new"!==o.state&&"gathering"!==o.state||(o.state="completed");else{"new"===o.state&&(o.state="gathering"),a.component=1,a.ufrag=o.getLocalParameters().usernameFragment;var u=i.writeCandidate(a);s.candidate=Object.assign(s.candidate,i.parseCandidate(u)),s.candidate.candidate=u,s.candidate.toJSON=function(){return{candidate:s.candidate.candidate,sdpMid:s.candidate.sdpMid,sdpMLineIndex:s.candidate.sdpMLineIndex,usernameFragment:s.candidate.usernameFragment}}}var d=i.getMediaSections(n._localDescription.sdp);d[s.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+s.candidate.candidate+"\r\n",n._localDescription.sdp=i.getDescription(n._localDescription.sdp)+d.join("");var l=n.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==n.iceGatheringState&&(n.iceGatheringState="gathering",n._emitGatheringStateChange()),c||n._dispatchEvent("icecandidate",s),l&&(n._dispatchEvent("icecandidate",new Event("icecandidate")),n.iceGatheringState="complete",n._emitGatheringStateChange())}},e.setTimeout((function(){s.forEach((function(e){o.onlocalcandidate(e)}))}),0)}},d.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var i=new e.RTCDtlsTransport(r);return i.ondtlsstatechange=function(){t._updateConnectionState()},i.onerror=function(){Object.defineProperty(i,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:r,dtlsTransport:i}},d.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var i=this.transceivers[e].dtlsTransport;i&&(delete i.ondtlsstatechange,delete i.onerror,delete this.transceivers[e].dtlsTransport)},d.prototype._transceive=function(e,r,n){var s=o(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:i.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),n&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s))},d.prototype.setLocalDescription=function(e){var t,r,n=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!s("setLocalDescription",e.type,n.signalingState)||n._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+n.signalingState));if("offer"===e.type)t=i.splitSections(e.sdp),r=t.shift(),t.forEach((function(e,t){var r=i.parseRtpParameters(e);n.transceivers[t].localCapabilities=r})),n.transceivers.forEach((function(e,t){n._gather(e.mid,t)}));else if("answer"===e.type){t=i.splitSections(n._remoteDescription.sdp),r=t.shift();var a=i.matchPrefix(r,"a=ice-lite").length>0;t.forEach((function(e,t){var s=n.transceivers[t],c=s.iceGatherer,u=s.iceTransport,d=s.dtlsTransport,l=s.localCapabilities,h=s.remoteCapabilities;if(!(i.isRejected(e)&&0===i.matchPrefix(e,"a=bundle-only").length||s.rejected)){var p=i.getIceParameters(e,r),f=i.getDtlsParameters(e,r);a&&(f.role="server"),n.usingBundle&&0!==t||(n._gather(s.mid,t),"new"===u.state&&u.start(c,p,a?"controlling":"controlled"),"new"===d.state&&d.start(f));var m=o(l,h);n._transceive(s,m.codecs.length>0,!1)}}))}return n._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?n._updateSignalingState("have-local-offer"):n._updateSignalingState("stable"),Promise.resolve()},d.prototype.setRemoteDescription=function(n){var d=this;if(-1===["offer","answer"].indexOf(n.type))return Promise.reject(c("TypeError",'Unsupported type "'+n.type+'"'));if(!s("setRemoteDescription",n.type,d.signalingState)||d._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+n.type+" in state "+d.signalingState));var l={};d.remoteStreams.forEach((function(e){l[e.id]=e}));var h=[],p=i.splitSections(n.sdp),f=p.shift(),m=i.matchPrefix(f,"a=ice-lite").length>0,g=i.matchPrefix(f,"a=group:BUNDLE ").length>0;d.usingBundle=g;var v=i.matchPrefix(f,"a=ice-options:")[0];return d.canTrickleIceCandidates=!!v&&v.substr(14).split(" ").indexOf("trickle")>=0,p.forEach((function(s,c){var u=i.splitLines(s),p=i.getKind(s),v=i.isRejected(s)&&0===i.matchPrefix(s,"a=bundle-only").length,y=u[0].substr(2).split(" ")[2],b=i.getDirection(s,f),S=i.parseMsid(s),E=i.getMid(s)||i.generateIdentifier();if(v||"application"===p&&("DTLS/SCTP"===y||"UDP/DTLS/SCTP"===y))d.transceivers[c]={mid:E,kind:p,protocol:y,rejected:!0};else{var C,T,R,_,I,w,k,O,A;!v&&d.transceivers[c]&&d.transceivers[c].rejected&&(d.transceivers[c]=d._createTransceiver(p,!0));var P,L,x=i.parseRtpParameters(s);v||(P=i.getIceParameters(s,f),(L=i.getDtlsParameters(s,f)).role="client"),k=i.parseRtpEncodingParameters(s);var D=i.parseRtcpParameters(s),M=i.matchPrefix(s,"a=end-of-candidates",f).length>0,U=i.matchPrefix(s,"a=candidate:").map((function(e){return i.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===n.type||"answer"===n.type)&&!v&&g&&c>0&&d.transceivers[c]&&(d._disposeIceAndDtlsTransports(c),d.transceivers[c].iceGatherer=d.transceivers[0].iceGatherer,d.transceivers[c].iceTransport=d.transceivers[0].iceTransport,d.transceivers[c].dtlsTransport=d.transceivers[0].dtlsTransport,d.transceivers[c].rtpSender&&d.transceivers[c].rtpSender.setTransport(d.transceivers[0].dtlsTransport),d.transceivers[c].rtpReceiver&&d.transceivers[c].rtpReceiver.setTransport(d.transceivers[0].dtlsTransport)),"offer"!==n.type||v)"answer"!==n.type||v||(T=(C=d.transceivers[c]).iceGatherer,R=C.iceTransport,_=C.dtlsTransport,I=C.rtpReceiver,w=C.sendEncodingParameters,O=C.localCapabilities,d.transceivers[c].recvEncodingParameters=k,d.transceivers[c].remoteCapabilities=x,d.transceivers[c].rtcpParameters=D,U.length&&"new"===R.state&&(!m&&!M||g&&0!==c?U.forEach((function(e){a(C.iceTransport,e)})):R.setRemoteCandidates(U)),g&&0!==c||("new"===R.state&&R.start(T,P,"controlling"),"new"===_.state&&_.start(L)),!o(C.localCapabilities,C.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&C.sendEncodingParameters[0].rtx&&delete C.sendEncodingParameters[0].rtx,d._transceive(C,"sendrecv"===b||"recvonly"===b,"sendrecv"===b||"sendonly"===b),!I||"sendrecv"!==b&&"sendonly"!==b?delete C.rtpReceiver:(A=I.track,S?(l[S.stream]||(l[S.stream]=new e.MediaStream),r(A,l[S.stream]),h.push([A,I,l[S.stream]])):(l.default||(l.default=new e.MediaStream),r(A,l.default),h.push([A,I,l.default]))));else{(C=d.transceivers[c]||d._createTransceiver(p)).mid=E,C.iceGatherer||(C.iceGatherer=d._createIceGatherer(c,g)),U.length&&"new"===C.iceTransport.state&&(!M||g&&0!==c?U.forEach((function(e){a(C.iceTransport,e)})):C.iceTransport.setRemoteCandidates(U)),O=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(O.codecs=O.codecs.filter((function(e){return"rtx"!==e.name}))),w=C.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var N,V=!1;"sendrecv"===b||"sendonly"===b?(V=!C.rtpReceiver,I=C.rtpReceiver||new e.RTCRtpReceiver(C.dtlsTransport,p),V&&(A=I.track,S&&"-"===S.stream||(S?(l[S.stream]||(l[S.stream]=new e.MediaStream,Object.defineProperty(l[S.stream],"id",{get:function(){return S.stream}})),Object.defineProperty(A,"id",{get:function(){return S.track}}),N=l[S.stream]):(l.default||(l.default=new e.MediaStream),N=l.default)),N&&(r(A,N),C.associatedRemoteMediaStreams.push(N)),h.push([A,I,N]))):C.rtpReceiver&&C.rtpReceiver.track&&(C.associatedRemoteMediaStreams.forEach((function(t){var r=t.getTracks().find((function(e){return e.id===C.rtpReceiver.track.id}));r&&function(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(r,t)})),C.associatedRemoteMediaStreams=[]),C.localCapabilities=O,C.remoteCapabilities=x,C.rtpReceiver=I,C.rtcpParameters=D,C.sendEncodingParameters=w,C.recvEncodingParameters=k,d._transceive(d.transceivers[c],!1,V)}}})),void 0===d._dtlsRole&&(d._dtlsRole="offer"===n.type?"active":"passive"),d._remoteDescription={type:n.type,sdp:n.sdp},"offer"===n.type?d._updateSignalingState("have-remote-offer"):d._updateSignalingState("stable"),Object.keys(l).forEach((function(t){var r=l[t];if(r.getTracks().length){if(-1===d.remoteStreams.indexOf(r)){d.remoteStreams.push(r);var i=new Event("addstream");i.stream=r,e.setTimeout((function(){d._dispatchEvent("addstream",i)}))}h.forEach((function(e){var t=e[0],i=e[1];r.id===e[2].id&&u(d,t,i,[r])}))}})),h.forEach((function(e){e[2]||u(d,e[0],e[1],[])})),e.setTimeout((function(){d&&d.transceivers&&d.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},d.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},d.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},d.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},d.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}},d.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}},d.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var o=r.transceivers.filter((function(e){return"audio"===e.kind})).length,s=r.transceivers.filter((function(e){return"video"===e.kind})).length,a=arguments[0];if(a){if(a.mandatory||a.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==a.offerToReceiveAudio&&(o=!0===a.offerToReceiveAudio?1:!1===a.offerToReceiveAudio?0:a.offerToReceiveAudio),void 0!==a.offerToReceiveVideo&&(s=!0===a.offerToReceiveVideo?1:!1===a.offerToReceiveVideo?0:a.offerToReceiveVideo)}for(r.transceivers.forEach((function(e){"audio"===e.kind?--o<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1)}));o>0||s>0;)o>0&&(r._createTransceiver("audio"),o--),s>0&&(r._createTransceiver("video"),s--);var u=i.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach((function(n,o){var s=n.track,a=n.kind,c=n.mid||i.generateIdentifier();n.mid=c,n.iceGatherer||(n.iceGatherer=r._createIceGatherer(o,r.usingBundle));var u=e.RTCRtpSender.getCapabilities(a);t<15019&&(u.codecs=u.codecs.filter((function(e){return"rtx"!==e.name}))),u.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),n.remoteCapabilities&&n.remoteCapabilities.codecs&&n.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),u.headerExtensions.forEach((function(e){(n.remoteCapabilities&&n.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var d=n.sendEncodingParameters||[{ssrc:1001*(2*o+1)}];s&&t>=15019&&"video"===a&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,a)),n.localCapabilities=u,n.sendEncodingParameters=d})),"max-compat"!==r._config.bundlePolicy&&(u+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),u+="a=ice-options:trickle\r\n",r.transceivers.forEach((function(e,t){u+=n(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),u+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===r.iceGatheringState||0!==t&&r.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,u+="a="+i.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(u+="a=end-of-candidates\r\n"))}));var d=new e.RTCSessionDescription({type:"offer",sdp:u});return Promise.resolve(d)},d.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var s=i.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(s+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),s+="a=ice-options:trickle\r\n";var a=i.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach((function(e,i){if(!(i+1>a)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?s+="m=application 0 DTLS/SCTP 5000\r\n":s+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?s+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(s+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(s+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;e.stream&&("audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var u=o(e.localCapabilities,e.remoteCapabilities);!u.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,s+=n(e,u,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(s+="a=rtcp-rsize\r\n")}}));var u=new e.RTCSessionDescription({type:"answer",sdp:s});return Promise.resolve(u)},d.prototype.addIceCandidate=function(e){var t,r=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(n,o){if(!r._remoteDescription)return o(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var s=e.sdpMLineIndex;if(e.sdpMid)for(var u=0;u<r.transceivers.length;u++)if(r.transceivers[u].mid===e.sdpMid){s=u;break}var d=r.transceivers[s];if(!d)return o(c("OperationError","Can not add ICE candidate"));if(d.rejected)return n();var l=Object.keys(e.candidate).length>0?i.parseCandidate(e.candidate):{};if("tcp"===l.protocol&&(0===l.port||9===l.port))return n();if(l.component&&1!==l.component)return n();if((0===s||s>0&&d.iceTransport!==r.transceivers[0].iceTransport)&&!a(d.iceTransport,l))return o(c("OperationError","Can not add ICE candidate"));var h=e.candidate.trim();0===h.indexOf("a=")&&(h=h.substr(2)),(t=i.getMediaSections(r._remoteDescription.sdp))[s]+="a="+(l.type?h:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=i.getDescription(r._remoteDescription.sdp)+t.join("")}else for(var p=0;p<r.transceivers.length&&(r.transceivers[p].rejected||(r.transceivers[p].iceTransport.addRemoteCandidate({}),(t=i.getMediaSections(r._remoteDescription.sdp))[p]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=i.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));p++);n()}))},d.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver)})),!r)throw c("InvalidAccessError","Invalid selector.");return r.getStats()}var i=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&i.push(e[t].getStats())}))})),Promise.all(i).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var i=r.prototype.getStats;r.prototype.getStats=function(){return i.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(r){var i;e[r].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(i=e[r]).type]||i.type,t.set(r,e[r])})),t}))}}}));var l=["createOffer","createAnswer"];return l.forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(l=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),d}},{sdp:17}],17:[function(e,t,r){var i={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};i.localCName=i.generateIdentifier(),i.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},i.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},i.getDescription=function(e){var t=i.splitSections(e);return t&&t[0]},i.getMediaSections=function(e){var t=i.splitSections(e);return t.shift(),t},i.matchPrefix=function(e,t){return i.splitLines(e).filter((function(e){return 0===e.indexOf(t)}))},i.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":r.relatedAddress=t[i+1];break;case"rport":r.relatedPort=parseInt(t[i+1],10);break;case"tcptype":r.tcpType=t[i+1];break;case"ufrag":r.ufrag=t[i+1],r.usernameFragment=t[i+1];break;default:r[t[i]]=t[i+1]}return r},i.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},i.parseIceOptions=function(e){return e.substr(14).split(" ")},i.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},i.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},i.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},i.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},i.parseFmtp=function(e){for(var t,r={},i=e.substr(e.indexOf(" ")+1).split(";"),n=0;n<i.length;n++)r[(t=i[n].trim().split("="))[0].trim()]=t[1];return r},i.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var i=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)})),t+="a=fmtp:"+r+" "+i.join(";")+"\r\n"}return t},i.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},i.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},i.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(r.attribute=e.substr(t+1,i-t-1),r.value=e.substr(i+1)):r.attribute=e.substr(t+1),r},i.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},i.getMid=function(e){var t=i.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},i.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},i.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:i.matchPrefix(e+t,"a=fingerprint:").map(i.parseFingerprint)}},i.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},i.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},i.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?i.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},i.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},i.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},i.getCryptoParameters=function(e,t){return i.matchPrefix(e+t,"a=crypto:").map(i.parseCryptoLine)},i.getIceParameters=function(e,t){var r=i.matchPrefix(e+t,"a=ice-ufrag:")[0],n=i.matchPrefix(e+t,"a=ice-pwd:")[0];return r&&n?{usernameFragment:r.substr(12),password:n.substr(10)}:null},i.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},i.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=i.splitLines(e)[0].split(" "),n=3;n<r.length;n++){var o=r[n],s=i.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(s){var a=i.parseRtpMap(s),c=i.matchPrefix(e,"a=fmtp:"+o+" ");switch(a.parameters=c.length?i.parseFmtp(c[0]):{},a.rtcpFeedback=i.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(i.parseRtcpFb),t.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(a.name.toUpperCase())}}}return i.matchPrefix(e,"a=extmap:").forEach((function(e){t.headerExtensions.push(i.parseExtmap(e))})),t},i.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ",r+=t.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach((function(e){r+=i.writeRtpMap(e),r+=i.writeFmtp(e),r+=i.writeRtcpFb(e)}));var n=0;return t.codecs.forEach((function(e){e.maxptime>n&&(n=e.maxptime)})),n>0&&(r+="a=maxptime:"+n+"\r\n"),r+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach((function(e){r+=i.writeExtmap(e)})),r},i.parseRtpEncodingParameters=function(e){var t,r=[],n=i.parseRtpParameters(e),o=-1!==n.fecMechanisms.indexOf("RED"),s=-1!==n.fecMechanisms.indexOf("ULPFEC"),a=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=a.length>0&&a[0].ssrc,u=i.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));u.length>0&&u[0].length>1&&u[0][0]===c&&(t=u[0][1]),n.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var i={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(i.rtx={ssrc:t}),r.push(i),o&&((i=JSON.parse(JSON.stringify(i))).fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},r.push(i))}})),0===r.length&&c&&r.push({ssrc:c});var d=i.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,r.forEach((function(e){e.maxBitrate=d}))),r},i.parseRtcpParameters=function(e){var t={},r=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];r&&(t.cname=r.value,t.ssrc=r.ssrc);var n=i.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=n.length>0,t.compound=0===n.length;var o=i.matchPrefix(e,"a=rtcp-mux");return t.mux=o.length>0,t},i.parseMsid=function(e){var t,r=i.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(t=r[0].substr(7).split(" "))[0],track:t[1]};var n=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return n.length>0?{stream:(t=n[0].value.split(" "))[0],track:t[1]}:void 0},i.parseSctpDescription=function(e){var t,r=i.parseMLine(e),n=i.matchPrefix(e,"a=max-message-size:");n.length>0&&(t=parseInt(n[0].substr(19),10)),isNaN(t)&&(t=65536);var o=i.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substr(12),10),protocol:r.fmt,maxMessageSize:t};if(i.matchPrefix(e,"a=sctpmap:").length>0){var s=i.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(s[0],10),protocol:s[1],maxMessageSize:t}}},i.writeSctpDescription=function(e,t){var r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},i.generateSessionId=function(){return Math.random().toString().substr(2,21)},i.writeSessionBoilerplate=function(e,t,r){var n=void 0!==t?t:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||i.generateSessionId())+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},i.writeMediaSection=function(e,t,r,n){var o=i.writeRtpDescription(e.kind,t);if(o+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),o+="a=mid:"+e.mid+"\r\n",e.direction?o+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var s="msid:"+n.id+" "+e.rtpSender.track.id+"\r\n";o+="a="+s,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+i.localCName+"\r\n"),o},i.getDirection=function(e,t){for(var r=i.splitLines(e),n=0;n<r.length;n++)switch(r[n]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[n].substr(2)}return t?i.getDirection(t):"sendrecv"},i.getKind=function(e){return i.splitLines(e)[0].split(" ")[0].substr(2)},i.isRejected=function(e){return"0"===e.split(" ",2)[1]},i.parseMLine=function(e){var t=i.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},i.parseOLine=function(e){var t=i.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},i.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=i.splitLines(e),r=0;r<t.length;r++)if(t[r].length<2||"="!==t[r].charAt(1))return!1;return!0},"object"==typeof t&&(t.exports=i)},{}]},{},[1])(1);class Gs extends $e{constructor(){super(),Uo.add(this),No.set(this,1),Vo.set(this,!1),jo.set(this,void 0),Fo.set(this,void 0),Bo.set(this,void 0),Wo.set(this,void 0),Go.set(this,!1),Ho.set(this,window.navigator.userAgent.match(/CPU.+Mac OS X/)&&window.navigator.userAgent.match(/(iPhone)|(iPad)/)),$o.set(this,!0),zo.set(this,(()=>{e(this,Go)||this.emit(Je.play),t(this,Go,!0),e(this,Ho)&&e(this,Uo).call(this,!1),this.emit(Je.playing)})),Jo.set(this,(()=>{e(this,Uo).call(this,!1),this.emit(Je.error)})),Yo.set(this,(()=>{t(this,Wo,setTimeout((()=>{e(this,Uo).call(this,!0)}),300))})),Ko.set(this,(()=>{e(this,Uo).call(this,!1),e(this,Ho)||e(this,Bo)&&e(this,$o)&&(e(this,Uo).call(this,!1),e(this,zo).call(this))}))}get muted(){let t=e(this,Vo);if(e(this,Bo))try{t=e(this,Bo).muted}catch(e){console.log(e)}return t}set muted(r){t(this,Vo,r),e(this,Bo)&&(r?e(this,Bo).muted=!0:(e(this,Bo).play().catch((e=>{console.log(e)})),e(this,Bo).muted=!1))}get volume(){return e(this,No)}set volume(r){r>1&&(r=1),t(this,No,r),e(this,Bo)&&(e(this,Bo).volume=r)}set stream(e){t(this,jo,e)}set videoWrapper(e){t(this,Fo,e)}async play(){const t=await e(this,Uo).call(this);await e(this,Uo).call(this,t.stream),console.log(t)}resume(){e(this,Bo)&&e(this,Bo).play().catch((e=>{console.log(e)}))}stop(){this.emit(Je.stop),e(this,Uo).call(this)}async setSinkId(t){await(e(this,Bo)?.setSinkId(t))}async getSinkId(){return e(this,Bo)?.sinkId||""}destroy(){this.stop(),super.destroy()}resize(){}}No=new WeakMap,Vo=new WeakMap,jo=new WeakMap,Fo=new WeakMap,Bo=new WeakMap,Wo=new WeakMap,Go=new WeakMap,Ho=new WeakMap,$o=new WeakMap,zo=new WeakMap,Jo=new WeakMap,Yo=new WeakMap,Ko=new WeakMap,Uo=new WeakSet;class Hs extends $e{constructor(){super(),qo.add(this),Xo.set(this,void 0),Qo.set(this,se.xrtc),Zo.set(this,!1),es.set(this,1),ts.set(this,void 0),rs.set(this,void 0),is.set(this,void 0),ns.set(this,void 0),os.set(this,{width:1080,height:1920}),ss.set(this,(()=>{e(this,Xo)&&e(this,Xo).destroy(),e(this,Qo)===se.xrtc?t(this,Xo,new Lo):e(this,Qo)===se.webrtc&&t(this,Xo,new Gs),e(this,Xo)?.on(Je.play,(()=>{this.emit(Je.play)})).on(Je.waiting,(()=>{this.emit(Je.waiting)})).on(Je.playing,(()=>{this.emit(Je.playing)})).on(Je.playNotAllowed,(()=>{this.emit(Je.playNotAllowed)})).on(Je.stop,(()=>{this.emit(Je.stop)}))})),as.set(this,(()=>{const{width:t,height:r}=e(this,os),i=e(this,is)?.offsetWidth||0,n=e(this,is)?.offsetHeight||0;if(!e(this,ns))return;let o=1;o=i/n>t/r?n/r:i/t,e(this,ns).style.left="50%",e(this,ns).style.top="50%",e(this,ns).style.transform=`translate(-50%,-50%) scale(${o})`})),t(this,as,e(this,as).bind(this))}set playerType(e){t(this,Qo,e)}get muted(){let t=e(this,Zo);if(e(this,Xo))try{t=e(this,Xo)?.muted}catch(e){console.log(e)}return t}set muted(r){t(this,Zo,r),e(this,Xo)&&(r?e(this,Xo).muted=!0:(e(this,Xo).resume(),e(this,Xo).muted=!1))}get volume(){return e(this,Xo)?.volume||e(this,es)}set volume(r){r>1&&(r=1),t(this,es,r),e(this,Xo)&&(e(this,Xo).volume=r)}set stream(r){t(this,ts,r),e(this,Xo)&&(e(this,Xo).stream=r)}set container(e){t(this,rs,e)}set videoSize(e){t(this,os,e)}async play(){e(this,qo).call(this),e(this,ss).call(this),e(this,Xo)&&(e(this,ts)&&(e(this,Xo).stream=e(this,ts)),e(this,Xo).videoWrapper=e(this,ns));try{await(e(this,Xo)?.play())}catch(e){this.stop()}}resume(){e(this,Xo)&&e(this,Xo).resume()}stop(){e(this,qo).call(this),e(this,Xo)?.stop()}async setSinkId(t){await(e(this,Xo)?.setSinkId(t))}async getSinkId(){return e(this,Xo)?.getSinkId()||""}destroy(){this.stop(),super.destroy()}resize(){e(this,ns)&&(e(this,ns).style.width=`${e(this,os).width}px`,e(this,ns).style.height=`${e(this,os).height}px`),e(this,Xo)?.resize(),e(this,as).call(this)}}Xo=new WeakMap,Qo=new WeakMap,Zo=new WeakMap,es=new WeakMap,ts=new WeakMap,rs=new WeakMap,is=new WeakMap,ns=new WeakMap,os=new WeakMap,ss=new WeakMap,as=new WeakMap,qo=new WeakSet,function(e){e.audioprocess="audioprocess"}(cs||(cs={}));class $s{static async requestPermissions(e){let t="";switch(e){case"audioinput":case"audiooutput":t="microphone";break;case"videoinput":t="camera"}if(t){let e="prompt";if(navigator.permissions){if(e=(await navigator.permissions.query({name:t})).state,"denied"===e)throw new de(Ve.message,Ve.code,Ge.UserMediaError)}if("prompt"===e){(await $s.getUserMedia({video:"camera"===t,audio:"microphone"===t})).getTracks().forEach((e=>{e.stop()}))}}}static async getEnumerateDevices(e){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)throw new de(Ue.message,Ue.code,Ge.UserMediaError);await $s.requestPermissions(e);return await navigator.mediaDevices.enumerateDevices().then((t=>t.filter((t=>t.kind===e&&t.deviceId)))).catch((e=>{throw new de(e.message||e.name||We.message,We.code,Ge.UserMediaError)}))}static async getUserMedia(e){return await navigator.mediaDevices.getUserMedia(e).catch((e=>{let t=new de(Be.message,Be.code,Ge.UserMediaError);switch(e?.name){case"NotAllowedError":t=new de(Ve.message,Ve.code,Ge.UserMediaError);break;case"SecurityError":t=new de(Ue.message,Ue.code,Ge.UserMediaError);break;case"NotReadableError":t=new de(je.message,je.code,Ge.UserMediaError);break;case"NotFoundError":t=new de(Ne.message,Ne.code,Ge.UserMediaError);break;case"OverconstrainedError":t=new de(Fe.message,Fe.code,Ge.UserMediaError)}return Promise.reject(t)}))}static getAudioOutputs(){throw new Error("Method not implemented.")}static getAudioInputs(){throw new Error("Method not implemented.")}}class zs extends $e{constructor(r){super(),us.add(this),ds.set(this,new window.AudioContext),ls.set(this,{sampleRate:16e3}),hs.set(this,void 0),ps.set(this,void 0),fs.set(this,void 0),ms.set(this,void 0),gs.set(this,void 0),vs.set(this,void 0),ys.set(this,0),bs.set(this,!1),Ss.set(this,!1),Es.set(this,12e4),Cs.set(this,void 0),Ts.set(this,!1),Rs.set(this,!1),_s.set(this,void 0),t(this,ls,{...e(this,ls),...r})}get recording(){return e(this,Ss)||!1}async startRecord(r,i){if(!window.isSecureContext)throw new de(Ue.message,Ue.code,Ge.UserMediaError);await e(this,ds).resume().catch((e=>{throw console.warn("audio ctx resume failed",e),e})),e(this,us).call(this);try{await e(this,us).call(this,r,i)}catch(e){throw t(this,Ss,!1),e}finally{e(this,ms)?.resolve?.()}}async stopRecord(r=!1){if(await e(this,fs),!e(this,Ss))return;clearTimeout(e(this,Cs)),t(this,Ss,!1);const i=e(this,ps)?.getAudioTracks();for(let e=0,t=i?.length||0;e<t;e++)i?.[e]?.stop();t(this,Ts,!0),!0!==r&&0!==e(this,ys)||(this.emitSync(cs.audioprocess,{s16buffer:new ArrayBuffer(2),frameStatus:ae.end,fullDuplex:e(this,Rs)??!1}),!0===r&&e(this,us).call(this));try{e(this,gs)&&e(this,hs)?.disconnect(e(this,gs)),e(this,gs)?.disconnect(e(this,ds).destination)}catch(e){console.warn("disconnect media source",e)}e(this,_s)?.call(this),t(this,_s,void 0)}async switchDevice(r){if(!e(this,gs))return;const i=await $s.getUserMedia({audio:{deviceId:{exact:r},noiseSuppression:!0,echoCancellation:!0},video:!1});e(this,hs)?.disconnect(e(this,gs)),e(this,ps)?.getTracks().forEach((e=>e.stop())),t(this,ps,i),t(this,hs,e(this,ds).createMediaStreamSource(i)),e(this,hs).connect(e(this,gs))}destroy(){this.stopRecord(),super.destroy()}}ds=new WeakMap,ls=new WeakMap,hs=new WeakMap,ps=new WeakMap,fs=new WeakMap,ms=new WeakMap,gs=new WeakMap,vs=new WeakMap,ys=new WeakMap,bs=new WeakMap,Ss=new WeakMap,Es=new WeakMap,Cs=new WeakMap,Ts=new WeakMap,Rs=new WeakMap,_s=new WeakMap,us=new WeakSet;class Js extends $e{constructor(r){super(),Is.add(this),ws.set(this,{useInlinePlayer:!0}),ks.set(this,void 0),Os.set(this,void 0),As.set(this,"v1"),Ps.set(this,""),Ls.set(this,""),xs.set(this,""),Ds.set(this,{pushMode:se.webrtc}),Ms.set(this,{width:720,height:1280,alpha:!1}),Us.set(this,{anchorId:"",vcn:""}),Ns.set(this,{audioRate:"16000"}),Vs.set(this,void 0),js.set(this,void 0),Fs.set(this,void 0),Bs.set(this,0),t(this,ws,{...e(this,ws),...r})}get player(){return e(this,ks)}setServerUrl(e){return t(this,Ls,e),this}setAppId(e){return t(this,Ps,e),this}setToken(e){return t(this,xs,e),this}setPushConfig(r){return t(this,Ds,{...e(this,Ds),...r}),this}setAnchorConfig(r){return t(this,Us,{...e(this,Us),...r}),this}setVideoConfig(r){return t(this,Ms,{...e(this,Ms),...r}),this}setExtend(r){return t(this,Ns,{...e(this,Ns),...r}),this}async excute(t){if(!(e(this,Ls)&&e(this,Ps)&&e(this,xs)&&e(this,Us).anchorId&&e(this,Us).vcn&&e(this,Ms).width&&e(this,Ms).height))throw new de(Ae.message,Ae.code,Ge.InvalidParam);this.close();try{await e(this,Is).call(this)}catch(e){throw new de(Pe.message,Pe.code,Ge.NetworkError)}try{const r=await e(this,Is).call(this);e(this,Is).call(this),e(this,Is).call(this);e(this,Is).call(this).pushMode!==se.text&&await e(this,Is).call(this,r,t)}catch(e){throw this.close(),e}}async notifyInterrupt(){await e(this,Is).call(this).then((()=>{e(this,Is).call(this,JSON.stringify({type:ue.break}))}))}async writeText(t,r){const i=le();try{await e(this,Is).call(this)}catch(e){throw console.error(e),new de(Pe.message,Pe.code,Ge.InvalidConnect)}const n=e(this,Is).call(this,r),o=r?.nlp??e(this,Is)?ue.nlpByText:ue.repeatText;return delete n.nlp,e(this,Is).call(this,JSON.stringify({cid:i,type:o,data:ke(t),extend:JSON.stringify(n)})),i}async writeAudio(r,i,n,o){let s="";i===ae.start&&t(this,Fs,le()),t(this,Fs,s=e(this,Fs)||le());try{await e(this,Is).call(this)}catch(e){throw console.error(e),new de(Pe.message,Pe.code,Ge.InvalidConnect)}const{nlp:a,bigvoice:c=!1,needVc:u,...d}=n||{},l=a??e(this,Is)?ue.nlpByVoice:c?ue.repeatBigVoice:ue.repeatVoice;return e(this,Is).call(this,JSON.stringify({cid:s,type:`${l}`,data:Oe(new Uint8Array(r)),frameStatus:i,needVc:(u??e(this,Us).needVc)||!1,extend:JSON.stringify(d||{}),...o})),s}async playAction(t){const r=le();try{await e(this,Is).call(this)}catch(e){throw console.error(e),new de(Pe.message,Pe.code,Ge.InvalidConnect)}return e(this,Is).call(this,JSON.stringify({cid:r,type:ue.actionPlay,data:ke(`[[action=${t}]]`)})),r}get recorder(){return e(this,Os)}createRecorder(){if(e(this,Os))return e(this,Os);return t(this,Os,new zs({sampleRate:Number(e(this,Ns).sampleRate??16e3)})).on(cs.audioprocess,(t=>{this.writeAudio(t.s16buffer,t.frameStatus,{nlp:e(this,Is)},{fullDuplex:t.fullDuplex}).catch((e=>console.error(e)))})),e(this,Os)}createPlayer(){if(e(this,ks))return e(this,ks);return t(this,ks,new Hs)}close(){if(!e(this,js))return;e(this,Vs)?.abort(),clearInterval(e(this,Bs)),e(this,Os)?.stopRecord(),e(this,ks)?.stop();const r=e(this,js);r?.readyState===WebSocket.OPEN&&(r.onclose=null,r.onmessage=null,r.close(),this.emit(ze.disconnected)),t(this,Vs,void 0),t(this,js,void 0)}destroy(){e(this,ks)?.destroy(),t(this,ks,void 0),this.close(),e(this,Os)?.destroy(),t(this,Os,void 0),super.destroy()}}ws=new WeakMap,ks=new WeakMap,Os=new WeakMap,As=new WeakMap,Ps=new WeakMap,Ls=new WeakMap,xs=new WeakMap,Ds=new WeakMap,Ms=new WeakMap,Us=new WeakMap,Ns=new WeakMap,Vs=new WeakMap,js=new WeakMap,Fs=new WeakMap,Bs=new WeakMap,Is=new WeakSet;var Ys="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function Ks(){throw new Error("setTimeout has not been defined")}function qs(){throw new Error("clearTimeout has not been defined")}var Xs=Ks,Qs=qs;function Zs(e){if(Xs===setTimeout)return setTimeout(e,0);if((Xs===Ks||!Xs)&&setTimeout)return Xs=setTimeout,setTimeout(e,0);try{return Xs(e,0)}catch(t){try{return Xs.call(null,e,0)}catch(t){return Xs.call(this,e,0)}}}"function"==typeof Ys.setTimeout&&(Xs=setTimeout),"function"==typeof Ys.clearTimeout&&(Qs=clearTimeout);var ea,ta=[],ra=!1,ia=-1;function na(){ra&&ea&&(ra=!1,ea.length?ta=ea.concat(ta):ia=-1,ta.length&&oa())}function oa(){if(!ra){var e=Zs(na);ra=!0;for(var t=ta.length;t;){for(ea=ta,ta=[];++ia<t;)ea&&ea[ia].run();ia=-1,t=ta.length}ea=null,ra=!1,function(e){if(Qs===clearTimeout)return clearTimeout(e);if((Qs===qs||!Qs)&&clearTimeout)return Qs=clearTimeout,clearTimeout(e);try{return Qs(e)}catch(t){try{return Qs.call(null,e)}catch(t){return Qs.call(this,e)}}}(e)}}function sa(e,t){this.fun=e,this.array=t}sa.prototype.run=function(){this.fun.apply(null,this.array)};function aa(){}var ca=aa,ua=aa,da=aa,la=aa,ha=aa,pa=aa,fa=aa;var ma=Ys.performance||{},ga=ma.now||ma.mozNow||ma.msNow||ma.oNow||ma.webkitNow||function(){return(new Date).getTime()};var va=new Date;var ya={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];ta.push(new sa(e,t)),1!==ta.length||ra||Zs(oa)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:ca,addListener:ua,once:da,off:la,removeListener:ha,removeAllListeners:pa,emit:fa,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*ga.call(ma),r=Math.floor(t),i=Math.floor(t%1*1e9);return e&&(r-=e[0],(i-=e[1])<0&&(r--,i+=1e9)),[r,i]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-va)/1e3}},ba=ya,Sa={exports:{}},Ea=Do(Object.freeze({__proto__:null,default:{}})),Ca=[],Ta=[],Ra="undefined"!=typeof Uint8Array?Uint8Array:Array,_a=!1;function Ia(){_a=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0;t<64;++t)Ca[t]=e[t],Ta[e.charCodeAt(t)]=t;Ta["-".charCodeAt(0)]=62,Ta["_".charCodeAt(0)]=63}function wa(e,t,r){for(var i,n,o=[],s=t;s<r;s+=3)i=(e[s]<<16)+(e[s+1]<<8)+e[s+2],o.push(Ca[(n=i)>>18&63]+Ca[n>>12&63]+Ca[n>>6&63]+Ca[63&n]);return o.join("")}function ka(e){var t;_a||Ia();for(var r=e.length,i=r%3,n="",o=[],s=16383,a=0,c=r-i;a<c;a+=s)o.push(wa(e,a,a+s>c?c:a+s));return 1===i?(t=e[r-1],n+=Ca[t>>2],n+=Ca[t<<4&63],n+="=="):2===i&&(t=(e[r-2]<<8)+e[r-1],n+=Ca[t>>10],n+=Ca[t>>4&63],n+=Ca[t<<2&63],n+="="),o.push(n),o.join("")}function Oa(e,t,r,i,n){var o,s,a=8*n-i-1,c=(1<<a)-1,u=c>>1,d=-7,l=r?n-1:0,h=r?-1:1,p=e[t+l];for(l+=h,o=p&(1<<-d)-1,p>>=-d,d+=a;d>0;o=256*o+e[t+l],l+=h,d-=8);for(s=o&(1<<-d)-1,o>>=-d,d+=i;d>0;s=256*s+e[t+l],l+=h,d-=8);if(0===o)o=1-u;else{if(o===c)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,i),o-=u}return(p?-1:1)*s*Math.pow(2,o-i)}function Aa(e,t,r,i,n,o){var s,a,c,u=8*o-n-1,d=(1<<u)-1,l=d>>1,h=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,p=i?0:o-1,f=i?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=d):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+l>=1?h/c:h*Math.pow(2,1-l))*c>=2&&(s++,c/=2),s+l>=d?(a=0,s=d):s+l>=1?(a=(t*c-1)*Math.pow(2,n),s+=l):(a=t*Math.pow(2,l-1)*Math.pow(2,n),s=0));n>=8;e[r+p]=255&a,p+=f,a/=256,n-=8);for(s=s<<n|a,u+=n;u>0;e[r+p]=255&s,p+=f,s/=256,u-=8);e[r+p-f]|=128*m}var Pa={}.toString,La=Array.isArray||function(e){return"[object Array]"==Pa.call(e)};Ua.TYPED_ARRAY_SUPPORT=void 0===Ys.TYPED_ARRAY_SUPPORT||Ys.TYPED_ARRAY_SUPPORT;var xa=Da();function Da(){return Ua.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function Ma(e,t){if(Da()<t)throw new RangeError("Invalid typed array length");return Ua.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=Ua.prototype:(null===e&&(e=new Ua(t)),e.length=t),e}function Ua(e,t,r){if(!(Ua.TYPED_ARRAY_SUPPORT||this instanceof Ua))return new Ua(e,t,r);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return ja(this,e)}return Na(this,e,t,r)}function Na(e,t,r,i){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,r,i){if(t.byteLength,r<0||t.byteLength<r)throw new RangeError("'offset' is out of bounds");if(t.byteLength<r+(i||0))throw new RangeError("'length' is out of bounds");t=void 0===r&&void 0===i?new Uint8Array(t):void 0===i?new Uint8Array(t,r):new Uint8Array(t,r,i);Ua.TYPED_ARRAY_SUPPORT?(e=t).__proto__=Ua.prototype:e=Fa(e,t);return e}(e,t,r,i):"string"==typeof t?function(e,t,r){"string"==typeof r&&""!==r||(r="utf8");if(!Ua.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var i=0|Ga(t,r);e=Ma(e,i);var n=e.write(t,r);n!==i&&(e=e.slice(0,n));return e}(e,t,r):function(e,t){if(Wa(t)){var r=0|Ba(t.length);return 0===(e=Ma(e,r)).length||t.copy(e,0,0,r),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(i=t.length)!=i?Ma(e,0):Fa(e,t);if("Buffer"===t.type&&La(t.data))return Fa(e,t.data)}var i;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function Va(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function ja(e,t){if(Va(t),e=Ma(e,t<0?0:0|Ba(t)),!Ua.TYPED_ARRAY_SUPPORT)for(var r=0;r<t;++r)e[r]=0;return e}function Fa(e,t){var r=t.length<0?0:0|Ba(t.length);e=Ma(e,r);for(var i=0;i<r;i+=1)e[i]=255&t[i];return e}function Ba(e){if(e>=Da())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+Da().toString(16)+" bytes");return 0|e}function Wa(e){return!(null==e||!e._isBuffer)}function Ga(e,t){if(Wa(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var i=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return gc(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return vc(e).length;default:if(i)return gc(e).length;t=(""+t).toLowerCase(),i=!0}}function Ha(e,t,r){var i=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return oc(this,t,r);case"utf8":case"utf-8":return tc(this,t,r);case"ascii":return ic(this,t,r);case"latin1":case"binary":return nc(this,t,r);case"base64":return ec(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return sc(this,t,r);default:if(i)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),i=!0}}function $a(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}function za(e,t,r,i,n){if(0===e.length)return-1;if("string"==typeof r?(i=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,isNaN(r)&&(r=n?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(n)return-1;r=e.length-1}else if(r<0){if(!n)return-1;r=0}if("string"==typeof t&&(t=Ua.from(t,i)),Wa(t))return 0===t.length?-1:Ja(e,t,r,i,n);if("number"==typeof t)return t&=255,Ua.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?n?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):Ja(e,[t],r,i,n);throw new TypeError("val must be string, number or Buffer")}function Ja(e,t,r,i,n){var o,s=1,a=e.length,c=t.length;if(void 0!==i&&("ucs2"===(i=String(i).toLowerCase())||"ucs-2"===i||"utf16le"===i||"utf-16le"===i)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,r/=2}function u(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(n){var d=-1;for(o=r;o<a;o++)if(u(e,o)===u(t,-1===d?0:o-d)){if(-1===d&&(d=o),o-d+1===c)return d*s}else-1!==d&&(o-=o-d),d=-1}else for(r+c>a&&(r=a-c),o=r;o>=0;o--){for(var l=!0,h=0;h<c;h++)if(u(e,o+h)!==u(t,h)){l=!1;break}if(l)return o}return-1}function Ya(e,t,r,i){r=Number(r)||0;var n=e.length-r;i?(i=Number(i))>n&&(i=n):i=n;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");i>o/2&&(i=o/2);for(var s=0;s<i;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[r+s]=a}return s}function Ka(e,t,r,i){return yc(gc(t,e.length-r),e,r,i)}function qa(e,t,r,i){return yc(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,i)}function Xa(e,t,r,i){return qa(e,t,r,i)}function Qa(e,t,r,i){return yc(vc(t),e,r,i)}function Za(e,t,r,i){return yc(function(e,t){for(var r,i,n,o=[],s=0;s<e.length&&!((t-=2)<0);++s)i=(r=e.charCodeAt(s))>>8,n=r%256,o.push(n),o.push(i);return o}(t,e.length-r),e,r,i)}function ec(e,t,r){return 0===t&&r===e.length?ka(e):ka(e.slice(t,r))}function tc(e,t,r){r=Math.min(e.length,r);for(var i=[],n=t;n<r;){var o,s,a,c,u=e[n],d=null,l=u>239?4:u>223?3:u>191?2:1;if(n+l<=r)switch(l){case 1:u<128&&(d=u);break;case 2:128==(192&(o=e[n+1]))&&(c=(31&u)<<6|63&o)>127&&(d=c);break;case 3:o=e[n+1],s=e[n+2],128==(192&o)&&128==(192&s)&&(c=(15&u)<<12|(63&o)<<6|63&s)>2047&&(c<55296||c>57343)&&(d=c);break;case 4:o=e[n+1],s=e[n+2],a=e[n+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(c=(15&u)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(d=c)}null===d?(d=65533,l=1):d>65535&&(d-=65536,i.push(d>>>10&1023|55296),d=56320|1023&d),i.push(d),n+=l}return function(e){var t=e.length;if(t<=rc)return String.fromCharCode.apply(String,e);var r="",i=0;for(;i<t;)r+=String.fromCharCode.apply(String,e.slice(i,i+=rc));return r}(i)}Ua.poolSize=8192,Ua._augment=function(e){return e.__proto__=Ua.prototype,e},Ua.from=function(e,t,r){return Na(null,e,t,r)},Ua.TYPED_ARRAY_SUPPORT&&(Ua.prototype.__proto__=Uint8Array.prototype,Ua.__proto__=Uint8Array),Ua.alloc=function(e,t,r){return function(e,t,r,i){return Va(t),t<=0?Ma(e,t):void 0!==r?"string"==typeof i?Ma(e,t).fill(r,i):Ma(e,t).fill(r):Ma(e,t)}(null,e,t,r)},Ua.allocUnsafe=function(e){return ja(null,e)},Ua.allocUnsafeSlow=function(e){return ja(null,e)},Ua.isBuffer=bc,Ua.compare=function(e,t){if(!Wa(e)||!Wa(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,i=t.length,n=0,o=Math.min(r,i);n<o;++n)if(e[n]!==t[n]){r=e[n],i=t[n];break}return r<i?-1:i<r?1:0},Ua.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Ua.concat=function(e,t){if(!La(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return Ua.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var i=Ua.allocUnsafe(t),n=0;for(r=0;r<e.length;++r){var o=e[r];if(!Wa(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(i,n),n+=o.length}return i},Ua.byteLength=Ga,Ua.prototype._isBuffer=!0,Ua.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)$a(this,t,t+1);return this},Ua.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)$a(this,t,t+3),$a(this,t+1,t+2);return this},Ua.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)$a(this,t,t+7),$a(this,t+1,t+6),$a(this,t+2,t+5),$a(this,t+3,t+4);return this},Ua.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?tc(this,0,e):Ha.apply(this,arguments)},Ua.prototype.equals=function(e){if(!Wa(e))throw new TypeError("Argument must be a Buffer");return this===e||0===Ua.compare(this,e)},Ua.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},Ua.prototype.compare=function(e,t,r,i,n){if(!Wa(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===i&&(i=0),void 0===n&&(n=this.length),t<0||r>e.length||i<0||n>this.length)throw new RangeError("out of range index");if(i>=n&&t>=r)return 0;if(i>=n)return-1;if(t>=r)return 1;if(this===e)return 0;for(var o=(n>>>=0)-(i>>>=0),s=(r>>>=0)-(t>>>=0),a=Math.min(o,s),c=this.slice(i,n),u=e.slice(t,r),d=0;d<a;++d)if(c[d]!==u[d]){o=c[d],s=u[d];break}return o<s?-1:s<o?1:0},Ua.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},Ua.prototype.indexOf=function(e,t,r){return za(this,e,t,r,!0)},Ua.prototype.lastIndexOf=function(e,t,r){return za(this,e,t,r,!1)},Ua.prototype.write=function(e,t,r,i){if(void 0===t)i="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)i=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(r)?(r|=0,void 0===i&&(i="utf8")):(i=r,r=void 0)}var n=this.length-t;if((void 0===r||r>n)&&(r=n),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");i||(i="utf8");for(var o=!1;;)switch(i){case"hex":return Ya(this,e,t,r);case"utf8":case"utf-8":return Ka(this,e,t,r);case"ascii":return qa(this,e,t,r);case"latin1":case"binary":return Xa(this,e,t,r);case"base64":return Qa(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Za(this,e,t,r);default:if(o)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),o=!0}},Ua.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var rc=4096;function ic(e,t,r){var i="";r=Math.min(e.length,r);for(var n=t;n<r;++n)i+=String.fromCharCode(127&e[n]);return i}function nc(e,t,r){var i="";r=Math.min(e.length,r);for(var n=t;n<r;++n)i+=String.fromCharCode(e[n]);return i}function oc(e,t,r){var i=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>i)&&(r=i);for(var n="",o=t;o<r;++o)n+=mc(e[o]);return n}function sc(e,t,r){for(var i=e.slice(t,r),n="",o=0;o<i.length;o+=2)n+=String.fromCharCode(i[o]+256*i[o+1]);return n}function ac(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function cc(e,t,r,i,n,o){if(!Wa(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>n||t<o)throw new RangeError('"value" argument is out of bounds');if(r+i>e.length)throw new RangeError("Index out of range")}function uc(e,t,r,i){t<0&&(t=65535+t+1);for(var n=0,o=Math.min(e.length-r,2);n<o;++n)e[r+n]=(t&255<<8*(i?n:1-n))>>>8*(i?n:1-n)}function dc(e,t,r,i){t<0&&(t=4294967295+t+1);for(var n=0,o=Math.min(e.length-r,4);n<o;++n)e[r+n]=t>>>8*(i?n:3-n)&255}function lc(e,t,r,i,n,o){if(r+i>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function hc(e,t,r,i,n){return n||lc(e,0,r,4),Aa(e,t,r,i,23,4),r+4}function pc(e,t,r,i,n){return n||lc(e,0,r,8),Aa(e,t,r,i,52,8),r+8}Ua.prototype.slice=function(e,t){var r,i=this.length;if((e=~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),(t=void 0===t?i:~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),t<e&&(t=e),Ua.TYPED_ARRAY_SUPPORT)(r=this.subarray(e,t)).__proto__=Ua.prototype;else{var n=t-e;r=new Ua(n,void 0);for(var o=0;o<n;++o)r[o]=this[o+e]}return r},Ua.prototype.readUIntLE=function(e,t,r){e|=0,t|=0,r||ac(e,t,this.length);for(var i=this[e],n=1,o=0;++o<t&&(n*=256);)i+=this[e+o]*n;return i},Ua.prototype.readUIntBE=function(e,t,r){e|=0,t|=0,r||ac(e,t,this.length);for(var i=this[e+--t],n=1;t>0&&(n*=256);)i+=this[e+--t]*n;return i},Ua.prototype.readUInt8=function(e,t){return t||ac(e,1,this.length),this[e]},Ua.prototype.readUInt16LE=function(e,t){return t||ac(e,2,this.length),this[e]|this[e+1]<<8},Ua.prototype.readUInt16BE=function(e,t){return t||ac(e,2,this.length),this[e]<<8|this[e+1]},Ua.prototype.readUInt32LE=function(e,t){return t||ac(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},Ua.prototype.readUInt32BE=function(e,t){return t||ac(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},Ua.prototype.readIntLE=function(e,t,r){e|=0,t|=0,r||ac(e,t,this.length);for(var i=this[e],n=1,o=0;++o<t&&(n*=256);)i+=this[e+o]*n;return i>=(n*=128)&&(i-=Math.pow(2,8*t)),i},Ua.prototype.readIntBE=function(e,t,r){e|=0,t|=0,r||ac(e,t,this.length);for(var i=t,n=1,o=this[e+--i];i>0&&(n*=256);)o+=this[e+--i]*n;return o>=(n*=128)&&(o-=Math.pow(2,8*t)),o},Ua.prototype.readInt8=function(e,t){return t||ac(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},Ua.prototype.readInt16LE=function(e,t){t||ac(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},Ua.prototype.readInt16BE=function(e,t){t||ac(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},Ua.prototype.readInt32LE=function(e,t){return t||ac(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},Ua.prototype.readInt32BE=function(e,t){return t||ac(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},Ua.prototype.readFloatLE=function(e,t){return t||ac(e,4,this.length),Oa(this,e,!0,23,4)},Ua.prototype.readFloatBE=function(e,t){return t||ac(e,4,this.length),Oa(this,e,!1,23,4)},Ua.prototype.readDoubleLE=function(e,t){return t||ac(e,8,this.length),Oa(this,e,!0,52,8)},Ua.prototype.readDoubleBE=function(e,t){return t||ac(e,8,this.length),Oa(this,e,!1,52,8)},Ua.prototype.writeUIntLE=function(e,t,r,i){(e=+e,t|=0,r|=0,i)||cc(this,e,t,r,Math.pow(2,8*r)-1,0);var n=1,o=0;for(this[t]=255&e;++o<r&&(n*=256);)this[t+o]=e/n&255;return t+r},Ua.prototype.writeUIntBE=function(e,t,r,i){(e=+e,t|=0,r|=0,i)||cc(this,e,t,r,Math.pow(2,8*r)-1,0);var n=r-1,o=1;for(this[t+n]=255&e;--n>=0&&(o*=256);)this[t+n]=e/o&255;return t+r},Ua.prototype.writeUInt8=function(e,t,r){return e=+e,t|=0,r||cc(this,e,t,1,255,0),Ua.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},Ua.prototype.writeUInt16LE=function(e,t,r){return e=+e,t|=0,r||cc(this,e,t,2,65535,0),Ua.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):uc(this,e,t,!0),t+2},Ua.prototype.writeUInt16BE=function(e,t,r){return e=+e,t|=0,r||cc(this,e,t,2,65535,0),Ua.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):uc(this,e,t,!1),t+2},Ua.prototype.writeUInt32LE=function(e,t,r){return e=+e,t|=0,r||cc(this,e,t,4,4294967295,0),Ua.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):dc(this,e,t,!0),t+4},Ua.prototype.writeUInt32BE=function(e,t,r){return e=+e,t|=0,r||cc(this,e,t,4,4294967295,0),Ua.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):dc(this,e,t,!1),t+4},Ua.prototype.writeIntLE=function(e,t,r,i){if(e=+e,t|=0,!i){var n=Math.pow(2,8*r-1);cc(this,e,t,r,n-1,-n)}var o=0,s=1,a=0;for(this[t]=255&e;++o<r&&(s*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},Ua.prototype.writeIntBE=function(e,t,r,i){if(e=+e,t|=0,!i){var n=Math.pow(2,8*r-1);cc(this,e,t,r,n-1,-n)}var o=r-1,s=1,a=0;for(this[t+o]=255&e;--o>=0&&(s*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},Ua.prototype.writeInt8=function(e,t,r){return e=+e,t|=0,r||cc(this,e,t,1,127,-128),Ua.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},Ua.prototype.writeInt16LE=function(e,t,r){return e=+e,t|=0,r||cc(this,e,t,2,32767,-32768),Ua.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):uc(this,e,t,!0),t+2},Ua.prototype.writeInt16BE=function(e,t,r){return e=+e,t|=0,r||cc(this,e,t,2,32767,-32768),Ua.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):uc(this,e,t,!1),t+2},Ua.prototype.writeInt32LE=function(e,t,r){return e=+e,t|=0,r||cc(this,e,t,4,2147483647,-2147483648),Ua.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):dc(this,e,t,!0),t+4},Ua.prototype.writeInt32BE=function(e,t,r){return e=+e,t|=0,r||cc(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),Ua.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):dc(this,e,t,!1),t+4},Ua.prototype.writeFloatLE=function(e,t,r){return hc(this,e,t,!0,r)},Ua.prototype.writeFloatBE=function(e,t,r){return hc(this,e,t,!1,r)},Ua.prototype.writeDoubleLE=function(e,t,r){return pc(this,e,t,!0,r)},Ua.prototype.writeDoubleBE=function(e,t,r){return pc(this,e,t,!1,r)},Ua.prototype.copy=function(e,t,r,i){if(r||(r=0),i||0===i||(i=this.length),t>=e.length&&(t=e.length),t||(t=0),i>0&&i<r&&(i=r),i===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),e.length-t<i-r&&(i=e.length-t+r);var n,o=i-r;if(this===e&&r<t&&t<i)for(n=o-1;n>=0;--n)e[n+t]=this[n+r];else if(o<1e3||!Ua.TYPED_ARRAY_SUPPORT)for(n=0;n<o;++n)e[n+t]=this[n+r];else Uint8Array.prototype.set.call(e,this.subarray(r,r+o),t);return o},Ua.prototype.fill=function(e,t,r,i){if("string"==typeof e){if("string"==typeof t?(i=t,t=0,r=this.length):"string"==typeof r&&(i=r,r=this.length),1===e.length){var n=e.charCodeAt(0);n<256&&(e=n)}if(void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!Ua.isEncoding(i))throw new TypeError("Unknown encoding: "+i)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var o;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(o=t;o<r;++o)this[o]=e;else{var s=Wa(e)?e:gc(new Ua(e,i).toString()),a=s.length;for(o=0;o<r-t;++o)this[o+t]=s[o%a]}return this};var fc=/[^+\/0-9A-Za-z-_]/g;function mc(e){return e<16?"0"+e.toString(16):e.toString(16)}function gc(e,t){var r;t=t||1/0;for(var i=e.length,n=null,o=[],s=0;s<i;++s){if((r=e.charCodeAt(s))>55295&&r<57344){if(!n){if(r>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===i){(t-=3)>-1&&o.push(239,191,189);continue}n=r;continue}if(r<56320){(t-=3)>-1&&o.push(239,191,189),n=r;continue}r=65536+(n-55296<<10|r-56320)}else n&&(t-=3)>-1&&o.push(239,191,189);if(n=null,r<128){if((t-=1)<0)break;o.push(r)}else if(r<2048){if((t-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function vc(e){return function(e){var t,r,i,n,o,s;_a||Ia();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");o="="===e[a-2]?2:"="===e[a-1]?1:0,s=new Ra(3*a/4-o),i=o>0?a-4:a;var c=0;for(t=0,r=0;t<i;t+=4,r+=3)n=Ta[e.charCodeAt(t)]<<18|Ta[e.charCodeAt(t+1)]<<12|Ta[e.charCodeAt(t+2)]<<6|Ta[e.charCodeAt(t+3)],s[c++]=n>>16&255,s[c++]=n>>8&255,s[c++]=255&n;return 2===o?(n=Ta[e.charCodeAt(t)]<<2|Ta[e.charCodeAt(t+1)]>>4,s[c++]=255&n):1===o&&(n=Ta[e.charCodeAt(t)]<<10|Ta[e.charCodeAt(t+1)]<<4|Ta[e.charCodeAt(t+2)]>>2,s[c++]=n>>8&255,s[c++]=255&n),s}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(fc,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function yc(e,t,r,i){for(var n=0;n<i&&!(n+r>=t.length||n>=e.length);++n)t[n+r]=e[n];return n}function bc(e){return null!=e&&(!!e._isBuffer||Sc(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&Sc(e.slice(0,0))}(e))}function Sc(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}var Ec,Cc=Do(Object.freeze({__proto__:null,Buffer:Ua,INSPECT_MAX_BYTES:50,SlowBuffer:function(e){return+e!=e&&(e=0),Ua.alloc(+e)},isBuffer:bc,kMaxLength:xa}));Ec=Sa,function(){var e="input is invalid type",t="object"==typeof window,r=t?window:{};r.JS_MD5_NO_WINDOW&&(t=!1);var i=!t&&"object"==typeof self,n=!r.JS_MD5_NO_NODE_JS&&"object"==typeof ba&&ba.versions&&ba.versions.node;n?r=xo:i&&(r=self);var o,s=!r.JS_MD5_NO_COMMON_JS&&Ec.exports,a=!r.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,c="0123456789abcdef".split(""),u=[128,32768,8388608,-2147483648],d=[0,8,16,24],l=["hex","array","digest","buffer","arrayBuffer","base64"],h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),p=[];if(a){var f=new ArrayBuffer(68);o=new Uint8Array(f),p=new Uint32Array(f)}var m=Array.isArray;!r.JS_MD5_NO_NODE_JS&&m||(m=function(e){return"[object Array]"===Object.prototype.toString.call(e)});var g=ArrayBuffer.isView;!a||!r.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&g||(g=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});var v=function(t){var r=typeof t;if("string"===r)return[t,!0];if("object"!==r||null===t)throw new Error(e);if(a&&t.constructor===ArrayBuffer)return[new Uint8Array(t),!1];if(!m(t)&&!g(t))throw new Error(e);return[t,!1]},y=function(e){return function(t){return new E(!0).update(t)[e]()}},b=function(t){var i,n=Ea,o=Cc.Buffer;return i=o.from&&!r.JS_MD5_NO_BUFFER_FROM?o.from:function(e){return new o(e)},function(r){if("string"==typeof r)return n.createHash("md5").update(r,"utf8").digest("hex");if(null==r)throw new Error(e);return r.constructor===ArrayBuffer&&(r=new Uint8Array(r)),m(r)||g(r)||r.constructor===o?n.createHash("md5").update(i(r)).digest("hex"):t(r)}},S=function(e){return function(t,r){return new C(t,!0).update(r)[e]()}};function E(e){if(e)p[0]=p[16]=p[1]=p[2]=p[3]=p[4]=p[5]=p[6]=p[7]=p[8]=p[9]=p[10]=p[11]=p[12]=p[13]=p[14]=p[15]=0,this.blocks=p,this.buffer8=o;else if(a){var t=new ArrayBuffer(68);this.buffer8=new Uint8Array(t),this.blocks=new Uint32Array(t)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}function C(e,t){var r,i=v(e);if(e=i[0],i[1]){var n,o=[],s=e.length,a=0;for(r=0;r<s;++r)(n=e.charCodeAt(r))<128?o[a++]=n:n<2048?(o[a++]=192|n>>>6,o[a++]=128|63&n):n<55296||n>=57344?(o[a++]=224|n>>>12,o[a++]=128|n>>>6&63,o[a++]=128|63&n):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++r)),o[a++]=240|n>>>18,o[a++]=128|n>>>12&63,o[a++]=128|n>>>6&63,o[a++]=128|63&n);e=o}e.length>64&&(e=new E(!0).update(e).array());var c=[],u=[];for(r=0;r<64;++r){var d=e[r]||0;c[r]=92^d,u[r]=54^d}E.call(this,t),this.update(u),this.oKeyPad=c,this.inner=!0,this.sharedMemory=t}E.prototype.update=function(e){if(this.finalized)throw new Error("finalize already called");var t=v(e);e=t[0];for(var r,i,n=t[1],o=0,s=e.length,c=this.blocks,u=this.buffer8;o<s;){if(this.hashed&&(this.hashed=!1,c[0]=c[16],c[16]=c[1]=c[2]=c[3]=c[4]=c[5]=c[6]=c[7]=c[8]=c[9]=c[10]=c[11]=c[12]=c[13]=c[14]=c[15]=0),n)if(a)for(i=this.start;o<s&&i<64;++o)(r=e.charCodeAt(o))<128?u[i++]=r:r<2048?(u[i++]=192|r>>>6,u[i++]=128|63&r):r<55296||r>=57344?(u[i++]=224|r>>>12,u[i++]=128|r>>>6&63,u[i++]=128|63&r):(r=65536+((1023&r)<<10|1023&e.charCodeAt(++o)),u[i++]=240|r>>>18,u[i++]=128|r>>>12&63,u[i++]=128|r>>>6&63,u[i++]=128|63&r);else for(i=this.start;o<s&&i<64;++o)(r=e.charCodeAt(o))<128?c[i>>>2]|=r<<d[3&i++]:r<2048?(c[i>>>2]|=(192|r>>>6)<<d[3&i++],c[i>>>2]|=(128|63&r)<<d[3&i++]):r<55296||r>=57344?(c[i>>>2]|=(224|r>>>12)<<d[3&i++],c[i>>>2]|=(128|r>>>6&63)<<d[3&i++],c[i>>>2]|=(128|63&r)<<d[3&i++]):(r=65536+((1023&r)<<10|1023&e.charCodeAt(++o)),c[i>>>2]|=(240|r>>>18)<<d[3&i++],c[i>>>2]|=(128|r>>>12&63)<<d[3&i++],c[i>>>2]|=(128|r>>>6&63)<<d[3&i++],c[i>>>2]|=(128|63&r)<<d[3&i++]);else if(a)for(i=this.start;o<s&&i<64;++o)u[i++]=e[o];else for(i=this.start;o<s&&i<64;++o)c[i>>>2]|=e[o]<<d[3&i++];this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this},E.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[t>>>2]|=u[3&t],t>=56&&(this.hashed||this.hash(),e[0]=e[16],e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.bytes<<3,e[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},E.prototype.hash=function(){var e,t,r,i,n,o,s=this.blocks;this.first?t=((t=((e=((e=s[0]-680876937)<<7|e>>>25)-271733879<<0)^(r=((r=(-271733879^(i=((i=(-1732584194^2004318071&e)+s[1]-117830708)<<12|i>>>20)+e<<0)&(-271733879^e))+s[2]-1126478375)<<17|r>>>15)+i<<0)&(i^e))+s[3]-1316259209)<<22|t>>>10)+r<<0:(e=this.h0,t=this.h1,r=this.h2,t=((t+=((e=((e+=((i=this.h3)^t&(r^i))+s[0]-680876936)<<7|e>>>25)+t<<0)^(r=((r+=(t^(i=((i+=(r^e&(t^r))+s[1]-389564586)<<12|i>>>20)+e<<0)&(e^t))+s[2]+606105819)<<17|r>>>15)+i<<0)&(i^e))+s[3]-1044525330)<<22|t>>>10)+r<<0),t=((t+=((e=((e+=(i^t&(r^i))+s[4]-176418897)<<7|e>>>25)+t<<0)^(r=((r+=(t^(i=((i+=(r^e&(t^r))+s[5]+1200080426)<<12|i>>>20)+e<<0)&(e^t))+s[6]-1473231341)<<17|r>>>15)+i<<0)&(i^e))+s[7]-45705983)<<22|t>>>10)+r<<0,t=((t+=((e=((e+=(i^t&(r^i))+s[8]+1770035416)<<7|e>>>25)+t<<0)^(r=((r+=(t^(i=((i+=(r^e&(t^r))+s[9]-1958414417)<<12|i>>>20)+e<<0)&(e^t))+s[10]-42063)<<17|r>>>15)+i<<0)&(i^e))+s[11]-1990404162)<<22|t>>>10)+r<<0,t=((t+=((e=((e+=(i^t&(r^i))+s[12]+1804603682)<<7|e>>>25)+t<<0)^(r=((r+=(t^(i=((i+=(r^e&(t^r))+s[13]-40341101)<<12|i>>>20)+e<<0)&(e^t))+s[14]-1502002290)<<17|r>>>15)+i<<0)&(i^e))+s[15]+1236535329)<<22|t>>>10)+r<<0,t=((t+=((i=((i+=(t^r&((e=((e+=(r^i&(t^r))+s[1]-165796510)<<5|e>>>27)+t<<0)^t))+s[6]-1069501632)<<9|i>>>23)+e<<0)^e&((r=((r+=(e^t&(i^e))+s[11]+643717713)<<14|r>>>18)+i<<0)^i))+s[0]-373897302)<<20|t>>>12)+r<<0,t=((t+=((i=((i+=(t^r&((e=((e+=(r^i&(t^r))+s[5]-701558691)<<5|e>>>27)+t<<0)^t))+s[10]+38016083)<<9|i>>>23)+e<<0)^e&((r=((r+=(e^t&(i^e))+s[15]-660478335)<<14|r>>>18)+i<<0)^i))+s[4]-405537848)<<20|t>>>12)+r<<0,t=((t+=((i=((i+=(t^r&((e=((e+=(r^i&(t^r))+s[9]+568446438)<<5|e>>>27)+t<<0)^t))+s[14]-1019803690)<<9|i>>>23)+e<<0)^e&((r=((r+=(e^t&(i^e))+s[3]-187363961)<<14|r>>>18)+i<<0)^i))+s[8]+1163531501)<<20|t>>>12)+r<<0,t=((t+=((i=((i+=(t^r&((e=((e+=(r^i&(t^r))+s[13]-1444681467)<<5|e>>>27)+t<<0)^t))+s[2]-51403784)<<9|i>>>23)+e<<0)^e&((r=((r+=(e^t&(i^e))+s[7]+1735328473)<<14|r>>>18)+i<<0)^i))+s[12]-1926607734)<<20|t>>>12)+r<<0,t=((t+=((o=(i=((i+=((n=t^r)^(e=((e+=(n^i)+s[5]-378558)<<4|e>>>28)+t<<0))+s[8]-2022574463)<<11|i>>>21)+e<<0)^e)^(r=((r+=(o^t)+s[11]+1839030562)<<16|r>>>16)+i<<0))+s[14]-35309556)<<23|t>>>9)+r<<0,t=((t+=((o=(i=((i+=((n=t^r)^(e=((e+=(n^i)+s[1]-1530992060)<<4|e>>>28)+t<<0))+s[4]+1272893353)<<11|i>>>21)+e<<0)^e)^(r=((r+=(o^t)+s[7]-155497632)<<16|r>>>16)+i<<0))+s[10]-1094730640)<<23|t>>>9)+r<<0,t=((t+=((o=(i=((i+=((n=t^r)^(e=((e+=(n^i)+s[13]+681279174)<<4|e>>>28)+t<<0))+s[0]-358537222)<<11|i>>>21)+e<<0)^e)^(r=((r+=(o^t)+s[3]-722521979)<<16|r>>>16)+i<<0))+s[6]+76029189)<<23|t>>>9)+r<<0,t=((t+=((o=(i=((i+=((n=t^r)^(e=((e+=(n^i)+s[9]-640364487)<<4|e>>>28)+t<<0))+s[12]-421815835)<<11|i>>>21)+e<<0)^e)^(r=((r+=(o^t)+s[15]+530742520)<<16|r>>>16)+i<<0))+s[2]-995338651)<<23|t>>>9)+r<<0,t=((t+=((i=((i+=(t^((e=((e+=(r^(t|~i))+s[0]-198630844)<<6|e>>>26)+t<<0)|~r))+s[7]+1126891415)<<10|i>>>22)+e<<0)^((r=((r+=(e^(i|~t))+s[14]-1416354905)<<15|r>>>17)+i<<0)|~e))+s[5]-57434055)<<21|t>>>11)+r<<0,t=((t+=((i=((i+=(t^((e=((e+=(r^(t|~i))+s[12]+1700485571)<<6|e>>>26)+t<<0)|~r))+s[3]-1894986606)<<10|i>>>22)+e<<0)^((r=((r+=(e^(i|~t))+s[10]-1051523)<<15|r>>>17)+i<<0)|~e))+s[1]-2054922799)<<21|t>>>11)+r<<0,t=((t+=((i=((i+=(t^((e=((e+=(r^(t|~i))+s[8]+1873313359)<<6|e>>>26)+t<<0)|~r))+s[15]-30611744)<<10|i>>>22)+e<<0)^((r=((r+=(e^(i|~t))+s[6]-1560198380)<<15|r>>>17)+i<<0)|~e))+s[13]+1309151649)<<21|t>>>11)+r<<0,t=((t+=((i=((i+=(t^((e=((e+=(r^(t|~i))+s[4]-145523070)<<6|e>>>26)+t<<0)|~r))+s[11]-1120210379)<<10|i>>>22)+e<<0)^((r=((r+=(e^(i|~t))+s[2]+718787259)<<15|r>>>17)+i<<0)|~e))+s[9]-343485551)<<21|t>>>11)+r<<0,this.first?(this.h0=e+1732584193<<0,this.h1=t-271733879<<0,this.h2=r-1732584194<<0,this.h3=i+271733878<<0,this.first=!1):(this.h0=this.h0+e<<0,this.h1=this.h1+t<<0,this.h2=this.h2+r<<0,this.h3=this.h3+i<<0)},E.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,i=this.h3;return c[e>>>4&15]+c[15&e]+c[e>>>12&15]+c[e>>>8&15]+c[e>>>20&15]+c[e>>>16&15]+c[e>>>28&15]+c[e>>>24&15]+c[t>>>4&15]+c[15&t]+c[t>>>12&15]+c[t>>>8&15]+c[t>>>20&15]+c[t>>>16&15]+c[t>>>28&15]+c[t>>>24&15]+c[r>>>4&15]+c[15&r]+c[r>>>12&15]+c[r>>>8&15]+c[r>>>20&15]+c[r>>>16&15]+c[r>>>28&15]+c[r>>>24&15]+c[i>>>4&15]+c[15&i]+c[i>>>12&15]+c[i>>>8&15]+c[i>>>20&15]+c[i>>>16&15]+c[i>>>28&15]+c[i>>>24&15]},E.prototype.toString=E.prototype.hex,E.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,i=this.h3;return[255&e,e>>>8&255,e>>>16&255,e>>>24&255,255&t,t>>>8&255,t>>>16&255,t>>>24&255,255&r,r>>>8&255,r>>>16&255,r>>>24&255,255&i,i>>>8&255,i>>>16&255,i>>>24&255]},E.prototype.array=E.prototype.digest,E.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(16),t=new Uint32Array(e);return t[0]=this.h0,t[1]=this.h1,t[2]=this.h2,t[3]=this.h3,e},E.prototype.buffer=E.prototype.arrayBuffer,E.prototype.base64=function(){for(var e,t,r,i="",n=this.array(),o=0;o<15;)e=n[o++],t=n[o++],r=n[o++],i+=h[e>>>2]+h[63&(e<<4|t>>>4)]+h[63&(t<<2|r>>>6)]+h[63&r];return e=n[o],i+=h[e>>>2]+h[e<<4&63]+"=="},C.prototype=new E,C.prototype.finalize=function(){if(E.prototype.finalize.call(this),this.inner){this.inner=!1;var e=this.array();E.call(this,this.sharedMemory),this.update(this.oKeyPad),this.update(e),E.prototype.finalize.call(this)}};var T=function(){var e=y("hex");n&&(e=b(e)),e.create=function(){return new E},e.update=function(t){return e.create().update(t)};for(var t=0;t<l.length;++t){var r=l[t];e[r]=y(r)}return e}();T.md5=T,T.md5.hmac=function(){var e=S("hex");e.create=function(e){return new C(e)},e.update=function(t,r){return e.create(t).update(r)};for(var t=0;t<l.length;++t){var r=l[t];e[r]=S(r)}return e}(),s?Ec.exports=T:r.md5=T}();var Tc=Sa.exports;const Rc=((e,...t)=>{const r=1===e.length?e[0]:t.reduce(((t,r,i)=>t+(e=>{if(!0===e._$cssResult$)return e.cssText;if("number"==typeof e)return e;throw Error("Value passed to 'css' function must be a 'css' function result: "+e+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(r)+e[i+1]),e[0]);return new s(r,e,n)})`#x-app{position:relative;width:100%;height:100%;-webkit-transform:scale(1);-ms-transform:scale(1);transform:scale(1)}`,_c="DgWdUc8V";let Ic=class extends ne{constructor(){super(),Object.defineProperty(this,"_interative",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_initAvatar",{enumerable:!0,configurable:!0,writable:!0,value:async()=>{const{accesstoken:e}=await(async(e,t)=>{const r=`${Date.now()}`;let i=`{"base":{"appid":"${e}","version":"v1","timestamp":"${r}"},"model":"remote"}`;const n=Tc.md5(Tc.md5(`${t}${r}`)+i),o=await fetch("/aiauth/v1/token",{method:"post",body:JSON.stringify({base:{appid:e,version:"v1",timestamp:r},model:"remote"}),headers:{"Content-Type":"application/json",Authorization:n}}).then((e=>e.json()));return{code:o?.retcode,message:o?.msg,accesstoken:o?.accesstoken}})(_c,"473834311fad4a60979ea17a5a7bfa6c");this._interative?.setToken(e),await(this._interative?.excute(this.renderRoot.querySelector("#x-app")).then().catch((e=>{console.error(e.code,e.message,e.name,e.stack)})))}}),Object.defineProperty(this,"_startRecord",{enumerable:!0,configurable:!0,writable:!0,value:()=>{const e=this._interative?.createRecorder();e?.startRecord(1e4,(()=>{console.log("recorder auto stopped")}))}}),Object.defineProperty(this,"_stopRecord",{enumerable:!0,configurable:!0,writable:!0,value:()=>{const e=this._interative?.createRecorder();e?.stopRecord()}}),console.log("constructor---")}connectedCallback(){super.connectedCallback(),this.bar="df";const e=this._interative=new Js({});e.setServerUrl("wss://test.xfyousheng.com/avatar-ws/v1/link").setAppId(_c).setToken("edd69225-4760-48c0-808b-adab237d746b").setAnchorConfig({anchorId:"110029003",vcn:"x4_panting"}).setPushConfig({pushMode:se.webrtc}).setVideoConfig({width:720,height:1280,alpha:!0}).setExtend({customerInterrupt:!0});const t=e.createPlayer();t?.on(Je.play,(()=>{console.log("sdk event: player play")})).on(Je.waiting,(()=>{console.log("sdk event: player waiting")})).on(Je.playing,(()=>{console.log("sdk event: player playing")})).on(Je.playNotAllowed,(()=>{console.log("sdk event: play not allowed, muted play")})),e.on(ze.connected,(e=>{console.log("sdk event: connected",e)})).on(ze.disconnected,(()=>{console.log("sdk event: disconnected")})).on(ze.asr,(e=>{console.log("sdk event: asr",e)})).on(ze.nlp,(e=>{console.log("sdk event: nlp",e)})).on(ze.frameBegin,(e=>{console.log("sdk event: frameBegin",e)})).on(ze.duration,(e=>{console.log("sdk event: duration",e)})).on(ze.frameEnd,(e=>{console.log("sdk event: frameEnd",e)})).on(ze.error,(e=>{console.log("sdk event: error",e)})),console.log("connectedCallback---"),this._initAvatar().then((()=>{console.warn("successfully connected")}))}disconnectedCallback(){super.disconnectedCallback(),console.log("disconnectedCallback---"),this._interative?.destroy()}render(){return W`<div
        id="x-app"
        class="x-relative x-block x-w-full x-h-full"
      ></div>
      <div @click="${this._startRecord}">123</div>
      <div @click="${this._stopRecord}">456</div>`}};Object.defineProperty(Ic,"styles",{enumerable:!0,configurable:!0,writable:!0,value:[Rc]}),Object.defineProperty(Ic,"properties",{enumerable:!0,configurable:!0,writable:!0,value:{bar:{type:String}}}),Ic=function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}([(e=>(t,r)=>{void 0!==r?r.addInitializer((()=>{customElements.define(e,t)})):customElements.define(e,t)})("my-hello")],Ic);var wc=Ic;export{wc as default};
